<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIä¸´åºŠå†³ç­–æ”¯æŒç³»ç»Ÿ</title>
    <!-- EmailJS SDK -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Microsoft YaHei', sans-serif; background: #f5f7fa; padding: 20px; }
        .main-container { max-width: 900px; margin: 0 auto; }
        .header { background: white; padding: 20px 30px; border-radius: 6px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); border-left: 4px solid #3498db; }
        .header h1 { color: #2c3e50; font-size: 20px; margin-bottom: 8px; font-weight: 600; }
        .experiment-tag { display: inline-block; background: #ecf0f1; color: #34495e; padding: 5px 12px; border-radius: 3px; font-size: 12px; font-weight: 500; }
        .save-status { float: right; font-size: 12px; color: #27ae60; padding: 5px 12px; background: #d4edda; border-radius: 3px; }
        .save-status.saving { color: #856404; background: #fff3cd; }
        .save-status.error { color: #721c24; background: #f8d7da; }
        .progress-container { background: white; padding: 20px 30px; border-radius: 6px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
        .progress-title { font-size: 14px; font-weight: 600; color: #2c3e50; margin-bottom: 12px; }
        .progress-bar-container { display: flex; gap: 8px; margin-bottom: 10px; }
        .progress-bar-item { flex: 1; height: 8px; background: #e0e6ed; border-radius: 4px; }
        .progress-bar-item.completed { background: #27ae60; }
        .progress-bar-item.current { background: #3498db; }
        .progress-text { font-size: 13px; color: #718096; text-align: center; }
        .case-navigation { background: white; padding: 15px 30px; border-radius: 6px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        .case-nav-btn { padding: 10px 20px; border: 2px solid #d1d5db; background: white; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: 600; color: #4a5568; transition: all 0.2s; }
        .case-nav-btn:hover { border-color: #3498db; color: #3498db; }
        .case-nav-btn.completed { background: #d4edda; border-color: #27ae60; color: #155724; }
        .case-nav-btn.current { background: #3498db; border-color: #3498db; color: white; }
        .case-nav-btn:disabled { cursor: not-allowed; opacity: 0.5; }
        .panel { background: white; border-radius: 6px; padding: 25px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); margin-bottom: 20px; }
        .panel-title { font-size: 16px; font-weight: 600; color: #2c3e50; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #e0e6ed; }
        .input-group { margin-bottom: 18px; }
        .input-group label { display: block; font-weight: 600; color: #4a5568; margin-bottom: 8px; font-size: 13px; }
        .input-group input[type="text"], .input-group textarea { width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 14px; font-family: inherit; transition: border-color 0.2s; }
        .input-group input[type="text"]:focus, .input-group textarea:focus { outline: none; border-color: #3498db; }
        .input-group textarea { resize: vertical; min-height: 75px; }
        .required-mark { color: #e53e3e; margin-left: 2px; }
        .help-text { font-size: 12px; color: #718096; margin-top: 4px; }
        .divider { height: 1px; background: #e0e6ed; margin: 25px 0; }
        .radio-group { margin-top: 8px; }
        .radio-group label { display: block; font-weight: normal; margin-bottom: 6px; cursor: pointer; padding: 9px 12px; border-radius: 4px; transition: background 0.2s; border: 1px solid transparent; }
        .radio-group label:hover { background: #f7fafc; border-color: #e2e8f0; }
        .radio-group input { margin-right: 8px; }
        .diagnosis-list { margin-top: 10px; }
        .diagnosis-item { display: grid; grid-template-columns: 90px 1fr; gap: 10px; margin-bottom: 10px; align-items: center; }
        .diagnosis-label { font-size: 13px; color: #718096; font-weight: 500; }
        .btn { padding: 11px 24px; border: none; border-radius: 4px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .btn-primary { background: #3498db; color: white; }
        .btn-primary:hover { background: #2980b9; }
        .btn-success { background: #27ae60; color: white; }
        .btn-success:hover { background: #229954; }
        .btn-secondary { background: #95a5a6; color: white; font-size: 13px; padding: 8px 16px; }
        .btn-secondary:hover { background: #7f8c8d; }
        .action-buttons { margin-top: 25px; text-align: right; }
        .action-buttons .btn { margin-left: 10px; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: white; margin: 5% auto; padding: 0; border-radius: 6px; width: 90%; max-width: 700px; max-height: 85vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        .modal-header { padding: 18px 24px; border-bottom: 1px solid #e0e6ed; background: #f8f9fa; border-radius: 6px 6px 0 0; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 10; }
        .modal-header h3 { font-size: 16px; color: #2c3e50; font-weight: 600; }
        .modal-minimize { background: none; border: none; color: #718096; cursor: pointer; font-size: 20px; padding: 0 8px; transition: color 0.2s; }
        .modal-minimize:hover { color: #2c3e50; }
        .modal-body { padding: 24px; }
        .modal-footer { padding: 14px 24px; border-top: 1px solid #e0e6ed; text-align: right; background: #f8f9fa; border-radius: 0 0 6px 6px; position: sticky; bottom: 0; }
        .ai-suggestion-box { background: #fffbea; border-left: 4px solid #f39c12; padding: 16px; border-radius: 4px; }
        .ai-section-label { font-weight: 600; color: #856404; margin-bottom: 10px; font-size: 14px; }
        .ai-diagnosis-list { list-style: none; padding: 0; }
        .ai-diagnosis-list li { padding: 7px 0; color: #2c3e50; font-size: 14px; }
        .ai-value { color: #2c3e50; font-size: 15px; font-weight: 600; }
        .minimized-container { position: fixed; right: 20px; top: 100px; z-index: 999; display: flex; flex-direction: column; gap: 10px; }
        .minimized-item { background: white; border: 1px solid #d1d5db; border-radius: 4px; padding: 12px 16px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: all 0.2s; width: 200px; }
        .minimized-item:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.15); border-color: #3498db; }
        .minimized-title { font-size: 13px; font-weight: 600; color: #2c3e50; margin-bottom: 4px; }
        .minimized-subtitle { font-size: 11px; color: #718096; }
        .status-indicator { display: inline-block; padding: 5px 12px; border-radius: 3px; font-size: 12px; font-weight: 600; margin-bottom: 15px; }
        .status-initial { background: #d4edda; color: #155724; }
        .status-final { background: #cfe2ff; color: #084298; }
        .phase-title { font-size: 14px; font-weight: 600; color: #2c3e50; margin-bottom: 12px; }
        .case-info-display { background: #f8f9fa; padding: 14px; border-radius: 4px; margin-bottom: 18px; border: 1px solid #e0e6ed; }
        .case-info-row { margin-bottom: 10px; line-height: 1.6; }
        .case-info-row:last-child { margin-bottom: 0; }
        .case-info-label { font-weight: 600; color: #4a5568; display: inline-block; min-width: 90px; }
        .case-info-value { color: #2c3e50; }
        .hidden { display: none; }
        .instruction-box { background: #e3f2fd; border-left: 4px solid #2196f3; padding: 12px 16px; border-radius: 4px; margin-bottom: 16px; font-size: 13px; color: #1565c0; }
        .thank-you-message { background: #d4edda; border: 2px solid #27ae60; border-radius: 6px; padding: 30px; text-align: center; margin-top: 20px; }
        .thank-you-message h2 { color: #155724; margin-bottom: 15px; }
        .thank-you-message p { color: #2c3e50; margin-bottom: 20px; }
        .download-btn { background: #95a5a6; color: white; padding: 12px 30px; border: none; border-radius: 4px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; margin-top: 10px; }
        .download-btn:hover { background: #7f8c8d; }
        .error-field { border-color: #e53e3e !important; }
        .time-stats-table { width: 100%; margin-top: 20px; border-collapse: collapse; }
        .time-stats-table th, .time-stats-table td { padding: 10px; text-align: left; border-bottom: 1px solid #e0e6ed; }
        .time-stats-table th { background: #f8f9fa; font-weight: 600; color: #4a5568; font-size: 13px; }
        .time-stats-table td { color: #2c3e50; font-size: 14px; }
        .time-stats-table tr:last-child td { border-bottom: none; }
        .total-time { background: #e3f2fd; padding: 15px; border-radius: 4px; margin-top: 15px; text-align: center; font-size: 16px; font-weight: 600; color: #1565c0; }

        /* æ€ç»´é“¾æ ·å¼ */
        .thinking-chain-section { margin-top: 20px; border-top: 2px dashed #e0e6ed; padding-top: 16px; }
        .thinking-chain-title { font-weight: 600; color: #718096; font-size: 13px; margin-bottom: 12px; }
        .thinking-chain-content { background: #f8f9fa; border-left: 3px solid #cbd5e0; padding: 12px 16px; border-radius: 4px; color: #4a5568; font-size: 13px; line-height: 1.8; white-space: pre-wrap; max-height: 400px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="header">
            <span class="save-status" id="saveStatus">å·²ä¿å­˜</span>
            <h1>AIä¸´åºŠå†³ç­–æ”¯æŒç³»ç»Ÿ - å‘¼å¸é“æ„ŸæŸ“è¯Šç–—</h1>
            <div class="experiment-tag">å®éªŒç¼–å·ï¼šRun 1</div>
        </div>

        <div class="progress-container">
            <div class="progress-title">å®éªŒè¿›åº¦</div>
            <div class="progress-bar-container" id="progressBar"></div>
            <div class="progress-text" id="progressText">æ¡ˆä¾‹ 0/5 å·²å®Œæˆ</div>
        </div>

        <div class="case-navigation" id="caseNavigation"></div>

        <div id="caseContentArea">
            <div class="panel">
                <div class="panel-title">æ‚£è€…ç—…å†ä¿¡æ¯</div>
                <div id="caseInfoDisplay"></div>
            </div>

            <div class="panel">
                <div class="panel-title">è¯Šç–—å†³ç­–</div>
                <div id="initialDecisionSection">
                    <div class="status-indicator status-initial">é˜¶æ®µ1ï¼šåˆæ­¥è¯Šæ–­ï¼ˆæœªçœ‹AIå»ºè®®ï¼‰</div>
                    <div class="input-group">
                        <label>è¯Šæ–­ï¼ˆæŒ‰å¯èƒ½æ€§ä»å¤§åˆ°å°æ’åˆ—ï¼‰<span class="required-mark">*</span></label>
                        <div class="help-text">è¯·åˆ—å‡ºæœ€å¯èƒ½çš„ä¸‰ä¸ªè¯Šæ–­</div>
                        <div class="diagnosis-list">
                            <div class="diagnosis-item"><span class="diagnosis-label">æœ€å¯èƒ½ï¼š</span><input type="text" id="initialDiag1" placeholder="ç¬¬ä¸€è¯Šæ–­"></div>
                            <div class="diagnosis-item"><span class="diagnosis-label">æ¬¡å¯èƒ½ï¼š</span><input type="text" id="initialDiag2" placeholder="ç¬¬äºŒè¯Šæ–­"></div>
                            <div class="diagnosis-item"><span class="diagnosis-label">ç¬¬ä¸‰å¯èƒ½ï¼š</span><input type="text" id="initialDiag3" placeholder="ç¬¬ä¸‰è¯Šæ–­"></div>
                        </div>
                    </div>
                    <div class="input-group">
                        <label>æ˜¯å¦ä½¿ç”¨æŠ—ç”Ÿç´ <span class="required-mark">*</span></label>
                        <div class="radio-group">
                            <label><input type="radio" name="initialAntibiotic" value="no">å¦ï¼Œä¸ä½¿ç”¨æŠ—ç”Ÿç´ </label>
                            <label><input type="radio" name="initialAntibiotic" value="yes">æ˜¯ï¼Œéœ€è¦ä½¿ç”¨æŠ—ç”Ÿç´ </label>
                        </div>
                    </div>
                    <div class="input-group hidden" id="initialAntibioticTypes">
                        <label>è¯·å¡«å†™æŠ—ç”Ÿç´ ç§ç±»<span class="required-mark">*</span></label>
                        <div class="help-text">å¯å¡«å†™å¤šç§ï¼Œç”¨é¡¿å·æˆ–é€—å·åˆ†éš”</div>
                        <input type="text" id="initialAntibioticInput" placeholder="ä¾‹å¦‚ï¼šé˜¿è«è¥¿æ—ã€å¤´å­¢æ°¨è‹„">
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="submitInitialDecision()">æäº¤åˆæ­¥è¯Šæ–­å¹¶æŸ¥çœ‹AIå»ºè®®</button>
                    </div>
                </div>

                <div id="finalDecisionSection" class="hidden">
                    <div class="status-indicator status-final">é˜¶æ®µ2ï¼šæœ€ç»ˆå†³ç­–ï¼ˆå·²æŸ¥çœ‹AIå»ºè®®ï¼‰</div>
                    <div class="phase-title">æ‚¨çš„åˆæ­¥è¯Šæ–­</div>
                    <div class="case-info-display" id="initialDecisionDisplay"></div>
                    <div style="margin-bottom: 20px;">
                        <button class="btn btn-secondary" onclick="restoreModal('diagnosisModal')">æŸ¥çœ‹AIè¯Šæ–­å»ºè®®</button>
                        <button class="btn btn-secondary" onclick="restoreModal('treatmentModal')">æŸ¥çœ‹AIç”¨è¯å»ºè®®</button>
                    </div>
                    <div class="divider"></div>
                    <div class="phase-title">è¯·åšå‡ºæœ€ç»ˆè¯Šç–—å†³ç­–</div>
                    <div class="input-group">
                        <label>è¯Šæ–­ï¼ˆæŒ‰å¯èƒ½æ€§ä»å¤§åˆ°å°æ’åˆ—ï¼‰<span class="required-mark">*</span></label>
                        <div class="help-text">è¯·åˆ—å‡ºæœ€å¯èƒ½çš„ä¸‰ä¸ªè¯Šæ–­</div>
                        <div class="diagnosis-list">
                            <div class="diagnosis-item"><span class="diagnosis-label">æœ€å¯èƒ½ï¼š</span><input type="text" id="finalDiag1" placeholder="ç¬¬ä¸€è¯Šæ–­"></div>
                            <div class="diagnosis-item"><span class="diagnosis-label">æ¬¡å¯èƒ½ï¼š</span><input type="text" id="finalDiag2" placeholder="ç¬¬äºŒè¯Šæ–­"></div>
                            <div class="diagnosis-item"><span class="diagnosis-label">ç¬¬ä¸‰å¯èƒ½ï¼š</span><input type="text" id="finalDiag3" placeholder="ç¬¬ä¸‰è¯Šæ–­"></div>
                        </div>
                    </div>
                    <div class="input-group">
                        <label>æ˜¯å¦ä½¿ç”¨æŠ—ç”Ÿç´ <span class="required-mark">*</span></label>
                        <div class="radio-group">
                            <label><input type="radio" name="finalAntibiotic" value="no">å¦ï¼Œä¸ä½¿ç”¨æŠ—ç”Ÿç´ </label>
                            <label><input type="radio" name="finalAntibiotic" value="yes">æ˜¯ï¼Œéœ€è¦ä½¿ç”¨æŠ—ç”Ÿç´ </label>
                        </div>
                    </div>
                    <div class="input-group hidden" id="finalAntibioticTypes">
                        <label>è¯·å¡«å†™æŠ—ç”Ÿç´ ç§ç±»<span class="required-mark">*</span></label>
                        <div class="help-text">å¯å¡«å†™å¤šç§ï¼Œç”¨é¡¿å·æˆ–é€—å·åˆ†éš”</div>
                        <input type="text" id="finalAntibioticInput" placeholder="ä¾‹å¦‚ï¼šé˜¿è«è¥¿æ—ã€å¤´å­¢æ°¨è‹„">
                    </div>
                    <div class="input-group">
                        <label>å†³ç­–ç¡®å®šæ€§ <span class="required-mark">*</span></label>
                        <div class="radio-group">
                            <label><input type="radio" name="certainty" value="1"> 1 - éå¸¸ä¸ç¡®å®š</label>
                            <label><input type="radio" name="certainty" value="2"> 2 - ä¸ç¡®å®š</label>
                            <label><input type="radio" name="certainty" value="3"> 3 - ä¸€èˆ¬</label>
                            <label><input type="radio" name="certainty" value="4"> 4 - ç¡®å®š</label>
                            <label><input type="radio" name="certainty" value="5"> 5 - éå¸¸ç¡®å®š</label>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-success" onclick="submitFinalDecision()">æäº¤æœ€ç»ˆå†³ç­–</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="completionArea" class="hidden">
            <div class="thank-you-message">
                <h2>âœ“ å®éªŒå·²å®Œæˆ</h2>
                <p>æ„Ÿè°¢æ‚¨çš„å‚ä¸ï¼æ‰€æœ‰5ä¸ªæ¡ˆä¾‹å·²å®Œæˆï¼Œæ•°æ®å·²é€šè¿‡é‚®ä»¶å‘é€ã€‚</p>
                <p style="font-size: 13px; color: #718096; margin-top: 20px;">
                    å‚ä¸è€…IDï¼š<span id="completedParticipantId" style="font-weight: 600; color: #2c3e50;"></span>
                </p>

                <div class="total-time" id="totalTimeDisplay"></div>

                <table class="time-stats-table">
                    <thead>
                        <tr>
                            <th>æ¡ˆä¾‹</th>
                            <th>å®Œæˆæ—¶é—´</th>
                            <th>è€—æ—¶ï¼ˆåˆ†é’Ÿï¼‰</th>
                        </tr>
                    </thead>
                    <tbody id="timeStatsBody"></tbody>
                </table>

                <p style="font-size: 12px; color: #95a5a6; margin-top: 20px;">
                    æ‚¨ä¹Ÿå¯ä»¥ä¸‹è½½æœ¬åœ°å¤‡ä»½
                </p>
                <button class="download-btn" onclick="downloadData()">ä¸‹è½½æ•°æ®å¤‡ä»½</button>
            </div>
        </div>
    </div>

    <div class="minimized-container" id="minimizedContainer"></div>

    <div id="inputToAIModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>å‘AIç³»ç»Ÿè¾“å…¥ç—…å†ä¿¡æ¯</h3>
                <button class="modal-minimize" onclick="minimizeModal('inputToAIModal', 'AIç—…å†è¾“å…¥')" title="æœ€å°åŒ–">âˆ’</button>
            </div>
            <div class="modal-body">
                <div class="instruction-box"><strong>æ“ä½œè¯´æ˜ï¼š</strong>å¯ä»¥æœ€å°åŒ–çª—å£å¤åˆ¶æ‰€æœ‰ç—…å†ä¿¡æ¯å¹¶ç²˜è´´åˆ°ä¸‹æ–¹è¾“å…¥æ¡†ä¸­ï¼Œæˆ–æ‰‹åŠ¨è¾“å…¥</div>
                <div class="input-group">
                    <label>ç—…å†ä¿¡æ¯ <span class="required-mark">*</span></label>
                    <textarea id="aiInputMedicalRecord" placeholder="è¯·å¤åˆ¶ç²˜è´´æˆ–æ‰‹åŠ¨è¾“å…¥å®Œæ•´çš„ç—…å†ä¿¡æ¯" style="min-height: 300px;"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="submitToAIAndShowDiagnosis()">æäº¤å¹¶è·å–AIå»ºè®®</button>
            </div>
        </div>
    </div>

    <div id="diagnosisModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>AIè¯Šæ–­å»ºè®®</h3>
                <button class="modal-minimize" onclick="minimizeModal('diagnosisModal', 'AIè¯Šæ–­å»ºè®®')" title="æœ€å°åŒ–">âˆ’</button>
            </div>
            <div class="modal-body">
                <div class="ai-suggestion-box" id="diagnosisContent"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="showNextModal()">ä¸‹ä¸€æ­¥ï¼šæŸ¥çœ‹ç”¨è¯å»ºè®®</button>
            </div>
        </div>
    </div>

    <div id="treatmentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>AIç”¨è¯å»ºè®®</h3>
                <button class="modal-minimize" onclick="minimizeModal('treatmentModal', 'AIç”¨è¯å»ºè®®')" title="æœ€å°åŒ–">âˆ’</button>
            </div>
            <div class="modal-body">
                <div class="ai-suggestion-box" id="treatmentContent"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-success" onclick="closeAllModalsAndProceed()">ç¡®å®šï¼Œè¿›å…¥æœ€ç»ˆå†³ç­–</button>
            </div>
        </div>
    </div>

    <script>
        // ===== EmailJSé…ç½® =====
        const EMAILJS_CONFIG = {
            serviceId: 'service_sjev6dm',
            templateId: 'template_ldiu064',
            publicKey: 'GbpZKeaCKEnzJeoAo'
        };

        (function() {
            emailjs.init(EMAILJS_CONFIG.publicKey);
        })();

        async function saveData(data, isFinal = false) {
            const statusEl = document.getElementById('saveStatus');

            try {
                localStorage.setItem('expData_' + data.participantId, JSON.stringify(data));

                if (isFinal) {
                    statusEl.textContent = 'å‘é€ä¸­...';
                    statusEl.className = 'save-status saving';

                    const emailData = {
                        participant_id: data.participantId,
                        start_time: data.startTime,
                        end_time: data.endTime || new Date().toISOString(),
                        run_config: data.runConfig,
                        full_data: JSON.stringify(data, null, 2)
                    };

                    const response = await emailjs.send(
                        EMAILJS_CONFIG.serviceId,
                        EMAILJS_CONFIG.templateId,
                        emailData
                    );

                    if (response.status === 200) {
                        statusEl.textContent = 'âœ“ æ•°æ®å·²å‘é€';
                        statusEl.className = 'save-status';
                        console.log('âœ“ æ•°æ®å·²æˆåŠŸé€šè¿‡EmailJSå‘é€');
                    } else {
                        throw new Error('EmailJSè¿”å›é”™è¯¯');
                    }
                } else {
                    statusEl.textContent = 'å·²ä¿å­˜';
                    statusEl.className = 'save-status';
                }

                return true;

            } catch (error) {
                console.error('å‘é€å¤±è´¥:', error);
                statusEl.textContent = 'å·²ä¿å­˜åˆ°æµè§ˆå™¨';
                statusEl.className = 'save-status';
                console.log('âš ï¸ æ•°æ®å·²ä¿å­˜åˆ°æµè§ˆå™¨æœ¬åœ°ï¼Œä½†æœªèƒ½å‘é€é‚®ä»¶');
                return true;
            }
        }

        function calculateDuration(startTime, endTime) {
            if (!startTime || !endTime) return 0;
            const start = new Date(startTime);
            const end = new Date(endTime);
            return Math.round((end - start) / 1000 / 60 * 10) / 10;
        }

        function formatDateTime(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            return date.toLocaleString('zh-CN', {
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        // ===== æ¡ˆä¾‹æ•°æ®ï¼ˆæ·»åŠ æ€ç»´é“¾å­—æ®µï¼‰=====
        const cases = [
            {
                id: 1, name: 'æ¡ˆä¾‹1', patientId: 'RTI-2025-001', gender: 'ç”·', age: '45å²', visitDate: '2025-10-16',
                chiefComplaint: 'å’³å—½ã€å’³ç—°3å¤©ï¼Œä¼´å‘çƒ­',
                presentIllness: 'æ‚£è€…3å¤©å‰æ— æ˜æ˜¾è¯±å› å‡ºç°å’³å—½ï¼Œåˆä¸ºå¹²å’³ï¼Œåè½¬ä¸ºå’³ç—°ï¼Œç—°æ¶²ä¸ºç™½è‰²ç²˜ç—°ï¼Œä¸æ˜“å’³å‡ºã€‚ä¼´æœ‰å‘çƒ­ï¼Œä½“æ¸©æœ€é«˜38.5â„ƒï¼Œæ— ç•å¯’å¯’æˆ˜ã€‚æ— èƒ¸ç—›ã€æ°”ä¿ƒã€å’¯è¡€ã€‚æ— é¼»å¡ã€æµæ¶•ã€å’½ç—›ã€‚ç—…ç¨‹ä¸­ç²¾ç¥ã€é£Ÿæ¬²æ¬ ä½³ï¼Œç¡çœ å¯ï¼Œå¤§å°ä¾¿æ­£å¸¸ã€‚',
                personalHistory: 'æ—¢å¾€ä½“å¥ï¼Œæ— æ…¢æ€§ç—…å²ã€‚æ— å¸çƒŸå²ï¼Œå¶å°”é¥®é…’ã€‚èŒä¸šï¼šåŠå…¬å®¤èŒå‘˜ã€‚',
                allergyHistory: 'å¦è®¤è¯ç‰©è¿‡æ•å²',
                physicalExam: 'ä½“æ¸©38.2â„ƒï¼Œè„‰æ92æ¬¡/åˆ†ï¼Œå‘¼å¸20æ¬¡/åˆ†ï¼Œè¡€å‹120/80mmHgã€‚ç¥å¿—æ¸…æ¥šï¼Œç²¾ç¥æ¬ ä½³ã€‚å’½éƒ¨è½»åº¦å……è¡€ï¼Œæ‰æ¡ƒä½“æ— è‚¿å¤§ã€‚åŒè‚ºå‘¼å¸éŸ³ç²—ï¼Œå¯é—»åŠæ•£åœ¨å¹²å•°éŸ³ï¼Œæœªé—»åŠæ¹¿å•°éŸ³ã€‚å¿ƒå¾‹é½ï¼Œå¿ƒéŸ³æœ‰åŠ›ï¼Œå„ç“£è†œå¬è¯ŠåŒºæœªé—»åŠæ‚éŸ³ã€‚è…¹è½¯ï¼Œæ— å‹ç—›ï¼Œè‚è„¾æœªè§¦åŠã€‚',
                labTests: 'è¡€å¸¸è§„ï¼šWBC 9.2Ã—10^9/Lï¼ŒN 65%ï¼ŒL 28%ï¼›CRP 15mg/Lï¼›èƒ¸éƒ¨Xçº¿ï¼šåŒè‚ºçº¹ç†å¢ç²—ï¼Œæœªè§æ˜æ˜¾å®å˜å½±ã€‚',
                aiRecommendation: {
                    diagnosis: ['æ€¥æ€§æ”¯æ°”ç®¡ç‚', 'ä¸Šå‘¼å¸é“æ„ŸæŸ“', 'ç¤¾åŒºè·å¾—æ€§è‚ºç‚'],
                    useAntibiotic: false,
                    antibioticType: null,
                    thinkingChain: `åˆ†ææ‚£è€…ç—‡çŠ¶ï¼š
1. ä¸»è¦ç—‡çŠ¶ï¼šå’³å—½ï¼ˆå¹²å’³è½¬ä¸ºå’³ç—°ï¼‰ã€å‘çƒ­ï¼ˆæœ€é«˜38.5â„ƒï¼‰
2. ç—…ç¨‹ï¼š3å¤©ï¼Œæ€¥æ€§èµ·ç—…
3. ä½“å¾ï¼šå’½éƒ¨è½»åº¦å……è¡€ã€åŒè‚ºæ•£åœ¨å¹²å•°éŸ³ã€æ— æ¹¿å•°éŸ³

å®éªŒå®¤æ£€æŸ¥åˆ†æï¼š
- WBC 9.2Ã—10^9/Lï¼ˆæ­£å¸¸èŒƒå›´ï¼Œè½»åº¦åé«˜ï¼‰
- ä¸­æ€§ç²’ç»†èƒ65%ï¼ˆè½»åº¦å‡é«˜ï¼‰
- CRP 15mg/Lï¼ˆè½»åº¦å‡é«˜ï¼‰
- èƒ¸éƒ¨Xçº¿ï¼šçº¹ç†å¢ç²—ï¼Œæœªè§å®å˜å½±

é‰´åˆ«è¯Šæ–­æ€è·¯ï¼š
â‘  æ€¥æ€§æ”¯æ°”ç®¡ç‚ï¼šç—‡çŠ¶ã€ä½“å¾ã€å®éªŒå®¤æ£€æŸ¥å‡ç¬¦åˆï¼Œæœ€å¯èƒ½
â‘¡ ä¸Šå‘¼å¸é“æ„ŸæŸ“ï¼šå’½éƒ¨å……è¡€æ”¯æŒï¼Œä½†å’³å—½å’³ç—°ç—‡çŠ¶æ›´çªå‡º
â‘¢ ç¤¾åŒºè·å¾—æ€§è‚ºç‚ï¼šéœ€æ’é™¤ï¼Œå› èƒ¸éƒ¨Xçº¿æœªè§å®å˜å½±ï¼Œå¯èƒ½æ€§è¾ƒå°

ç—…åŸå­¦åˆ¤æ–­ï¼š
- ç‚ç—‡æŒ‡æ ‡è½»åº¦å‡é«˜
- æ— å…¸å‹ç»†èŒæ„ŸæŸ“è¯æ®
- è€ƒè™‘ç—…æ¯’æ€§æ„ŸæŸ“å¯èƒ½æ€§å¤§

æ²»ç–—å»ºè®®ï¼š
åŸºäºç—…æ¯’æ€§æ„ŸæŸ“çš„åˆ¤æ–­ï¼Œå»ºè®®å¯¹ç—‡æ²»ç–—ï¼Œæš‚ä¸ä½¿ç”¨æŠ—ç”Ÿç´ ã€‚`
                }
            },
            {
                id: 2, name: 'æ¡ˆä¾‹2', patientId: 'RTI-2025-002', gender: 'å¥³', age: '32å²', visitDate: '2025-10-17',
                chiefComplaint: 'é¼»å¡ã€æµæ¶•ã€æ‰“å–·åš2å¤©',
                presentIllness: 'æ‚£è€…2å¤©å‰å—å‡‰åå‡ºç°é¼»å¡ã€æµæ¸…æ°´æ ·é¼»æ¶•ã€æ‰“å–·åšï¼Œä¼´è½»åº¦å’½éƒ¨ä¸é€‚ã€‚æ— å‘çƒ­ã€å’³å—½ã€å’³ç—°ã€‚æ— å¤´ç—›ã€è‚Œè‚‰é…¸ç—›ã€‚ç²¾ç¥é£Ÿæ¬²å¯ï¼Œç¡çœ ç¨å·®ï¼ˆå› é¼»å¡ï¼‰ã€‚',
                personalHistory: 'æ—¢å¾€ä½“å¥ã€‚æ— å¸çƒŸé¥®é…’å²ã€‚èŒä¸šï¼šæ•™å¸ˆã€‚',
                allergyHistory: 'é’éœ‰ç´ è¿‡æ•',
                physicalExam: 'ä½“æ¸©36.8â„ƒï¼Œè„‰æ78æ¬¡/åˆ†ï¼Œå‘¼å¸18æ¬¡/åˆ†ï¼Œè¡€å‹110/70mmHgã€‚ç¥å¿—æ¸…æ¥šï¼Œç²¾ç¥å¯ã€‚é¼»ç²˜è†œå……è¡€æ°´è‚¿ï¼Œæœ‰æ¸…æ¶•ã€‚å’½éƒ¨è½»åº¦å……è¡€ï¼Œæ‰æ¡ƒä½“æ— è‚¿å¤§ã€‚åŒè‚ºå‘¼å¸éŸ³æ¸…ï¼Œæœªé—»åŠå¹²æ¹¿å•°éŸ³ã€‚å¿ƒå¾‹é½ï¼Œæœªé—»åŠæ‚éŸ³ã€‚',
                labTests: 'æœªåšç‰¹æ®Šæ£€æŸ¥ã€‚',
                aiRecommendation: {
                    diagnosis: ['æ€¥æ€§ä¸Šå‘¼å¸é“æ„ŸæŸ“ï¼ˆæ™®é€šæ„Ÿå†’ï¼‰', 'è¿‡æ•æ€§é¼»ç‚', 'æ€¥æ€§é¼»ç‚'],
                    useAntibiotic: false,
                    antibioticType: null,
                    thinkingChain: `ç—‡çŠ¶åˆ†æï¼š
- é¼»å¡ã€æµæ¸…æ¶•ã€æ‰“å–·åšï¼ˆå…¸å‹ä¸Šå‘¼å¸é“ç—‡çŠ¶ï¼‰
- æ— å‘çƒ­ï¼ˆæ’é™¤æµæ„Ÿå¯èƒ½ï¼‰
- è½»åº¦å’½éƒ¨ä¸é€‚
- ç—…ç¨‹2å¤©ï¼Œå—å‡‰åèµ·ç—…

ä½“æ ¼æ£€æŸ¥è¦ç‚¹ï¼š
- ä½“æ¸©æ­£å¸¸ï¼ˆ36.8â„ƒï¼‰
- é¼»ç²˜è†œå……è¡€æ°´è‚¿
- å’½éƒ¨è½»åº¦å……è¡€
- è‚ºéƒ¨æ— å¼‚å¸¸ä½“å¾

è¯Šæ–­è€ƒè™‘ï¼š
â‘  æ€¥æ€§ä¸Šå‘¼å¸é“æ„ŸæŸ“ï¼ˆæ™®é€šæ„Ÿå†’ï¼‰- æœ€ç¬¦åˆï¼Œå…¸å‹ç—…æ¯’æ€§æ„ŸæŸ“
â‘¡ è¿‡æ•æ€§é¼»ç‚ - éœ€é‰´åˆ«ï¼Œä½†æœ‰å—å‡‰è¯±å› ï¼Œæ€¥æ€§èµ·ç—…æ›´ç¬¦åˆæ„ŸæŸ“
â‘¢ æ€¥æ€§é¼»ç‚ - ç—‡çŠ¶ç›¸ä¼¼ï¼Œå¯èƒ½æ€§è¾ƒå°

æ²»ç–—åŸåˆ™ï¼š
- ç—…æ¯’æ€§æ„ŸæŸ“ï¼Œè‡ªé™æ€§ç–¾ç—…
- å»ºè®®å¯¹ç—‡æ²»ç–—ï¼ˆä¼‘æ¯ã€å¤šé¥®æ°´ã€å¿…è¦æ—¶ä½¿ç”¨æ„Ÿå†’è¯ï¼‰
- ä¸æ¨èä½¿ç”¨æŠ—ç”Ÿç´ 
- æ³¨æ„ï¼šæ‚£è€…æœ‰é’éœ‰ç´ è¿‡æ•å²ï¼Œéœ€è®°å½•`
                }
            },
            {
                id: 3, name: 'æ¡ˆä¾‹3', patientId: 'RTI-2025-003', gender: 'ç”·', age: '28å²', visitDate: '2025-10-18',
                chiefComplaint: 'å’½ç—›3å¤©ï¼Œä¼´å‘çƒ­',
                presentIllness: 'æ‚£è€…3å¤©å‰å‡ºç°å’½ç—›ï¼Œåå’½æ—¶åŠ é‡ï¼Œä¼´å‘çƒ­ï¼Œä½“æ¸©æœ€é«˜39.0â„ƒã€‚æ— å’³å—½ã€å’³ç—°ã€‚æ— é¼»å¡ã€æµæ¶•ã€‚ç—…ç¨‹ä¸­ä¹åŠ›æ˜æ˜¾ï¼Œé£Ÿæ¬²å·®ã€‚',
                personalHistory: 'æ—¢å¾€ä½“å¥ã€‚å¸çƒŸå²5å¹´ï¼Œæ¯å¤©çº¦10æ”¯ã€‚å¶å°”é¥®é…’ã€‚',
                allergyHistory: 'å¦è®¤è¯ç‰©è¿‡æ•å²',
                physicalExam: 'ä½“æ¸©38.8â„ƒï¼Œè„‰æ96æ¬¡/åˆ†ï¼Œå‘¼å¸18æ¬¡/åˆ†ï¼Œè¡€å‹125/85mmHgã€‚ç¥å¿—æ¸…æ¥šï¼Œç²¾ç¥å·®ã€‚å’½éƒ¨æ˜æ˜¾å……è¡€ï¼Œæ‰æ¡ƒä½“â…¡åº¦è‚¿å¤§ï¼Œè¡¨é¢å¯è§è„“æ€§åˆ†æ³Œç‰©ã€‚é¢ˆéƒ¨å¯è§¦åŠè‚¿å¤§æ·‹å·´ç»“ï¼Œæœ‰å‹ç—›ã€‚åŒè‚ºå‘¼å¸éŸ³æ¸…ï¼Œæœªé—»åŠå¹²æ¹¿å•°éŸ³ã€‚',
                labTests: 'è¡€å¸¸è§„ï¼šWBC 13.5Ã—10^9/Lï¼ŒN 82%ï¼ŒL 15%ï¼›CRP 45mg/Lã€‚å’½æ‹­å­å¿«é€Ÿé“¾çƒèŒæŠ—åŸæ£€æµ‹ï¼šé˜³æ€§ã€‚',
                aiRecommendation: {
                    diagnosis: ['æ€¥æ€§åŒ–è„“æ€§æ‰æ¡ƒä½“ç‚', 'æ€¥æ€§å’½ç‚', 'Aç»„é“¾çƒèŒå’½ç‚'],
                    useAntibiotic: true,
                    antibioticType: 'é˜¿è«è¥¿æ—æˆ–å¤´å­¢æ°¨è‹„',
                    thinkingChain: `ä¸´åºŠè¡¨ç°è¯„ä¼°ï¼š
- ä¸»è¦ç—‡çŠ¶ï¼šå’½ç—›æ˜æ˜¾ã€åå’½ç—›ã€é«˜çƒ­ï¼ˆ39.0â„ƒï¼‰
- ä¼´éšç—‡çŠ¶ï¼šä¹åŠ›ã€é£Ÿæ¬²å·®
- æ— ä¸Šå‘¼å¸é“å¡ä»–ç—‡çŠ¶ï¼ˆé¼»å¡ã€æµæ¶•ï¼‰

ä½“æ ¼æ£€æŸ¥å…³é”®å‘ç°ï¼š
- é«˜çƒ­ï¼ˆ38.8â„ƒï¼‰
- å’½éƒ¨æ˜æ˜¾å……è¡€
- æ‰æ¡ƒä½“â…¡åº¦è‚¿å¤§ + è„“æ€§åˆ†æ³Œç‰©ï¼ˆå…³é”®ä½“å¾ï¼‰
- é¢ˆéƒ¨æ·‹å·´ç»“è‚¿å¤§å‹ç—›

å®éªŒå®¤æ£€æŸ¥åˆ†æï¼š
- WBC 13.5Ã—10^9/Lï¼ˆæ˜æ˜¾å‡é«˜ï¼‰
- ä¸­æ€§ç²’ç»†èƒ82%ï¼ˆæ˜¾è‘—å‡é«˜ï¼‰
- CRP 45mg/Lï¼ˆæ˜¾è‘—å‡é«˜ï¼‰
- **å’½æ‹­å­é“¾çƒèŒæŠ—åŸæ£€æµ‹é˜³æ€§**ï¼ˆç¡®è¯Šè¯æ®ï¼‰

è¯Šæ–­ä¾æ®ï¼š
1. å…¸å‹åŒ–è„“æ€§æ‰æ¡ƒä½“ç‚è¡¨ç°
2. å®éªŒå®¤æç¤ºç»†èŒæ„ŸæŸ“
3. Aç»„é“¾çƒèŒæ£€æµ‹é˜³æ€§ï¼ˆé‡‘æ ‡å‡†ï¼‰

æŠ—ç”Ÿç´ ä½¿ç”¨æŒ‡å¾æ˜ç¡®ï¼š
âœ“ ç¬¦åˆCentoræ ‡å‡†ï¼ˆå‘çƒ­ã€æ‰æ¡ƒä½“æ¸—å‡ºã€é¢ˆéƒ¨æ·‹å·´ç»“è‚¿å¤§ã€æ— å’³å—½ï¼‰
âœ“ é“¾çƒèŒæ£€æµ‹é˜³æ€§
âœ“ éœ€è¦æŠ—ç”Ÿç´ æ²»ç–—é¢„é˜²é£æ¹¿çƒ­ç­‰å¹¶å‘ç—‡

æ¨èæŠ—ç”Ÿç´ æ–¹æ¡ˆï¼š
é¦–é€‰ï¼šé˜¿è«è¥¿æ— æˆ– å¤´å­¢æ°¨è‹„
ç–—ç¨‹ï¼š10å¤©
æ³¨æ„ï¼šæ‚£è€…æ— é’éœ‰ç´ è¿‡æ•å²`
                }
            },
            {
                id: 4, name: 'æ¡ˆä¾‹4', patientId: 'RTI-2025-004', gender: 'å¥³', age: '55å²', visitDate: '2025-10-19',
                chiefComplaint: 'å‘çƒ­ã€å…¨èº«é…¸ç—›2å¤©',
                presentIllness: 'æ‚£è€…2å¤©å‰çªç„¶èµ·ç—…ï¼Œå‡ºç°å‘çƒ­ï¼Œä½“æ¸©æœ€é«˜39.5â„ƒï¼Œä¼´ç•å¯’ã€å…¨èº«è‚Œè‚‰é…¸ç—›ã€å¤´ç—›ã€ä¹åŠ›æ˜æ˜¾ã€‚æœ‰è½»åº¦å¹²å’³ï¼Œæ— å’³ç—°ã€‚æ— é¼»å¡ã€æµæ¶•ã€å’½ç—›ã€‚é£Ÿæ¬²æ˜æ˜¾å‡é€€ã€‚',
                personalHistory: 'æœ‰é«˜è¡€å‹ç—…å²5å¹´ï¼Œè§„å¾‹æœè¯æ§åˆ¶è‰¯å¥½ã€‚æ— å¸çƒŸé¥®é…’å²ã€‚èŒä¸šï¼šä¼šè®¡ã€‚',
                allergyHistory: 'å¦è®¤è¯ç‰©è¿‡æ•å²',
                physicalExam: 'ä½“æ¸©39.2â„ƒï¼Œè„‰æ102æ¬¡/åˆ†ï¼Œå‘¼å¸22æ¬¡/åˆ†ï¼Œè¡€å‹135/85mmHgã€‚ç¥å¿—æ¸…æ¥šï¼Œç²¾ç¥èé¡ã€‚å’½éƒ¨è½»åº¦å……è¡€ã€‚åŒè‚ºå‘¼å¸éŸ³ç²—ï¼Œæœªé—»åŠå¹²æ¹¿å•°éŸ³ã€‚å¿ƒå¾‹é½ã€‚è…¹è½¯ã€‚',
                labTests: 'è¡€å¸¸è§„ï¼šWBC 4.8Ã—10^9/Lï¼ŒN 55%ï¼ŒL 38%ï¼›CRP 8mg/Lã€‚æµæ„Ÿç—…æ¯’æŠ—åŸå¿«é€Ÿæ£€æµ‹ï¼šç”²å‹æµæ„Ÿé˜³æ€§ã€‚',
                aiRecommendation: {
                    diagnosis: ['æµè¡Œæ€§æ„Ÿå†’ï¼ˆç”²å‹ï¼‰', 'ä¸Šå‘¼å¸é“æ„ŸæŸ“', 'æ€¥æ€§æ”¯æ°”ç®¡ç‚'],
                    useAntibiotic: false,
                    antibioticType: null,
                    thinkingChain: `ç—‡çŠ¶ç‰¹ç‚¹åˆ†æï¼š
- çªç„¶èµ·ç—…ï¼ˆå…¸å‹æµæ„Ÿç‰¹å¾ï¼‰
- é«˜çƒ­ï¼ˆ39.5â„ƒï¼‰+ ç•å¯’
- å…¨èº«ç—‡çŠ¶çªå‡ºï¼šè‚Œè‚‰é…¸ç—›ã€å¤´ç—›ã€ä¹åŠ›
- å‘¼å¸é“ç—‡çŠ¶ç›¸å¯¹è¾ƒè½»ï¼šä»…è½»åº¦å¹²å’³
- æ— æ˜æ˜¾ä¸Šå‘¼å¸é“å¡ä»–ç—‡çŠ¶

æµæ„Ÿ vs æ™®é€šæ„Ÿå†’çš„é‰´åˆ«ï¼š
æµæ„Ÿç‰¹å¾ï¼ˆæœ¬ä¾‹ç¬¦åˆï¼‰ï¼š
âœ“ çªç„¶èµ·ç—…
âœ“ é«˜çƒ­
âœ“ å…¨èº«ç—‡çŠ¶é‡äºå±€éƒ¨ç—‡çŠ¶
âœ“ è‚Œè‚‰é…¸ç—›ã€ä¹åŠ›æ˜æ˜¾

æ™®é€šæ„Ÿå†’ç‰¹å¾ï¼š
Ã— é€æ¸èµ·ç—…
Ã— å‘çƒ­ä¸æ˜æ˜¾æˆ–ä½çƒ­
Ã— å±€éƒ¨ç—‡çŠ¶ä¸ºä¸»ï¼ˆé¼»å¡ã€æµæ¶•ï¼‰

å®éªŒå®¤æ£€æŸ¥è§£è¯»ï¼š
- WBC 4.8Ã—10^9/Lï¼ˆæ­£å¸¸åä½ï¼Œæç¤ºç—…æ¯’æ„ŸæŸ“ï¼‰
- æ·‹å·´ç»†èƒç›¸å¯¹æ¯”ä¾‹38%ï¼ˆç—…æ¯’æ„ŸæŸ“ç‰¹å¾ï¼‰
- CRPä»…8mg/Lï¼ˆè½»åº¦å‡é«˜ï¼Œæ— æ˜¾è‘—ç»†èŒæ„ŸæŸ“ï¼‰
- **ç”²å‹æµæ„ŸæŠ—åŸé˜³æ€§**ï¼ˆç¡®è¯Šä¾æ®ï¼‰

è¯Šæ–­ç»“è®ºï¼š
ç”²å‹æµè¡Œæ€§æ„Ÿå†’ï¼ˆç¡®è¯Šï¼‰

æ²»ç–—å»ºè®®ï¼š
1. æŠ—ç—…æ¯’æ²»ç–—ï¼šå¥¥å¸ä»–éŸ¦ï¼ˆå‘ç—…48å°æ—¶å†…ä½¿ç”¨æ•ˆæœæœ€ä½³ï¼‰
2. å¯¹ç—‡æ²»ç–—ï¼šé€€çƒ­ã€æ­¢ç—›
3. æ”¯æŒæ²»ç–—ï¼šä¼‘æ¯ã€è¡¥æ¶²
4. **ä¸æ¨èä½¿ç”¨æŠ—ç”Ÿç´ **ï¼ˆç—…æ¯’æ„ŸæŸ“ï¼Œé™¤éç»§å‘ç»†èŒæ„ŸæŸ“ï¼‰

æ³¨æ„äº‹é¡¹ï¼š
- æ‚£è€…æœ‰é«˜è¡€å‹ç—…å²ï¼Œæ³¨æ„ç›‘æµ‹è¡€å‹
- è§‚å¯Ÿæ˜¯å¦å‡ºç°ç»†èŒç»§å‘æ„ŸæŸ“å¾è±¡`
                }
            },
            {
                id: 5, name: 'æ¡ˆä¾‹5', patientId: 'RTI-2025-005', gender: 'ç”·', age: '68å²', visitDate: '2025-10-20',
                chiefComplaint: 'å’³å—½ã€å’³ç—°ã€æ°”ä¿ƒ4å¤©ï¼Œä¼´å‘çƒ­',
                presentIllness: 'æ‚£è€…4å¤©å‰å—å‡‰åå‡ºç°å’³å—½ã€å’³é»„è„“ç—°ï¼Œä¸æ˜“å’³å‡ºï¼Œä¼´å‘çƒ­ï¼Œä½“æ¸©æœ€é«˜38.8â„ƒã€‚2å¤©å‰å‡ºç°æ´»åŠ¨åæ°”ä¿ƒã€‚ä¼´èƒ¸ç—›ï¼ˆæ·±å¸æ°”æ—¶åŠ é‡ï¼‰ã€‚æ— å’¯è¡€ã€‚ç—…ç¨‹ä¸­ä¹åŠ›æ˜æ˜¾ï¼Œé£Ÿæ¬²å·®ã€‚',
                personalHistory: 'æœ‰æ…¢æ€§é˜»å¡æ€§è‚ºç–¾ç—…ï¼ˆCOPDï¼‰ç—…å²10å¹´ï¼Œå¸çƒŸå²30å¹´ï¼ˆå·²æˆ’çƒŸ5å¹´ï¼‰ã€‚',
                allergyHistory: 'å¦è®¤è¯ç‰©è¿‡æ•å²',
                physicalExam: 'ä½“æ¸©38.5â„ƒï¼Œè„‰æ98æ¬¡/åˆ†ï¼Œå‘¼å¸24æ¬¡/åˆ†ï¼Œè¡€å‹130/80mmHgï¼Œè¡€æ°§é¥±å’Œåº¦92%ï¼ˆå¸ç©ºæ°”ï¼‰ã€‚ç¥å¿—æ¸…æ¥šï¼Œç²¾ç¥å·®ã€‚å£å”‡è½»åº¦å‘ç»€ã€‚å³ä¸‹è‚ºå©è¯ŠæµŠéŸ³ï¼Œå‘¼å¸éŸ³å‡å¼±ï¼Œå¯é—»åŠæ¹¿å•°éŸ³ã€‚',
                labTests: 'è¡€å¸¸è§„ï¼šWBC 15.2Ã—10^9/Lï¼ŒN 85%ï¼ŒL 10%ï¼›CRP 68mg/Lï¼›é™é’™ç´ åŸ0.8ng/mLã€‚èƒ¸éƒ¨Xçº¿ï¼šå³ä¸‹è‚ºå¯è§ç‰‡çŠ¶é«˜å¯†åº¦å½±ï¼Œè¾¹ç•Œæ¨¡ç³Šã€‚',
                aiRecommendation: {
                    diagnosis: ['ç¤¾åŒºè·å¾—æ€§è‚ºç‚', 'æ…¢æ€§é˜»å¡æ€§è‚ºç–¾ç—…æ€¥æ€§åŠ é‡', 'æ€¥æ€§æ”¯æ°”ç®¡ç‚'],
                    useAntibiotic: true,
                    antibioticType: 'å·¦æ°§æ°Ÿæ²™æ˜Ÿæˆ–å¤´å­¢æ›²æ¾',
                    thinkingChain: `æ‚£è€…åŸºæœ¬æƒ…å†µï¼š
- å¹´é¾„ï¼š68å²ï¼ˆè€å¹´æ‚£è€…ï¼‰
- åŸºç¡€ç–¾ç—…ï¼šCOPD 10å¹´
- å¸çƒŸå²ï¼š30å¹´ï¼ˆå·²æˆ’çƒŸ5å¹´ï¼‰
- é«˜å±äººç¾¤

ç—‡çŠ¶åˆ†æï¼š
æ€¥æ€§ç—‡çŠ¶ï¼ˆ4å¤©ï¼‰ï¼š
- å’³å—½ + é»„è„“ç—°ï¼ˆç»†èŒæ„ŸæŸ“å¾è±¡ï¼‰
- å‘çƒ­ï¼ˆ38.8â„ƒï¼‰
- æ°”ä¿ƒï¼ˆ2å¤©å‰å‡ºç°ï¼Œæç¤ºç—…æƒ…è¿›å±•ï¼‰
- èƒ¸ç—›ï¼ˆèƒ¸è†œå—ç´¯ï¼‰

ä½“æ ¼æ£€æŸ¥å…³é”®å‘ç°ï¼š
- å‘¼å¸é¢‘ç‡å¢å¿«ï¼ˆ24æ¬¡/åˆ†ï¼‰
- è¡€æ°§é¥±å’Œåº¦é™ä½ï¼ˆ92%ï¼‰- æç¤ºå‘¼å¸åŠŸèƒ½å—æŸ
- å£å”‡è½»åº¦å‘ç»€
- å³ä¸‹è‚ºä½“å¾ï¼š
  * å©è¯ŠæµŠéŸ³
  * å‘¼å¸éŸ³å‡å¼±
  * æ¹¿å•°éŸ³ï¼ˆ+ï¼‰
â†’ æç¤ºè‚ºéƒ¨å®å˜

å®éªŒå®¤æ£€æŸ¥è¯„ä¼°ï¼š
å¼ºçƒˆæç¤ºç»†èŒæ„ŸæŸ“ï¼š
- WBC 15.2Ã—10^9/Lï¼ˆæ˜¾è‘—å‡é«˜ï¼‰
- ä¸­æ€§ç²’ç»†èƒ85%ï¼ˆæ˜¾è‘—å‡é«˜ï¼‰
- CRP 68mg/Lï¼ˆæ˜¾è‘—å‡é«˜ï¼‰
- é™é’™ç´ åŸ0.8ng/mLï¼ˆ>0.5æç¤ºç»†èŒæ„ŸæŸ“ï¼‰

å½±åƒå­¦ç¡®è¯Šä¾æ®ï¼š
èƒ¸éƒ¨Xçº¿ï¼šå³ä¸‹è‚ºç‰‡çŠ¶é«˜å¯†åº¦å½±
â†’ è‚ºéƒ¨å®å˜ï¼Œç¡®è¯Šè‚ºç‚

è¯Šæ–­é€»è¾‘ï¼š
1. ç¤¾åŒºè·å¾—æ€§è‚ºç‚ï¼ˆCAPï¼‰- é¦–è¦è¯Šæ–­
   - å…¸å‹ä¸´åºŠè¡¨ç°
   - å½±åƒå­¦ç¡®è¯Š
   - ç»†èŒæ„ŸæŸ“æ˜ç¡®

2. COPDæ€¥æ€§åŠ é‡ - å¹¶å­˜è¯Šæ–­
   - æœ‰COPDåŸºç¡€
   - å¯èƒ½åˆå¹¶æˆ–ç»§å‘

3. æ€¥æ€§æ”¯æ°”ç®¡ç‚ - å¯èƒ½æ€§è¾ƒå°
   - ç—‡çŠ¶å’Œä½“å¾æ›´ç¬¦åˆè‚ºç‚

æŠ—ç”Ÿç´ ä½¿ç”¨å¿…è¦æ€§è¯„ä¼°ï¼š
âœ“ æ˜ç¡®ç»†èŒæ€§è‚ºç‚
âœ“ è€å¹´æ‚£è€…
âœ“ æœ‰åŸºç¡€è‚ºç—…
âœ“ ç—…æƒ…è¾ƒé‡ï¼ˆä½æ°§è¡€ç—‡ï¼‰
â†’ **æ˜ç¡®æŠ—ç”Ÿç´ æŒ‡å¾**

æŠ—ç”Ÿç´ é€‰æ‹©è€ƒè™‘ï¼š
- ç¤¾åŒºè·å¾—æ€§è‚ºç‚å¸¸è§ç—…åŸä½“ï¼š
  è‚ºç‚é“¾çƒèŒã€æµæ„Ÿå—œè¡€æ†èŒã€éå…¸å‹ç—…åŸä½“

- æ‚£è€…æœ‰COPDï¼Œå¯èƒ½é©å…°é˜´æ€§æ†èŒæ„ŸæŸ“

æ¨èæ–¹æ¡ˆï¼š
é¦–é€‰ï¼šå·¦æ°§æ°Ÿæ²™æ˜Ÿï¼ˆè¦†ç›–å…¸å‹+éå…¸å‹ç—…åŸä½“ï¼‰
æˆ–ï¼šå¤´å­¢æ›²æ¾ï¼ˆç¬¬ä¸‰ä»£å¤´å­¢ï¼‰

æ²»ç–—ç­–ç•¥ï¼š
1. æŠ—ç”Ÿç´ æ²»ç–—ï¼ˆå¿…é¡»ï¼‰
2. æ°§ç–—ï¼ˆSpO2 92%ï¼‰
3. ç¥›ç—°æ²»ç–—
4. COPDåŸºç¡€æ²»ç–—
5. å¯†åˆ‡ç›‘æµ‹ç—…æƒ…å˜åŒ–`
                }
            }
        ];

        const expData = {
            participantId: 'P' + Date.now().toString().slice(-6),
            startTime: new Date().toISOString(),
            runConfig: 'Run 1',
            cases: [],
            endTime: null
        };

        let curCase = 0, completedCases = 0;

        function init() {
            const pb = document.getElementById('progressBar');
            for (let i = 0; i < 5; i++) {
                const item = document.createElement('div');
                item.className = 'progress-bar-item';
                item.id = `progress-${i}`;
                pb.appendChild(item);
            }

            const nav = document.getElementById('caseNavigation');
            cases.forEach((c, i) => {
                const btn = document.createElement('button');
                btn.className = 'case-nav-btn';
                btn.id = `nav-btn-${i}`;
                btn.textContent = c.name;
                btn.onclick = () => switchCase(i);
                if (i !== 0) btn.disabled = true;
                nav.appendChild(btn);
            });

            updateProgress();
            loadCase(0);
            recordCaseStartTime(0);
            saveData(expData);
        }

        function recordCaseStartTime(caseIndex) {
            const c = cases[caseIndex];
            let cd = expData.cases.find(x => x.caseId === c.id);
            if (!cd) {
                cd = {
                    caseId: c.id,
                    caseName: c.name,
                    patientId: c.patientId,
                    timestamps: {}
                };
                expData.cases.push(cd);
            }

            if (!cd.timestamps.caseStart) {
                cd.timestamps.caseStart = new Date().toISOString();
                console.log(`${c.name} å¼€å§‹æ—¶é—´: ${formatDateTime(cd.timestamps.caseStart)}`);
                saveData(expData);
            }
        }

        function updateProgress() {
            document.getElementById('progressText').textContent = `æ¡ˆä¾‹ ${completedCases}/5 å·²å®Œæˆ`;
            for (let i = 0; i < 5; i++) {
                const item = document.getElementById(`progress-${i}`);
                item.className = 'progress-bar-item';
                if (i < completedCases) item.classList.add('completed');
                else if (i === curCase) item.classList.add('current');
            }

            cases.forEach((c, i) => {
                const btn = document.getElementById(`nav-btn-${i}`);
                btn.className = 'case-nav-btn';
                const cd = expData.cases.find(x => x.caseId === c.id);
                if (cd && cd.finalDecision) {
                    btn.classList.add('completed');
                    btn.disabled = false;
                } else if (i === curCase) {
                    btn.classList.add('current');
                    btn.disabled = false;
                } else if (i < curCase || (cd && cd.initialDecision)) {
                    btn.disabled = false;
                }
            });
        }

        function switchCase(i) {
            if (i < 0 || i >= cases.length) return;

            document.getElementById('inputToAIModal').style.display = 'none';
            document.getElementById('diagnosisModal').style.display = 'none';
            document.getElementById('treatmentModal').style.display = 'none';
            document.getElementById('minimizedContainer').innerHTML = '';

            curCase = i;
            recordCaseStartTime(i);
            loadCase(i);
            updateProgress();
        }

        function loadCase(i) {
            const c = cases[i];
            document.getElementById('caseInfoDisplay').innerHTML = `
                <div class="input-group"><label>æ‚£è€…ID</label><input type="text" value="${c.patientId}" readonly style="background: #f8f9fa;"></div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 18px;">
                    <div><label style="display: block; font-weight: 600; color: #4a5568; margin-bottom: 8px; font-size: 13px;">æ€§åˆ«</label><input type="text" value="${c.gender}" readonly style="width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 14px; background: #f8f9fa;"></div>
                    <div><label style="display: block; font-weight: 600; color: #4a5568; margin-bottom: 8px; font-size: 13px;">å¹´é¾„</label><input type="text" value="${c.age}" readonly style="width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 14px; background: #f8f9fa;"></div>
                    <div><label style="display: block; font-weight: 600; color: #4a5568; margin-bottom: 8px; font-size: 13px;">å°±è¯Šæ—¥æœŸ</label><input type="text" value="${c.visitDate}" readonly style="width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 14px; background: #f8f9fa;"></div>
                </div>
                <div class="input-group"><label>ä¸»è¯‰</label><input type="text" value="${c.chiefComplaint}" readonly style="background: #f8f9fa;"></div>
                <div class="input-group"><label>ç°ç—…å²</label><textarea readonly style="background: #f8f9fa; min-height: 90px;">${c.presentIllness}</textarea></div>
                <div class="input-group"><label>ä¸ªäººå²</label><textarea readonly style="background: #f8f9fa; min-height: 50px;">${c.personalHistory}</textarea></div>
                <div class="input-group"><label>è¯ç‰©è¿‡æ•å²</label><input type="text" value="${c.allergyHistory}" readonly style="background: #f8f9fa;"></div>
                <div class="input-group"><label>ä½“æ ¼æ£€æŸ¥</label><textarea readonly style="background: #f8f9fa; min-height: 90px;">${c.physicalExam}</textarea></div>
                <div class="input-group"><label>è¾…åŠ©æ£€æŸ¥</label><textarea readonly style="background: #f8f9fa; min-height: 60px;">${c.labTests}</textarea></div>
            `;

            const cd = expData.cases.find(x => x.caseId === c.id);
            if (cd && cd.finalDecision) {
                document.getElementById('initialDecisionSection').classList.add('hidden');
                document.getElementById('finalDecisionSection').classList.add('hidden');
            } else if (cd && cd.initialDecision) {
                showFinalSection(cd);
            } else {
                resetInitial();
                document.getElementById('initialDecisionSection').classList.remove('hidden');
                document.getElementById('finalDecisionSection').classList.add('hidden');
            }
        }

        function resetInitial() {
            document.getElementById('initialDiag1').value = '';
            document.getElementById('initialDiag2').value = '';
            document.getElementById('initialDiag3').value = '';
            document.querySelectorAll('input[name="initialAntibiotic"]').forEach(r => r.checked = false);
            document.getElementById('initialAntibioticTypes').classList.add('hidden');
            document.getElementById('initialAntibioticInput').value = '';
        }

        document.querySelectorAll('input[name="initialAntibiotic"]').forEach(r => {
            r.addEventListener('change', function() {
                document.getElementById('initialAntibioticTypes').classList.toggle('hidden', this.value !== 'yes');
            });
        });

        document.querySelectorAll('input[name="finalAntibiotic"]').forEach(r => {
            r.addEventListener('change', function() {
                document.getElementById('finalAntibioticTypes').classList.toggle('hidden', this.value !== 'yes');
            });
        });

        function clearErrorHighlight(element) {
            element.classList.remove('error-field');
        }

        function submitInitialDecision() {
            const c = cases[curCase];
            const d1 = document.getElementById('initialDiag1');
            const d2 = document.getElementById('initialDiag2');
            const d3 = document.getElementById('initialDiag3');
            const ab = document.querySelector('input[name="initialAntibiotic"]:checked');
            const absInput = document.getElementById('initialAntibioticInput');

            [d1, d2, d3, absInput].forEach(el => clearErrorHighlight(el));

            if (!d1.value.trim()) {
                d1.classList.add('error-field');
                alert('è¯·å¡«å†™ç¬¬ä¸€è¯Šæ–­');
                d1.focus();
                return;
            }
            if (!d2.value.trim()) {
                d2.classList.add('error-field');
                alert('è¯·å¡«å†™ç¬¬äºŒè¯Šæ–­');
                d2.focus();
                return;
            }
            if (!d3.value.trim()) {
                d3.classList.add('error-field');
                alert('è¯·å¡«å†™ç¬¬ä¸‰è¯Šæ–­');
                d3.focus();
                return;
            }

            if (!ab) {
                alert('è¯·é€‰æ‹©æ˜¯å¦ä½¿ç”¨æŠ—ç”Ÿç´ ');
                return;
            }

            const useAb = ab.value === 'yes';
            let abs = '';

            if (useAb) {
                abs = absInput.value.trim();
                if (!abs) {
                    absInput.classList.add('error-field');
                    alert('è¯·å¡«å†™æŠ—ç”Ÿç´ ç§ç±»');
                    absInput.focus();
                    return;
                }
            }

            let cd = expData.cases.find(x => x.caseId === c.id);
            if (!cd) {
                cd = { caseId: c.id, caseName: c.name, patientId: c.patientId, timestamps: {} };
                expData.cases.push(cd);
            }

            cd.initialDecision = {
                diagnosis: [d1.value.trim(), d2.value.trim(), d3.value.trim()],
                useAntibiotic: useAb,
                antibiotics: abs
            };
            cd.timestamps.initialSubmit = new Date().toISOString();
            saveData(expData);

            document.getElementById('inputToAIModal').style.display = 'block';
        }

        function submitToAIAndShowDiagnosis() {
            const input = document.getElementById('aiInputMedicalRecord');

            clearErrorHighlight(input);

            if (!input.value.trim()) {
                input.classList.add('error-field');
                alert('è¯·è¾“å…¥ç—…å†ä¿¡æ¯');
                input.focus();
                return;
            }

            const c = cases[curCase];
            const cd = expData.cases.find(x => x.caseId === c.id);
            cd.aiInputInfo = { medicalRecord: input.value.trim() };
            cd.timestamps.aiInput = new Date().toISOString();
            saveData(expData);

            document.getElementById('inputToAIModal').style.display = 'none';

            // æ¸²æŸ“è¯Šæ–­å»ºè®®ï¼ˆåŒ…å«æ€ç»´é“¾ï¼‰
            let diagnosisHTML = `
                <div class="ai-section-label">è¯Šæ–­å»ºè®®ï¼ˆæŒ‰å¯èƒ½æ€§æ’åºï¼‰</div>
                <ul class="ai-diagnosis-list">
                    ${c.aiRecommendation.diagnosis.map((d, i) => `<li>${i+1}. ${d}</li>`).join('')}
                </ul>
            `;

            // å¦‚æœæœ‰æ€ç»´é“¾ï¼Œç›´æ¥æ˜¾ç¤º
            if (c.aiRecommendation.thinkingChain) {
                diagnosisHTML += `
                    <div class="thinking-chain-section">
                        <div class="thinking-chain-title">ğŸ§  AIæ€ç»´è¿‡ç¨‹</div>
                        <div class="thinking-chain-content">${c.aiRecommendation.thinkingChain}</div>
                    </div>
                `;
            }

            document.getElementById('diagnosisContent').innerHTML = diagnosisHTML;
            document.getElementById('diagnosisModal').style.display = 'block';
        }

        function showNextModal() {
            const c = cases[curCase];
            document.getElementById('diagnosisModal').style.display = 'none';

            let html = `
                <div class="ai-section-label">æ˜¯å¦ä½¿ç”¨æŠ—ç”Ÿç´ </div>
                <div class="ai-value" style="margin-bottom: 16px;">
                    ${c.aiRecommendation.useAntibiotic ? 'æ˜¯ï¼Œå»ºè®®ä½¿ç”¨æŠ—ç”Ÿç´ ' : 'å¦ï¼Œä¸å»ºè®®ä½¿ç”¨æŠ—ç”Ÿç´ '}
                </div>
            `;
            if (c.aiRecommendation.useAntibiotic && c.aiRecommendation.antibioticType) {
                html += `<div class="ai-section-label">æ¨èæŠ—ç”Ÿç´ </div><div class="ai-value">${c.aiRecommendation.antibioticType}</div>`;
            }

            // å¦‚æœæœ‰æ€ç»´é“¾ï¼Œç›´æ¥æ˜¾ç¤º
            if (c.aiRecommendation.thinkingChain) {
                html += `
                    <div class="thinking-chain-section">
                        <div class="thinking-chain-title">ğŸ§  AIæ€ç»´è¿‡ç¨‹</div>
                        <div class="thinking-chain-content">${c.aiRecommendation.thinkingChain}</div>
                    </div>
                `;
            }

            document.getElementById('treatmentContent').innerHTML = html;
            document.getElementById('treatmentModal').style.display = 'block';
        }

        function minimizeModal(id, title) {
            document.getElementById(id).style.display = 'none';
            const cont = document.getElementById('minimizedContainer');
            const existing = document.getElementById('minimized-' + id);
            if (!existing) {
                const item = document.createElement('div');
                item.className = 'minimized-item';
                item.id = 'minimized-' + id;
                item.onclick = () => restoreModal(id);
                item.innerHTML = `<div class="minimized-title">${title}</div><div class="minimized-subtitle">ç‚¹å‡»æ¢å¤æŸ¥çœ‹</div>`;
                cont.appendChild(item);
            }
        }

        function restoreModal(id) {
            document.getElementById(id).style.display = 'block';
            const mi = document.getElementById('minimized-' + id);
            if (mi) mi.remove();
        }

        function closeAllModalsAndProceed() {
            document.getElementById('diagnosisModal').style.display = 'none';
            document.getElementById('treatmentModal').style.display = 'none';
            document.getElementById('minimizedContainer').innerHTML = '';

            const c = cases[curCase];
            const cd = expData.cases.find(x => x.caseId === c.id);
            cd.timestamps.aiViewed = new Date().toISOString();
            saveData(expData);

            showFinalSection(cd);
        }

        function showFinalSection(cd) {
            document.getElementById('initialDecisionDisplay').innerHTML = `
                <div class="case-info-row">
                    <span class="case-info-label">è¯Šæ–­ï¼š</span>
                    <span class="case-info-value">
                        1. ${cd.initialDecision.diagnosis[0]}<br>
                        2. ${cd.initialDecision.diagnosis[1]}<br>
                        3. ${cd.initialDecision.diagnosis[2]}
                    </span>
                </div>
                <div class="case-info-row">
                    <span class="case-info-label">æŠ—ç”Ÿç´ ï¼š</span>
                    <span class="case-info-value">${cd.initialDecision.useAntibiotic ? 'ä½¿ç”¨ - ' + cd.initialDecision.antibiotics : 'ä¸ä½¿ç”¨'}</span>
                </div>
            `;

            document.getElementById('initialDecisionSection').classList.add('hidden');
            document.getElementById('finalDecisionSection').classList.remove('hidden');

            document.getElementById('finalDiag1').value = cd.initialDecision.diagnosis[0];
            document.getElementById('finalDiag2').value = cd.initialDecision.diagnosis[1];
            document.getElementById('finalDiag3').value = cd.initialDecision.diagnosis[2];

            const radio = document.querySelector(`input[name="finalAntibiotic"][value="${cd.initialDecision.useAntibiotic ? 'yes' : 'no'}"]`);
            if (radio) {
                radio.checked = true;
                radio.dispatchEvent(new Event('change'));
            }

            if (cd.initialDecision.useAntibiotic) {
                document.getElementById('finalAntibioticInput').value = cd.initialDecision.antibiotics;
            }
        }

        function submitFinalDecision() {
            const d1 = document.getElementById('finalDiag1');
            const d2 = document.getElementById('finalDiag2');
            const d3 = document.getElementById('finalDiag3');
            const ab = document.querySelector('input[name="finalAntibiotic"]:checked');
            const cert = document.querySelector('input[name="certainty"]:checked');
            const absInput = document.getElementById('finalAntibioticInput');

            [d1, d2, d3, absInput].forEach(el => clearErrorHighlight(el));

            if (!d1.value.trim()) {
                d1.classList.add('error-field');
                alert('è¯·å¡«å†™ç¬¬ä¸€è¯Šæ–­');
                d1.focus();
                return;
            }
            if (!d2.value.trim()) {
                d2.classList.add('error-field');
                alert('è¯·å¡«å†™ç¬¬äºŒè¯Šæ–­');
                d2.focus();
                return;
            }
            if (!d3.value.trim()) {
                d3.classList.add('error-field');
                alert('è¯·å¡«å†™ç¬¬ä¸‰è¯Šæ–­');
                d3.focus();
                return;
            }
            if (!ab) {
                alert('è¯·é€‰æ‹©æ˜¯å¦ä½¿ç”¨æŠ—ç”Ÿç´ ');
                return;
            }

            const useAb = ab.value === 'yes';
            let abs = '';

            if (useAb) {
                abs = absInput.value.trim();
                if (!abs) {
                    absInput.classList.add('error-field');
                    alert('è¯·å¡«å†™æŠ—ç”Ÿç´ ç§ç±»');
                    absInput.focus();
                    return;
                }
            }

            if (!cert) {
                alert('è¯·é€‰æ‹©å†³ç­–ç¡®å®šæ€§');
                return;
            }

            const c = cases[curCase];
            const cd = expData.cases.find(x => x.caseId === c.id);

            cd.finalDecision = {
                diagnosis: [d1.value.trim(), d2.value.trim(), d3.value.trim()],
                useAntibiotic: useAb,
                antibiotics: abs,
                certainty: parseInt(cert.value)
            };
            cd.timestamps.finalSubmit = new Date().toISOString();
            cd.timestamps.caseEnd = new Date().toISOString();

            const duration = calculateDuration(cd.timestamps.caseStart, cd.timestamps.caseEnd);
            cd.duration = duration;

            console.log(`${c.name} å®Œæˆï¼è€—æ—¶: ${duration} åˆ†é’Ÿ`);

            completedCases++;
            updateProgress();
            saveData(expData);

            d1.value = '';
            d2.value = '';
            d3.value = '';
            document.querySelectorAll('input[name="finalAntibiotic"]').forEach(r => r.checked = false);
            document.querySelectorAll('input[name="certainty"]').forEach(r => r.checked = false);
            absInput.value = '';
            document.getElementById('aiInputMedicalRecord').value = '';

            if (completedCases >= 5) {
                expData.endTime = new Date().toISOString();
                showCompletionSummary();
                saveData(expData, true);
                console.log('å®éªŒå®Œæˆï¼Œæ•°æ®ï¼š', expData);
            } else {
                alert(`âœ“ ${c.name}å·²å®Œæˆï¼è€—æ—¶ ${duration} åˆ†é’Ÿ\n\nè¯·ç»§ç»­ä¸‹ä¸€ä¸ªæ¡ˆä¾‹ã€‚`);
                switchCase(curCase + 1);
            }
        }

        function showCompletionSummary() {
            document.getElementById('completedParticipantId').textContent = expData.participantId;

            const totalDuration = calculateDuration(expData.startTime, expData.endTime);
            document.getElementById('totalTimeDisplay').textContent = `æ€»ç”¨æ—¶ï¼š${totalDuration} åˆ†é’Ÿ`;

            const tbody = document.getElementById('timeStatsBody');
            tbody.innerHTML = '';

            expData.cases.forEach(cd => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${cd.caseName}</td>
                    <td>${formatDateTime(cd.timestamps.caseEnd)}</td>
                    <td>${cd.duration} åˆ†é’Ÿ</td>
                `;
                tbody.appendChild(row);
            });

            document.getElementById('caseContentArea').classList.add('hidden');
            document.getElementById('completionArea').classList.remove('hidden');
            window.scrollTo(0, 0);
        }

        function downloadData() {
            const dataStr = JSON.stringify(expData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `experiment-data-${expData.participantId}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        init();
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIä¸´åºŠå†³ç­–æ”¯æŒç³»ç»Ÿ - åˆ†è¾¨ç‡VIå®éªŒè®¾è®¡</title>
    <!-- CDNèµ„æºåŠ è½½ï¼šå¸¦å¤šæºfallbackï¼Œé˜²æ­¢CDNè¢«å¢™ -->
    <script>
    // ========================================
    // CDN Fallback Loader - å¤šæºå®¹é”™åŠ è½½
    // å¦‚æœä¸»CDNè¢«å¢™ï¼Œè‡ªåŠ¨å°è¯•å¤‡ç”¨CDN
    // ========================================
    window.__cdnLoadStatus = { emailjs: false, chart: false, supabase: false };

    function loadScript(urls, timeout) {
        return new Promise(function(resolve, reject) {
            var index = 0;
            function tryNext() {
                if (index >= urls.length) {
                    reject(new Error('æ‰€æœ‰CDNæºå‡åŠ è½½å¤±è´¥'));
                    return;
                }
                var url = urls[index];
                index++;
                var script = document.createElement('script');
                script.src = url;
                script.async = false;
                var timer = setTimeout(function() {
                    script.onload = script.onerror = null;
                    if (script.parentNode) script.parentNode.removeChild(script);
                    console.warn('[CDN Fallback] è¶…æ—¶: ' + url);
                    tryNext();
                }, timeout || 8000);
                script.onload = function() {
                    clearTimeout(timer);
                    console.log('[CDN Fallback] æˆåŠŸåŠ è½½: ' + url);
                    resolve(url);
                };
                script.onerror = function() {
                    clearTimeout(timer);
                    if (script.parentNode) script.parentNode.removeChild(script);
                    console.warn('[CDN Fallback] å¤±è´¥: ' + url);
                    tryNext();
                };
                document.head.appendChild(script);
            }
            tryNext();
        });
    }

    // æŒ‰é¡ºåºåŠ è½½ä¸‰ä¸ªåº“
    (async function() {
        try {
            await loadScript([
                'https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js',
                'https://unpkg.com/@emailjs/browser@4/dist/email.min.js',
                'https://cdnjs.cloudflare.com/ajax/libs/emailjs-com/3.2.0/email.min.js',
                'https://fastly.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js'
            ], 8000);
            window.__cdnLoadStatus.emailjs = true;
        } catch(e) {
            console.error('[CDN] EmailJSåŠ è½½å¤±è´¥:', e.message);
        }

        try {
            await loadScript([
                'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js',
                'https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js',
                'https://unpkg.com/chart.js@3.9.1/dist/chart.min.js',
                'https://fastly.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js'
            ], 8000);
            window.__cdnLoadStatus.chart = true;
        } catch(e) {
            console.error('[CDN] Chart.jsåŠ è½½å¤±è´¥:', e.message);
        }

        try {
            await loadScript([
                'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2',
                'https://unpkg.com/@supabase/supabase-js@2',
                'https://fastly.jsdelivr.net/npm/@supabase/supabase-js@2'
            ], 8000);
            window.__cdnLoadStatus.supabase = true;
        } catch(e) {
            console.error('[CDN] SupabaseåŠ è½½å¤±è´¥:', e.message);
        }

        console.log('[CDN Fallback] åŠ è½½çŠ¶æ€:', JSON.stringify(window.__cdnLoadStatus));
    })();
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Microsoft YaHei', sans-serif; background: #f5f7fa; padding: 20px; font-size: 16px; }

        .welcome-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000; }
        .welcome-box { background: white; border-radius: 16px; padding: 40px; max-width: 500px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); }
        .welcome-box h2 { color: #1976d2; font-size: 28px; margin-bottom: 16px; text-align: center; }
        .welcome-box p { color: #616161; line-height: 1.6; margin-bottom: 24px; font-size: 16px; }
        .welcome-input { width: 100%; padding: 12px 16px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 18px; margin-bottom: 24px; font-weight: 600; }
        .welcome-input:focus { outline: none; border-color: #1976d2; }
        .welcome-btn { width: 100%; padding: 14px; background: #1976d2; color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .welcome-btn:hover { background: #1565c0; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(25,118,210,0.3); }
        .welcome-btn:disabled { background: #e0e0e0; cursor: not-allowed; transform: none; }
        .welcome-info { background: #e3f2fd; padding: 12px; border-radius: 8px; margin-top: 16px; font-size: 12px; color: #1565c0; line-height: 1.6; }
        .error-text { color: #d32f2f; font-size: 12px; margin-top: 8px; display: none; }

        .survey-item { margin-bottom: 20px; }
        .survey-question { font-size: 16px; color: #2c3e50; margin-bottom: 10px; font-weight: 500; line-height: 1.5; }
        .likert-scale, .likert-scale-7 { display: flex; flex-wrap: wrap; gap: 8px; }
        .likert-scale label, .likert-scale-7 label { padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 4px; cursor: pointer; font-size: 15px; transition: all 0.2s; background: white; }
        .likert-scale label:hover, .likert-scale-7 label:hover { background: #f0f9ff; border-color: #3498db; }
        .likert-scale label input, .likert-scale-7 label input { margin-right: 6px; }
        .likert-scale input:checked + label, .likert-scale-7 input:checked + label,
        .likert-scale label:has(input:checked), .likert-scale-7 label:has(input:checked) { background: #3498db; color: white; border-color: #3498db; }


        /* æ»‘åŠ¨æ¡æ ·å¼ */
        .slider-container { margin: 15px 0; }
        .slider-wrapper { position: relative; padding: 0 10px; }
        .range-slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: linear-gradient(to right, #e74c3c 0%, #f39c12 16.66%, #f1c40f 33.33%, #95a5a6 50%, #5dade2 66.66%, #3498db 83.33%, #27ae60 100%);
            outline: none;
            -webkit-appearance: none;
        }
        .range-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: white;
            border: 3px solid #3498db;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            transition: all 0.2s;
        }
        .range-slider::-webkit-slider-thumb:hover {
            transform: scale(1.15);
            box-shadow: 0 3px 10px rgba(52, 152, 219, 0.5);
        }
        .range-slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: white;
            border: 3px solid #3498db;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            transition: all 0.2s;
        }
        .range-slider::-moz-range-thumb:hover {
            transform: scale(1.15);
            box-shadow: 0 3px 10px rgba(52, 152, 219, 0.5);
        }
        .slider-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 11px;
            color: #718096;
            padding: 0 10px;
        }
        .slider-labels span {
            text-align: center;
            flex: 1;
        }
        .slider-value {
            text-align: center;
            margin-top: 10px;
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
            padding: 8px;
            background: #e8f4f8;
            border-radius: 6px;
        }
        .slider-ticks {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
            padding: 0 10px;
        }
        .slider-tick {
            width: 2px;
            height: 8px;
            background: #95a5a6;
        }

        .main-wrapper { max-width: 1400px; margin: 0 auto; }
        .header { background: white; padding: 20px 30px; border-radius: 6px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); border-left: 4px solid #3498db; }
        .header h1 { color: #2c3e50; font-size: 24px; margin-bottom: 8px; font-weight: 600; }
        .experiment-tag { display: inline-block; background: #ecf0f1; color: #34495e; padding: 5px 12px; border-radius: 3px; font-size: 14px; font-weight: 500; }
        .save-status { float: right; font-size: 12px; color: #27ae60; padding: 5px 12px; background: #d4edda; border-radius: 3px; display: none; }

        .case-navigation { background: white; padding: 15px 30px; border-radius: 6px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
        .progress-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 12px; border-bottom: 2px solid #e0e6ed; }
        .progress-title { font-size: 17px; font-weight: 600; color: #2c3e50; }
        .progress-stats { display: flex; gap: 20px; font-size: 15px; }
        .progress-stat-item { display: flex; align-items: center; gap: 6px; }
        .progress-stat-label { color: #718096; }
        .progress-stat-value { font-weight: 600; color: #3498db; }
        .progress-bar-wrapper { margin-bottom: 20px; }
        .progress-bar-bg { width: 100%; height: 20px; background: #e0e6ed; border-radius: 10px; overflow: hidden; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1); }
        .progress-bar-fill { height: 100%; background: linear-gradient(90deg, #3498db 0%, #2ecc71 100%); border-radius: 10px; transition: width 0.4s ease; display: flex; align-items: center; justify-content: flex-end; padding-right: 8px; }
        .progress-bar-text { color: white; font-size: 11px; font-weight: 600; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        .system-group { margin-bottom: 15px; }
        .system-group-title { font-size: 16px; font-weight: 600; color: #2c3e50; margin-bottom: 8px; padding: 8px 12px; background: #f8f9fa; border-radius: 4px; }
        .case-nav-btns { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        .case-nav-btn { padding: 10px 20px; border: 2px solid #d1d5db; background: white; border-radius: 4px; cursor: pointer; font-size: 15px; font-weight: 600; color: #4a5568; transition: all 0.2s; }
        .case-nav-btn.current { background: #3498db; border-color: #3498db; color: white; }
        .case-nav-btn.completed { background: #27ae60; border-color: #27ae60; color: white; }

        .content-layout { display: flex; gap: 20px; align-items: flex-start; }
        .main-content { flex: 1; min-width: 0; }

        .ai-sidebar { width: 420px; background: white; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); position: sticky; top: 20px; max-height: calc(100vh - 40px); overflow-y: auto; display: none; }
        .ai-sidebar.active { display: block; }
        .ai-sidebar-header { padding: 18px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 6px 6px 0 0; }
        .ai-sidebar-content { padding: 20px; }

        .ai-modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 9999; }
        .ai-modal-overlay.active { display: flex; }
        .ai-modal-overlay.minimized {
            align-items: flex-end;
            justify-content: flex-end;
            padding: 20px;
            pointer-events: none;
            background: transparent;
        }
        .ai-modal { background: white; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); max-width: 600px; width: 90%; max-height: 85vh; overflow-y: auto; position: relative; transition: all 0.3s ease; }
        .ai-modal.minimized {
            max-width: 300px;
            max-height: 60px;
            overflow: hidden;
            pointer-events: auto;
        }
        .ai-modal-header { padding: 18px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 8px 8px 0 0; display: flex; justify-content: space-between; align-items: center; }
        .ai-modal-controls { display: flex; gap: 8px; }
        .ai-modal-btn { background: rgba(255,255,255,0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; transition: background 0.2s; }
        .ai-modal-btn:hover { background: rgba(255,255,255,0.3); }
        .ai-modal-content { padding: 20px; }
        .ai-modal.minimized .ai-modal-content { display: none; }

        .ai-section { margin-bottom: 25px; padding: 16px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #3498db; }
        .ai-section.hidden { display: none; }
        .ai-section-title { font-size: 16px; font-weight: 600; color: #2c3e50; margin-bottom: 12px; }

        .thinking-process { background: #fff9e6; border-left: 3px solid #f39c12; padding: 12px; border-radius: 4px; margin-bottom: 12px; }
        .thinking-step { padding: 8px 0; color: #856404; font-size: 15px; line-height: 1.6; opacity: 0; animation: fadeIn 0.3s forwards; }
        @keyframes fadeIn { to { opacity: 1; } }
        .thinking-label { font-weight: 600; color: #e67e22; }

        .ai-conclusion { background: #e8f5e9; border: 2px solid #27ae60; padding: 14px; border-radius: 6px; margin-top: 12px; }
        .conclusion-label { font-weight: 600; color: #2e7d32; margin-bottom: 8px; font-size: 16px; }

        .diagnosis-item-with-confidence { padding: 10px; background: white; border-radius: 4px; margin-bottom: 8px; border: 1px solid #e0e6ed; }
        .diagnosis-name { font-weight: 600; color: #2c3e50; margin-bottom: 6px; font-size: 16px; }
        .confidence-bar-container { display: flex; align-items: center; gap: 10px; margin-top: 6px; }
        .confidence-bar { flex: 1; height: 8px; background: #e0e6ed; border-radius: 4px; overflow: hidden; }
        .confidence-fill { height: 100%; border-radius: 4px; transition: width 0.3s; }
        .confidence-fill.high { background: #27ae60; }
        .confidence-fill.medium { background: #f39c12; }
        .confidence-fill.low { background: #e74c3c; }
        .confidence-text { font-size: 15px; font-weight: 600; color: #4a5568; min-width: 45px; text-align: right; }
        .confidence-explain { font-size: 13px; color: #718096; margin-top: 4px; }

        .ig-visualization { background: white; border: 1px solid #e0e6ed; border-radius: 6px; padding: 16px; margin-top: 12px; }
        .ig-title { font-size: 15px; font-weight: 600; color: #2c3e50; margin-bottom: 8px; }
        .ig-explain { font-size: 13px; color: #718096; margin-bottom: 12px; line-height: 1.5; }
        .ig-chart-container { position: relative; height: 280px; }

        .antibiotic-recommendation { margin-top: 12px; }
        .antibiotic-standard { background: #fff3e0; border-left: 3px solid #ff9800; padding: 12px; border-radius: 4px; margin-bottom: 8px; }
        .antibiotic-primary { background: #f0fdf4; border: 2px solid #27ae60; padding: 12px; border-radius: 4px; }
        .searching-indicator { color: #1976d2; font-style: italic; animation: pulse 1.5s ease-in-out infinite; margin: 10px 0; font-size: 15px; }
        @keyframes pulse { 0%, 100% { opacity: 0.6; } 50% { opacity: 1; } }

        .panel { background: white; border-radius: 6px; padding: 25px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); margin-bottom: 20px; }
        .panel-title { font-size: 18px; font-weight: 600; color: #2c3e50; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #e0e6ed; }

        .medical-record-textarea { width: 100%; min-height: 400px; max-height: 550px; padding: 12px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 16px; font-family: 'Microsoft YaHei', monospace; line-height: 1.8; background: #f8f9fa; resize: none; overflow-y: auto; }
        .copy-btn { background: #3498db; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s; margin-top: 8px; }
        .copy-btn:hover { background: #2980b9; transform: translateY(-1px); }
        .copy-btn:active { transform: translateY(0); }
        .copy-success { background: #27ae60 !important; }

        .input-group { margin-bottom: 18px; }
        .input-group label { display: block; font-weight: 600; color: #4a5568; margin-bottom: 8px; font-size: 15px; }
        .input-group input[type="text"], .input-group input[type="number"] { width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 16px; }

        .diagnosis-list { margin-top: 10px; }
        .diagnosis-item { display: grid; grid-template-columns: 90px 1fr; gap: 10px; margin-bottom: 10px; align-items: center; }

        .radio-group { margin-top: 8px; }
        .radio-group label { display: block; font-weight: normal; margin-bottom: 6px; cursor: pointer; padding: 9px 12px; border-radius: 4px; transition: background 0.2s; }
        .radio-group label:hover { background: #f7fafc; }
        .radio-group input { margin-right: 8px; }

        .btn { padding: 11px 24px; border: none; border-radius: 4px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .btn-primary { background: #3498db; color: white; }
        .btn-primary:hover { background: #2980b9; }
        .btn-success { background: #27ae60; color: white; }
        .btn-success:hover { background: #229954; }
        .btn-ai-suggest { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-ai-suggest:hover { opacity: 0.9; transform: translateY(-1px); }

        .action-buttons { margin-top: 25px; text-align: right; }
        .action-buttons .btn { margin-left: 10px; }

        .hidden { display: none; }
        .required-mark { color: #e53e3e; }
        .help-text { font-size: 14px; color: #718096; margin-top: 4px; }

        @media (max-width: 1200px) {
            .content-layout { flex-direction: column; }
            .ai-sidebar { width: 100%; position: relative; top: 0; max-height: none; }
        }

        /* æç¤ºæ¡†æ ·å¼ */
        .submit-tip {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #27ae60;
            color: white;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            font-size: 16px;
            font-weight: 600;
            z-index: 10000;
            animation: slideInRight 0.5s ease;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* é«˜äº®æ•ˆæœæ ·å¼ */
        .highlight-effect {
            animation: highlightPulse 2s ease-in-out;
            background: #fff3cd !important;
            border: 2px solid #ffc107 !important;
        }

        @keyframes highlightPulse {
            0%, 100% {
                background: #fff3cd;
                border-color: #ffc107;
            }
            50% {
                background: #ffecb3;
                border-color: #ff9800;
            }
        }

    </style>
</head>
<body>

    <!-- ç¬¬ä¸€æ­¥ï¼šå§“åè¾“å…¥ + çŸ¥æƒ…åŒæ„ä¹¦ -->
    <div id="welcomeOverlay" class="welcome-overlay">
        <div class="welcome-box" style="max-width: 750px; max-height: 90vh; overflow-y: auto;">
            <h2 style="text-align: center; color: #1976d2; margin-bottom: 5px;">ğŸ“ æ¬¢è¿å‚ä¸ä¸´åºŠAIå®éªŒ</h2>
            <p style="text-align: center; font-size: 14px; color: #616161; margin-bottom: 15px;">é¡¹ç›®åç§°ï¼šAIç‰¹å¾å¯¹åŸºå±‚åŒ»ç”Ÿè¯Šç–—å†³ç­–è¡Œä¸ºçš„å½±å“ç ”ç©¶</p>

            <!-- AI-CDSSç®€ä»‹ -->
            <div style="background: #e3f2fd; border-left: 4px solid #1976d2; padding: 12px 15px; margin-bottom: 15px; border-radius: 0 8px 8px 0;">
                <strong style="color: #1565c0; font-size: 14px;">ä»€ä¹ˆæ˜¯AI-CDSSï¼Ÿ</strong>
                <p style="margin: 6px 0 0 0; font-size: 13px; color: #424242; line-height: 1.6;">AI-CDSSï¼ˆäººå·¥æ™ºèƒ½ä¸´åºŠå†³ç­–æ”¯æŒç³»ç»Ÿï¼‰æ˜¯ä¸€ç§è¾…åŠ©åŒ»ç”Ÿè¿›è¡Œè¯Šæ–­å’Œæ²»ç–—å†³ç­–çš„æ™ºèƒ½å·¥å…·ï¼Œé€šè¿‡åˆ†ææ‚£è€…ä¿¡æ¯ä¸ºä¸´åºŠåŒ»ç”Ÿæä¾›è¯Šæ–­å»ºè®®å’Œæ²»ç–—æ–¹æ¡ˆå‚è€ƒã€‚</p>
            </div>

            <div style="text-align: left; font-size: 14px; line-height: 1.8; color: #424242;">
                <p>å°Šæ•¬çš„åŒ»ç”Ÿæœ‹å‹ï¼š</p>
                <p style="text-indent: 2em;">æ‚¨å¥½ï¼è¯šæŒšé‚€è¯·æ‚¨å‚ä¸ä¸€é¡¹å…³äºäººå·¥æ™ºèƒ½ï¼ˆAIï¼‰è¾…åŠ©åŒ»ç–—å†³ç­–çš„ç ”ç©¶ã€‚</p>

                <!-- ç ”ç©¶ç›®æ ‡é«˜äº® -->
                <div style="background: #fff8e1; border: 2px solid #ff9800; border-radius: 8px; padding: 12px 15px; margin: 15px 0;">
                    <p style="margin: 0;"><strong style="color: #e65100;">ğŸ¯ ç ”ç©¶ç›®æ ‡ï¼š</strong><span style="color: #e65100; font-weight: 600;">è¯„ä»·å…·æœ‰ä¸åŒç‰¹å¾çš„AIç³»ç»Ÿå¯¹åŒ»ç”Ÿè¯Šç–—å†³ç­–çš„å½±å“</span>ï¼Œä»¥ä¸ºæœªæ¥å¼€å‘æ›´é€‚åˆåŸºå±‚ä¸´åºŠå·¥ä½œçš„AIå·¥å…·æä¾›ç§‘å­¦ä¾æ®ã€‚</p>
                </div>

                <p style="text-indent: 2em;">åœ¨æ‚¨å†³å®šæ˜¯å¦å‚ä¸ä¹‹å‰ï¼Œè¯·ä»”ç»†é˜…è¯»ä»¥ä¸‹ä¿¡æ¯ï¼š</p>

                <!-- ä¸€ã€æ‹›å‹Ÿå¯¹è±¡ -->
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <h3 style="font-size: 15px; color: #2c3e50; margin: 0 0 10px 0;">ä¸€ã€æ‹›å‹Ÿå¯¹è±¡</h3>
                    <p style="margin: 0 0 8px 0;">æœ¬ç ”ç©¶é¢å‘ä¸Šæµ·åœ°åŒºåŸºå±‚åŒ»ç–—å«ç”Ÿæœºæ„ï¼ˆç¤¾åŒºå«ç”ŸæœåŠ¡ä¸­å¿ƒ/ç«™ã€æ‘å«ç”Ÿå®¤ç­‰ï¼‰çš„åœ¨èŒä¸´åºŠåŒ»ç”Ÿï¼Œè¦æ±‚ï¼š</p>
                    <ul style="margin: 0; padding-left: 20px;">
                        <li>æ‰§ä¸šèŒƒå›´ä¸ºå…¨ç§‘åŒ»å­¦æˆ–å†…ç§‘ï¼›</li>
                        <li>å…·æœ‰å‘¼å¸é“æ„ŸæŸ“ç±»ç–¾ç—…çš„è¯Šç–—ç»éªŒï¼›</li>
                        <li>ä¸´åºŠå·¥ä½œå¹´é™æ»¡1å¹´åŠä»¥ä¸Šã€‚</li>
                    </ul>
                </div>

                <!-- äºŒã€æ‚¨éœ€è¦åšä»€ä¹ˆ -->
                <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 15px 0; border: 2px solid #1976d2;">
                    <h3 style="font-size: 15px; color: #1565c0; margin: 0 0 10px 0;">äºŒã€æ‚¨éœ€è¦åšä»€ä¹ˆï¼Ÿ</h3>
                    <p style="margin: 0 0 10px 0;">è¿™æ˜¯ä¸€é¡¹åŸºäºç½‘é¡µçš„åœ¨çº¿æ¨¡æ‹Ÿå®éªŒï¼Œ<strong>è¯·åŠ¡å¿…ä½¿ç”¨ç”µè„‘ï¼ˆPCç«¯ï¼‰è¿›è¡Œæ“ä½œï¼Œä¸æ”¯æŒæ‰‹æœºæˆ–å¹³æ¿</strong>ã€‚</p>

                    <!-- åŒ»ç”Ÿå·¥ä½œé«˜äº® -->
                    <div style="background: #bbdefb; border-radius: 6px; padding: 12px; margin: 10px 0;">
                        <p style="margin: 0 0 8px 0;"><strong style="color: #0d47a1;">ğŸ“‹ æ‚¨çš„æ ¸å¿ƒä»»åŠ¡ï¼š</strong></p>
                        <ul style="margin: 0; padding-left: 20px; color: #0d47a1;">
                            <li><strong>é˜…è¯»å¹¶ä½“éªŒ3ç§å…·æœ‰ä¸åŒç‰¹å¾çš„AIè¾…åŠ©å†³ç­–ç³»ç»Ÿ</strong></li>
                            <li><strong>é’ˆå¯¹æ¯ä¸ªç—…ä¾‹è¿›è¡Œè¯Šç–—å†³ç­–</strong>ï¼ˆåˆæ­¥è¯Šæ–­ â†’ æŸ¥çœ‹AIå»ºè®® â†’ æœ€ç»ˆå†³ç­–ï¼‰</li>
                            <li><strong>å¯¹æ¯ç§AIç³»ç»Ÿè¿›è¡Œè¯„ä»·</strong>ï¼ˆä½¿ç”¨æ„æ„¿ã€æ„ŸçŸ¥æœ‰ç”¨æ€§å’Œæ˜“ç”¨æ€§ï¼‰</li>
                        </ul>
                    </div>

                    <!-- é‡ç‚¹å…³æ³¨é«˜äº® -->
                    <div style="background: #ffcdd2; border-radius: 6px; padding: 12px; margin: 10px 0;">
                        <p style="margin: 0;"><strong style="color: #c62828;">âš ï¸ é‡ç‚¹å…³æ³¨ï¼š</strong><span style="color: #c62828;">æ‚¨å°†ä¼šè¢«åˆ†é…åˆ°<strong>3ç§å…·æœ‰ä¸åŒç‰¹å¾çš„AIç³»ç»Ÿ</strong>ï¼Œæ‚¨éœ€ä½¿ç”¨ä¸åŒç³»ç»Ÿã€è¿›è¡Œè¯Šç–—å†³ç­–å¹¶å¯¹ä¸åŒçš„ç³»ç»Ÿè¿›è¡Œè¯„ä»·ã€‚</span></p>
                    </div>

                    <ul style="margin: 10px 0 0 0; padding-left: 20px;">
                        <li><strong>å¡«å†™åŸºæœ¬ä¿¡æ¯</strong>ï¼šç®€å•çš„èŒä¸šèƒŒæ™¯è°ƒæŸ¥ã€‚</li>
                        <li><strong>é¢„è®¡è€—æ—¶</strong>ï¼šå…¨ç¨‹çº¦<strong>20åˆ†é’Ÿ</strong>ã€‚</li>
                        <li><strong>æ–­ç‚¹ç»­å¡«</strong>ï¼šå¦‚é‡å·¥ä½œæ‰“æ–­ï¼Œå†æ¬¡é€šè¿‡åŒä¸€å°ç”µè„‘ã€åŒä¸€æµè§ˆå™¨æ‰“å¼€é“¾æ¥å³å¯æ¢å¤è¿›åº¦ã€‚</li>
                    </ul>
                </div>

                <!-- ä¸‰ã€å‚ä¸å›æŠ¥ -->
                <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <h3 style="font-size: 15px; color: #2e7d32; margin: 0 0 10px 0;">ä¸‰ã€å‚ä¸å›æŠ¥</h3>
                    <p style="margin: 0;">ä¸ºæ„Ÿè°¢æ‚¨çš„å®è´µæ—¶é—´ä¸ä¸“ä¸šè´¡çŒ®ï¼Œå¯¹äºå®Œæ•´å®Œæˆå®éªŒï¼Œæ•°æ®æœ‰æ•ˆï¼ˆé€šè¿‡åå°è´¨é‡å®¡æ ¸ï¼‰ï¼Œä¸”ç¬¦åˆæ‹›å‹Ÿæ¡ä»¶è¦æ±‚çš„ç¤¾åŒºå…¨ç§‘åŒ»ç”Ÿï¼Œè¯¾é¢˜ç»„å°†æä¾›<strong>150å…ƒ/äºº</strong>çš„åŠ³åŠ¡è¡¥è´´ã€‚</p>
                </div>

                <!-- å››ã€éšç§ä¿æŠ¤ -->
                <div style="background: #fff3e0; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <h3 style="font-size: 15px; color: #e65100; margin: 0 0 10px 0;">å››ã€éšç§ä¿æŠ¤</h3>
                    <p style="margin: 0;">æœ¬ç ”ç©¶éµå¾ªä¸¥æ ¼çš„ä¿å¯†åŸåˆ™ã€‚æ‚¨å¡«å†™çš„æ‰€æœ‰ä¿¡æ¯ä»…ç”¨äºå­¦æœ¯ç ”ç©¶ç»Ÿè®¡ï¼Œç»ä¸ä¼šå‘ä»»ä½•ç¬¬ä¸‰æ–¹é€éœ²æ‚¨çš„ä¸ªäººéšç§ã€‚</p>
                </div>

                <!-- äº”ã€è”ç³»æˆ‘ä»¬ -->
                <div style="background: #f3e5f5; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <h3 style="font-size: 15px; color: #7b1fa2; margin: 0 0 10px 0;">äº”ã€è”ç³»æˆ‘ä»¬</h3>
                    <p style="margin: 0 0 8px 0;">å¦‚æœåœ¨å¡«å†™è¿‡ç¨‹ä¸­é‡åˆ°ä»»ä½•æŠ€æœ¯é—®é¢˜æˆ–ç–‘é—®ï¼Œè¯·éšæ—¶è”ç³»é¡¹ç›®è”ç»œå‘˜ï¼š</p>
                    <ul style="margin: 0; padding-left: 20px;">
                        <li>è”ç³»äººï¼šæŸ³ç¾½å§</li>
                        <li>ç”µè¯ï¼š18772101551</li>
                        <li>å¾®ä¿¡å·ï¼šlys-414321</li>
                    </ul>
                </div>

                <p style="text-align: center; color: #1976d2; font-weight: 600; margin-top: 20px;">å†æ¬¡æ„Ÿè°¢æ‚¨å¯¹æœ¬ç ”ç©¶çš„æ”¯æŒï¼</p>
            </div>

            <!-- å§“åè¾“å…¥åŒºåŸŸ -->
            <div style="margin: 20px 0 15px 0;">
                <strong style="color: #2c3e50; display: block; margin-bottom: 10px;">ğŸ“ è¯·è¾“å…¥æ‚¨çš„å§“åä»¥å¼€å§‹å®éªŒ</strong>
                <input type="text" id="participantInput" class="welcome-input" placeholder="è¯·è¾“å…¥æ‚¨çš„å§“å" style="margin-bottom: 8px;">
                <div id="errorText" class="error-text">è¯·è¾“å…¥è‡³å°‘2ä¸ªå­—ç¬¦</div>
            </div>

            <button class="welcome-btn" id="startBtn" onclick="goToScreening()">æˆ‘å·²é˜…è¯»å¹¶åŒæ„ï¼Œç»§ç»­å‚ä¸</button>
        </div>
    </div>

    <!-- åŸçŸ¥æƒ…åŒæ„ä¹¦é¡µé¢ä¿ç•™ä½†éšè—ï¼ˆå…¼å®¹æ€§è€ƒè™‘ï¼‰ -->
    <div id="consentOverlay" class="welcome-overlay" style="display: none;">
        <!-- å†…å®¹å·²æ•´åˆåˆ°ç¬¬ä¸€é¡µ -->
    </div>

    <!-- ç¬¬ä¸‰æ­¥ï¼šèµ„æ ¼ç­›é€‰ -->
    <div id="screeningOverlay" class="welcome-overlay" style="display: none;">
        <div class="welcome-box" style="max-width: 650px; max-height: 90vh; overflow-y: auto;">
            <h2>ğŸ“‹ èµ„æ ¼ç¡®è®¤</h2>
            <p style="font-size: 14px; margin-bottom: 20px; color: #616161;">è¯·å›ç­”ä»¥ä¸‹é—®é¢˜ä»¥ç¡®è®¤æ‚¨ç¬¦åˆæœ¬ç ”ç©¶çš„å‚ä¸èµ„æ ¼</p>

            <div style="text-align: left;">
                <!-- çº³å…¥æ ‡å‡† -->
                <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #4caf50;">
                    <h3 style="font-size: 16px; color: #2e7d32; margin-bottom: 15px;">çº³å…¥æ ‡å‡†ç¡®è®¤</h3>

                    <div class="input-group" style="margin-bottom: 15px;">
                        <label style="font-weight: 600; margin-bottom: 8px; display: block; line-height: 1.6;">
                            1. æ‚¨æ˜¯å¦åœ¨ç¤¾åŒºå«ç”ŸæœåŠ¡ä¸­å¿ƒã€ç¤¾åŒºå«ç”ŸæœåŠ¡ç«™ã€ä¹¡é•‡å«ç”Ÿé™¢æˆ–æ‘å«ç”Ÿå®¤ç­‰åŸºå±‚åŒ»ç–—æœºæ„<strong>å…¨èŒ</strong>ä»äº‹ä¸´åºŠå·¥ä½œï¼Ÿ
                            <span class="required-mark">*</span>
                        </label>
                        <div class="radio-group">
                            <label><input type="radio" name="inclusion1" value="æ˜¯">æ˜¯</label>
                            <label><input type="radio" name="inclusion1" value="å¦">å¦</label>
                        </div>
                    </div>

                    <div class="input-group" style="margin-bottom: 15px;">
                        <label style="font-weight: 600; margin-bottom: 8px; display: block; line-height: 1.6;">
                            2. æ‚¨çš„æ‰§ä¸šç±»åˆ«æ˜¯å¦ä¸ºä¸´åºŠåŒ»å¸ˆï¼Œæ‰§ä¸šèŒƒå›´ä¸ºå…¨ç§‘åŒ»å­¦æˆ–å†…ç§‘ï¼Œä¸”å…·æœ‰å‘¼å¸é“æ„ŸæŸ“ç±»ç–¾ç—…çš„è¯Šç–—ç»éªŒï¼Ÿ
                            <span class="required-mark">*</span>
                        </label>
                        <div class="radio-group">
                            <label><input type="radio" name="inclusion2" value="æ˜¯">æ˜¯</label>
                            <label><input type="radio" name="inclusion2" value="å¦">å¦</label>
                        </div>
                    </div>

                    <div class="input-group" style="margin-bottom: 15px;">
                        <label style="font-weight: 600; margin-bottom: 8px; display: block; line-height: 1.6;">
                            3. æ‚¨çš„ä¸´åºŠå·¥ä½œå¹´é™æ˜¯å¦æ»¡1å¹´åŠä»¥ä¸Šï¼Ÿ
                            <span class="required-mark">*</span>
                        </label>
                        <div class="radio-group">
                            <label><input type="radio" name="inclusion3" value="æ˜¯">æ˜¯</label>
                            <label><input type="radio" name="inclusion3" value="å¦">å¦</label>
                        </div>
                    </div>
                </div>

                <!-- æ’é™¤æ ‡å‡† -->
                <div style="background: #fff3e0; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ff9800;">
                    <h3 style="font-size: 16px; color: #e65100; margin-bottom: 15px;">æ’é™¤æ ‡å‡†ç¡®è®¤</h3>

                    <div class="input-group" style="margin-bottom: 15px;">
                        <label style="font-weight: 600; margin-bottom: 8px; display: block; line-height: 1.6;">
                            4. æ‚¨æ˜¯å¦å±äºéä¸´åºŠå²—ä½äººå‘˜ï¼Ÿ
                            <span style="font-weight: normal; color: #718096; font-size: 13px;">ï¼ˆå¦‚è¡Œæ”¿ã€è¯å‰‚ã€æ£€éªŒã€å…¬å…±å«ç”Ÿç­‰æœªç›´æ¥å‚ä¸é—¨è¯Šè¯Šç–—è€…ï¼‰</span>
                            <span class="required-mark">*</span>
                        </label>
                        <div class="radio-group">
                            <label><input type="radio" name="exclusion1" value="æ˜¯">æ˜¯ï¼ˆæˆ‘æ˜¯éä¸´åºŠå²—ä½äººå‘˜ï¼‰</label>
                            <label><input type="radio" name="exclusion1" value="å¦">å¦ï¼ˆæˆ‘æ˜¯ä¸´åºŠå²—ä½äººå‘˜ï¼Œç›´æ¥å‚ä¸é—¨è¯Šè¯Šç–—ï¼‰</label>
                        </div>
                    </div>
                </div>
            </div>

            <button class="welcome-btn" onclick="submitScreening()">ç¡®è®¤å¹¶ç»§ç»­</button>
        </div>
    </div>

    <!-- èµ„æ ¼ä¸ç¬¦ç»“æŸç•Œé¢ -->
    <div id="disqualifiedOverlay" class="welcome-overlay" style="display: none;">
        <div class="welcome-box" style="max-width: 500px; text-align: center;">
            <div style="font-size: 60px; margin-bottom: 20px;">ğŸ™</div>
            <h2 style="color: #e74c3c; margin-bottom: 20px;">æ„Ÿè°¢æ‚¨çš„å…³æ³¨</h2>
            <p style="font-size: 16px; line-height: 1.8; color: #616161; margin-bottom: 20px;">
                éå¸¸æ„Ÿè°¢æ‚¨å¯¹æœ¬ç ”ç©¶çš„å…³æ³¨ï¼<br><br>
                æ ¹æ®æ‚¨å¡«å†™çš„ä¿¡æ¯ï¼Œæ‚¨æš‚æ—¶ä¸ç¬¦åˆæœ¬æ¬¡ç ”ç©¶çš„å‚ä¸æ¡ä»¶ã€‚<br><br>
                å¦‚æœ‰ç–‘é—®ï¼Œè¯·è”ç³»ç ”ç©¶å›¢é˜Ÿã€‚
            </p>
            <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; font-size: 14px; color: #718096;">
                æœ¬ç ”ç©¶ä»…é¢å‘åœ¨åŸºå±‚åŒ»ç–—æœºæ„å…¨èŒä»äº‹ä¸´åºŠå·¥ä½œçš„åŒ»å¸ˆ
            </div>
        </div>
    </div>

    <!-- ç¬¬ä¸‰æ­¥ï¼šä¸ªäººä¿¡æ¯è¡¨å• -->
    <div id="demographicsOverlay" class="welcome-overlay" style="display: none;">
        <div class="welcome-box" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
            <h2>ğŸ“‹ ä¸ªäººä¿¡æ¯è°ƒæŸ¥</h2>
            <p style="font-size: 13px; margin-bottom: 20px;">è¯·å¦‚å®å¡«å†™ä»¥ä¸‹ä¿¡æ¯ï¼Œæ‰€æœ‰æ•°æ®ä»…ç”¨äºç ”ç©¶åˆ†æ</p>

            <div style="text-align: left;">
                <div class="input-group" style="margin-bottom: 15px;">
                    <label style="font-weight: 600; margin-bottom: 8px; display: block;">1. æ€§åˆ« <span class="required-mark">*</span></label>
                    <div class="radio-group">
                        <label><input type="radio" name="gender" value="ç”·">ç”·</label>
                        <label><input type="radio" name="gender" value="å¥³">å¥³</label>
                    </div>
                </div>

                <div class="input-group" style="margin-bottom: 15px;">
                    <label style="font-weight: 600; margin-bottom: 8px; display: block;">2. å¹´é¾„ï¼ˆå²ï¼‰ <span class="required-mark">*</span></label>
                    <input type="number" id="age" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;" placeholder="è¯·è¾“å…¥å¹´é¾„">
                </div>

                <div class="input-group" style="margin-bottom: 15px;">
                    <label style="font-weight: 600; margin-bottom: 8px; display: block;">3. æ–‡åŒ–ç¨‹åº¦ <span class="required-mark">*</span></label>
                    <div class="radio-group">
                        <label><input type="radio" name="education" value="å°å­¦åŠä»¥ä¸‹">å°å­¦åŠä»¥ä¸‹</label>
                        <label><input type="radio" name="education" value="åˆä¸­">åˆä¸­</label>
                        <label><input type="radio" name="education" value="é«˜ä¸­æˆ–ä¸­ä¸“">é«˜ä¸­æˆ–ä¸­ä¸“</label>
                        <label><input type="radio" name="education" value="å¤§ä¸“æˆ–æœ¬ç§‘">å¤§ä¸“æˆ–æœ¬ç§‘</label>
                        <label><input type="radio" name="education" value="ç¡•å£«ç ”ç©¶ç”Ÿ">ç¡•å£«ç ”ç©¶ç”Ÿ</label>
                        <label><input type="radio" name="education" value="åšå£«ç ”ç©¶ç”Ÿ">åšå£«ç ”ç©¶ç”Ÿ</label>
                    </div>
                </div>

                <div class="input-group" style="margin-bottom: 15px;">
                    <label style="font-weight: 600; margin-bottom: 8px; display: block;">4. æ‚¨æ‰€åœ¨çš„çœä»½ <span class="required-mark">*</span></label>
                    <select id="province" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;">
                        <option value="">è¯·é€‰æ‹©çœä»½</option>
                        <option value="åŒ—äº¬å¸‚">åŒ—äº¬å¸‚</option>
                        <option value="å¤©æ´¥å¸‚">å¤©æ´¥å¸‚</option>
                        <option value="æ²³åŒ—çœ">æ²³åŒ—çœ</option>
                        <option value="å±±è¥¿çœ">å±±è¥¿çœ</option>
                        <option value="å†…è’™å¤è‡ªæ²»åŒº">å†…è’™å¤è‡ªæ²»åŒº</option>
                        <option value="è¾½å®çœ">è¾½å®çœ</option>
                        <option value="å‰æ—çœ">å‰æ—çœ</option>
                        <option value="é»‘é¾™æ±Ÿçœ">é»‘é¾™æ±Ÿçœ</option>
                        <option value="ä¸Šæµ·å¸‚">ä¸Šæµ·å¸‚</option>
                        <option value="æ±Ÿè‹çœ">æ±Ÿè‹çœ</option>
                        <option value="æµ™æ±Ÿçœ">æµ™æ±Ÿçœ</option>
                        <option value="å®‰å¾½çœ">å®‰å¾½çœ</option>
                        <option value="ç¦å»ºçœ">ç¦å»ºçœ</option>
                        <option value="æ±Ÿè¥¿çœ">æ±Ÿè¥¿çœ</option>
                        <option value="å±±ä¸œçœ">å±±ä¸œçœ</option>
                        <option value="æ²³å—çœ">æ²³å—çœ</option>
                        <option value="æ¹–åŒ—çœ">æ¹–åŒ—çœ</option>
                        <option value="æ¹–å—çœ">æ¹–å—çœ</option>
                        <option value="å¹¿ä¸œçœ">å¹¿ä¸œçœ</option>
                        <option value="å¹¿è¥¿å£®æ—è‡ªæ²»åŒº">å¹¿è¥¿å£®æ—è‡ªæ²»åŒº</option>
                        <option value="æµ·å—çœ">æµ·å—çœ</option>
                        <option value="é‡åº†å¸‚">é‡åº†å¸‚</option>
                        <option value="å››å·çœ">å››å·çœ</option>
                        <option value="è´µå·çœ">è´µå·çœ</option>
                        <option value="äº‘å—çœ">äº‘å—çœ</option>
                        <option value="è¥¿è—è‡ªæ²»åŒº">è¥¿è—è‡ªæ²»åŒº</option>
                        <option value="é™•è¥¿çœ">é™•è¥¿çœ</option>
                        <option value="ç”˜è‚ƒçœ">ç”˜è‚ƒçœ</option>
                        <option value="é’æµ·çœ">é’æµ·çœ</option>
                        <option value="å®å¤å›æ—è‡ªæ²»åŒº">å®å¤å›æ—è‡ªæ²»åŒº</option>
                        <option value="æ–°ç–†ç»´å¾å°”è‡ªæ²»åŒº">æ–°ç–†ç»´å¾å°”è‡ªæ²»åŒº</option>
                        <option value="é¦™æ¸¯ç‰¹åˆ«è¡Œæ”¿åŒº">é¦™æ¸¯ç‰¹åˆ«è¡Œæ”¿åŒº</option>
                        <option value="æ¾³é—¨ç‰¹åˆ«è¡Œæ”¿åŒº">æ¾³é—¨ç‰¹åˆ«è¡Œæ”¿åŒº</option>
                        <option value="å°æ¹¾çœ">å°æ¹¾çœ</option>
                    </select>
                </div>

                <div class="input-group" style="margin-bottom: 15px;">
                    <label style="font-weight: 600; margin-bottom: 8px; display: block;">5. åŸºå±‚å·¥ä½œå¹´é™ï¼ˆå¹´ï¼‰<span class="required-mark">*</span></label>
                    <input type="number" id="workYears" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;" placeholder="è¯·è¾“å…¥å·¥ä½œå¹´é™">
                </div>

                <div class="input-group" style="margin-bottom: 15px;">
                    <label style="font-weight: 600; margin-bottom: 8px; display: block;">6. èŒç§° <span class="required-mark">*</span></label>
                    <div class="radio-group">
                        <label><input type="radio" name="title" value="é«˜çº§">é«˜çº§</label>
                        <label><input type="radio" name="title" value="ä¸­çº§">ä¸­çº§</label>
                        <label><input type="radio" name="title" value="åˆçº§">åˆçº§</label>
                        <label><input type="radio" name="title" value="æœªå®šçº§">æœªå®šçº§</label>
                    </div>
                </div>

                <div class="input-group" style="margin-bottom: 15px;">
                    <label style="font-weight: 600; margin-bottom: 8px; display: block;">7. åŸºå±‚åŒ»ç–—æœºæ„ç±»å‹ <span class="required-mark">*</span></label>
                    <div class="radio-group">
                        <label><input type="radio" name="facility" value="ç¤¾åŒºå«ç”ŸæœåŠ¡ä¸­å¿ƒ">ç¤¾åŒºå«ç”ŸæœåŠ¡ä¸­å¿ƒ</label>
                        <label><input type="radio" name="facility" value="ç¤¾åŒºå«ç”ŸæœåŠ¡ç«™">ç¤¾åŒºå«ç”ŸæœåŠ¡ç«™</label>
                        <label><input type="radio" name="facility" value="ä¹¡é•‡å«ç”Ÿé™¢">ä¹¡é•‡å«ç”Ÿé™¢</label>
                        <label><input type="radio" name="facility" value="æ‘å«ç”Ÿå®¤">æ‘å«ç”Ÿå®¤</label>
                    </div>
                </div>

                <div class="input-group" style="margin-bottom: 15px;">
                    <label style="font-weight: 600; margin-bottom: 8px; display: block;">8. ä¸ªäººæ—¥å‡è¯Šç–—äººæ¬¡ï¼ˆ/äººæ¬¡ï¼‰<span class="required-mark">*</span></label>
                    <input type="number" id="dailyPatients" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;" placeholder="è¯·è¾“å…¥æ—¥å‡è¯Šç–—äººæ¬¡">
                </div>

                <div class="input-group" style="margin-bottom: 15px;">
                    <label style="font-weight: 600; margin-bottom: 8px; display: block;">9. æ‚¨å¯¹äººå·¥æ™ºèƒ½çš„äº†è§£ç¨‹åº¦ <span class="required-mark">*</span></label>
                    <div class="radio-group">
                        <label><input type="radio" name="aiKnowledge" value="éå¸¸äº†è§£">éå¸¸äº†è§£</label>
                        <label><input type="radio" name="aiKnowledge" value="æ¯”è¾ƒäº†è§£">æ¯”è¾ƒäº†è§£</label>
                        <label><input type="radio" name="aiKnowledge" value="ä¸€èˆ¬">ä¸€èˆ¬</label>
                        <label><input type="radio" name="aiKnowledge" value="æ¯”è¾ƒä¸äº†è§£">æ¯”è¾ƒä¸äº†è§£</label>
                        <label><input type="radio" name="aiKnowledge" value="éå¸¸ä¸äº†è§£">éå¸¸ä¸äº†è§£</label>
                    </div>
                </div>

                <div class="input-group" style="margin-bottom: 20px;">
                    <label style="font-weight: 600; margin-bottom: 8px; display: block;">10. æ˜¯å¦åœ¨è¯Šç–—å†³ç­–ä¸­ä½¿ç”¨è¿‡äººå·¥æ™ºèƒ½è¿›è¡Œè¾…åŠ© <span class="required-mark">*</span></label>
                    <div class="radio-group">
                        <label><input type="radio" name="aiExperience" value="æ˜¯">æ˜¯</label>
                        <label><input type="radio" name="aiExperience" value="å¦">å¦</label>
                    </div>
                </div>
            </div>

            <button class="welcome-btn" onclick="submitDemographics()">æäº¤å¹¶å¼€å§‹å®éªŒ</button>
        </div>
    </div>

    <!-- ç³»ç»Ÿå®Œæˆåçš„é‡è¡¨ -->
    <div id="systemSurveyOverlay" class="welcome-overlay" style="display: none;">
        <div class="welcome-box" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
            <h2>ğŸ“Š ç³»ç»Ÿè¯„ä»·é‡è¡¨</h2>
            <p style="font-size: 13px; margin-bottom: 20px; color: #718096;">
                æ‚¨å·²å®Œæˆ<strong id="surveySystemName" style="color: #3498db;"></strong>çš„æ‰€æœ‰ç—…å†ï¼<br>
                è¯·æ ¹æ®æ‚¨åˆšæ‰çš„ä½¿ç”¨ä½“éªŒï¼Œå¯¹è¯¥AIç³»ç»Ÿè¿›è¡Œè¯„ä»·
            </p>

            <div style="text-align: left;">
                <!-- é‡‡çº³æ„æ„¿ -->
                <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                    <h3 style="font-size: 15px; color: #2c3e50; margin-bottom: 15px;">A. é‡‡çº³æ„æ„¿</h3>

                    <div class="survey-item">
                        <p class="survey-question">1. å½“æˆ‘æ‰€åœ¨çš„æœºæ„å¼•å…¥è¯¥AI-CDSSåï¼Œæˆ‘æ„¿æ„å°†å…¶åº”ç”¨äºæ—¥å¸¸è¯Šç–—</p>
                        <div class="likert-scale">
                            <label><input type="radio" name="intention1" value="1">1 éå¸¸ä¸åŒæ„</label>
                            <label><input type="radio" name="intention1" value="2">2 ä¸åŒæ„</label>
                            <label><input type="radio" name="intention1" value="3">3 ä¸­ç«‹</label>
                            <label><input type="radio" name="intention1" value="4">4 åŒæ„</label>
                            <label><input type="radio" name="intention1" value="5">5 éå¸¸åŒæ„</label>
                        </div>
                    </div>

                    <div class="survey-item">
                        <p class="survey-question">2. æˆ‘æ‰“ç®—æ ¹æ®å®é™…éœ€æ±‚ï¼Œä½¿ç”¨AI-CDSSä¸ºæ‚£è€…æä¾›åŒ»ç–—æœåŠ¡</p>
                        <div class="likert-scale">
                            <label><input type="radio" name="intention2" value="1">1 éå¸¸ä¸åŒæ„</label>
                            <label><input type="radio" name="intention2" value="2">2 ä¸åŒæ„</label>
                            <label><input type="radio" name="intention2" value="3">3 ä¸­ç«‹</label>
                            <label><input type="radio" name="intention2" value="4">4 åŒæ„</label>
                            <label><input type="radio" name="intention2" value="5">5 éå¸¸åŒæ„</label>
                        </div>
                    </div>

                    <div class="survey-item">
                        <p class="survey-question">3. åœ¨æ¡ä»¶å…è®¸çš„æƒ…å†µä¸‹ï¼Œæˆ‘æ„¿æ„é¢‘ç¹ä½¿ç”¨AI-CDSSå¼€å±•æ—¥å¸¸è¯Šç–—</p>
                        <div class="likert-scale">
                            <label><input type="radio" name="intention3" value="1">1 éå¸¸ä¸åŒæ„</label>
                            <label><input type="radio" name="intention3" value="2">2 ä¸åŒæ„</label>
                            <label><input type="radio" name="intention3" value="3">3 ä¸­ç«‹</label>
                            <label><input type="radio" name="intention3" value="4">4 åŒæ„</label>
                            <label><input type="radio" name="intention3" value="5">5 éå¸¸åŒæ„</label>
                        </div>
                    </div>
                </div>

                <!-- æ„ŸçŸ¥æœ‰ç”¨æ€§ -->
                <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                    <h3 style="font-size: 15px; color: #2c3e50; margin-bottom: 15px;">B. æ„ŸçŸ¥æœ‰ç”¨æ€§</h3>

                    <div class="survey-item">
                        <p class="survey-question">1. åœ¨å·¥ä½œä¸­ä½¿ç”¨AI-CDSSèƒ½è®©æˆ‘æ›´å¿«åœ°å®Œæˆä»»åŠ¡</p>
                        <div class="likert-scale-7">
                            <label><input type="radio" name="usefulness1" value="1">1 éå¸¸ä¸åŒæ„</label>
                            <label><input type="radio" name="usefulness1" value="2">2 ä¸åŒæ„</label>
                            <label><input type="radio" name="usefulness1" value="3">3 æœ‰ç‚¹ä¸åŒæ„</label>
                            <label><input type="radio" name="usefulness1" value="4">4 ä¸­ç«‹</label>
                            <label><input type="radio" name="usefulness1" value="5">5 æœ‰ç‚¹åŒæ„</label>
                            <label><input type="radio" name="usefulness1" value="6">6 åŒæ„</label>
                            <label><input type="radio" name="usefulness1" value="7">7 éå¸¸åŒæ„</label>
                        </div>
                    </div>

                    <div class="survey-item">
                        <p class="survey-question">2. ä½¿ç”¨AI-CDSSä¼šæé«˜æˆ‘çš„å·¥ä½œè¡¨ç°</p>
                        <div class="likert-scale-7">
                            <label><input type="radio" name="usefulness2" value="1">1 éå¸¸ä¸åŒæ„</label>
                            <label><input type="radio" name="usefulness2" value="2">2 ä¸åŒæ„</label>
                            <label><input type="radio" name="usefulness2" value="3">3 æœ‰ç‚¹ä¸åŒæ„</label>
                            <label><input type="radio" name="usefulness2" value="4">4 ä¸­ç«‹</label>
                            <label><input type="radio" name="usefulness2" value="5">5 æœ‰ç‚¹åŒæ„</label>
                            <label><input type="radio" name="usefulness2" value="6">6 åŒæ„</label>
                            <label><input type="radio" name="usefulness2" value="7">7 éå¸¸åŒæ„</label>
                        </div>
                    </div>

                    <div class="survey-item">
                        <p class="survey-question">3. åœ¨å·¥ä½œä¸­ä½¿ç”¨AI-CDSSä¼šæé«˜æˆ‘çš„å·¥ä½œæ•ˆç‡</p>
                        <div class="likert-scale-7">
                            <label><input type="radio" name="usefulness3" value="1">1 éå¸¸ä¸åŒæ„</label>
                            <label><input type="radio" name="usefulness3" value="2">2 ä¸åŒæ„</label>
                            <label><input type="radio" name="usefulness3" value="3">3 æœ‰ç‚¹ä¸åŒæ„</label>
                            <label><input type="radio" name="usefulness3" value="4">4 ä¸­ç«‹</label>
                            <label><input type="radio" name="usefulness3" value="5">5 æœ‰ç‚¹åŒæ„</label>
                            <label><input type="radio" name="usefulness3" value="6">6 åŒæ„</label>
                            <label><input type="radio" name="usefulness3" value="7">7 éå¸¸åŒæ„</label>
                        </div>
                    </div>


                    <div class="survey-item">
                        <p class="survey-question">4. ä½¿ç”¨AI-CDSSä¼šå¢å¼ºæˆ‘çš„å·¥ä½œæœ‰æ•ˆæ€§</p>
                        <div class="likert-scale-7">
                            <label><input type="radio" name="usefulness4" value="1">1 éå¸¸ä¸åŒæ„</label>
                            <label><input type="radio" name="usefulness4" value="2">2 ä¸åŒæ„</label>
                            <label><input type="radio" name="usefulness4" value="3">3 æœ‰ç‚¹ä¸åŒæ„</label>
                            <label><input type="radio" name="usefulness4" value="4">4 ä¸­ç«‹</label>
                            <label><input type="radio" name="usefulness4" value="5">5 æœ‰ç‚¹åŒæ„</label>
                            <label><input type="radio" name="usefulness4" value="6">6 åŒæ„</label>
                            <label><input type="radio" name="usefulness4" value="7">7 éå¸¸åŒæ„</label>
                        </div>
                    </div>

                    <div class="survey-item">
                        <p class="survey-question">5. ä½¿ç”¨AI-CDSSä¼šè®©æˆ‘çš„å·¥ä½œæ›´è½»æ¾</p>
                        <div class="likert-scale-7">
                            <label><input type="radio" name="usefulness5" value="1">1 éå¸¸ä¸åŒæ„</label>
                            <label><input type="radio" name="usefulness5" value="2">2 ä¸åŒæ„</label>
                            <label><input type="radio" name="usefulness5" value="3">3 æœ‰ç‚¹ä¸åŒæ„</label>
                            <label><input type="radio" name="usefulness5" value="4">4 ä¸­ç«‹</label>
                            <label><input type="radio" name="usefulness5" value="5">5 æœ‰ç‚¹åŒæ„</label>
                            <label><input type="radio" name="usefulness5" value="6">6 åŒæ„</label>
                            <label><input type="radio" name="usefulness5" value="7">7 éå¸¸åŒæ„</label>
                        </div>
                    </div>

                    <div class="survey-item">
                        <p class="survey-question">6. æˆ‘è®¤ä¸ºAI-CDSSåœ¨å·¥ä½œä¸­æ˜¯æœ‰ç”¨çš„</p>
                        <div class="likert-scale-7">
                            <label><input type="radio" name="usefulness6" value="1">1 éå¸¸ä¸åŒæ„</label>
                            <label><input type="radio" name="usefulness6" value="2">2 ä¸åŒæ„</label>
                            <label><input type="radio" name="usefulness6" value="3">3 æœ‰ç‚¹ä¸åŒæ„</label>
                            <label><input type="radio" name="usefulness6" value="4">4 ä¸­ç«‹</label>
                            <label><input type="radio" name="usefulness6" value="5">5 æœ‰ç‚¹åŒæ„</label>
                            <label><input type="radio" name="usefulness6" value="6">6 åŒæ„</label>
                            <label><input type="radio" name="usefulness6" value="7">7 éå¸¸åŒæ„</label>
                        </div>
                    </div>
                </div>

                <!-- æ„ŸçŸ¥æ˜“ç”¨æ€§ -->
                <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                    <h3 style="font-size: 15px; color: #2c3e50; margin-bottom: 15px;">C. æ„ŸçŸ¥æ˜“ç”¨æ€§</h3>

                    <div class="survey-item">
                        <p class="survey-question">1. å­¦ä¹ æ“ä½œAI-CDSSå¯¹æˆ‘æ¥è¯´ä¼šå¾ˆå®¹æ˜“</p>
                        <div class="likert-scale-7">
                            <label><input type="radio" name="easeOfUse1" value="1">1 éå¸¸ä¸åŒæ„</label>
                            <label><input type="radio" name="easeOfUse1" value="2">2 ä¸åŒæ„</label>
                            <label><input type="radio" name="easeOfUse1" value="3">3 æœ‰ç‚¹ä¸åŒæ„</label>
                            <label><input type="radio" name="easeOfUse1" value="4">4 ä¸­ç«‹</label>
                            <label><input type="radio" name="easeOfUse1" value="5">5 æœ‰ç‚¹åŒæ„</label>
                            <label><input type="radio" name="easeOfUse1" value="6">6 åŒæ„</label>
                            <label><input type="radio" name="easeOfUse1" value="7">7 éå¸¸åŒæ„</label>
                        </div>
                    </div>

                    <div class="survey-item">
                        <p class="survey-question">2. æˆ‘å‘ç°è®©AI-CDSSå®Œæˆæˆ‘æƒ³è¦çš„æ“ä½œå¾ˆå®¹æ˜“</p>
                        <div class="likert-scale-7">
                            <label><input type="radio" name="easeOfUse2" value="1">1 éå¸¸ä¸åŒæ„</label>
                            <label><input type="radio" name="easeOfUse2" value="2">2 ä¸åŒæ„</label>
                            <label><input type="radio" name="easeOfUse2" value="3">3 æœ‰ç‚¹ä¸åŒæ„</label>
                            <label><input type="radio" name="easeOfUse2" value="4">4 ä¸­ç«‹</label>
                            <label><input type="radio" name="easeOfUse2" value="5">5 æœ‰ç‚¹åŒæ„</label>
                            <label><input type="radio" name="easeOfUse2" value="6">6 åŒæ„</label>
                            <label><input type="radio" name="easeOfUse2" value="7">7 éå¸¸åŒæ„</label>
                        </div>
                    </div>

                    <div class="survey-item">
                        <p class="survey-question">3. æˆ‘ä¸AI-CDSSçš„äº¤äº’æ˜¯æ¸…æ™°æ˜“æ‡‚çš„</p>
                        <div class="likert-scale-7">
                            <label><input type="radio" name="easeOfUse3" value="1">1 éå¸¸ä¸åŒæ„</label>
                            <label><input type="radio" name="easeOfUse3" value="2">2 ä¸åŒæ„</label>
                            <label><input type="radio" name="easeOfUse3" value="3">3 æœ‰ç‚¹ä¸åŒæ„</label>
                            <label><input type="radio" name="easeOfUse3" value="4">4 ä¸­ç«‹</label>
                            <label><input type="radio" name="easeOfUse3" value="5">5 æœ‰ç‚¹åŒæ„</label>
                            <label><input type="radio" name="easeOfUse3" value="6">6 åŒæ„</label>
                            <label><input type="radio" name="easeOfUse3" value="7">7 éå¸¸åŒæ„</label>
                        </div>
                    </div>

                    <div class="survey-item">
                        <p class="survey-question">4. æˆ‘å‘ç°AI-CDSSçš„äº¤äº’æ–¹å¼æ˜¯çµæ´»çš„</p>
                        <div class="likert-scale-7">
                            <label><input type="radio" name="easeOfUse4" value="1">1 éå¸¸ä¸åŒæ„</label>
                            <label><input type="radio" name="easeOfUse4" value="2">2 ä¸åŒæ„</label>
                            <label><input type="radio" name="easeOfUse4" value="3">3 æœ‰ç‚¹ä¸åŒæ„</label>
                            <label><input type="radio" name="easeOfUse4" value="4">4 ä¸­ç«‹</label>
                            <label><input type="radio" name="easeOfUse4" value="5">5 æœ‰ç‚¹åŒæ„</label>
                            <label><input type="radio" name="easeOfUse4" value="6">6 åŒæ„</label>
                            <label><input type="radio" name="easeOfUse4" value="7">7 éå¸¸åŒæ„</label>
                        </div>
                    </div>

                    <div class="survey-item">
                        <p class="survey-question">5. æˆ‘èƒ½å¤Ÿå¾ˆå®¹æ˜“åœ°ç†Ÿç»ƒä½¿ç”¨AI-CDSS</p>
                        <div class="likert-scale-7">
                            <label><input type="radio" name="easeOfUse5" value="1">1 éå¸¸ä¸åŒæ„</label>
                            <label><input type="radio" name="easeOfUse5" value="2">2 ä¸åŒæ„</label>
                            <label><input type="radio" name="easeOfUse5" value="3">3 æœ‰ç‚¹ä¸åŒæ„</label>
                            <label><input type="radio" name="easeOfUse5" value="4">4 ä¸­ç«‹</label>
                            <label><input type="radio" name="easeOfUse5" value="5">5 æœ‰ç‚¹åŒæ„</label>
                            <label><input type="radio" name="easeOfUse5" value="6">6 åŒæ„</label>
                            <label><input type="radio" name="easeOfUse5" value="7">7 éå¸¸åŒæ„</label>
                        </div>
                    </div>

                    <div class="survey-item">
                        <p class="survey-question">6. æˆ‘è®¤ä¸ºAI-CDSSæ˜“äºä½¿ç”¨</p>
                        <div class="likert-scale-7">
                            <label><input type="radio" name="easeOfUse6" value="1">1 éå¸¸ä¸åŒæ„</label>
                            <label><input type="radio" name="easeOfUse6" value="2">2 ä¸åŒæ„</label>
                            <label><input type="radio" name="easeOfUse6" value="3">3 æœ‰ç‚¹ä¸åŒæ„</label>
                            <label><input type="radio" name="easeOfUse6" value="4">4 ä¸­ç«‹</label>
                            <label><input type="radio" name="easeOfUse6" value="5">5 æœ‰ç‚¹åŒæ„</label>
                            <label><input type="radio" name="easeOfUse6" value="6">6 åŒæ„</label>
                            <label><input type="radio" name="easeOfUse6" value="7">7 éå¸¸åŒæ„</label>
                        </div>
                    </div>
                </div>
            </div>

            <button class="welcome-btn" onclick="submitSystemSurvey()">æäº¤è¯„ä»·</button>
        </div>
    </div>

    <!-- åŠ³åŠ¡è´¹ä¿¡æ¯æ”¶é›†ï¼ˆå®éªŒå®Œæˆåæ˜¾ç¤ºï¼‰ -->
    <div id="paymentInfoOverlay" class="welcome-overlay" style="display: none;">
        <div class="welcome-box" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
            <h2>ğŸ‰ å®éªŒå·²å®Œæˆï¼</h2>
            <p style="font-size: 14px; margin-bottom: 15px; color: #27ae60; font-weight: 600;">æ„Ÿè°¢æ‚¨å®Œæˆæ‰€æœ‰å®éªŒå†…å®¹ï¼</p>

            <!-- ä¿¡æ¯å®‰å…¨è¯´æ˜ -->
            <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #1976d2;">
                <h3 style="font-size: 15px; color: #27ae60; margin-bottom: 10px;"> ä¿¡æ¯å®‰å…¨ä¿éšœè¯´æ˜</h3>
                <p style="font-size: 13px; color: #424242; line-height: 1.8; margin: 0;">
                    ä»¥ä¸‹ä¿¡æ¯å°†æäº¤è‡³<strong>åä¸­ç§‘æŠ€å¤§å­¦</strong>ï¼Œç”±<strong>åä¸­ç§‘æŠ€å¤§å­¦åˆ˜æ™¨æ›¦å›¢é˜Ÿ</strong>è´Ÿè´£ä¿ç®¡ã€‚<br>
                    æ‰€æœ‰ä¿¡æ¯<strong>ä»…ç”¨äºåŠ³åŠ¡æŠ¥é…¬ç”³è¯·</strong>ï¼Œæˆ‘ä»¬æ‰¿è¯º<strong>ç»ä¸å¤–æ³„</strong>æ‚¨çš„ä»»ä½•ä¸ªäººä¿¡æ¯ã€‚
                </p>
            </div>

            <div style="text-align: left;">
                <div class="input-group" style="margin-bottom: 15px;">
                    <label style="font-weight: 600; margin-bottom: 8px; display: block;">1. èº«ä»½è¯å· <span class="required-mark">*</span></label>
                    <input type="text" id="idCard" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;" placeholder="è¯·è¾“å…¥18ä½èº«ä»½è¯å·" maxlength="18">
                    <small style="color: #718096; font-size: 12px;">è¯·è¾“å…¥18ä½èº«ä»½è¯å·ç </small>
                </div>

                <div class="input-group" style="margin-bottom: 15px;">
                    <label style="font-weight: 600; margin-bottom: 8px; display: block;">2. æ‰‹æœºå· <span class="required-mark">*</span></label>
                    <input type="tel" id="phone" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;" placeholder="è¯·è¾“å…¥11ä½æ‰‹æœºå·" maxlength="11">
                    <small style="color: #718096; font-size: 12px;">è¯·è¾“å…¥11ä½æ‰‹æœºå·ç </small>
                </div>

                <div class="input-group" style="margin-bottom: 15px;">
                    <label style="font-weight: 600; margin-bottom: 8px; display: block;">3. å·¥ä½œå•ä½ <span class="required-mark">*</span></label>
                    <input type="text" id="workplace" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;" placeholder="è¯·è¾“å…¥å®Œæ•´çš„å·¥ä½œå•ä½åç§°">
                    <small style="color: #718096; font-size: 12px;">ä¾‹å¦‚ï¼šXXçœXXå¸‚XXç¤¾åŒºå«ç”ŸæœåŠ¡ä¸­å¿ƒ</small>
                </div>

                <div class="input-group" style="margin-bottom: 15px;">
                    <label style="font-weight: 600; margin-bottom: 8px; display: block;">4. é“¶è¡Œå¡å· <span class="required-mark">*</span></label>
                    <input type="text" id="bankCard" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;" placeholder="è¯·è¾“å…¥é“¶è¡Œå¡å·" maxlength="19">
                    <small style="color: #718096; font-size: 12px;">è¯·è¾“å…¥ç”¨äºæ¥æ”¶æŠ¥é…¬çš„é“¶è¡Œå¡å·</small>
                </div>

                <div class="input-group" style="margin-bottom: 15px;">
                    <label style="font-weight: 600; margin-bottom: 8px; display: block;">5. å¼€æˆ·åœ°åŒº <span class="required-mark">*</span></label>
                    <input type="text" id="bankRegion" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;" placeholder="è¯·è¾“å…¥å¼€æˆ·åœ°åŒº">
                    <small style="color: #718096; font-size: 12px;">ä¾‹å¦‚ï¼šåŒ—äº¬å¸‚æœé˜³åŒº</small>
                </div>

                <div class="input-group" style="margin-bottom: 20px;">
                    <label style="font-weight: 600; margin-bottom: 8px; display: block;">6. å¼€æˆ·è¡Œ <span class="required-mark">*</span></label>
                    <input type="text" id="bankName" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;" placeholder="è¯·è¾“å…¥å¼€æˆ·è¡Œåç§°">
                    <small style="color: #718096; font-size: 12px;">ä¾‹å¦‚ï¼šä¸­å›½å·¥å•†é“¶è¡ŒåŒ—äº¬æœé˜³æ”¯è¡Œ</small>
                </div>
            </div>

            <button class="welcome-btn" onclick="submitPaymentInfo()">æäº¤ä¿¡æ¯å¹¶å®Œæˆå®éªŒ</button>

            <div style="margin-top: 15px; padding: 10px; background: #f5f5f5; border-radius: 6px;">
                <p style="font-size: 12px; color: #718096; margin: 0; text-align: center;">
                    ğŸ’¡ æäº¤åï¼ŒåŠ³åŠ¡æŠ¥é…¬å°†åœ¨å®¡æ ¸é€šè¿‡åå‘æ”¾è‡³æ‚¨çš„é“¶è¡Œè´¦æˆ·
                </p>
            </div>
        </div>
    </div>

    <div class="main-wrapper" id="mainContent" style="display: none;">
        <div class="header">
            <span class="save-status" id="saveStatus">å·²ä¿å­˜</span>
            <h1>AIä¸´åºŠå†³ç­–æ”¯æŒç³»ç»Ÿ - å‘¼å¸é“æ„ŸæŸ“è¯Šç–—</h1>
            <div class="experiment-tag" id="experimentTag">åŠ è½½ä¸­...</div>
        </div>

        <div class="case-navigation" id="caseNavigation">
            <div class="progress-header">
                <div class="progress-title">å®éªŒè¿›åº¦</div>
                <div class="progress-stats">
                    <div class="progress-stat-item">
                        <span class="progress-stat-label">å·²å®Œæˆ:</span>
                        <span class="progress-stat-value" id="completedCount">0/9</span>
                    </div>
                    <div class="progress-stat-item">
                        <span class="progress-stat-label">å½“å‰:</span>
                        <span class="progress-stat-value" id="currentCase">æ¡ˆä¾‹1</span>
                    </div>
                </div>
            </div>
            <div class="progress-bar-wrapper">
                <div class="progress-bar-bg">
                    <div class="progress-bar-fill" id="progressBarFill" style="width: 0%">
                        <span class="progress-bar-text" id="progressBarText">0%</span>
                    </div>
                </div>
            </div>
            <div id="caseNavigationContent"></div>
        </div>

        <div class="content-layout">
            <div class="main-content">
                <div id="caseContentArea">
                    <div class="panel">
                        <div class="panel-title">æ‚£è€…ç—…å†ä¿¡æ¯</div>
                        <div class="input-group">
                            <label>å®Œæ•´ç—…å†</label>
                            <textarea id="medicalRecordDisplay" class="medical-record-textarea" readonly></textarea>
                            <button class="copy-btn" onclick="copyMedicalRecord()" id="copyBtn">ğŸ“‹ ä¸€é”®å¤åˆ¶ç—…å†</button>
                        </div>
                    </div>

                    <div class="panel">
                        <div class="panel-title">è¯Šç–—å†³ç­–</div>
                        <div id="initialDecisionSection">
                            <div style="background: #d4edda; color: #155724; padding: 8px 12px; border-radius: 4px; margin-bottom: 15px; font-size: 12px; font-weight: 600;">
                                é˜¶æ®µ1:åˆæ­¥è¯Šæ–­(æœªçœ‹AIå»ºè®®)
                            </div>
                            <div class="input-group">
                                <label>è¯Šæ–­(æŒ‰å¯èƒ½æ€§ä»å¤§åˆ°å°æ’åˆ—)<span class="required-mark">*</span></label>
                                <div class="help-text">ç¬¬ä¸€è¯Šæ–­å¿…å¡«ï¼Œç¬¬äºŒã€ç¬¬ä¸‰è¯Šæ–­é€‰å¡«</div>
                                <div class="diagnosis-list">
                                    <div class="diagnosis-item"><span style="font-size: 13px; color: #718096;">æœ€å¯èƒ½:</span><input type="text" id="initialDiag1" placeholder="ç¬¬ä¸€è¯Šæ–­ï¼ˆå¿…å¡«ï¼‰"></div>
                                    <div class="diagnosis-item"><span style="font-size: 13px; color: #718096;">æ¬¡å¯èƒ½:</span><input type="text" id="initialDiag2" placeholder="ç¬¬äºŒè¯Šæ–­ï¼ˆé€‰å¡«ï¼‰"></div>
                                    <div class="diagnosis-item"><span style="font-size: 13px; color: #718096;">ç¬¬ä¸‰å¯èƒ½:</span><input type="text" id="initialDiag3" placeholder="ç¬¬ä¸‰è¯Šæ–­ï¼ˆé€‰å¡«ï¼‰"></div>
                                </div>
                            </div>
                            <div class="input-group">
                                <label>æ˜¯å¦ä½¿ç”¨æŠ—ç”Ÿç´  <span class="required-mark">*</span></label>
                                <div class="radio-group">
                                    <label><input type="radio" name="initialAntibiotic" value="no">å¦,ä¸ä½¿ç”¨æŠ—ç”Ÿç´ </label>
                                    <label><input type="radio" name="initialAntibiotic" value="yes">æ˜¯,éœ€è¦ä½¿ç”¨æŠ—ç”Ÿç´ </label>
                                </div>
                            </div>
                            <div class="input-group hidden" id="initialAntibioticTypes">
                                <label>è¯·å¡«å†™æŠ—ç”Ÿç´ ç§ç±»<span class="required-mark">*</span></label>
                                <input type="text" id="initialAntibioticInput" placeholder="ä¾‹å¦‚:é˜¿è«è¥¿æ—ã€å¤´å­¢æ°¨è‹„">
                            </div>
                            <div class="action-buttons">
                                <button class="btn btn-ai-suggest" onclick="submitInitialDecision()">ğŸ“Š æäº¤å¹¶è·å–AIå»ºè®®</button>
                            </div>
                        </div>

                        <div id="finalDecisionSection" class="hidden">
                            <div style="background: #cfe2ff; color: #084298; padding: 8px 12px; border-radius: 4px; margin-bottom: 15px; font-size: 12px; font-weight: 600;">
                                é˜¶æ®µ2:æœ€ç»ˆå†³ç­–(æ­¤é˜¶æ®µå¯ä¿®æ”¹åˆæ­¥å†³ç­–çš„ç»“æœ)
                            </div>
                            <div class="input-group">
                                <label>è¯Šæ–­(æŒ‰å¯èƒ½æ€§ä»å¤§åˆ°å°æ’åˆ—)<span class="required-mark">*</span></label>
                                <div class="help-text" style="font-size: 12px; color: #718096; margin-bottom: 8px;">ç¬¬ä¸€è¯Šæ–­å¿…å¡«ï¼Œç¬¬äºŒã€ç¬¬ä¸‰è¯Šæ–­é€‰å¡«</div>
                                <div class="diagnosis-list">
                                    <div class="diagnosis-item"><span style="font-size: 13px; color: #718096;">æœ€å¯èƒ½:</span><input type="text" id="finalDiag1" placeholder="ç¬¬ä¸€è¯Šæ–­ï¼ˆå¿…å¡«ï¼‰"></div>
                                    <div class="diagnosis-item"><span style="font-size: 13px; color: #718096;">æ¬¡å¯èƒ½:</span><input type="text" id="finalDiag2" placeholder="ç¬¬äºŒè¯Šæ–­ï¼ˆé€‰å¡«ï¼‰"></div>
                                    <div class="diagnosis-item"><span style="font-size: 13px; color: #718096;">ç¬¬ä¸‰å¯èƒ½:</span><input type="text" id="finalDiag3" placeholder="ç¬¬ä¸‰è¯Šæ–­ï¼ˆé€‰å¡«ï¼‰"></div>
                                </div>
                            </div>
                            <div class="input-group">
                                <label>æ˜¯å¦ä½¿ç”¨æŠ—ç”Ÿç´  <span class="required-mark">*</span></label>
                                <div class="radio-group">
                                    <label><input type="radio" name="finalAntibiotic" value="no">å¦,ä¸ä½¿ç”¨æŠ—ç”Ÿç´ </label>
                                    <label><input type="radio" name="finalAntibiotic" value="yes">æ˜¯,éœ€è¦ä½¿ç”¨æŠ—ç”Ÿç´ </label>
                                </div>
                            </div>
                            <div class="input-group hidden" id="finalAntibioticTypes">
                                <label>è¯·å¡«å†™æŠ—ç”Ÿç´ ç§ç±»<span class="required-mark">*</span></label>
                                <input type="text" id="finalAntibioticInput">
                            </div>
                            <div class="input-group">
                                <label>å†³ç­–ç¡®å®šæ€§ <span class="required-mark">*</span></label>
                                <div class="radio-group">
                                    <label><input type="radio" name="certainty" value="1">1 - éå¸¸ä¸ç¡®å®š</label>
                                    <label><input type="radio" name="certainty" value="2">2 - ä¸ç¡®å®š</label>
                                    <label><input type="radio" name="certainty" value="3">3 - ä¸€èˆ¬</label>
                                    <label><input type="radio" name="certainty" value="4">4 - ç¡®å®š</label>
                                    <label><input type="radio" name="certainty" value="5">5 - éå¸¸ç¡®å®š</label>
                                </div>
                            </div>
                            <div class="action-buttons">
                                <button class="btn btn-success" onclick="submitFinalDecision()">æäº¤æœ€ç»ˆå†³ç­–</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="completionArea" class="hidden">
                    <div style="background: #d4edda; border: 2px solid #27ae60; border-radius: 6px; padding: 30px; text-align: center;">
                        <h2 style="color: #155724;">âœ“ å®éªŒå·²å®Œæˆ</h2>
                        <p style="margin-top: 15px;">æ„Ÿè°¢æ‚¨çš„å‚ä¸!æ‰€æœ‰9ä¸ªæ¡ˆä¾‹å·²å®Œæˆã€‚</p>
                        <p style="font-size: 13px; color: #718096; margin-top: 15px;">å‚ä¸è€…:<span id="completedParticipantId" style="font-weight: 600;"></span></p>
                    </div>
                </div>
            </div>

            <div class="ai-sidebar" id="aiSidebar">
                <div class="ai-sidebar-header">
                    <h3>ğŸ¤– AIè¾…åŠ©è¯Šç–—ç³»ç»Ÿ</h3>
                    <div style="font-size: 11px; opacity: 0.9; margin-top: 4px;">æ™ºèƒ½åˆ†æ Â· è¾…åŠ©å†³ç­–</div>
                </div>
                <div class="ai-sidebar-content">
                    <div class="ai-section hidden" id="pasteSectionSidebar">
                        <div class="ai-section-title">ğŸ“‹ è¯·å¤åˆ¶ç²˜è´´ç—…å†å†…å®¹</div>
                        <div style="color: #718096; font-size: 13px; line-height: 1.6; margin-bottom: 16px;">
                            ä¸ºäº†è®©AIç³»ç»Ÿåˆ†æç—…å†,è¯·å°†å·¦ä¾§çš„å®Œæ•´ç—…å†å†…å®¹å¤åˆ¶ç²˜è´´åˆ°ä¸‹æ–¹æ–‡æœ¬æ¡†ä¸­:
                        </div>
                        <textarea id="pasteTextareaSidebar" class="medical-record-textarea" placeholder="è¯·åœ¨æ­¤å¤„ç²˜è´´å®Œæ•´ç—…å†å†…å®¹..." style="margin-bottom: 16px;"></textarea>
                        <div style="text-align: right;">
                            <button class="btn btn-primary" onclick="submitPastedContentSidebar()">âœ“ æäº¤å¹¶è·å–AIå»ºè®®</button>
                        </div>
                    </div>

                    <div class="ai-section hidden" id="diagnosisSection">
                        <div class="ai-section-title">ğŸ¯ è¯Šç–—å»ºè®®</div>
                        <div id="diagnosisContent"></div>
                    </div>

                    <div class="ai-section hidden" id="thinkingSection">
                        <div class="ai-section-title">ğŸ’­ AIæ¨ç†è¿‡ç¨‹</div>
                        <div class="thinking-process" id="thinkingProcess"></div>
                    </div>

                    <div class="ai-section hidden" id="featureSection">
                        <div class="ai-section-title">ğŸ“Š å…³é”®ç‰¹å¾åˆ†æ</div>
                        <div class="ig-visualization">
                            <div class="ig-title">ç—…å†ç‰¹å¾å¯¹è¯Šæ–­çš„å½±å“ç¨‹åº¦</div>
                            <div class="ig-explain">
                                æ­¤å›¾æ˜¾ç¤ºå„é¡¹ç—…å†ä¿¡æ¯å¯¹AIè¯Šæ–­å†³ç­–çš„è´¡çŒ®åº¦ã€‚<strong style="color: #27ae60;">ç»¿è‰²</strong>è¡¨ç¤ºè¯¥ç‰¹å¾æ”¯æŒå½“å‰è¯Šæ–­,<strong style="color: #e74c3c;">çº¢è‰²</strong>è¡¨ç¤ºè¯¥ç‰¹å¾ä¸æ”¯æŒå½“å‰è¯Šæ–­ã€‚æ•°å€¼è¶Šå¤§,å½±å“è¶Šæ˜¾è‘—ã€‚
                            </div>
                            <div class="ig-chart-container">
                                <canvas id="igChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="ai-section hidden" id="treatmentSection">
                        <div class="ai-section-title">ğŸ’Š ç”¨è¯å»ºè®®åŠè¯´æ˜</div>
                        <div id="treatmentContent"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="ai-modal-overlay" id="aiModalOverlay">
            <div class="ai-modal" id="aiModal">
                <div class="ai-modal-header">
                    <div>
                        <h3>ğŸ¤– AIè¾…åŠ©è¯Šç–—ç³»ç»Ÿ</h3>
                        <div style="font-size: 11px; opacity: 0.9; margin-top: 4px;">æ™ºèƒ½åˆ†æ Â· è¾…åŠ©å†³ç­–</div>
                    </div>
                    <div class="ai-modal-controls">
                        <button class="ai-modal-btn" onclick="toggleMinimizeModal()" title="æœ€å°åŒ–">
                            <span id="minimizeIcon">âˆ’</span>
                        </button>
                    </div>
                </div>
                <div class="ai-modal-content">
                    <div class="ai-section hidden" id="pasteSectionModal">
                        <div class="ai-section-title">ğŸ“‹ è¯·å¤åˆ¶ç²˜è´´ç—…å†å†…å®¹</div>
                        <div style="color: #718096; font-size: 13px; line-height: 1.6; margin-bottom: 16px;">
                            ä¸ºäº†è®©AIç³»ç»Ÿåˆ†æç—…å†,è¯·å°†å·¦ä¾§çš„å®Œæ•´ç—…å†å†…å®¹å¤åˆ¶ç²˜è´´åˆ°ä¸‹æ–¹æ–‡æœ¬æ¡†ä¸­:
                        </div>
                        <textarea id="pasteTextareaModal" class="medical-record-textarea" placeholder="è¯·åœ¨æ­¤å¤„ç²˜è´´å®Œæ•´ç—…å†å†…å®¹..." style="margin-bottom: 16px;"></textarea>
                        <div style="text-align: right;">
                            <button class="btn btn-primary" onclick="submitPastedContentModal()">âœ“ æäº¤å¹¶è·å–AIå»ºè®®</button>
                        </div>
                    </div>

                    <div class="ai-section hidden" id="diagnosisSectionModal">
                        <div class="ai-section-title">ğŸ¯ è¯Šç–—å»ºè®®</div>
                        <div id="diagnosisContentModal"></div>
                    </div>

                    <div class="ai-section hidden" id="thinkingSectionModal">
                        <div class="ai-section-title">ğŸ’­ AIæ¨ç†è¿‡ç¨‹</div>
                        <div class="thinking-process" id="thinkingProcessModal"></div>
                    </div>

                    <div class="ai-section hidden" id="featureSectionModal">
                        <div class="ai-section-title">ğŸ“Š å…³é”®ç‰¹å¾åˆ†æ</div>
                        <div class="ig-visualization">
                            <div class="ig-title">ç—…å†ç‰¹å¾å¯¹è¯Šæ–­çš„å½±å“ç¨‹åº¦</div>
                            <div class="ig-explain">
                                æ­¤å›¾æ˜¾ç¤ºå„é¡¹ç—…å†ä¿¡æ¯å¯¹AIè¯Šæ–­å†³ç­–çš„è´¡çŒ®åº¦ã€‚<strong style="color: #27ae60;">ç»¿è‰²</strong>è¡¨ç¤ºè¯¥ç‰¹å¾æ”¯æŒå½“å‰è¯Šæ–­,<strong style="color: #e74c3c;">çº¢è‰²</strong>è¡¨ç¤ºè¯¥ç‰¹å¾ä¸æ”¯æŒå½“å‰è¯Šæ–­ã€‚æ•°å€¼è¶Šå¤§,å½±å“è¶Šæ˜¾è‘—ã€‚
                            </div>
                            <div class="ig-chart-container">
                                <canvas id="igChartModal"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="ai-section hidden" id="treatmentSectionModal">
                        <div class="ai-section-title">ğŸ’Š ç”¨è¯å»ºè®®åŠè¯´æ˜</div>
                        <div id="treatmentContentModal"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== äº¤äº’è¿½è¸ªç³»ç»Ÿ ====================
        const MouseTracker = {
            isTracking: false,
            currentTask: null,
            trajectory: [],
            startTime: null,
            startPosition: null,
            targetElement: null,
            targetPosition: null,
            targetSize: null,

            // åˆå§‹åŒ–è¿½è¸ª
            startTracking(taskName, targetElement) {
                this.isTracking = true;
                this.currentTask = taskName;
                this.trajectory = [];
                this.startTime = Date.now();
                this.targetElement = targetElement;

                // è·å–ç›®æ ‡å…ƒç´ çš„ä½ç½®å’Œå¤§å°
                if (targetElement) {
                    const rect = targetElement.getBoundingClientRect();
                    this.targetPosition = {
                        x: rect.left + rect.width / 2,
                        y: rect.top + rect.height / 2
                    };
                    this.targetSize = {
                        width: rect.width,
                        height: rect.height
                    };
                }

                // è®°å½•èµ·å§‹ä½ç½®
                this.startPosition = { x: 0, y: 0 };


            },

            // åœæ­¢è¿½è¸ª
            stopTracking() {
                this.isTracking = false;

            },

            // è®°å½•ç§»åŠ¨
            recordMouseMove(event) {
                if (!this.isTracking) return;

                const currentTime = Date.now();
                const point = {
                    x: event.clientX,
                    y: event.clientY,
                    timestamp: currentTime,
                    timeFromStart: currentTime - this.startTime
                };

                this.trajectory.push(point);

                // å¦‚æœè¿™æ˜¯ç¬¬ä¸€ä¸ªç‚¹ï¼Œè®¾ç½®ä¸ºèµ·å§‹ä½ç½®
                if (this.trajectory.length === 1) {
                    this.startPosition = { x: point.x, y: point.y };
                }
            },

            // è®¡ç®—è¿½è¸ªæŒ‡æ ‡
            calculateMetrics() {
                if (this.trajectory.length < 2) {
                    return null;
                }

                const endTime = Date.now();
                const responseTime = endTime - this.startTime;

                // è®¡ç®—æ€»ç§»åŠ¨è·ç¦»
                let totalDistance = 0;
                for (let i = 1; i < this.trajectory.length; i++) {
                    const dx = this.trajectory[i].x - this.trajectory[i-1].x;
                    const dy = this.trajectory[i].y - this.trajectory[i-1].y;
                    totalDistance += Math.sqrt(dx * dx + dy * dy);
                }

                // è®¡ç®—ç†æƒ³ç›´çº¿è·ç¦»
                const endPosition = this.trajectory[this.trajectory.length - 1];
                const idealDistance = Math.sqrt(
                    Math.pow(endPosition.x - this.startPosition.x, 2) +
                    Math.pow(endPosition.y - this.startPosition.y, 2)
                );

                // è®¡ç®—è½¨è¿¹åå·®ï¼ˆå®é™…è·¯å¾„ä¸ç†æƒ³è·¯å¾„çš„æ¯”å€¼ï¼‰
                const trajectoryDeviation = idealDistance > 0 ? totalDistance / idealDistance : 1;

                // è®¡ç®—åˆ°ç›®æ ‡çš„è·ç¦»åå·®
                let distanceToTarget = null;
                if (this.targetPosition) {
                    const dx = endPosition.x - this.targetPosition.x;
                    const dy = endPosition.y - this.targetPosition.y;
                    distanceToTarget = Math.sqrt(dx * dx + dy * dy);
                }

                // è®¡ç®—å¹³å‡é€Ÿåº¦
                const averageSpeed = totalDistance / responseTime; // åƒç´ /æ¯«ç§’

                // è®¡ç®—é€Ÿåº¦å˜åŒ–ï¼ˆåŠ é€Ÿåº¦æŒ‡æ ‡ï¼‰
                const velocities = [];
                for (let i = 1; i < this.trajectory.length; i++) {
                    const dx = this.trajectory[i].x - this.trajectory[i-1].x;
                    const dy = this.trajectory[i].y - this.trajectory[i-1].y;
                    const dt = this.trajectory[i].timestamp - this.trajectory[i-1].timestamp;
                    if (dt > 0) {
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        velocities.push(distance / dt);
                    }
                }

                let velocityVariance = 0;
                if (velocities.length > 1) {
                    const meanVelocity = velocities.reduce((a, b) => a + b, 0) / velocities.length;
                    velocityVariance = velocities.reduce((sum, v) => sum + Math.pow(v - meanVelocity, 2), 0) / velocities.length;
                }

                // è®¡ç®—æ–¹å‘å˜åŒ–æ¬¡æ•°ï¼ˆè½¬æŠ˜ç‚¹ï¼‰
                let directionChanges = 0;
                for (let i = 2; i < this.trajectory.length; i++) {
                    const dx1 = this.trajectory[i-1].x - this.trajectory[i-2].x;
                    const dy1 = this.trajectory[i-1].y - this.trajectory[i-2].y;
                    const dx2 = this.trajectory[i].x - this.trajectory[i-1].x;
                    const dy2 = this.trajectory[i].y - this.trajectory[i-1].y;

                    const angle1 = Math.atan2(dy1, dx1);
                    const angle2 = Math.atan2(dy2, dx2);
                    const angleDiff = Math.abs(angle2 - angle1);

                    if (angleDiff > Math.PI / 4) { // è¶…è¿‡45åº¦è®¤ä¸ºæ˜¯æ–¹å‘å˜åŒ–
                        directionChanges++;
                    }
                }

                // è®¡ç®—æš‚åœæ¬¡æ•°ï¼ˆé€Ÿåº¦æ¥è¿‘0çš„ç‚¹ï¼‰
                let pauseCount = 0;
                const pauseThreshold = 0.1; // åƒç´ /æ¯«ç§’
                for (let velocity of velocities) {
                    if (velocity < pauseThreshold) {
                        pauseCount++;
                    }
                }

                return {
                    taskName: this.currentTask,
                    responseTime: responseTime, // æ¯«ç§’
                    totalDistance: Math.round(totalDistance), // åƒç´ 
                    idealDistance: Math.round(idealDistance), // åƒç´ 
                    trajectoryDeviation: trajectoryDeviation.toFixed(3), // åå·®æ¯”ç‡
                    distanceToTarget: distanceToTarget ? Math.round(distanceToTarget) : null, // åˆ°ç›®æ ‡çš„è·ç¦»
                    averageSpeed: (averageSpeed * 1000).toFixed(2), // åƒç´ /ç§’
                    velocityVariance: velocityVariance.toFixed(4),
                    directionChanges: directionChanges,
                    pauseCount: pauseCount,
                    samplingPoints: this.trajectory.length,
                    startPosition: this.startPosition,
                    endPosition: endPosition,
                    targetPosition: this.targetPosition,
                    targetSize: this.targetSize,
                    rawTrajectory: this.trajectory // ä¿å­˜å®Œæ•´è½¨è¿¹ç”¨äºè¯¦ç»†åˆ†æ
                };
            },

            // é‡ç½®è¿½è¸ªå™¨
            reset() {
                this.isTracking = false;
                this.currentTask = null;
                this.trajectory = [];
                this.startTime = null;
                this.startPosition = null;
                this.targetElement = null;
                this.targetPosition = null;
                this.targetSize = null;
            }
        };

        // å…¨å±€ç›‘å¬ç§»åŠ¨
        document.addEventListener('mousemove', (event) => {
            MouseTracker.recordMouseMove(event);
        });

        // ========================================
        // ç—…å†æ•°æ®åº“ (9ä¸ªç—…ä¾‹)
        // ç»„1(case001-003): éœ€è¦æŠ—ç”Ÿç´ 
        // ç»„2(case004-006): éƒ¨åˆ†éœ€è¦æŠ—ç”Ÿç´ 
        // ç»„3(case007-009): ä¸éœ€è¦æŠ—ç”Ÿç´ 
        // ========================================
        const CASE_DATABASE = {
    // ç»„1: éœ€è¦ä½¿ç”¨æŠ—ç”Ÿç´ 
    case001: {
        id: "case001",
        patientId: "PT2023001",
        gender: "ç”·",
        age: "37å²",
        visitDate: "2023-12-30",
        chiefComplaint: "å’³å—½3å‘¨",
        presentIllness: "3å‘¨å‰å¼€å§‹å‡ºç°å’³å—½ï¼Œå’³è¾ƒå¤šé»„ç—°ï¼Œæ— ä¼´å’½ç—›ã€å’½ç—’ï¼Œæ— å‘çƒ­ï¼Œè‡ªè§‰èƒ¸é—·æ°”çŸ­ï¼Œæ— èƒ¸ç—›ï¼Œæ— å’¯è¡€ã€‚æ›¾æœç”¨å¤´å­¢ã€é˜¿å¥‡éœ‰ç´ æ²»ç–—ã€‚å¤œé—´å’³å—½æ˜æ˜¾ã€‚",
        personalHistory: "æ— ç‰¹æ®Šï¼Œæ— å¸çƒŸå²ã€‚",
        allergyHistory: "æ— è¯ç‰©è¿‡æ•å²",
        physicalExam: "ä¸€èˆ¬æƒ…å†µå¯ï¼Œå’½éƒ¨å……è¡€ï¼Œå’½åå£æ»¤æ³¡å¢ç”Ÿï¼Œæ‰æ¡ƒä½“æ— è‚¿å¤§ï¼ŒåŒè‚ºå‘¼å¸éŸ³æ¸…ï¼Œå³è‚ºå¯é—»åŠæ¹¿æ€§ç½—éŸ³ã€‚",
        labTests: "èƒ¸ç‰‡å³ä¸‹è‚ºæ–‘ç‰‡å½±",
        aiRecommendation: {
            thinking: [
                "æ‚£è€…æœ‰é»„ç—°ã€å¤œé—´å’³å—½ã€èƒ¸ç‰‡æ–‘ç‰‡å½±ï¼Œå³è‚ºæ¹¿å•°éŸ³",
                "æœ€å¯èƒ½çš„è¯Šæ–­æ˜¯è‚ºç‚ï¼Œå› ä¸ºèƒ¸ç‰‡æ˜¾ç¤ºè‚ºéƒ¨æµ¸æ¶¦ï¼Œä¸”ç—‡çŠ¶ç¬¦åˆæ„ŸæŸ“",
                "å…¶æ¬¡æ˜¯æ”¯æ°”ç®¡æ‰©å¼ ç—‡ï¼Œå› ä¸ºæœ‰æ…¢æ€§å’³å—½å’Œæ¹¿å•°éŸ³",
                "æ€¥æ€§æ”¯æ°”ç®¡ç‚è™½ç„¶å¸¸è§ï¼Œä½†é€šå¸¸æ— è‚ºéƒ¨æµ¸æ¶¦"
            ],
            diagnosis: [
                { name: "è‚ºç‚", confidence: 75 },
                { name: "æ”¯æ°”ç®¡æ‰©å¼ ç—‡", confidence: 50 },
                { name: "æ€¥æ€§æ”¯æ°”ç®¡ç‚", confidence: 25 }
            ],
            featureImportance: {
                features: ["å’³å—½3å‘¨", "37å²", "èƒ¸ç‰‡å³ä¸‹è‚ºæ–‘ç‰‡å½±", "å’³è¾ƒå¤šé»„ç—°", "æ— ä¼´å’½ç—›", "è‡ªè§‰èƒ¸é—·æ°”çŸ­", "å’½ç—’", "å¤œé—´å’³å—½æ˜æ˜¾", "å’½åå£æ»¤æ³¡å¢ç”Ÿ", "æ— èƒ¸ç—›", "æ— å’¯è¡€", "å³è‚ºå¯é—»åŠæ¹¿æ€§ç½—éŸ³"],
                gradients: [1.0000, 0.6097, 0.5616, 0.5486, 0.5133, 0.2434, 0.2286, 0.2118, 0.2028, 0.1551, 0.1128, -0.1123]
            },
            useAntibiotic: true,
            antibioticStandard: "æ ¹æ®èƒ¸ç‰‡å’Œç—‡çŠ¶ï¼Œè‚ºç‚çš„å¯èƒ½æ€§å¤§ï¼Œéœ€ä½¿ç”¨æŠ—ç”Ÿç´ ã€‚é˜¿è«è¥¿æ—å…‹æ‹‰ç»´é…¸é’¾",
            antibioticPrimary: "é˜¿è«è¥¿æ—å…‹æ‹‰ç»´é…¸é’¾",
        }
    },
    case002: {
        id: "case002",
        patientId: "PT2023002",
        gender: "å¥³",
        age: "60å²",
        visitDate: "2023-12-29",
        chiefComplaint: "å’³å—½2å‘¨",
        presentIllness: "2å‘¨å‰å¼€å§‹å‡ºç°å’³å—½ï¼Œå’³å°‘è®¸é»„ç—°ï¼Œæ— ä¼´å’½ç—›ã€å’½ç—’ï¼Œ4å¤©å‰ä¼´å‘çƒ­ï¼Œä½çƒ­ï¼Œä¼´æ°”çŸ­ï¼Œæ— èƒ¸ç—›ï¼Œæ— å’¯è¡€ã€‚æœªæ²»ç–—ã€‚",
        personalHistory: "æ— ç‰¹æ®Šï¼Œæ— å¸çƒŸå²ã€‚",
        allergyHistory: "æ— è¯ç‰©è¿‡æ•å²",
        physicalExam: "ä¸€èˆ¬æƒ…å†µå¯ï¼Œå’½éƒ¨å……è¡€ï¼Œå’½åå£æ»¤æ³¡å¢ç”Ÿï¼Œæ‰æ¡ƒä½“æ— è‚¿å¤§ï¼ŒåŒè‚ºå‘¼å¸éŸ³æ¸…ï¼Œå·¦è‚ºå¯é—»åŠæ¹¿æ€§ç½—éŸ³ã€‚",
        labTests: "è¡€å¸¸è§„äº”åˆ†ç±»+hsCRP[æ€¥]ï¼šWBC 8.41E+9/Lã€LYM% 18.9%ã€MONO% 10.9%ã€MONO# 0.92E+9/Lã€hs-CRP 72.230mg/Lã€‚èƒ¸ç‰‡æœªè¯¦è¿°ã€‚",
        aiRecommendation: {
            thinking: [
                "60å²å¥³æ€§ï¼Œå’³å—½2å‘¨ï¼Œæœ‰é»„ç—°ï¼Œä½çƒ­å’Œæ°”çŸ­4å¤©ï¼Œå·¦è‚ºæ¹¿å•°éŸ³",
                "è¡€å¸¸è§„æ˜¾ç¤ºç™½ç»†èƒæ­£å¸¸ï¼Œæ·‹å·´ç»†èƒç™¾åˆ†æ¯”ä½ï¼Œå•æ ¸ç»†èƒç™¾åˆ†æ¯”å’Œç»å¯¹å€¼å‡é«˜ï¼Œhs-CRPæ˜¾è‘—å‡é«˜",
                "è‚ºç‚çš„å¯èƒ½æ€§è¾ƒé«˜ï¼Œå› ä¸ºæœ‰å‘çƒ­ã€æ°”çŸ­ã€æ¹¿å•°éŸ³ï¼ŒCRPå‡é«˜",
                "æ€¥æ€§æ”¯æ°”ç®¡ç‚å¯èƒ½æœ‰å’³å—½å’Œé»„ç—°ï¼Œä½†é€šå¸¸ä¸ä¼´æœ‰å‘çƒ­"
            ],
            diagnosis: [
                { name: "è‚ºç‚", confidence: 75 },
                { name: "æ€¥æ€§æ”¯æ°”ç®¡ç‚", confidence: 60 },
                { name: "æ”¯æ°”ç®¡æ‰©å¼ ç—‡", confidence: 45 }
            ],
            featureImportance: {
                features: ["å’³å—½", "å’³å°‘è®¸é»„ç—°", "é«˜è¡€å‹ç—…", "æ— ä¼´å’½ç—›", "è¯ç‰©", "60å²", "4å¤©å‰ä¼´å‘çƒ­", "å’½ç—’", "å’½åå£æ»¤æ³¡å¢ç”Ÿ", "ä¼´æ°”çŸ­", "æ‰æ¡ƒä½“æ— è‚¿å¤§"],
                gradients: [1.0000, 0.2265, 0.1599, 0.1301, 0.1090, -0.0969, 0.0904, 0.0657, -0.0558, 0.0538, -0.0397]
            },
            useAntibiotic: true,
            antibioticStandard: "è‚ºç‚çš„å¯èƒ½æ€§å¤§ï¼Œéœ€ä½¿ç”¨æŠ—ç”Ÿç´ ã€‚é˜¿è«è¥¿æ—å…‹æ‹‰ç»´é…¸é’¾",
            antibioticPrimary: "é˜¿è«è¥¿æ—å…‹æ‹‰ç»´é…¸é’¾",
        }
    },
    case003: {
        id: "case003",
        patientId: "PT2023003",
        gender: "å¥³",
        age: "3å²",
        visitDate: "2023-12-18",
        chiefComplaint: "å‘çƒ­ä¼´å’³å—½5å¤©,ç»æ²»ç–—å¥½è½¬",
        presentIllness: "5å¤©å‰å¼€å§‹å‘çƒ­ä¼´å’³å—½ï¼Œæœ‰ç—°ï¼Œé˜µå‘æ€§å’³å—½ï¼Œä¼´æ¶å¿ƒã€‚å¤œé—´ä¸ºç”šï¼Œä¼´é¼»å¡ã€‚æ— æµé»„æ¶•ï¼Œç»æ²»ç–—åå¥½è½¬ã€‚",
        personalHistory: "æ— ç‰¹æ®Šã€‚",
        allergyHistory: "æ— ç‰¹æ®Š",
        physicalExam: "T 38â„ƒï¼Œå’½è…”å……è¡€ï¼Œæ‰æ¡ƒä½“â…¢Â°IIÂ°ï¼Œå……è¡€ï¼ŒåŒè‚ºå¯é—»åŠå°‘è®¸ç—°é¸£éŸ³ã€‚",
        labTests: "æ‰‹æŒ‡è¡€è¡€å¸¸è§„äº”åˆ†ç±»+hsCRP[æ€¥]+æ‰‹æŒ‡è¡€è‚ºç‚æ”¯åŸä½“æŠ—ä½“IgM(å¿«æ£€)[æ€¥]ï¼šWBC 10.73E+9/Lã€NEU% 76.3%ã€LYM% 12.0%ã€MONO% 11.3%ã€NEU# 8.19E+9/Lã€LYM# 1.29E+9/Lã€MONO# 1.21E+9/Lã€HCT 33.7%ã€MPV 7.7fLã€P-LCR 11.9%ã€hs-CRP 108.850mg/Lã€MP-IgM é˜³æ€§",
        aiRecommendation: {
            thinking: [
                "æ”¯æ°”ç®¡ç‚å’Œè‚ºç‚æ˜¯å¸¸è§åŸå› ï¼Œä½†æ‚£è€…æ²»ç–—åå¥½è½¬",
                "è‚ºç‚æ”¯åŸä½“IgMé˜³æ€§æç¤ºæ”¯åŸä½“æ„ŸæŸ“",
                "æ‰æ¡ƒä½“è‚¿å¤§å¯èƒ½ä¸æ‰æ¡ƒä½“ç‚ç›¸å…³ï¼Œä½†æ‚£è€…æœ‰ç—°é¸£éŸ³ï¼Œå¯èƒ½ä¸ºè‚ºç‚",
                "è¡€å¸¸è§„å’ŒCRPå‡é«˜æç¤ºæ„ŸæŸ“ï¼Œæ”¯åŸä½“IgMé˜³æ€§å¯èƒ½éœ€è€ƒè™‘"
            ],
            diagnosis: [
                { name: "è‚ºç‚", confidence: 75 },
                { name: "æ”¯æ°”ç®¡ç‚", confidence: 60 },
                { name: "æ€¥æ€§æ‰æ¡ƒä½“ç‚", confidence: 45 }
            ],
            featureImportance: {
                features: ["3å²", "å‘çƒ­ä¼´å’³å—½5å¤©", "MP-IgM é˜³æ€§", "å‘çƒ­", "æ‰æ¡ƒä½“â…¢Â°", "å¦è®¤é«˜è¡€å‹ç—…", "æœ‰ç—°", "å’½è…”å……è¡€", "åŒè‚ºå¯é—»åŠå°‘è®¸ç—°é¸£éŸ³"],
                gradients: [1.0000, 0.9863, 0.3999, 0.3758, 0.3427, 0.2381, 0.1479, 0.1320, -0.1569]
            },
            useAntibiotic: true,
            antibioticStandard: "æ”¯åŸä½“æ„ŸæŸ“é€šå¸¸ä½¿ç”¨å¤§ç¯å†…é…¯ç±»æŠ—ç”Ÿç´ ã€‚",
            antibioticPrimary: "é˜¿å¥‡éœ‰ç´ ",
        }
    },
    // ç»„2: éƒ¨åˆ†éœ€è¦ä½¿ç”¨æŠ—ç”Ÿç´ 
    case004: {
        id: "case004",
        patientId: "PT2023004",
        gender: "ç”·",
        age: "21å²",
        visitDate: "2023-12-29",
        chiefComplaint: "å’½ç—›1å‘¨ä½™",
        presentIllness: "1å‘¨å‰å¼€å§‹å‡ºç°å’½ç—›ï¼Œåå’½æ—¶ç–¼ç—›æ˜æ˜¾ï¼Œæ— æ˜æ˜¾å‘¼å¸åŠåå’½å›°éš¾ï¼Œå¶æœ‰å’³å—½ï¼Œæ— ç—°ã€‚",
        personalHistory: "æ— ç‰¹æ®Šã€‚",
        allergyHistory: "æ— è¿‡æ•",
        physicalExam: "å’½éƒ¨ç²˜è†œå……è¡€æ˜æ˜¾ï¼Œä¼šåŒæ— æ˜æ˜¾æ°´è‚¿ï¼Œæœªè§æ˜æ˜¾å¼‚ç‰©åŠè‚¿ç‰©ã€‚",
        labTests: "æ— ",
        aiRecommendation: {
            thinking: [
                "21å²ç”·æ€§ï¼Œå’½ç—›1å‘¨ä½™ï¼Œæ— å‘¼å¸å›°éš¾ï¼Œå¶æœ‰å’³å—½",
                "ä½“æ ¼æ£€æŸ¥æ˜¾ç¤ºå’½éƒ¨å……è¡€ï¼Œä¼šåŒæ— æ°´è‚¿",
                "æ€¥æ€§å’½ç‚å¯èƒ½æ€§æœ€é«˜ï¼Œå› ä¸ºå’½ç—›æ˜æ˜¾ï¼Œæ— å…¶ä»–ä¸¥é‡ç—‡çŠ¶",
                "æ‰æ¡ƒä½“ç‚å¯èƒ½ï¼Œä½†æ— æ‰æ¡ƒä½“è‚¿å¤§æˆ–æ¸—å‡º"
            ],
            diagnosis: [
                { name: "æ€¥æ€§å’½ç‚", confidence: 85 },
                { name: "æ€¥æ€§æ‰æ¡ƒä½“ç‚", confidence: 60 },
                { name: "æ€¥æ€§å–‰ç‚", confidence: 55 }
            ],
            featureImportance: {
                features: ["ä¼šåŒæ— æ˜æ˜¾æ°´è‚¿", "åå’½æ—¶ç–¼ç—›æ˜æ˜¾", "å’½ç—›1å‘¨ä½™", "å’½éƒ¨ç²˜è†œå……è¡€æ˜æ˜¾", "æ— æ˜æ˜¾å‘¼å¸åŠåå’½å›°éš¾", "æ— ç—°", "è‚¿ç‰©", "å¶æœ‰å’³å—½", "æœªè§æ˜æ˜¾å¼‚ç‰©", "21å²"],
                gradients: [1.0000, 0.6720, 0.6536, 0.4501, 0.3435, 0.1960, 0.1004, 0.0580, -0.0383, 0.0244]
            },
            useAntibiotic: false,
            antibioticStandard: "æ€¥æ€§å’½ç‚é€šå¸¸ç”±ç—…æ¯’å¼•èµ·ï¼Œæ— éœ€ä½¿ç”¨æŠ—ç”Ÿç´ ã€‚",
            antibioticPrimary: "",
        }
    },
    case005: {
        id: "case005",
        patientId: "PT2023005",
        gender: "å¥³",
        age: "37å²",
        visitDate: "2023-12-28",
        chiefComplaint: "å’½ç—›2å¤©ä½™",
        presentIllness: "2å¤©ä½™å‰ï¼Œæ— æ˜æ˜¾è¯±å› ä¸‹ï¼Œå‡ºç°å’½ç—›ï¼ŒæŒç»­æ€§ï¼Œåå’½æ—¶æ˜æ˜¾ï¼Œæ— ä¼´åå’½æ¢—é˜»æ„Ÿï¼Œæ— ä¼´è¯´è¯å«ç³Šï¼Œæ— å£°å˜¶ï¼Œæ— å‘¼å¸ä¸ç•…ï¼Œæ— åå’½ä¸èƒ½ã€‚",
        personalHistory: "æ— ç‰¹æ®Šã€‚",
        allergyHistory: "æ— è¯ç‰©è¿‡æ•å²",
        physicalExam: "å‘¼å¸å¹³ç¨³ï¼Œå£å”‡æ— å‘ç»€ï¼Œå¼ å£æ— å—é™ï¼ŒåŒä¾§æ‰æ¡ƒä½“IIåº¦å¤§ï¼Œç¨å……è¡€ï¼Œè¡¨é¢è§è„“æ “ï¼Œå³ä¾§èˆŒæ ¹æ•£åœ¨æºƒç–¡æ ·æ”¹å˜ã€‚ä¼šåŒèˆŒé¢æ— å……è¡€è‚¿èƒ€ï¼ŒåŒä¾§æŠ«è£‚æ— å……è¡€ã€‚å³ä¾§å¤–è€³é“å¤§é‡è€µèï¼Œé¼“è†œæ— æ³•çª¥åŠã€‚",
        labTests: "æ— ",
        aiRecommendation: {
            thinking: [
                "37å²å¥³æ€§ï¼Œå’½ç—›2å¤©ä½™ï¼Œæ‰æ¡ƒä½“â…¡åº¦è‚¿å¤§ä¼´è„“æ “ï¼ŒèˆŒæ ¹æºƒç–¡",
                "æ€¥æ€§æ‰æ¡ƒä½“ç‚å¯èƒ½æ€§é«˜ï¼Œä½†éœ€æ’é™¤å…¶ä»–æ„ŸæŸ“",
                "æ‰æ¡ƒä½“å‘¨å›´è„“è‚¿å¯èƒ½æ€§è¾ƒä½ï¼Œå› ä¸ºæ— æ˜æ˜¾è„“è‚¿è¿¹è±¡",
                "æ‰æ¡ƒä½“ç‚å¯èƒ½éœ€è¦æŠ—ç”Ÿç´ æ²»ç–—"
            ],
            diagnosis: [
                { name: "æ€¥æ€§æ‰æ¡ƒä½“ç‚", confidence: 75 },
                { name: "æ‰æ¡ƒä½“å‘¨å›´è„“è‚¿", confidence: 60 },
                { name: "æ€¥æ€§ä¸Šå‘¼å¸é“æ„ŸæŸ“", confidence: 55 }
            ],
            featureImportance: {
                features: ["å’½ç—›2å¤©ä½™", "æ— æ˜æ˜¾è¯±å› ", "æ— ä¼´åå’½æ¢—é˜»æ„Ÿ", "ä¼šåŒèˆŒé¢æ— å……è¡€è‚¿èƒ€", "37å²", "å³ä¾§èˆŒæ ¹æ•£åœ¨æºƒç–¡æ ·æ”¹å˜", "å³ä¾§å¤–è€³é“å¤§é‡è€µè", "é¼“è†œæ— æ³•çª¥åŠ", "å‘¼å¸å¹³ç¨³", "åŒä¾§æŠ«è£‚æ— å……è¡€", "æ— å‘ç»€", "æ— ä¼´è¯´è¯å«ç³Š"],
                gradients: [1.0000, 0.6674, 0.5467, 0.5353, 0.4151, 0.3972, 0.3848, 0.2265, 0.2241, 0.2061, 0.1962, 0.1808]
            },
            useAntibiotic: true,
            antibioticStandard: "æ€¥æ€§æ‰æ¡ƒä½“ç‚ä¼´æœ‰è„“æ “ï¼Œå»ºè®®ä½¿ç”¨æŠ—ç”Ÿç´ æ²»ç–—ã€‚é˜¿è«è¥¿æ—å…‹æ‹‰ç»´é…¸é’¾",
            antibioticPrimary: "é˜¿è«è¥¿æ—å…‹æ‹‰ç»´é…¸é’¾",
        }
    },
    case006: {
        id: "case006",
        patientId: "PT2023006",
        gender: "å¥³",
        age: "33å²",
        visitDate: "2023-12-26",
        chiefComplaint: "é¼»å¡ã€æµè„“æ¶•7å¤©",
        presentIllness: "é¼»å¡ï¼Œæµè„“æ¶•7å¤©ï¼Œæ— é¼»ç—’ã€æµæ¸…æ¶•ã€åå¤æ‰“å–·åšï¼Œæ— è€³é¸£ã€è€³é—·ã€æ¶•ä¸­å¸¦è¡€ï¼Œæ— å‘çƒ­ã€ä¹åŠ›ã€å’³å—½ã€å’³ç—°ç­‰ä¸é€‚ã€‚",
        personalHistory: "å¦è®¤å›½å†…å›½å¤–ç–«åŒºæ¥è§¦å²ã€‚",
        allergyHistory: "æš‚æ— ",
        physicalExam: "é¼»ä¸­éš”ç•¥åæ›²ï¼ŒåŒä¾§ä¸‹é¼»ç”²ç¨è‚¥åšï¼Œé¼»è…”é€šæ°”å¯,é¼»è…”å°‘é‡è„“æ€§åˆ†æ³Œç‰©ã€‚å³ä¾§ä¸‹é¼»ç”²å‰ç«¯ç³œçƒ‚å‡ºè¡€ã€‚",
        labTests: "æš‚æ— ",
        aiRecommendation: {
            thinking: [
                "33å²å¥³æ€§ï¼Œé¼»å¡ã€æµè„“æ¶•7å¤©ï¼Œæ— å…¶ä»–ç—‡çŠ¶",
                "ä½“æ ¼æ£€æŸ¥æ˜¾ç¤ºé¼»è…”æœ‰è„“æ€§åˆ†æ³Œç‰©ï¼Œå³ä¾§ä¸‹é¼»ç”²å‰ç«¯ç³œçƒ‚å‡ºè¡€",
                "æ…¢æ€§é¼»çª¦ç‚å¯èƒ½æ€§è¾ƒé«˜ï¼Œå› ä¸ºç—‡çŠ¶æŒç»­ä¸”æœ‰è„“æ¶•",
                "æ€¥æ€§é¼»çª¦ç‚å¯èƒ½ï¼Œä½†é€šå¸¸æœ‰å‘çƒ­ç­‰è¡¨ç°"
            ],
            diagnosis: [
                { name: "æ…¢æ€§é¼»çª¦ç‚", confidence: 85 },
                { name: "æ€¥æ€§é¼»çª¦ç‚", confidence: 60 },
                { name: "é¼»è…”è„“è‚¿", confidence: 55 }
            ],
            featureImportance: {
                features: ["é¼»å¡", "æµè„“æ¶•7å¤©", "å’³ç—°", "æ¶•ä¸­å¸¦è¡€", "å³ä¾§ä¸‹é¼»ç”²å‰ç«¯ç³œçƒ‚å‡ºè¡€", "æ— é¼»ç—’", "åŒä¾§ä¸‹é¼»ç”²ç¨è‚¥åš", "é¼»è…”å°‘é‡è„“æ€§åˆ†æ³Œç‰©", "é¼»ä¸­éš”ç•¥åæ›²", "é¼»è…”é€šæ°”å¯"],
                gradients: [1.0000, 0.7462, 0.3479, 0.2835, -0.2257, 0.1540, -0.1409, 0.1196, -0.0984, -0.0887]
            },
            useAntibiotic: true,
            antibioticStandard: "æ€¥æ€§ç»†èŒæ€§é¼»çª¦ç‚ä¼´æœ‰è„“æ¶•å’Œå½±åƒå­¦è¯æ®æ—¶å»ºè®®ä½¿ç”¨æŠ—ç”Ÿç´ ã€‚é˜¿è«è¥¿æ—å…‹æ‹‰ç»´é…¸é’¾",
            antibioticPrimary: "é˜¿è«è¥¿æ—å…‹æ‹‰ç»´é…¸é’¾",
        }
    },
    // ç»„3: ä¸éœ€è¦ä½¿ç”¨æŠ—ç”Ÿç´ 
    case007: {
        id: "case007",
        patientId: "PT2023007",
        gender: "å¥³",
        age: "32å²",
        visitDate: "2023-12-30",
        chiefComplaint: "å’½ç—›1å¤©",
        presentIllness: "æ‚£è€…1å¤©å‰å‡ºç°æœ‰å’½ç—›ï¼Œåˆå¹¶æœ‰å’³å—½ã€å’³ç—°ï¼Œåˆå¹¶æœ‰é¼»å¡ã€æµæ¶•ï¼Œå¦è®¤æœ‰å‘çƒ­ï¼Œåˆå¹¶æœ‰å…¨èº«é…¸ç—›ã€‚",
        personalHistory: "å¦è®¤å¦Šå¨ ã€‚",
        allergyHistory: "æ— è¯ç‰©è¿‡æ•å²",
        physicalExam: "ç¥å¿—æ¸…æ¥šï¼Œç²¾ç¥å¯ï¼Œå’½çº¢ï¼Œæ‰æ¡ƒä½“æ— è‚¿å¤§ï¼Œé¢ˆè½¯æ— æŠµæŠ—ï¼ŒåŒè‚ºå‘¼å¸éŸ³ç¨ç²—ï¼Œæ— æ˜æ˜¾å¹²æ¹¿æ€§å•°éŸ³ï¼Œå¾‹é½æ— æ‚éŸ³ï¼Œè…¹éƒ¨å¹³è½¯æ— å‹ç—›åŠåè·³ç—›ã€‚",
        labTests: "è¡€å¸¸è§„äº”åˆ†ç±»+hsCRP[æ€¥]ï¼šWBC 5.75E+9/Lã€NEU% 66.5%ã€LYM% 18.0%ã€MONO% 10.3%ã€LYM# 1.03E+9/Lã€RBC 3.90E+12/Lã€HGB 124g/Lã€hs-CRP 4.100mg/L",
        aiRecommendation: {
            thinking: [
                "æ‚£è€…æœ‰ä¸Šå‘¼å¸é“æ„ŸæŸ“çš„ç—‡çŠ¶ï¼Œå¦‚å’½ç—›ã€å’³å—½ã€é¼»å¡ã€æµæ¶•ï¼Œä»¥åŠå…¨èº«é…¸ç—›",
                "ä½†æ— å‘çƒ­ï¼Œè¡€å¸¸è§„æ˜¾ç¤ºç™½ç»†èƒæ­£å¸¸ï¼Œhs-CRPæ­£å¸¸",
                "æç¤ºå¯èƒ½ä¸ºç—…æ¯’æ€§æ„ŸæŸ“",
                "ç”±äºç—…æ¯’æ€§æ„ŸæŸ“å¯èƒ½æ€§å¤§ï¼Œä¸éœ€è¦ä½¿ç”¨æŠ—ç”Ÿç´ "
            ],
            diagnosis: [
                { name: "æ€¥æ€§ä¸Šå‘¼å¸é“æ„ŸæŸ“", confidence: 70 },
                { name: "æ€¥æ€§å’½ç‚", confidence: 50 },
                { name: "æ€¥æ€§æ”¯æ°”ç®¡ç‚", confidence: 30 }
            ],
            featureImportance: {
                features: ["å’½ç—›1å¤©", "åˆå¹¶æœ‰å…¨èº«é…¸ç—›", "å’½ç—›", "é¢ˆè½¯æ— æŠµæŠ—", "å’³ç—°", "åˆå¹¶æœ‰é¼»å¡", "æµæ¶•", "æ— æ˜æ˜¾å¹²æ¹¿æ€§å•°éŸ³", "1å¤©å‰", "è…¹éƒ¨å¹³è½¯", "åˆå¹¶æœ‰å’³å—½", "æ‰æ¡ƒä½“æ— è‚¿å¤§", "æ— å‹ç—›"],
                gradients: [1.0000, 0.8098, 0.6416, 0.6222, 0.4327, 0.3874, 0.3765, -0.3417, 0.3130, 0.2672, 0.2458, 0.2276, 0.1837]
            },
            useAntibiotic: false,
            antibioticStandard: "æ€¥æ€§ä¸Šå‘¼å¸é“æ„ŸæŸ“é€šå¸¸ç”±ç—…æ¯’å¼•èµ·ï¼Œæ— éœ€ä½¿ç”¨æŠ—ç”Ÿç´ ã€‚",
            antibioticPrimary: "",
        }
    },
    case008: {
        id: "case008",
        patientId: "PT2023008",
        gender: "å¥³",
        age: "4å²",
        visitDate: "2023-12-24",
        chiefComplaint: "é˜µå‘æ€§å’³å—½1å‘¨",
        presentIllness: "æ‚£å„¿äº1å‘¨å‰å¼€å§‹å‡ºç°é˜µå‘æ€§å’³å—½ï¼Œæœ‰ç—°ï¼Œå¤œé—´æ™¨èµ·ä¸ºä¸»ï¼Œä¼´é¼»å¡ï¼Œæ— å‘çƒ­ï¼Œæ— å–˜æ¯æ— å‘•åè…¹æ³»ï¼Œç²¾ç¥èƒƒçº³ä¸€èˆ¬ï¼Œå¤§å°ä¾¿æ­£å¸¸ã€‚",
        personalHistory: "æ— ç‰¹æ®Šã€‚",
        allergyHistory: "æ— ç‰¹æ®Š",
        physicalExam: "ç¥å¿—æ¸…ï¼Œå‘¼å¸å¹³é¡ºï¼Œæ— çš®ç–¹ï¼Œæµ…è¡¨æ·‹å·´ç»“æ— æ˜æ˜¾è‚¿å¤§ï¼Œå’½å……è¡€ï¼ŒåŒè‚ºå‘¼å¸éŸ³ç²—ï¼Œæœªé—»å¹²æ¹¿ç½—éŸ³ï¼Œå¿ƒéŸ³æ­£å¸¸ï¼Œå¾‹é½ï¼Œæœªé—»æ‚éŸ³ï¼Œè…¹å¹³è½¯ï¼Œæ— å‹ç—›ï¼Œè‚ é¸£éŸ³æ­£å¸¸ã€‚",
        labTests: "æ— ",
        aiRecommendation: {
            thinking: [
                "æ€¥æ€§æ”¯æ°”ç®¡ç‚æ˜¯æœ€å¸¸è§çš„ï¼Œå› ä¸ºç—‡çŠ¶åŒ…æ‹¬å’³å—½ã€é¼»å¡ï¼Œä½†æ— å‘çƒ­",
                "æ„Ÿå†’ç—‡çŠ¶ç›¸ä¼¼ï¼Œä¹Ÿå¯èƒ½",
                "æ€¥æ€§ä¸Šå‘¼å¸é“æ„ŸæŸ“å¯èƒ½ï¼Œä½†æ‚£è€…ç—‡çŠ¶è¾ƒè½»",
                "ç”±äºæ²¡æœ‰æ„ŸæŸ“è¯æ®ï¼Œä¸éœ€è¦ä½¿ç”¨æŠ—ç”Ÿç´ "
            ],
            diagnosis: [
                { name: "æ€¥æ€§æ”¯æ°”ç®¡ç‚", confidence: 70 },
                { name: "æ„Ÿå†’", confidence: 50 },
                { name: "æ€¥æ€§ä¸Šå‘¼å¸é“æ„ŸæŸ“", confidence: 30 }
            ],
            featureImportance: {
                features: ["é˜µå‘æ€§å’³å—½1å‘¨", "4å²", "æœ‰ç—°", "å’½å……è¡€", "ç¥å¿—æ¸…", "æ— å–˜æ¯", "æœªé—»æ‚éŸ³", "å¤§å°ä¾¿æ­£å¸¸", "ä¼´é¼»å¡", "å¤œé—´æ™¨èµ·ä¸ºä¸»", "è…¹å¹³è½¯", "è‚ é¸£éŸ³æ­£å¸¸", "æ— å‘çƒ­", "æœªé—»å¹²æ¹¿ç½—éŸ³"],
                gradients: [1.0000, -0.5796, 0.5613, 0.4801, -0.4299, 0.3045, -0.2996, -0.2165, -0.2048, -0.2013, 0.1823, -0.1729, 0.1692, -0.1176]
            },
            useAntibiotic: false,
            antibioticStandard: "æ€¥æ€§æ”¯æ°”ç®¡ç‚é€šå¸¸ç”±ç—…æ¯’å¼•èµ·ï¼Œæ— éœ€ä½¿ç”¨æŠ—ç”Ÿç´ ã€‚",
            antibioticPrimary: "",
        }
    },
    case009: {
        id: "case009",
        patientId: "PT2023009",
        gender: "ç”·",
        age: "57å²",
        visitDate: "2023-12-29",
        chiefComplaint: "åå¤æµæ¸…æ¶•åŠå¹´ä½™",
        presentIllness: "åŠæœˆä½™æ¥åå¤æµæ¸…æ¶•ï¼Œæ™¨èµ·æ˜æ˜¾ï¼Œæ— æ˜æ˜¾é¼»å¡ã€æ‰“å–·åšï¼Œæ— æµè„“æ¶•ï¼Œæ— å¤´ç—›ã€å‘çƒ­ï¼Œæ— é¼»å‡ºè¡€ã€‚",
        personalHistory: "å¦è®¤æ‰‹æœ¯å¤–ä¼¤å²ï¼Œå¦è®¤é«˜è¡€å‹ç—…ã€ç³–å°¿ç—…ä»¥åŠå¿ƒè„ç—…ç—…å²ï¼Œå¦è®¤è¯ç‰©é£Ÿç‰©è¿‡æ•å²ï¼Œå¦è®¤è¾“è¡€å²ã€‚",
        allergyHistory: "å¦è®¤è¯ç‰©é£Ÿç‰©è¿‡æ•å²",
        physicalExam: "é¼»ä¸­éš”åŸºæœ¬å±…ä¸­ï¼Œé¼»è…”ç²˜è†œç¨å……è¡€ã€è‚¿èƒ€ï¼Œå°‘é‡ç²˜æ€§åˆ†æ³Œç‰©ï¼Œæœªè§æ˜æ˜¾æ–°ç”Ÿç‰©ã€‚",
        labTests: "æ— ",
        aiRecommendation: {
            thinking: [
                "æ…¢æ€§é¼»ç‚æ˜¯æœ€å¸¸è§çš„ï¼Œå› ä¸ºç—‡çŠ¶åŒ…æ‹¬æµæ¸…æ¶•ï¼Œä¸”æ— å…¶ä»–æ„ŸæŸ“è¿¹è±¡",
                "å˜åº”æ€§é¼»ç‚å¯èƒ½ï¼Œä½†æ‚£è€…æ²¡æœ‰æ‰“å–·åšæˆ–é¼»å¡",
                "é¼»çª¦ç‚å¯èƒ½æ€§è¾ƒä½ï¼Œä½†æ‚£è€…æ²¡æœ‰è„“æ¶•æˆ–å¤´ç—›",
                "æ…¢æ€§é¼»ç‚é€šå¸¸ç”±éæ„ŸæŸ“å› ç´ å¼•èµ·ï¼Œä¸éœ€è¦ä½¿ç”¨æŠ—ç”Ÿç´ "
            ],
            diagnosis: [
                { name: "æ…¢æ€§é¼»ç‚", confidence: 70 },
                { name: "å˜åº”æ€§é¼»ç‚", confidence: 50 },
                { name: "é¼»çª¦ç‚", confidence: 30 }
            ],
            featureImportance: {
                features: ["æ‰“å–·åš", "57å²", "å¦è®¤é«˜è¡€å‹ç—…", "é¼»è…”ç²˜è†œç¨å……è¡€", "æ— æµè„“æ¶•", "æ™¨èµ·æ˜æ˜¾", "åå¤æµæ¸…æ¶•åŠå¹´ä½™", "å°‘é‡ç²˜æ€§åˆ†æ³Œç‰©"],
                gradients: [-1.0000, -0.6194, 0.5763, 0.5295, -0.4494, 0.4031, 0.2506, 0.2001]
            },
            useAntibiotic: false,
            antibioticStandard: "æ…¢æ€§é¼»ç‚é€šå¸¸ç”±éæ„ŸæŸ“å› ç´ å¼•èµ·ï¼Œä¸éœ€è¦ä½¿ç”¨æŠ—ç”Ÿç´ ã€‚",
            antibioticPrimary: "",
        }
    }
};

        // ========================================
        // EmailJSé…ç½®
        // ========================================
        const EMAILJS_CONFIG = {
            serviceId: 'service_sjev6dm',
            templateId: 'template_ldiu064',
            publicKey: 'GbpZKeaCKEnzJeoAo'
        };

        // EmailJSå»¶è¿Ÿåˆå§‹åŒ–ï¼šç­‰å¾…CDNå¼‚æ­¥åŠ è½½å®Œæˆåå†init
        let emailjsReady = false;
        (function initEmailJSWhenReady() {
            var attempts = 0;
            var maxAttempts = 40; // æœ€å¤šç­‰20ç§’ (40 * 500ms)
            var checkInterval = setInterval(function() {
                attempts++;
                if (typeof emailjs !== 'undefined' && emailjs.init) {
                    clearInterval(checkInterval);
                    try {
                        emailjs.init(EMAILJS_CONFIG.publicKey);
                        emailjsReady = true;
                        console.log('[EmailJS] åˆå§‹åŒ–æˆåŠŸï¼ˆç­‰å¾…' + (attempts * 500) + 'msï¼‰');
                    } catch(e) {
                        console.error('[EmailJS] åˆå§‹åŒ–å¼‚å¸¸:', e);
                    }
                } else if (attempts >= maxAttempts) {
                    clearInterval(checkInterval);
                    console.warn('[EmailJS] CDNåŠ è½½è¶…æ—¶ï¼Œé‚®ä»¶å‘é€åŠŸèƒ½ä¸å¯ç”¨ï¼Œæ•°æ®å°†ä¿å­˜åœ¨æœ¬åœ°');
                }
            }, 500);
        })();

        // ========================================
        // Supabaseé…ç½® - åŒºç»„éšæœºåŒ–
        // ========================================
        const SUPABASE_CONFIG = {
            url: 'https://khtsdzhholhkypgwornn.supabase.co',
            anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtodHNkemhob2xoa3lwZ3dvcm5uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgyOTAyMjcsImV4cCI6MjA4Mzg2NjIyN30.W95XnxWIqFomUslYgmygFY5ZoSz2Lpc1yG8vKIk0Eao',
        };

        // åˆå§‹åŒ–Supabaseå®¢æˆ·ç«¯
        let supabaseClient = null;
        function initSupabase() {
            if (SUPABASE_CONFIG.url === 'YOUR_SUPABASE_URL') {
                console.warn('[Supabase] æœªé…ç½®Supabaseï¼Œå°†ä½¿ç”¨æœ¬åœ°éšæœºåˆ†é…');
                return null;
            }
            if (typeof supabase === 'undefined' || !supabase.createClient) {
                console.warn('[Supabase] åº“æœªåŠ è½½ï¼ˆå¯èƒ½CDNè¢«å¢™ï¼‰ï¼Œå°†ä½¿ç”¨æœ¬åœ°éšæœºåˆ†é…');
                return null;
            }
            try {
                supabaseClient = supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey);
                console.log('[Supabase] å®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ');
                return supabaseClient;
            } catch (error) {
                console.error('[Supabase] åˆå§‹åŒ–å¤±è´¥:', error);
                return null;
            }
        }

        // ========================================
        // åŒºç»„éšæœºåŒ–ç®¡ç†æ¨¡å—
        // ========================================
        const BlockRandomization = {
            BLOCK_SIZE: 32,           // æ¯ä¸ªåŒºç»„åŒ…å«32ç§å®éªŒæ¡ä»¶
            CONDITIONS_PER_PARTICIPANT: 3,  // æ¯ä½å‚ä¸è€…åˆ†é…3ä¸ªç³»ç»Ÿ

            // Fisher-Yatesæ´—ç‰Œç®—æ³•
            shuffleArray(array) {
                const shuffled = [...array];
                for (let i = shuffled.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }
                return shuffled;
            },

            // ç”Ÿæˆæ–°åŒºç»„ï¼ˆæ‰“ä¹±çš„32ä¸ªæ¡ä»¶ç´¢å¼•ï¼‰
            generateNewBlock() {
                const conditions = Array.from({ length: this.BLOCK_SIZE }, (_, i) => i);
                return this.shuffleArray(conditions);
            },

            // ä»Supabaseè·å–æˆ–åˆ›å»ºå½“å‰åŒºç»„
            async getCurrentBlock() {
                if (!supabaseClient) {
                    console.log('[åŒºç»„éšæœºåŒ–] Supabaseæœªè¿æ¥ï¼Œä½¿ç”¨æœ¬åœ°æ¨¡å¼');
                    return null;
                }

                try {
                    // æŸ¥æ‰¾å½“å‰æ´»è·ƒçš„åŒºç»„ï¼ˆå‰©ä½™æ§½ä½ >= 3ï¼Œå³ next_index <= 29ï¼‰
                    const maxValidIndex = this.BLOCK_SIZE - this.CONDITIONS_PER_PARTICIPANT; // 32 - 3 = 29
                    const { data: blocks, error: fetchError } = await supabaseClient
                        .from('experiment_blocks')
                        .select('*')
                        .lte('next_index', maxValidIndex)  // next_index <= 29ï¼Œç¡®ä¿å‰©ä½™>=3
                        .order('block_number', { ascending: false })
                        .limit(1);

                    if (fetchError) throw fetchError;

                    if (blocks && blocks.length > 0) {
                        console.log(`[åŒºç»„éšæœºåŒ–] ä½¿ç”¨ç°æœ‰åŒºç»„ #${blocks[0].block_number}ï¼Œå½“å‰ç´¢å¼•: ${blocks[0].next_index}ï¼Œå‰©ä½™: ${this.BLOCK_SIZE - blocks[0].next_index}`);
                        return blocks[0];
                    }

                    // æ²¡æœ‰å¯ç”¨åŒºç»„ï¼ˆæˆ–å‰©ä½™æ§½ä½éƒ½ä¸è¶³ï¼‰ï¼Œåˆ›å»ºæ–°åŒºç»„
                    console.log('[åŒºç»„éšæœºåŒ–] æ— å¯ç”¨åŒºç»„ï¼Œåˆ›å»ºæ–°åŒºç»„');
                    return await this.createNewBlock();
                } catch (error) {
                    console.error('[åŒºç»„éšæœºåŒ–] è·å–åŒºç»„å¤±è´¥:', error);
                    return null;
                }
            },

            // åˆ›å»ºæ–°åŒºç»„
            async createNewBlock() {
                if (!supabaseClient) return null;

                try {
                    // è·å–æœ€å¤§åŒºç»„ç¼–å·
                    const { data: maxBlock, error: maxError } = await supabaseClient
                        .from('experiment_blocks')
                        .select('block_number')
                        .order('block_number', { ascending: false })
                        .limit(1);

                    if (maxError) throw maxError;

                    const newBlockNumber = (maxBlock && maxBlock.length > 0) ? maxBlock[0].block_number + 1 : 1;
                    const shuffledConditions = this.generateNewBlock();

                    const { data: newBlock, error: insertError } = await supabaseClient
                        .from('experiment_blocks')
                        .insert({
                            block_number: newBlockNumber,
                            shuffled_conditions: shuffledConditions,
                            next_index: 0,
                            created_at: new Date().toISOString()
                        })
                        .select()
                        .single();

                    if (insertError) throw insertError;

                    console.log(`[åŒºç»„éšæœºåŒ–] åˆ›å»ºæ–°åŒºç»„ #${newBlockNumber}`);
                    return newBlock;
                } catch (error) {
                    console.error('[åŒºç»„éšæœºåŒ–] åˆ›å»ºåŒºç»„å¤±è´¥:', error);
                    return null;
                }
            },

            // åˆ†é…æ¡ä»¶ç»™å‚ä¸è€…ï¼ˆåŸå­æ“ä½œï¼Œé˜²æ­¢å¹¶å‘å†²çªï¼‰
            // é‡‡ç”¨ä¸è·¨åŒºç»„ç­–ç•¥ï¼šæ¯åŒºç»„åªåˆ†é…ç»™10äºº(30æ§½ä½)ï¼Œå‰©ä½™2æ§½ä½ä¸¢å¼ƒ
            async allocateConditions(participantId) {
                if (!supabaseClient) {
                    console.log('[åŒºç»„éšæœºåŒ–] ä½¿ç”¨æœ¬åœ°éšæœºåˆ†é…');
                    return this.localAllocate();
                }

                const maxRetries = 5;
                let retries = 0;

                while (retries < maxRetries) {
                    try {
                        // è·å–å½“å‰åŒºç»„ï¼ˆå·²ä¿è¯å‰©ä½™æ§½ä½ >= 3ï¼‰
                        let block = await this.getCurrentBlock();

                        if (!block) {
                            console.warn('[åŒºç»„éšæœºåŒ–] æ— æ³•è·å–åŒºç»„ï¼Œä½¿ç”¨æœ¬åœ°åˆ†é…');
                            return this.localAllocate();
                        }

                        const currentIndex = block.next_index;
                        const conditions = block.shuffled_conditions;

                        // ä»å½“å‰ä½ç½®åˆ†é…3ä¸ªæ¡ä»¶
                        const allocatedConditions = conditions.slice(currentIndex, currentIndex + this.CONDITIONS_PER_PARTICIPANT);
                        const newIndex = currentIndex + this.CONDITIONS_PER_PARTICIPANT;

                        // éªŒè¯åˆ†é…çš„æ¡ä»¶æ•°é‡æ˜¯å¦æ­£ç¡®ï¼ˆé˜²å¾¡æ€§æ£€æŸ¥ï¼‰
                        if (allocatedConditions.length !== this.CONDITIONS_PER_PARTICIPANT) {
                            console.error(`[åŒºç»„éšæœºåŒ–] æ¡ä»¶æ•°é‡é”™è¯¯: æœŸæœ›${this.CONDITIONS_PER_PARTICIPANT}ï¼Œå®é™…${allocatedConditions.length}`);
                            return this.localAllocate();
                        }

                        // ä½¿ç”¨ä¹è§‚é”æ›´æ–°åŒºç»„ç´¢å¼•
                        const { data: updateResult, error: updateError } = await supabaseClient
                            .from('experiment_blocks')
                            .update({ next_index: newIndex })
                            .eq('id', block.id)
                            .eq('next_index', currentIndex)  // ä¹è§‚é”ï¼šç¡®ä¿ç´¢å¼•æœªè¢«å…¶ä»–è¯·æ±‚ä¿®æ”¹
                            .select();

                        if (updateError) throw updateError;

                        // æ£€æŸ¥æ›´æ–°æ˜¯å¦æˆåŠŸï¼ˆä¹è§‚é”éªŒè¯ï¼‰
                        if (!updateResult || updateResult.length === 0) {
                            console.log(`[åŒºç»„éšæœºåŒ–] å¹¶å‘å†²çªï¼Œé‡è¯•... (${retries + 1}/${maxRetries})`);
                            retries++;
                            await new Promise(resolve => setTimeout(resolve, 100 * Math.random())); // éšæœºå»¶è¿Ÿ
                            continue;
                        }

                        // è®°å½•åˆ†é…å†å²
                        await this.recordAllocation(participantId, block.block_number, allocatedConditions);

                        console.log(`[åŒºç»„éšæœºåŒ–] æˆåŠŸåˆ†é…æ¡ä»¶: [${allocatedConditions.join(', ')}] æ¥è‡ªåŒºç»„ #${block.block_number}`);
                        return allocatedConditions;

                    } catch (error) {
                        console.error(`[åŒºç»„éšæœºåŒ–] åˆ†é…å¤±è´¥ (å°è¯• ${retries + 1}):`, error);
                        retries++;
                        if (retries >= maxRetries) {
                            console.warn('[åŒºç»„éšæœºåŒ–] è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œä½¿ç”¨æœ¬åœ°åˆ†é…');
                            return this.localAllocate();
                        }
                        await new Promise(resolve => setTimeout(resolve, 200));
                    }
                }

                return this.localAllocate();
            },

            // è®°å½•åˆ†é…å†å²
            async recordAllocation(participantId, blockNumber, conditions) {
                if (!supabaseClient) return;

                try {
                    await supabaseClient
                        .from('participant_allocations')
                        .insert({
                            participant_id: participantId,
                            block_number: blockNumber,
                            assigned_conditions: conditions,
                            assigned_at: new Date().toISOString()
                        });
                    console.log(`[åŒºç»„éšæœºåŒ–] å·²è®°å½•åˆ†é…: å‚ä¸è€… ${participantId}`);
                } catch (error) {
                    console.error('[åŒºç»„éšæœºåŒ–] è®°å½•åˆ†é…å¤±è´¥:', error);
                }
            },

            // æœ¬åœ°éšæœºåˆ†é…ï¼ˆé™çº§æ–¹æ¡ˆï¼‰
            localAllocate() {
                const conditions = this.generateNewBlock();
                const allocated = conditions.slice(0, this.CONDITIONS_PER_PARTICIPANT);
                console.log(`[åŒºç»„éšæœºåŒ–] æœ¬åœ°åˆ†é…æ¡ä»¶: [${allocated.join(', ')}]`);
                return allocated;
            },

            // è·å–åˆ†é…ç»Ÿè®¡ä¿¡æ¯
            async getStatistics() {
                if (!supabaseClient) return null;

                try {
                    // è·å–æ‰€æœ‰åŒºç»„
                    const { data: blocks, error: blocksError } = await supabaseClient
                        .from('experiment_blocks')
                        .select('*')
                        .order('block_number', { ascending: true });

                    if (blocksError) throw blocksError;

                    // è·å–æ‰€æœ‰åˆ†é…è®°å½•
                    const { data: allocations, error: allocError } = await supabaseClient
                        .from('participant_allocations')
                        .select('*');

                    if (allocError) throw allocError;

                    // ç»Ÿè®¡æ¯ä¸ªæ¡ä»¶è¢«åˆ†é…çš„æ¬¡æ•°
                    const conditionCounts = Array(this.BLOCK_SIZE).fill(0);
                    allocations.forEach(a => {
                        a.assigned_conditions.forEach(c => {
                            conditionCounts[c]++;
                        });
                    });

                    return {
                        totalBlocks: blocks.length,
                        totalParticipants: allocations.length,
                        conditionDistribution: conditionCounts,
                        currentBlockStatus: blocks.length > 0 ? blocks[blocks.length - 1] : null
                    };
                } catch (error) {
                    console.error('[åŒºç»„éšæœºåŒ–] è·å–ç»Ÿè®¡å¤±è´¥:', error);
                    return null;
                }
            }
        };

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–Supabaseï¼ˆå»¶è¿Ÿç­‰å¾…CDNåŠ è½½å®Œæˆï¼‰
        function tryInitSupabase() {
            if (typeof supabase !== 'undefined' && supabase.createClient) {
                initSupabase();
            } else if (window.__cdnLoadStatus && window.__cdnLoadStatus.supabase) {
                initSupabase();
            } else {
                console.log('[Supabase] ç­‰å¾…CDNåŠ è½½...');
                // æœ€å¤šç­‰å¾…15ç§’
                var attempts = 0;
                var checkInterval = setInterval(function() {
                    attempts++;
                    if (typeof supabase !== 'undefined' && supabase.createClient) {
                        clearInterval(checkInterval);
                        initSupabase();
                    } else if (attempts >= 30) { // 15ç§’è¶…æ—¶
                        clearInterval(checkInterval);
                        console.warn('[Supabase] CDNåŠ è½½è¶…æ—¶ï¼Œä½¿ç”¨æœ¬åœ°éšæœºåˆ†é…');
                    }
                }, 500);
            }
        }
        tryInitSupabase();

        // ========================================
        // å…¨å±€å˜é‡
        // ========================================
        let igChartInstance = null;
        let igChartInstanceModal = null;
        let experimentConfig = null;
        let expData = null;
        let curCase = 0, completedCases = 0;
        let allCases = [];
        let currentDisplayMode = 'sidebar';
        let currentSystemIndex = -1; // è·Ÿè¸ªå½“å‰ç³»ç»Ÿ

        // ========================================
        // æ–­ç‚¹ç»­å¡«å†™åŠŸèƒ½
        // ========================================

        // è‡ªåŠ¨ä¿å­˜è¿›åº¦
        // ã€ä¿®å¤7ã€‘ä¿å­˜è¿›åº¦å¹¶æ£€æµ‹LocalStorageå®¹é‡
        function saveProgress() {
            try {
                if (expData) {
                    // è®¡ç®—æ•°æ®å¤§å°
                    const dataString = JSON.stringify(expData);
                    const dataSize = new Blob([dataString]).size;
                    const dataSizeMB = (dataSize / 1024 / 1024).toFixed(2);

                    // æ£€æŸ¥æ•°æ®å¤§å°ï¼ˆLocalStorageé€šå¸¸é™åˆ¶5-10MBï¼‰
                    if (dataSize > 4.5 * 1024 * 1024) { // 4.5MBè­¦å‘Šé˜ˆå€¼
                        console.warn(`[å­˜å‚¨è­¦å‘Š] æ•°æ®é‡è¾ƒå¤§: ${dataSizeMB}MBï¼Œæ¥è¿‘å­˜å‚¨é™åˆ¶`);
                    }

                    localStorage.setItem('experimentProgress', dataString);
                    localStorage.setItem('currentCaseIndex', curCase.toString());
                    localStorage.setItem('completedCasesCount', completedCases.toString());
                    localStorage.setItem('experimentConfig', JSON.stringify(experimentConfig));
                    localStorage.setItem('allCases', JSON.stringify(allCases));

                    const saveStatus = document.getElementById('saveStatus');
                    if (saveStatus) {
                        saveStatus.textContent = 'âœ“ å·²è‡ªåŠ¨ä¿å­˜';
                        saveStatus.style.display = 'inline-block';
                        setTimeout(() => {
                            saveStatus.style.display = 'none';
                        }, 2000);
                    }
                    console.log(`[ä¿å­˜è¿›åº¦] æˆåŠŸ - æ•°æ®å¤§å°: ${dataSizeMB}MB - ${new Date().toLocaleTimeString()}`);
                }
            } catch (e) {
                console.error('[ä¿å­˜å¤±è´¥]', e);
                if (e.name === 'QuotaExceededError') {
                    alert('âš ï¸ å­˜å‚¨ç©ºé—´ä¸è¶³\n\nå®éªŒæ•°æ®æ— æ³•ä¿å­˜ã€‚è¯·æ¸…ç†æµè§ˆå™¨ç¼“å­˜åé‡è¯•ã€‚\n\nå¦‚æœé—®é¢˜æŒç»­ï¼Œè¯·è”ç³»å®éªŒç®¡ç†å‘˜ã€‚');
                } else {
                    alert('æ•°æ®ä¿å­˜å¤±è´¥ï¼Œè¯·è”ç³»å®éªŒç®¡ç†å‘˜');
                }
            }
        }

        // åŠ è½½å·²ä¿å­˜çš„è¿›åº¦
        function loadProgress() {
            try {
                const savedProgress = localStorage.getItem('experimentProgress');
                const savedCaseIndex = localStorage.getItem('currentCaseIndex');
                const savedCompletedCases = localStorage.getItem('completedCasesCount');
                const savedConfig = localStorage.getItem('experimentConfig');
                const savedAllCases = localStorage.getItem('allCases');

                if (savedProgress && savedConfig && savedAllCases) {
                    expData = JSON.parse(savedProgress);
                    experimentConfig = JSON.parse(savedConfig);
                    allCases = JSON.parse(savedAllCases);

                    if (savedCaseIndex !== null) {
                        curCase = parseInt(savedCaseIndex);
                    }
                    if (savedCompletedCases !== null) {
                        completedCases = parseInt(savedCompletedCases);
                    }

                    console.log('è¿›åº¦å·²æ¢å¤:', {
                        å½“å‰æ¡ˆä¾‹: curCase,
                        å·²å®Œæˆ: completedCases,
                        æ€»æ¡ˆä¾‹æ•°: allCases.length
                    });
                    return true;
                }
            } catch (e) {
                console.error('åŠ è½½è¿›åº¦å¤±è´¥:', e);
            }
            return false;
        }

        // æ¸…é™¤ä¿å­˜çš„è¿›åº¦
        function clearProgress() {
            localStorage.removeItem('experimentProgress');
            localStorage.removeItem('currentCaseIndex');
            localStorage.removeItem('completedCasesCount');
            localStorage.removeItem('experimentConfig');
            localStorage.removeItem('allCases');
            console.log('è¿›åº¦å·²æ¸…é™¤');
        }

        // æ¢å¤è¡¨å•æ•°æ®
        function restoreFormData(formId, data) {
            if (!data) return;

            const form = document.getElementById(formId);
            if (!form) return;

            Object.keys(data).forEach(key => {
                const value = data[key];
                const elements = form.elements[key];

                if (!elements) return;

                if (elements.length > 1) {
                    // å¤„ç†å•é€‰æŒ‰é’®æˆ–å¤é€‰æ¡†ç»„
                    for (let i = 0; i < elements.length; i++) {
                        if (elements[i].type === 'radio' && elements[i].value == value) {
                            elements[i].checked = true;
                        } else if (elements[i].type === 'checkbox') {
                            if (Array.isArray(value) && value.includes(elements[i].value)) {
                                elements[i].checked = true;
                            }
                        }
                    }
                } else {
                    // å¤„ç†å•ä¸ªå…ƒç´ 
                    if (elements.type === 'range') {
                        elements.value = value;
                        if (formId.includes('intention')) {
                            updateIntentionSliderValue(elements);
                        } else {
                            updateSliderValue(elements);
                        }
                    } else if (elements.tagName === 'TEXTAREA' || elements.tagName === 'INPUT') {
                        elements.value = value;
                    }
                }
            });
        }


        // ========================================
        // ç¬¬ä¸€æ­¥ï¼šå§“åè¾“å…¥
        // ========================================
        document.getElementById('participantInput').addEventListener('input', function() {
            const value = this.value.trim();
            const errorText = document.getElementById('errorText');
            const startBtn = document.getElementById('startBtn');

            if (value.length < 2) {
                errorText.style.display = 'block';
                startBtn.disabled = true;
            } else {
                errorText.style.display = 'none';
                startBtn.disabled = false;
            }
        });

        function goToConsent() {
            const input = document.getElementById('participantInput');
            const participantName = input.value.trim();

            if (!participantName || participantName.length < 2) {
                document.getElementById('errorText').style.display = 'block';
                return;
            }

            // ä¿å­˜å§“åå¹¶æ˜¾ç¤ºçŸ¥æƒ…åŒæ„ä¹¦ç•Œé¢
            localStorage.setItem('participantName', participantName);
            document.getElementById('welcomeOverlay').style.display = 'none';
            document.getElementById('consentOverlay').style.display = 'flex';
        }

        function goToScreening() {
            // éªŒè¯å§“åï¼ˆç°åœ¨çŸ¥æƒ…åŒæ„ä¹¦å’Œç¬¬ä¸€é¡µåˆå¹¶äº†ï¼‰
            const input = document.getElementById('participantInput');
            const participantName = input.value.trim();

            if (!participantName || participantName.length < 2) {
                document.getElementById('errorText').style.display = 'block';
                return;
            }

            // ä¿å­˜å§“åå¹¶è·³è½¬åˆ°èµ„æ ¼ç­›é€‰
            localStorage.setItem('participantName', participantName);
            document.getElementById('welcomeOverlay').style.display = 'none';
            document.getElementById('consentOverlay').style.display = 'none';
            document.getElementById('screeningOverlay').style.display = 'flex';
        }

        // ========================================
        // ç¬¬äºŒæ­¥ï¼šèµ„æ ¼ç­›é€‰
        // ========================================
        function submitScreening() {
            // è·å–æ‰€æœ‰ç­›é€‰é—®é¢˜çš„ç­”æ¡ˆ
            const inclusion1 = document.querySelector('input[name="inclusion1"]:checked');
            const inclusion2 = document.querySelector('input[name="inclusion2"]:checked');
            const inclusion3 = document.querySelector('input[name="inclusion3"]:checked');
            const exclusion1 = document.querySelector('input[name="exclusion1"]:checked');

            // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰é—®é¢˜éƒ½å·²å›ç­”
            if (!inclusion1 || !inclusion2 || !inclusion3 || !exclusion1) {
                alert('è¯·å›ç­”æ‰€æœ‰èµ„æ ¼ç¡®è®¤é—®é¢˜');
                return;
            }

            // æ£€æŸ¥çº³å…¥æ ‡å‡†ï¼ˆæ‰€æœ‰çº³å…¥æ ‡å‡†éƒ½éœ€è¦é€‰"æ˜¯"ï¼‰
            const inclusionPassed =
                inclusion1.value === 'æ˜¯' &&
                inclusion2.value === 'æ˜¯' &&
                inclusion3.value === 'æ˜¯';

            // æ£€æŸ¥æ’é™¤æ ‡å‡†ï¼ˆæ’é™¤æ ‡å‡†éœ€è¦é€‰"å¦"ï¼Œå³ä¸æ˜¯éä¸´åºŠå²—ä½äººå‘˜ï¼‰
            const exclusionPassed = exclusion1.value === 'å¦';

            // ä¿å­˜ç­›é€‰ç»“æœ
            const screeningData = {
                inclusion1: inclusion1.value,
                inclusion2: inclusion2.value,
                inclusion3: inclusion3.value,
                exclusion1: exclusion1.value,
                qualified: inclusionPassed && exclusionPassed,
                timestamp: new Date().toISOString()
            };
            localStorage.setItem('screeningData', JSON.stringify(screeningData));

            if (inclusionPassed && exclusionPassed) {
                // é€šè¿‡ç­›é€‰ï¼Œç»§ç»­åˆ°ä¸ªäººä¿¡æ¯è¡¨å•
                document.getElementById('screeningOverlay').style.display = 'none';
                document.getElementById('demographicsOverlay').style.display = 'flex';
            } else {
                // æœªé€šè¿‡ç­›é€‰ï¼Œæ˜¾ç¤ºç»“æŸç•Œé¢
                document.getElementById('screeningOverlay').style.display = 'none';
                document.getElementById('disqualifiedOverlay').style.display = 'flex';
            }
        }

        // ========================================
        // ç¬¬ä¸‰æ­¥ï¼šæäº¤ä¸ªäººä¿¡æ¯
        // ========================================
        function submitDemographics() {
            // éªŒè¯æ‰€æœ‰å¿…å¡«é¡¹
            const gender = document.querySelector('input[name="gender"]:checked');
            const age = document.getElementById('age').value.trim();
            const education = document.querySelector('input[name="education"]:checked');
            const province = document.getElementById('province').value.trim();
            const workYears = document.getElementById('workYears').value.trim();
            const title = document.querySelector('input[name="title"]:checked');
            const facility = document.querySelector('input[name="facility"]:checked');
            const dailyPatients = document.getElementById('dailyPatients').value.trim();
            const aiKnowledge = document.querySelector('input[name="aiKnowledge"]:checked');
            const aiExperience = document.querySelector('input[name="aiExperience"]:checked');

            if (!gender || !age || !education || !province || !workYears || !title ||
                !facility || !dailyPatients || !aiKnowledge || !aiExperience) {
                alert('è¯·å®Œæ•´å¡«å†™æ‰€æœ‰å¿…å¡«é¡¹');
                return;
            }

            // è·å–ç­›é€‰æ•°æ®
            const screeningData = JSON.parse(localStorage.getItem('screeningData') || '{}');

            // ä¿å­˜ä¸ªäººä¿¡æ¯
            const demographics = {
                // èµ„æ ¼ç­›é€‰ä¿¡æ¯
                screening: screeningData,
                // åŸºæœ¬ä¿¡æ¯
                gender: gender.value,
                age: age,
                education: education.value,
                province: province,
                workYears: workYears,
                title: title.value,
                facility: facility.value,
                dailyPatients: dailyPatients,
                aiKnowledge: aiKnowledge.value,
                aiExperience: aiExperience.value
            };

            localStorage.setItem('demographics', JSON.stringify(demographics));

            // å…³é—­ä¸ªäººä¿¡æ¯è¡¨å•ï¼Œå¼€å§‹å®éªŒ
            document.getElementById('demographicsOverlay').style.display = 'none';
            startExperiment();
        }

        // ========================================
        // ç¬¬å››æ­¥ï¼šå¼€å§‹å®éªŒ
        // ========================================
        async function startExperiment() {
            const participantName = localStorage.getItem('participantName');
            const timestamp = new Date().toISOString();

            // éšè—æ‰€æœ‰æ¬¢è¿ç•Œé¢
            document.getElementById('welcomeOverlay').style.display = 'none';
            document.getElementById('consentOverlay').style.display = 'none';
            document.getElementById('screeningOverlay').style.display = 'none';
            document.getElementById('disqualifiedOverlay').style.display = 'none';
            document.getElementById('demographicsOverlay').style.display = 'none';

            // å°è¯•åŠ è½½ä¹‹å‰çš„è¿›åº¦
            const hasProgress = loadProgress();

            if (hasProgress) {
                // ä½¿ç”¨å·²åŠ è½½çš„è¿›åº¦
                console.log('='.repeat(60));
                console.log('âœ“ æ¢å¤å®éªŒè¿›åº¦');
                console.log('='.repeat(60));
                console.log('å‚ä¸è€…å§“å:', experimentConfig.participantName);
                console.log('å‚ä¸è€…ID:', experimentConfig.participantId);
                console.log('å½“å‰æ¡ˆä¾‹ç´¢å¼•(curCase):', curCase);
                console.log('å·²å®Œæˆæ¡ˆä¾‹æ•°(completedCases):', completedCases);
                console.log('='.repeat(60));

                document.getElementById('mainContent').style.display = 'block';
                initializeExperiment();

                // æ£€æŸ¥æ˜¯å¦æœ‰æœªå®Œæˆçš„ç³»ç»Ÿé‡è¡¨
                // æ¯å®Œæˆ3ä¸ªæ¡ˆä¾‹éœ€è¦å¡«å†™ä¸€ä¸ªç³»ç»Ÿé‡è¡¨
                // ç³»ç»Ÿ0çš„é‡è¡¨åœ¨å®Œæˆæ¡ˆä¾‹0,1,2åå¡«å†™ (completedCases=3)
                // ç³»ç»Ÿ1çš„é‡è¡¨åœ¨å®Œæˆæ¡ˆä¾‹3,4,5åå¡«å†™ (completedCases=6)
                // ç³»ç»Ÿ2çš„é‡è¡¨åœ¨å®Œæˆæ¡ˆä¾‹6,7,8åå¡«å†™ (completedCases=9)
                let pendingSurveySystemIndex = -1;

                for (let sysIdx = 0; sysIdx < 3; sysIdx++) {
                    const systemCasesCompleted = (sysIdx + 1) * 3; // 3, 6, 9
                    const surveyFilled = expData.systems[sysIdx] && expData.systems[sysIdx].survey;

                    // å¦‚æœå·²å®Œæˆè¶³å¤Ÿçš„æ¡ˆä¾‹ä½†é‡è¡¨æœªå¡«å†™
                    if (completedCases >= systemCasesCompleted && !surveyFilled) {
                        pendingSurveySystemIndex = sysIdx;
                        break; // æ‰¾åˆ°ç¬¬ä¸€ä¸ªæœªå¡«å†™çš„é‡è¡¨
                    }
                }

                if (pendingSurveySystemIndex >= 0) {
                    // æœ‰æœªå®Œæˆçš„é‡è¡¨ï¼Œæ˜¾ç¤ºå®ƒ
                    console.log(`æ£€æµ‹åˆ°ç³»ç»Ÿ${pendingSurveySystemIndex + 1}çš„é‡è¡¨æœªå®Œæˆï¼Œå°†æ˜¾ç¤ºé‡è¡¨`);
                    alert(`âœ“ å·²æ¢å¤æ‚¨çš„å®éªŒè¿›åº¦ï¼\n\næ£€æµ‹åˆ°æ‚¨æœ‰æœªå®Œæˆçš„ç³»ç»Ÿè¯„ä»·é‡è¡¨ã€‚\nè¯·å…ˆå®Œæˆé‡è¡¨å†ç»§ç»­å®éªŒã€‚`);
                    showSystemSurvey(pendingSurveySystemIndex);
                } else {
                    // æ²¡æœ‰æœªå®Œæˆçš„é‡è¡¨
                    // ã€ä¿®å¤1ã€‘éå†æ‰€æœ‰æ¡ˆä¾‹ï¼Œæ‰¾åˆ°ç¬¬ä¸€ä¸ªæœªå®Œæˆçš„æ¡ˆä¾‹ï¼ˆæ›´å¯é çš„æ–¹æ³•ï¼‰
                    let targetCase = -1;

                    for (let i = 0; i < 9; i++) {
                        const caseInfo = allCases[i];
                        const caseData = expData.cases.find(x => x.caseId === caseInfo.id && x.systemIndex === caseInfo.systemIndex);

                        // å¦‚æœæ¡ˆä¾‹ä¸å­˜åœ¨æˆ–æœªå®Œæˆæœ€ç»ˆå†³ç­–ï¼Œåˆ™è¿™æ˜¯ç›®æ ‡æ¡ˆä¾‹
                        if (!caseData || !caseData.finalDecision || !caseData.timestamps.finalSubmit) {
                            targetCase = i;
                            console.log(`[è¿›åº¦æ¢å¤] æ‰¾åˆ°ç¬¬ä¸€ä¸ªæœªå®Œæˆçš„æ¡ˆä¾‹: ç´¢å¼•${i}, ID=${caseInfo.id}`);
                            break;
                        }
                    }

                    // å¦‚æœæ‰€æœ‰æ¡ˆä¾‹éƒ½å®Œæˆäº†
                    if (targetCase === -1) {
                        console.log('[è¿›åº¦æ¢å¤] æ‰€æœ‰æ¡ˆä¾‹å·²å®Œæˆ');
                        // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰é‡è¡¨éƒ½å¡«å†™äº†
                        if (completedCases >= 9 && expData.systems[2] && expData.systems[2].survey) {
                            // æ£€æŸ¥æ˜¯å¦å·²å¡«å†™åŠ³åŠ¡è´¹ä¿¡æ¯
                            const demographics = JSON.parse(localStorage.getItem('demographics') || '{}');
                            if (demographics.reimbursement && demographics.reimbursement.idCard) {
                                // åŠ³åŠ¡è´¹ä¿¡æ¯å·²å¡«å†™ï¼Œæ˜¾ç¤ºå®Œæˆç•Œé¢
                                document.getElementById('completedParticipantId').textContent = expData.participantId;
                                document.getElementById('caseContentArea').classList.add('hidden');
                                document.getElementById('completionArea').classList.remove('hidden');
                                alert('å®éªŒå·²å®Œæˆï¼æ„Ÿè°¢æ‚¨çš„å‚ä¸ã€‚');
                                updateProgress();
                                return;
                            } else {
                                // åŠ³åŠ¡è´¹ä¿¡æ¯æœªå¡«å†™ï¼Œæ˜¾ç¤ºåŠ³åŠ¡è´¹ä¿¡æ¯æ”¶é›†ç•Œé¢
                                document.getElementById('paymentInfoOverlay').style.display = 'flex';
                                updateProgress();
                                return;
                            }
                        }
                        // å¦åˆ™æ˜¾ç¤ºæœ€åä¸€ä¸ªæ¡ˆä¾‹ï¼ˆå¯èƒ½é‡è¡¨æœªå®Œæˆï¼‰
                        targetCase = 8;
                        console.log('[è¿›åº¦æ¢å¤] æ˜¾ç¤ºæœ€åä¸€ä¸ªæ¡ˆä¾‹ï¼ˆç­‰å¾…é‡è¡¨å®Œæˆï¼‰');
                    }

                    curCase = targetCase;
                    alert(`âœ“ å·²æ¢å¤æ‚¨çš„å®éªŒè¿›åº¦ï¼\n\nå½“å‰è¿›åº¦: ç¬¬${targetCase + 1}ä¸ªæ¡ˆä¾‹ (å…±9ä¸ª)\nå·²å®Œæˆ: ${completedCases}ä¸ªæ¡ˆä¾‹\n\nç‚¹å‡»ç¡®å®šç»§ç»­å®éªŒã€‚`);
                    switchCase(targetCase);
                }

                updateProgress(); // æ›´æ–°è¿›åº¦æ¡
                return;
            }

            // å¼€å§‹æ–°å®éªŒ
            // æ˜¾ç¤ºåŠ è½½æç¤º
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loadingOverlay';
            loadingDiv.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:99999;';
            loadingDiv.innerHTML = '<div style="background:white;padding:30px 50px;border-radius:12px;text-align:center;"><div style="font-size:18px;color:#1976d2;margin-bottom:10px;">æ­£åœ¨åˆ†é…å®éªŒæ¡ä»¶...</div><div style="font-size:14px;color:#666;">è¯·ç¨å€™</div></div>';
            document.body.appendChild(loadingDiv);

            try {
                experimentConfig = await generateExperimentConfig(participantName, timestamp);
                localStorage.setItem('participantId', experimentConfig.participantId);
            } catch (error) {
                console.error('ç”Ÿæˆå®éªŒé…ç½®å¤±è´¥:', error);
                alert('å®éªŒé…ç½®ç”Ÿæˆå¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚');
                document.body.removeChild(loadingDiv);
                return;
            }

            // ç§»é™¤åŠ è½½æç¤º
            document.body.removeChild(loadingDiv);

            // å®šä¹‰æŠ—ç”Ÿç´ ç—…å†åˆ—è¡¨ï¼ˆç”¨äºéªŒè¯ï¼‰- æ–°9ä¸ªç—…ä¾‹
            // ç»„1(case001-003): å…¨éƒ¨éœ€è¦æŠ—ç”Ÿç´ 
            // ç»„2: case004ä¸éœ€è¦, case005éœ€è¦, case006éœ€è¦
            // ç»„3(case007-009): å…¨éƒ¨ä¸éœ€è¦æŠ—ç”Ÿç´ 
            const antibioticCases = ['case001', 'case002', 'case003', 'case005', 'case006'];

            // æ§åˆ¶å°è¾“å‡ºå®éªŒé…ç½®ä¿¡æ¯
            console.log('='.repeat(60));
            console.log('å®éªŒé…ç½®ä¿¡æ¯ - åˆ†è¾¨ç‡VIéƒ¨åˆ†æå› è®¾è®¡');
            console.log('='.repeat(60));
            console.log('å‚ä¸è€…å§“å:', participantName);
            console.log('å‚ä¸è€…ID:', experimentConfig.participantId);
            console.log('æ—¶é—´æˆ³:', timestamp);
            console.log('-'.repeat(60));
            console.log('å®éªŒè®¾è®¡:', experimentConfig.experimentDesign);
            console.log('-'.repeat(60));
            console.log('ç³»ç»Ÿé…ç½®è¯¦æƒ…:');
            experimentConfig.systems.forEach((s, idx) => {
                console.log(`\nç³»ç»Ÿ${idx + 1}:`);
                console.log('  - è®¾è®¡çŸ©é˜µç¼–å·:', s.systemIndex);
                console.log('  - åˆ†é…ç—…å†:', s.assignedCases.join(', '));

                // ç»Ÿè®¡æŠ—ç”Ÿç´ ç—…å†
                const antibioticInSystem = s.assignedCases.filter(caseId => antibioticCases.includes(caseId));
                console.log(`  - æŠ—ç”Ÿç´ ç—…å†: ${antibioticInSystem.length}/3 (${antibioticInSystem.join(', ') || 'æ— '})`);

                if (antibioticInSystem.length === 0) {
                    console.error(`  âš ï¸ è­¦å‘Šï¼šç³»ç»Ÿ${idx + 1}æ²¡æœ‰åŒ…å«éœ€è¦æŠ—ç”Ÿç´ çš„ç—…å†ï¼`);
                } else {
                    console.log(`  âœ“ å·²ç¡®ä¿åŒ…å«æŠ—ç”Ÿç´ ç—…å†`);
                }

                // ä¸åœ¨æ§åˆ¶å°æ˜¾ç¤ºå…·ä½“ç‰¹å¾ä¿¡æ¯
                // console.log('  - æ¿€æ´»ç‰¹å¾:', s.activeFeatures.join(', ') || 'åŸºç¡€AI');
                // console.log('  - ç‰¹å¾é…ç½®:', s.features);
                console.log('  - è®¾è®¡ä¿¡æ¯:', s.designInfo);
            });
            console.log('='.repeat(60));

            document.getElementById('mainContent').style.display = 'block';
            initializeExperiment();
        }

        function generateRandomSystems() {
            const all = Array.from({length: 32}, (_, i) => i);
            for (let i = all.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [all[i], all[j]] = [all[j], all[i]];
            }
            return all.slice(0, 3);
        }
        // ========================================
        // ã€ä¿®å¤ã€‘åˆ†å±‚éšæœºé€‰æ‹©ç—…å† - ç¡®ä¿9ä¸ªç—…ä¾‹å…¨éƒ¨ä½¿ç”¨ä¸”ä¸é‡å¤
        // ç»„1(case001-003): éœ€è¦æŠ—ç”Ÿç´ 
        // ç»„2(case004-006): éƒ¨åˆ†éœ€è¦æŠ—ç”Ÿç´  (case004ä¸éœ€è¦, case005éœ€è¦, case006éœ€è¦)
        // ç»„3(case007-009): ä¸éœ€è¦æŠ—ç”Ÿç´ 
        // ========================================

        // Fisher-Yates æ´—ç‰Œç®—æ³•
        function shuffleArray(arr) {
            const a = [...arr];
            for (let i = a.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [a[i], a[j]] = [a[j], a[i]];
            }
            return a;
        }

        // ä¸ºæ‰€æœ‰3ä¸ªç³»ç»Ÿä¸€æ¬¡æ€§åˆ†é…å…¨éƒ¨9ä¸ªç—…ä¾‹ï¼ˆä¸é‡å¤ï¼‰
        // è¿”å›æ ¼å¼: [[ç³»ç»Ÿ1çš„3ä¸ªç—…ä¾‹], [ç³»ç»Ÿ2çš„3ä¸ªç—…ä¾‹], [ç³»ç»Ÿ3çš„3ä¸ªç—…ä¾‹]]
        function selectAllCasesForSystems() {
            // å®šä¹‰ä¸‰ä¸ªç»„
            const group1 = ['case001', 'case002', 'case003'];  // éœ€è¦æŠ—ç”Ÿç´ 
            const group2 = ['case004', 'case005', 'case006'];  // éƒ¨åˆ†éœ€è¦æŠ—ç”Ÿç´ 
            const group3 = ['case007', 'case008', 'case009'];  // ä¸éœ€è¦æŠ—ç”Ÿç´ 

            // æ ‡æ³¨å“ªäº›ç—…å†éœ€è¦æŠ—ç”Ÿç´ 
            const antibioticCases = ['case001', 'case002', 'case003', 'case005', 'case006'];

            console.log('='.repeat(60));
            console.log('=== åˆ†å±‚éšæœºæŠ½æ ·ç­–ç•¥ï¼ˆå…¨å±€ä¸é‡å¤åˆ†é…ï¼‰ ===');
            console.log('='.repeat(60));

            // å¯¹æ¯ä¸ªç»„è¿›è¡Œæ´—ç‰Œ
            const shuffledGroup1 = shuffleArray(group1);
            const shuffledGroup2 = shuffleArray(group2);
            const shuffledGroup3 = shuffleArray(group3);

            console.log(`ç»„1æ´—ç‰Œç»“æœ: ${shuffledGroup1.join(', ')}`);
            console.log(`ç»„2æ´—ç‰Œç»“æœ: ${shuffledGroup2.join(', ')}`);
            console.log(`ç»„3æ´—ç‰Œç»“æœ: ${shuffledGroup3.join(', ')}`);
            console.log('-'.repeat(60));

            // ä¸º3ä¸ªç³»ç»Ÿåˆ†é…ç—…ä¾‹
            // æ¯ä¸ªç³»ç»Ÿä»æ¯ç»„è·å¾—1ä¸ªç—…ä¾‹ï¼Œä¸”ä¸é‡å¤
            const allSystemCases = [];

            for (let sysIdx = 0; sysIdx < 3; sysIdx++) {
                // ç³»ç»Ÿiè·å¾—: group1[i], group2[i], group3[i]
                let systemCases = [
                    shuffledGroup1[sysIdx],
                    shuffledGroup2[sysIdx],
                    shuffledGroup3[sysIdx]
                ];

                // æ‰“ä¹±æ¯ä¸ªç³»ç»Ÿå†…çš„ç—…ä¾‹é¡ºåºï¼ˆæ¶ˆé™¤ç»„å†…é¡ºåºæ•ˆåº”ï¼‰
                systemCases = shuffleArray(systemCases);

                allSystemCases.push(systemCases);

                // è¾“å‡ºè¯¥ç³»ç»Ÿçš„åˆ†é…ç»“æœ
                const antibioticCount = systemCases.filter(caseId => antibioticCases.includes(caseId)).length;
                console.log(`ç³»ç»Ÿ${sysIdx + 1}åˆ†é…ç—…ä¾‹: ${systemCases.join(', ')}`);
                console.log(`  ğŸ“Š æŠ—ç”Ÿç´ ç—…å†: ${antibioticCount}/3`);
                systemCases.forEach((caseId, idx) => {
                    const needsAntibiotic = antibioticCases.includes(caseId);
                    const groupNum = group1.includes(caseId) ? 1 : (group2.includes(caseId) ? 2 : 3);
                    console.log(`     ç¬¬${idx+1}ä¸ª: ${caseId} [ç»„${groupNum}]: ${needsAntibiotic ? 'âœ“ éœ€è¦æŠ—ç”Ÿç´ ' : 'âœ— ä¸éœ€è¦æŠ—ç”Ÿç´ '}`);
                });
            }

            // éªŒè¯ï¼šç¡®ä¿9ä¸ªç—…ä¾‹å…¨éƒ¨åˆ†é…ä¸”ä¸é‡å¤
            const allCaseIds = allSystemCases.flat();
            const uniqueCaseIds = [...new Set(allCaseIds)];

            console.log('-'.repeat(60));
            console.log(`âœ“ éªŒè¯: å…±åˆ†é… ${allCaseIds.length} ä¸ªç—…ä¾‹ï¼Œå»é‡å ${uniqueCaseIds.length} ä¸ª`);

            if (allCaseIds.length !== 9 || uniqueCaseIds.length !== 9) {
                console.error('âŒ é”™è¯¯ï¼šç—…ä¾‹åˆ†é…å­˜åœ¨é‡å¤æˆ–ç¼ºå¤±ï¼');
            } else {
                console.log('âœ“ éªŒè¯é€šè¿‡ï¼š9ä¸ªç—…ä¾‹å…¨éƒ¨åˆ†é…ï¼Œæ— é‡å¤');
            }
            console.log('='.repeat(60));

            return allSystemCases;
        }

        // ä¿ç•™åŸå‡½æ•°åä»¥å…¼å®¹å¯èƒ½çš„å…¶ä»–è°ƒç”¨ï¼ˆä½†ä¸å†ä½¿ç”¨ï¼‰
        function selectStratifiedCases() {
            console.warn('âš ï¸ selectStratifiedCaseså·²å¼ƒç”¨ï¼Œè¯·ä½¿ç”¨selectAllCasesForSystems');
            // è¿”å›ä¸€ä¸ªéšæœºçš„3ç—…ä¾‹ç»„åˆï¼ˆä»…ä½œä¸ºé™çº§æ–¹æ¡ˆï¼‰
            const group1 = ['case001', 'case002', 'case003'];
            const group2 = ['case004', 'case005', 'case006'];
            const group3 = ['case007', 'case008', 'case009'];
            return shuffleArray([
                group1[Math.floor(Math.random() * 3)],
                group2[Math.floor(Math.random() * 3)],
                group3[Math.floor(Math.random() * 3)]
            ]);
        }

        async function generateExperimentConfig(participantName, timestamp) {
            const designMatrix = [];

            for (let i = 0; i < 32; i++) {
                const row = {
                    A: (i >> 4) & 1,
                    B: (i >> 3) & 1,
                    C: (i >> 2) & 1,
                    D: (i >> 1) & 1,
                    E: i & 1,
                };
                row.F = row.A ^ row.B ^ row.C ^ row.D ^ row.E;
                designMatrix.push(row);
            }

            // ä½¿ç”¨åŒºç»„éšæœºåŒ–åˆ†é…å®éªŒæ¡ä»¶
            const participantId = participantName + '_' + Date.now();
            console.log('[åŒºç»„éšæœºåŒ–] æ­£åœ¨ä¸ºå‚ä¸è€…åˆ†é…å®éªŒæ¡ä»¶...');

            const systemIndices = await BlockRandomization.allocateConditions(participantId);
            console.log(`[åŒºç»„éšæœºåŒ–] åˆ†é…çš„ç³»ç»Ÿæ¡ä»¶ç´¢å¼•: [${systemIndices.join(', ')}]`);

            // ã€ä¿®å¤ã€‘ä¸€æ¬¡æ€§ä¸ºæ‰€æœ‰ç³»ç»Ÿåˆ†é…ç—…ä¾‹ï¼Œç¡®ä¿9ä¸ªç—…ä¾‹ä¸é‡å¤
            const allSystemCases = selectAllCasesForSystems();

            const systems = systemIndices.map((sysIdx, systemNum) => {
                // ä½¿ç”¨é¢„åˆ†é…çš„ç—…ä¾‹ï¼ˆä¸å†å•ç‹¬è°ƒç”¨selectStratifiedCasesï¼‰
                const shuffled = allSystemCases[systemNum];

                const featureNames = {
                    A: 'ä¾§è¾¹æ ',
                    B: 'æ€ç»´é“¾',
                    C: 'ç½®ä¿¡åº¦',
                    D: 'ç‰¹å¾é‡è¦æ€§',
                    E: 'åˆ†æ­¥è¯ç‰©',
                    F: 'è‡ªåŠ¨æå–'
                };

                const features = designMatrix[sysIdx];
                const activeFeatures = Object.entries(features)
                    .filter(([key, val]) => val === 1)
                    .map(([key]) => featureNames[key]);

                return {
                    systemIndex: sysIdx + 1,
                    systemName: `ç³»ç»Ÿ${systemNum + 1}`,
                    features: features,
                    activeFeatures: activeFeatures,
                    assignedCases: shuffled,
                    designInfo: {
                        resolution: 'VI',
                        generator: 'F=ABCDE',
                        totalRuns: 32,
                        selectedRun: sysIdx + 1,
                        blockRandomization: true  // æ ‡è®°ä½¿ç”¨äº†åŒºç»„éšæœºåŒ–
                    }
                };
            });

            return {
                participantId: participantId,
                participantName: participantName,
                timestamp: timestamp,
                experimentDesign: {
                    type: '2^(6-1)éƒ¨åˆ†æå› è®¾è®¡',
                    resolution: 'VI',
                    factors: 6,
                    runs: 32,
                    generator: 'F=ABCDE',
                    description: 'åˆ†è¾¨ç‡VIç¡®ä¿ä¸»æ•ˆåº”å’ŒäºŒå› å­äº¤äº’å¯æ¸…æ™°ä¼°è®¡',
                    randomizationMethod: 'Block Randomization'  // æ ‡è®°éšæœºåŒ–æ–¹æ³•
                },
                systems: systems
            };
        }

        function initializeExperiment() {
            // å¦‚æœå·²ç»ä»ä¿å­˜çš„è¿›åº¦ä¸­æ¢å¤äº†allCases,åˆ™è·³è¿‡é‡å»º
            const hasRestoredData = allCases.length > 0 && expData && expData.cases;

            if (!hasRestoredData) {
                allCases = [];

                experimentConfig.systems.forEach((system, sysIdx) => {
                    system.assignedCases.forEach((caseId, caseIdx) => {
                        const caseData = CASE_DATABASE[caseId];
                        if (!caseData) {
                            console.error(`ç—…å† ${caseId} åœ¨æ•°æ®åº“ä¸­æœªæ‰¾åˆ°`);
                            return;
                        }

                        allCases.push({
                            ...caseData,
                            systemIndex: sysIdx,
                            systemOrder: sysIdx,
                            systemName: system.systemName,
                            caseName: `${system.systemName}-æ¡ˆä¾‹${caseIdx + 1}`,
                            features: system.features,
                            activeFeatures: system.activeFeatures
                        });
                    });
                });
            }

            document.getElementById('experimentTag').textContent =
                `å‚ä¸è€…:${experimentConfig.participantId}`;

            // åˆå§‹åŒ–å®éªŒæ•°æ®(å¦‚æœè¿˜æ²¡æœ‰)
            if (!expData || !expData.cases) {
                const demographics = JSON.parse(localStorage.getItem('demographics') || '{}');
                expData = {
                    participantId: experimentConfig.participantId,
                    participantName: experimentConfig.participantName,
                    timestamp: experimentConfig.timestamp,
                    demographics: demographics,
                    experimentDesign: experimentConfig.experimentDesign,
                    systems: experimentConfig.systems.map(s => ({
                        systemIndex: s.systemIndex,
                        systemName: s.systemName,
                        features: s.features,
                        activeFeatures: s.activeFeatures,
                        designInfo: s.designInfo,
                        survey: null  // å°†åœ¨ç³»ç»Ÿå®Œæˆåå¡«å……
                    })),
                    startTime: new Date().toISOString(),
                    cases: [],
                    endTime: null,
                    mouseTrackingEnabled: true
                };
            }

            // åˆ›å»ºæ¡ˆä¾‹å¯¼èˆª
            const nav = document.getElementById('caseNavigationContent');
            nav.innerHTML = '';

            experimentConfig.systems.forEach((system, sysIdx) => {
                const group = document.createElement('div');
                group.className = 'system-group';

                const groupTitle = document.createElement('div');
                groupTitle.className = 'system-group-title';
                // åªæ˜¾ç¤ºç³»ç»Ÿåç§°å’Œé…ç½®ç¼–å·ï¼Œä¸æ˜¾ç¤ºå…·ä½“ç‰¹å¾å’Œæ¡ˆä¾‹æŒ‰é’®
                groupTitle.textContent = `${system.systemName} [é…ç½®#${system.systemIndex}]`;
                group.appendChild(groupTitle);

                // ä¸æ˜¾ç¤ºæ¡ˆä¾‹æŒ‰é’®ï¼Œä¿æŒç•Œé¢ç®€æ´
                nav.appendChild(group);
            });

            // åªæœ‰åœ¨æ²¡æœ‰æ¢å¤æ•°æ®æ—¶æ‰åŠ è½½ç¬¬ä¸€ä¸ªæ¡ˆä¾‹
            // å¦‚æœæ˜¯æ¢å¤è¿›åº¦ï¼ŒstartExperimentä¼šè°ƒç”¨switchCase(curCase)æ¥åŠ è½½æ­£ç¡®çš„æ¡ˆä¾‹
            if (!hasRestoredData) {
                loadCase(0);
            }
            updateProgress();
        }

        function updateProgress() {
            const totalCases = 9;
            const percentage = Math.round((completedCases / totalCases) * 100);

            const progressBarFill = document.getElementById('progressBarFill');
            const progressBarText = document.getElementById('progressBarText');
            if (progressBarFill) {
                progressBarFill.style.width = `${percentage}%`;
            }
            if (progressBarText) {
                progressBarText.textContent = `${percentage}%`;
            }

            const completedCount = document.getElementById('completedCount');
            if (completedCount) {
                completedCount.textContent = `${completedCases}/9`;
            }

            const currentCaseElement = document.getElementById('currentCase');
            if (currentCaseElement) {
                const systemNum = Math.floor(curCase / 3) + 1;
                const caseNum = (curCase % 3) + 1;
                currentCaseElement.textContent = `ç³»ç»Ÿ${systemNum}-æ¡ˆä¾‹${caseNum}`;
            }

            // ä¸å†éœ€è¦æ›´æ–°æŒ‰é’®æ ·å¼ï¼Œå› ä¸ºå·²ç§»é™¤æ¡ˆä¾‹æŒ‰é’®
            /*
            for (let i = 0; i < 9; i++) {
                const btn = document.getElementById(`nav-btn-${i}`);
                if (btn) {
                    btn.classList.remove('completed', 'current');
                    if (i < completedCases) {
                        btn.classList.add('completed');
                    } else if (i === curCase) {
                        btn.classList.add('current');
                    }
                }
            }
            */
        }

        function switchCase(i) {
            // è¾¹ç•Œæ£€æŸ¥
            if (i < 0 || i >= 9) {
                console.error('switchCase: ç´¢å¼•è¶Šç•Œ', i);
                return;
            }

            // ã€ä¿®å¤3ã€‘åœæ­¢ä¸Šä¸€ä¸ªæ¡ˆä¾‹çš„è¿½è¸ªï¼Œå¹¶ä¿å­˜è¿½è¸ªæ•°æ®
            if (MouseTracker.isTracking) {
                // ä¿å­˜å½“å‰æ¡ˆä¾‹çš„è¿½è¸ªæ•°æ®ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
                const metrics = MouseTracker.calculateMetrics();
                if (metrics && curCase >= 0 && curCase < allCases.length) {
                    const currentCaseInfo = allCases[curCase];
                    const currentCaseData = expData.cases.find(x =>
                        x.caseId === currentCaseInfo.id && x.systemIndex === currentCaseInfo.systemIndex
                    );

                    if (currentCaseData) {
                        // æ ¹æ®å½“å‰å¤„äºå“ªä¸ªé˜¶æ®µä¿å­˜æ•°æ®
                        if (!currentCaseData.initialDecision) {
                            currentCaseData.mouseTracking_initial = metrics;
                            console.log('[é¼ æ ‡è¿½è¸ª] ä¿å­˜åˆæ­¥è¯Šæ–­é˜¶æ®µçš„è¿½è¸ªæ•°æ®');
                        } else if (!currentCaseData.finalDecision) {
                            currentCaseData.mouseTracking_final = metrics;
                            console.log('[é¼ æ ‡è¿½è¸ª] ä¿å­˜æœ€ç»ˆå†³ç­–é˜¶æ®µçš„è¿½è¸ªæ•°æ®');
                        }
                        saveProgress();
                    }
                }

                MouseTracker.stopTracking();
                MouseTracker.reset();
            }

            curCase = i;
            saveProgress(); // ä¿å­˜å½“å‰æ¡ˆä¾‹ç´¢å¼•

            document.getElementById('aiSidebar').classList.remove('active');
            document.getElementById('aiModalOverlay').classList.remove('active');

            document.getElementById('aiModalOverlay').classList.remove('minimized');
            document.getElementById('aiModal').classList.remove('minimized');
            document.getElementById('minimizeIcon').textContent = 'âˆ’';

            loadCase(i);
            updateProgress();
        }

        function formatMedicalRecord(c) {
            return `æ‚£è€…ID: ${c.patientId}
æ€§åˆ«: ${c.gender}
å¹´é¾„: ${c.age}
å°±è¯Šæ—¥æœŸ: ${c.visitDate}
ã€ä¸»è¯‰ã€‘
${c.chiefComplaint}
ã€ç°ç—…å²ã€‘
${c.presentIllness}
ã€ä¸ªäººå²ã€‘
${c.personalHistory}
ã€è¯ç‰©è¿‡æ•å²ã€‘
${c.allergyHistory}
ã€ä½“æ ¼æ£€æŸ¥ã€‘
${c.physicalExam}
ã€è¾…åŠ©æ£€æŸ¥ã€‘
${c.labTests}`;
        }

        function loadCase(i) {
            // è¾¹ç•Œæ£€æŸ¥
            if (i < 0 || i >= allCases.length) {
                console.error('loadCase: ç´¢å¼•è¶Šç•Œ', i, 'æ€»æ¡ˆä¾‹æ•°:', allCases.length);
                return;
            }

            const c = allCases[i];
            if (!c) {
                console.error('loadCase: æ¡ˆä¾‹æ•°æ®ä¸å­˜åœ¨', i);
                return;
            }

            const textarea = document.getElementById('medicalRecordDisplay');
            textarea.value = formatMedicalRecord(c);
            autoResizeTextarea(textarea);

            let cd = expData.cases.find(x => x.caseId === c.id && x.systemIndex === c.systemIndex);
            if (!cd) {
                cd = {
                    caseId: c.id,
                    caseName: c.caseName,
                    systemIndex: c.systemIndex,
                    systemName: c.systemName,
                    timestamps: {}
                };
                expData.cases.push(cd);
                saveProgress(); // è‡ªåŠ¨ä¿å­˜è¿›åº¦
                cd.timestamps.caseStart = new Date().toISOString();
            }

            // æ£€æŸ¥æ¡ˆä¾‹æ˜¯å¦å·²å®Œæˆï¼ˆæœ‰finalDecisionï¼‰
            const isCompleted = cd.finalDecision && cd.timestamps.finalSubmit;
            // æ£€æŸ¥æ¡ˆä¾‹æ˜¯å¦å¤„äºåˆæ­¥è¯Šæ–­åã€æœ€ç»ˆå†³ç­–å‰çš„é˜¶æ®µ
            const hasInitialOnly = cd.initialDecision && cd.timestamps.initialSubmit && !cd.finalDecision;

            // æ¸…ç©ºæ‰€æœ‰è¡¨å•ä¸ºé»˜è®¤çŠ¶æ€
            document.getElementById('initialDiag1').value = '';
            document.getElementById('initialDiag2').value = '';
            document.getElementById('initialDiag3').value = '';
            document.querySelectorAll('input[name="initialAntibiotic"]').forEach(r => r.checked = false);
            document.getElementById('initialAntibioticTypes').classList.add('hidden');
            document.getElementById('initialAntibioticInput').value = '';

            document.getElementById('finalDiag1').value = '';
            document.getElementById('finalDiag2').value = '';
            document.getElementById('finalDiag3').value = '';
            document.querySelectorAll('input[name="finalAntibiotic"]').forEach(r => r.checked = false);
            document.getElementById('finalAntibioticTypes').classList.add('hidden');
            document.getElementById('finalAntibioticInput').value = '';
            document.querySelectorAll('input[name="certainty"]').forEach(r => r.checked = false);

            // å…³é—­æ‰€æœ‰AIé¢æ¿
            document.getElementById('aiSidebar').classList.remove('active');
            document.getElementById('aiModalOverlay').classList.remove('active');
            document.getElementById('aiModalOverlay').classList.remove('minimized');
            document.getElementById('aiModal').classList.remove('minimized');

            // é‡ç½®AIé¢æ¿ä¸­çš„å„ä¸ªsection
            document.getElementById('pasteSectionSidebar').classList.add('hidden');
            document.getElementById('pasteSectionModal').classList.add('hidden');
            document.getElementById('thinkingSection').classList.add('hidden');
            document.getElementById('thinkingSectionModal').classList.add('hidden');
            document.getElementById('diagnosisSection').classList.add('hidden');
            document.getElementById('diagnosisSectionModal').classList.add('hidden');
            document.getElementById('featureSection').classList.add('hidden');
            document.getElementById('featureSectionModal').classList.add('hidden');
            document.getElementById('treatmentSection').classList.add('hidden');
            document.getElementById('treatmentSectionModal').classList.add('hidden');

            // æ ¹æ®æ¡ˆä¾‹çŠ¶æ€æ¢å¤è¡¨å•æ•°æ®å’Œç•Œé¢
            if (isCompleted) {
                // æ¡ˆä¾‹å·²å®Œæˆ - è¿™ç§æƒ…å†µä¸€èˆ¬ä¸ä¼šå‘ç”Ÿï¼Œå› ä¸ºå·²å®Œæˆçš„æ¡ˆä¾‹ä¸åº”è¯¥å†è¢«åŠ è½½
                // ä½†ä¸ºäº†å®‰å…¨ï¼Œå¦‚æœå‘ç”Ÿäº†ï¼Œæ˜¾ç¤ºæœ€ç»ˆå†³ç­–åŒºåŸŸ
                console.log('è­¦å‘Š: åŠ è½½äº†å·²å®Œæˆçš„æ¡ˆä¾‹:', c.id);

                // æ¢å¤æœ€ç»ˆå†³ç­–æ•°æ®æ˜¾ç¤º
                if (cd.finalDecision) {
                    document.getElementById('finalDiag1').value = cd.finalDecision.diagnosis[0] || '';
                    document.getElementById('finalDiag2').value = cd.finalDecision.diagnosis[1] || '';
                    document.getElementById('finalDiag3').value = cd.finalDecision.diagnosis[2] || '';
                    if (cd.finalDecision.useAntibiotic) {
                        document.querySelector('input[name="finalAntibiotic"][value="yes"]').checked = true;
                        document.getElementById('finalAntibioticTypes').classList.remove('hidden');
                        document.getElementById('finalAntibioticInput').value = cd.finalDecision.antibiotics || '';
                    } else {
                        document.querySelector('input[name="finalAntibiotic"][value="no"]').checked = true;
                    }
                    if (cd.finalDecision.certainty) {
                        const certaintyRadio = document.querySelector(`input[name="certainty"][value="${cd.finalDecision.certainty}"]`);
                        if (certaintyRadio) certaintyRadio.checked = true;
                    }
                }

                document.getElementById('initialDecisionSection').classList.add('hidden');
                document.getElementById('finalDecisionSection').classList.remove('hidden');

            } else if (hasInitialOnly) {
                // æ¡ˆä¾‹åªå®Œæˆäº†åˆæ­¥è¯Šæ–­ï¼Œéœ€è¦æ¢å¤åˆ°AIå»ºè®®é˜¶æ®µ
                console.log('æ¢å¤åˆæ­¥è¯Šæ–­åçš„æ¡ˆä¾‹:', c.id, '- å°†é‡æ–°è·å–AIå»ºè®®');

                // æ¢å¤åˆæ­¥è¯Šæ–­æ•°æ®ï¼ˆç”¨äºåç»­çš„finalDecisioné¢„å¡«å……ï¼‰
                if (cd.initialDecision) {
                    document.getElementById('initialDiag1').value = cd.initialDecision.diagnosis[0] || '';
                    document.getElementById('initialDiag2').value = cd.initialDecision.diagnosis[1] || '';
                    document.getElementById('initialDiag3').value = cd.initialDecision.diagnosis[2] || '';
                    if (cd.initialDecision.useAntibiotic) {
                        document.querySelector('input[name="initialAntibiotic"][value="yes"]').checked = true;
                        document.getElementById('initialAntibioticTypes').classList.remove('hidden');
                        document.getElementById('initialAntibioticInput').value = cd.initialDecision.antibiotics || '';
                    } else {
                        document.querySelector('input[name="initialAntibiotic"][value="no"]').checked = true;
                    }
                }

                // éšè—ä¸¤ä¸ªå†³ç­–åŒºåŸŸï¼Œç­‰å¾…AIå»ºè®®å±•ç¤ºåå†æ˜¾ç¤ºfinalDecisionSection
                document.getElementById('initialDecisionSection').classList.add('hidden');
                document.getElementById('finalDecisionSection').classList.add('hidden');

                // ã€ä¿®å¤4ã€‘è‡ªåŠ¨è§¦å‘AIå»ºè®®è·å–ï¼Œæ¢å¤åˆ°ä¹‹å‰çš„é˜¶æ®µ
                setTimeout(async () => {
                    // æ£€æŸ¥æ˜¯å¦å·²æœ‰AIå»ºè®®æ•°æ®ï¼ˆé¿å…é‡å¤è·å–ï¼‰
                    const hasAIData = cd.aiSuggestionShown || cd.timestamps.aiSuggestionDisplayed;

                    if (hasAIData) {
                        console.log('[AIæ¢å¤] æ£€æµ‹åˆ°å·²æœ‰AIå»ºè®®æ•°æ®ï¼Œè·³è¿‡é‡å¤è·å–');
                        // ç›´æ¥æ˜¾ç¤ºæœ€ç»ˆå†³ç­–åŒºåŸŸ
                        document.getElementById('initialDecisionSection').classList.add('hidden');
                        document.getElementById('finalDecisionSection').classList.remove('hidden');

                        // é¢„å¡«å……åˆæ­¥è¯Šæ–­æ•°æ®åˆ°æœ€ç»ˆå†³ç­–
                        if (cd.initialDecision) {
                            document.getElementById('finalDiag1').value = cd.initialDecision.diagnosis[0] || '';
                            document.getElementById('finalDiag2').value = cd.initialDecision.diagnosis[1] || '';
                            document.getElementById('finalDiag3').value = cd.initialDecision.diagnosis[2] || '';
                        }
                        return;
                    }

                    // å¦‚æœéœ€è¦ç²˜è´´å†…å®¹çš„æ¨¡å¼(F=0)ä¸”æ²¡æœ‰ç²˜è´´è¿‡ï¼Œæ˜¾ç¤ºç²˜è´´åŒºåŸŸ
                    if (c.features.F === 0 && !cd.timestamps.pastedContent) {
                        const useModal = (c.features.A === 0);
                        if (useModal) {
                            document.getElementById('aiModalOverlay').classList.add('active');
                            document.getElementById('pasteSectionModal').classList.remove('hidden');
                        } else {
                            document.getElementById('aiSidebar').classList.add('active');
                            document.getElementById('pasteSectionSidebar').classList.remove('hidden');
                        }
                    } else {
                        // è‡ªåŠ¨æå–æ¨¡å¼æˆ–å·²ç²˜è´´è¿‡å†…å®¹ï¼Œè·å–AIå»ºè®®
                        console.log('[AIæ¢å¤] é‡æ–°è·å–AIå»ºè®®');
                        await getAISuggestion();
                    }
                }, 500);

            } else {
                // æ–°æ¡ˆä¾‹æˆ–æœªå¼€å§‹çš„æ¡ˆä¾‹ï¼Œæ˜¾ç¤ºåˆæ­¥è¯Šæ–­åŒºåŸŸ
                document.getElementById('initialDecisionSection').classList.remove('hidden');
                document.getElementById('finalDecisionSection').classList.add('hidden');

                // å¯åŠ¨è¿½è¸ª - é˜¶æ®µ1ï¼ˆåˆæ­¥è¯Šæ–­ï¼‰
                setTimeout(() => {
                    const submitBtn = document.querySelector('#initialDecisionSection .btn-ai-suggest');
                    if (submitBtn) {
                        MouseTracker.startTracking(`case_${c.id}_system_${c.systemIndex}_initial`, submitBtn);
                    }
                }, 500);
            }
        }

        document.querySelectorAll('input[name="initialAntibiotic"]').forEach(r => {
            r.addEventListener('change', function() {
                document.getElementById('initialAntibioticTypes').classList.toggle('hidden', this.value !== 'yes');
            });
        });

        document.querySelectorAll('input[name="finalAntibiotic"]').forEach(r => {
            r.addEventListener('change', function() {
                document.getElementById('finalAntibioticTypes').classList.toggle('hidden', this.value !== 'yes');
            });
        });

        async function submitInitialDecision() {
            const d1 = document.getElementById('initialDiag1').value.trim();
            const d2 = document.getElementById('initialDiag2').value.trim();
            const d3 = document.getElementById('initialDiag3').value.trim();
            const ab = document.querySelector('input[name="initialAntibiotic"]:checked');

            if (!d1) {
                alert('è¯·å¡«å†™ç¬¬ä¸€è¯Šæ–­ï¼ˆå¿…å¡«ï¼‰');
                return;
            }
            if (!ab) {
                alert('è¯·é€‰æ‹©æ˜¯å¦ä½¿ç”¨æŠ—ç”Ÿç´ ');
                return;
            }

            const useAb = ab.value === 'yes';
            let abs = '';
            if (useAb) {
                abs = document.getElementById('initialAntibioticInput').value.trim();
                if (!abs) {
                    alert('è¯·å¡«å†™æŠ—ç”Ÿç´ ç§ç±»');
                    return;
                }
            }

            const c = allCases[curCase];
            const cd = expData.cases.find(x => x.caseId === c.id && x.systemIndex === c.systemIndex);
            cd.initialDecision = {
                diagnosis: [d1, d2, d3],
                useAntibiotic: useAb,
                antibiotics: abs
            };
            cd.timestamps.initialSubmit = new Date().toISOString();

            saveProgress(); // è‡ªåŠ¨ä¿å­˜è¿›åº¦

            // ä¿å­˜ç¬¬ä¸€é˜¶æ®µçš„è¿½è¸ªæ•°æ®
            if (MouseTracker.isTracking) {
                const metrics = MouseTracker.calculateMetrics();
                if (metrics) {
                    cd.mouseTracking_initial = metrics;
                }
                MouseTracker.reset();
            }

            const useModal = (c.features.A === 0);

            if (c.features.F === 0) {
                if (useModal) {
                    document.getElementById('aiModalOverlay').classList.add('active');
                    document.getElementById('pasteSectionModal').classList.remove('hidden');
                    document.getElementById('pasteTextareaModal').value = '';

                    document.getElementById('thinkingSectionModal').classList.add('hidden');
                    document.getElementById('diagnosisSectionModal').classList.add('hidden');
                    document.getElementById('featureSectionModal').classList.add('hidden');
                    document.getElementById('treatmentSectionModal').classList.add('hidden');
                } else {
                    document.getElementById('aiSidebar').classList.add('active');
                    document.getElementById('pasteSectionSidebar').classList.remove('hidden');
                    document.getElementById('pasteTextareaSidebar').value = '';

                    document.getElementById('thinkingSection').classList.add('hidden');
                    document.getElementById('diagnosisSection').classList.add('hidden');
                    document.getElementById('featureSection').classList.add('hidden');
                    document.getElementById('treatmentSection').classList.add('hidden');
                }
            } else {
                await getAISuggestion();
            }
        }

        async function getAISuggestion() {
            const c = allCases[curCase];
            const useModal = (c.features.A === 0);
            const rec = c.aiRecommendation;

            if (useModal) {
                document.getElementById('aiModalOverlay').classList.add('active');
                document.getElementById('aiModalOverlay').classList.remove('minimized');
                document.getElementById('aiModal').classList.remove('minimized');
                document.getElementById('minimizeIcon').textContent = 'âˆ’';

                document.getElementById('pasteSectionModal').classList.add('hidden');
                document.getElementById('diagnosisSectionModal').classList.remove('hidden');
                currentDisplayMode = 'modal';
            } else {
                document.getElementById('aiSidebar').classList.add('active');
                document.getElementById('pasteSectionSidebar').classList.add('hidden');
                document.getElementById('diagnosisSection').classList.remove('hidden');
                currentDisplayMode = 'sidebar';
            }

            const getElement = (baseName) => {
                return document.getElementById(baseName + (useModal ? 'Modal' : ''));
            };

            // ===== ç¬¬ä¸€éƒ¨åˆ†ï¼šè¯Šç–—å»ºè®®ï¼ˆè¯Šæ–­ç»“è®º + æ˜¯å¦éœ€è¦æŠ—ç”Ÿç´ ï¼‰ =====
            getElement('diagnosisSection').classList.remove('hidden');
            let diagnosisHTML = '<div class="ai-conclusion"><div class="conclusion-label">ğŸ¯ AIè¯Šæ–­ç»“è®º</div>';

            c.aiRecommendation.diagnosis.forEach((d, i) => {
                diagnosisHTML += `<div class="diagnosis-item-with-confidence">
                    <div class="diagnosis-name">${i+1}. ${d.name}</div>`;

                if (c.features.C === 1) {
                    const confClass = d.confidence >= 80 ? 'high' : d.confidence >= 60 ? 'medium' : 'low';
                    const confExplain = d.confidence >= 80 ? 'é«˜ç½®ä¿¡åº¦:AIå¯¹æ­¤è¯Šæ–­éå¸¸ç¡®å®š' :
                                       d.confidence >= 60 ? 'ä¸­ç­‰ç½®ä¿¡åº¦:AIè®¤ä¸ºæ­¤è¯Šæ–­è¾ƒä¸ºå¯èƒ½' :
                                       'ä½ç½®ä¿¡åº¦:AIè®¤ä¸ºæ­¤è¯Šæ–­å¯èƒ½æ€§è¾ƒä½';
                    diagnosisHTML += `
                        <div class="confidence-bar-container">
                            <div class="confidence-bar">
                                <div class="confidence-fill ${confClass}" style="width: ${d.confidence}%"></div>
                            </div>
                            <span class="confidence-text">${d.confidence}%</span>
                        </div>
                        <div class="confidence-explain">${confExplain}</div>`;
                }

                diagnosisHTML += `</div>`;
            });
            diagnosisHTML += '</div>';

            // åœ¨è¯Šæ–­ç»“è®ºåæ·»åŠ "æ˜¯å¦éœ€è¦æŠ—ç”Ÿç´ "çš„åˆ¤æ–­
            diagnosisHTML += `
                <div style="margin-top: 16px; padding: 12px; background: white; border-radius: 4px; border: 2px solid ${rec.useAntibiotic ? '#27ae60' : '#e74c3c'};">
                    <strong>ğŸ’‰ æ˜¯å¦éœ€è¦æŠ—ç”Ÿç´ :</strong>
                    <span style="color: ${rec.useAntibiotic ? '#27ae60' : '#e74c3c'}; font-weight: 600; font-size: 15px;">
                        ${rec.useAntibiotic ? 'âœ“ å»ºè®®ä½¿ç”¨' : 'âœ— ä¸å»ºè®®ä½¿ç”¨'}
                    </span>
                </div>
            `;

            getElement('diagnosisContent').innerHTML = diagnosisHTML;

            // ===== ç¬¬äºŒéƒ¨åˆ†ï¼šæ¨ç†è¿‡ç¨‹ï¼ˆå¦‚æœB=1ï¼‰ =====
            if (c.features.B === 1) {
                await sleep(500);
                getElement('thinkingSection').classList.remove('hidden');
                const thinkingProcess = getElement('thinkingProcess');
                thinkingProcess.innerHTML = '';

                for (let i = 0; i < c.aiRecommendation.thinking.length; i++) {
                    await sleep(300);
                    const step = document.createElement('div');
                    step.className = 'thinking-step';
                    step.innerHTML = `<span class="thinking-label">æ­¥éª¤ ${i+1}:</span> ${c.aiRecommendation.thinking[i]}`;
                    thinkingProcess.appendChild(step);
                }
                await sleep(500);
            } else {
                getElement('thinkingSection').classList.add('hidden');
            }

            // ===== ç¬¬ä¸‰éƒ¨åˆ†ï¼šç‰¹å¾åˆ†æï¼ˆå¦‚æœD=1ï¼‰ =====
            if (c.features.D === 1) {
                await sleep(500);
                renderFeatureImportance(c.aiRecommendation.featureImportance, useModal);
                getElement('featureSection').classList.remove('hidden');
            } else {
                getElement('featureSection').classList.add('hidden');
            }

            // ===== ç¬¬å››éƒ¨åˆ†ï¼šç”¨è¯å»ºè®®åŠè¯´æ˜ =====
            await sleep(500);
            await showTreatmentRecommendation(c, useModal);

            document.getElementById('initialDecisionSection').classList.add('hidden');
            const finalSection = document.getElementById('finalDecisionSection');
            finalSection.classList.remove('hidden');

            // æ·»åŠ é«˜äº®æ•ˆæœåˆ°æœ€ç»ˆå†³ç­–åŒºåŸŸ
            setTimeout(() => {
                finalSection.classList.add('highlight-effect');
                // 20ç§’åç§»é™¤é«˜äº®æ•ˆæœ
                setTimeout(() => {
                    finalSection.classList.remove('highlight-effect');
                }, 200000);
            }, 100);

            // å¯åŠ¨ç¬¬äºŒé˜¶æ®µçš„è¿½è¸ªï¼ˆæœ€ç»ˆå†³ç­–ï¼‰
            setTimeout(() => {
                const submitBtn = document.querySelector('#finalDecisionSection .btn-success');
                if (submitBtn) {
                    MouseTracker.startTracking(`case_${c.id}_system_${c.systemIndex}_final`, submitBtn);
                }
            }, 500);

            const cd = expData.cases.find(x => x.caseId === c.id && x.systemIndex === c.systemIndex);
            document.getElementById('finalDiag1').value = cd.initialDecision.diagnosis[0];
            document.getElementById('finalDiag2').value = cd.initialDecision.diagnosis[1];
            document.getElementById('finalDiag3').value = cd.initialDecision.diagnosis[2];

            const antibioticValue = cd.initialDecision.useAntibiotic ? 'yes' : 'no';
            document.querySelector(`input[name="finalAntibiotic"][value="${antibioticValue}"]`).checked = true;

            if (cd.initialDecision.useAntibiotic) {
                document.getElementById('finalAntibioticTypes').classList.remove('hidden');
                document.getElementById('finalAntibioticInput').value = cd.initialDecision.antibiotics;
            }
        }

        function renderFeatureImportance(data, useModal = false) {
            // å¦‚æœChart.jsæœªåŠ è½½ï¼Œæ˜¾ç¤ºçº¯æ–‡æœ¬æ›¿ä»£
            if (typeof Chart === 'undefined') {
                const containerId = useModal ? 'featureSectionModal' : 'featureSection';
                const container = document.getElementById(containerId);
                if (container) {
                    let fallbackHTML = '<div style="padding:12px;background:#f8f9fa;border-radius:6px;">';
                    fallbackHTML += '<div style="font-size:14px;font-weight:600;color:#2c3e50;margin-bottom:10px;">ğŸ“Š å…³é”®ç‰¹å¾å¯¹è¯Šæ–­çš„å½±å“ç¨‹åº¦</div>';
                    fallbackHTML += '<div style="font-size:12px;color:#718096;margin-bottom:10px;">ï¼ˆå›¾è¡¨åº“æœªåŠ è½½ï¼Œä»¥æ–‡å­—å½¢å¼å±•ç¤ºï¼‰</div>';
                    data.features.forEach((feature, i) => {
                        const val = data.gradients[i];
                        const pct = (Math.abs(val) * 100).toFixed(1);
                        const direction = val >= 0 ? 'æ”¯æŒ' : 'ä¸æ”¯æŒ';
                        const color = val >= 0 ? '#27ae60' : '#e74c3c';
                        const barWidth = Math.abs(val) * 100;
                        fallbackHTML += `<div style="margin-bottom:6px;display:flex;align-items:center;gap:8px;">
                            <span style="min-width:120px;font-size:12px;color:#4a5568;text-align:right;">${feature}</span>
                            <div style="flex:1;height:16px;background:#e0e6ed;border-radius:3px;overflow:hidden;">
                                <div style="width:${barWidth}%;height:100%;background:${color};border-radius:3px;"></div>
                            </div>
                            <span style="min-width:80px;font-size:11px;color:${color};">${direction} ${pct}%</span>
                        </div>`;
                    });
                    fallbackHTML += '</div>';
                    // æ›¿æ¢å›¾è¡¨å®¹å™¨å†…å®¹
                    const igViz = container.querySelector('.ig-visualization');
                    if (igViz) {
                        igViz.innerHTML = fallbackHTML;
                    }
                }
                return;
            }

            const chartId = useModal ? 'igChartModal' : 'igChart';
            const ctx = document.getElementById(chartId);

            if (useModal && igChartInstanceModal) {
                igChartInstanceModal.destroy();
            } else if (!useModal && igChartInstance) {
                igChartInstance.destroy();
            }

            // æ ¹æ®ç‰¹å¾æ•°é‡åŠ¨æ€è°ƒæ•´å›¾è¡¨å®¹å™¨é«˜åº¦
            const featureCount = data.features.length;
            const minBarHeight = 28; // æ¯ä¸ªbaræœ€å°é«˜åº¦(px)
            const minContainerHeight = Math.max(280, featureCount * minBarHeight);
            const container = ctx.parentElement;
            if (container) {
                container.style.height = minContainerHeight + 'px';
            }

            const colors = data.gradients.map(val => val >= 0 ? '#27ae60' : '#e74c3c');

            const chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.features,
                    datasets: [{
                        data: data.gradients,
                        backgroundColor: colors,
                        borderColor: colors,
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.x;
                                    const direction = value >= 0 ? 'æ”¯æŒ' : 'ä¸æ”¯æŒ';
                                    return `${direction}å½“å‰è¯Šæ–­: ${Math.abs(value * 100).toFixed(1)}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return (value * 100).toFixed(0) + '%';
                                }
                            }
                        },
                        y: {
                            ticks: {
                                autoSkip: false,  // ä¸è·³è¿‡ä»»ä½•æ ‡ç­¾
                                font: {
                                    size: 12
                                }
                            }
                        }
                    }
                }
            });

            if (useModal) {
                igChartInstanceModal = chartInstance;
            } else {
                igChartInstance = chartInstance;
            }
        }

        async function showTreatmentRecommendation(c, useModal = false) {
            const rec = c.aiRecommendation;
            const getElement = (baseName) => {
                return document.getElementById(baseName + (useModal ? 'Modal' : ''));
            };

            let html = '';

            if (rec.useAntibiotic && rec.antibioticStandard) {
                if (c.features.E === 1) {
                    html += `
                        <div class="antibiotic-standard">
                            <strong>ğŸ¥ æ ‡å‡†æ²»ç–—æ–¹æ¡ˆ:</strong>
                            <div style="margin-top: 6px; color: #e65100;">${rec.antibioticStandard}</div>
                        </div>
                    `;

                    getElement('treatmentContent').innerHTML = html;
                    getElement('treatmentSection').classList.remove('hidden');

                    await sleep(1500);
                    html += '<div class="searching-indicator">ğŸ” æ­£åœ¨æ£€ç´¢åŸºå±‚åŒ»ç–—æœºæ„è¯å“åº“å­˜...</div>';
                    getElement('treatmentContent').innerHTML = html;

                    await sleep(1500);
                    html = html.replace('<div class="searching-indicator">ğŸ” æ­£åœ¨æ£€ç´¢åŸºå±‚åŒ»ç–—æœºæ„è¯å“åº“å­˜...</div>', '');
                    html += `
                        <div class="antibiotic-primary">
                            <strong>âœ“ åŸºå±‚åŒ»ç–—æœºæ„å¯åŠæ–¹æ¡ˆ:</strong>
                            <div style="margin-top: 6px; color: #2e7d32; font-weight: 600;">${rec.antibioticPrimary}</div>
                            <div style="margin-top: 8px; font-size: 12px; color: #059669;">è¯¥æ–¹æ¡ˆè¯ç‰©åœ¨åŸºå±‚åŒ»ç–—æœºæ„å¸¸å¤‡,å¯ç«‹å³è·å–</div>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="antibiotic-standard">
                            <strong>ğŸ¥ æ ‡å‡†æ²»ç–—æ–¹æ¡ˆ:</strong>
                            <div style="margin-top: 6px; color: #e65100;">${rec.antibioticStandard}</div>
                        </div>
                    `;
                }
                getElement('treatmentContent').innerHTML = html;
                getElement('treatmentSection').classList.remove('hidden');
            } else {
                // å¦‚æœä¸éœ€è¦æŠ—ç”Ÿç´ ï¼Œæ˜¾ç¤ºè¯´æ˜
                html = `
                    <div style="padding: 12px; background: #f0f9ff; border-radius: 4px; border-left: 3px solid #3498db;">
                        <div style="color: #1e40af; font-size: 14px; line-height: 1.6;">
                            æ ¹æ®AIåˆ†æï¼Œè¯¥æ‚£è€…ç›®å‰ä¸éœ€è¦ä½¿ç”¨æŠ—ç”Ÿç´ æ²»ç–—ã€‚å»ºè®®é‡‡å–å¯¹ç—‡æ”¯æŒæ²»ç–—ï¼Œå¦‚å……åˆ†ä¼‘æ¯ã€å¤šé¥®æ°´ç­‰ã€‚å¦‚ç—‡çŠ¶åŠ é‡æˆ–æŒç»­ï¼Œè¯·åŠæ—¶å¤è¯Šã€‚
                        </div>
                    </div>
                `;
                getElement('treatmentContent').innerHTML = html;
                getElement('treatmentSection').classList.remove('hidden');
            }
        }

        function submitFinalDecision() {
            const d1 = document.getElementById('finalDiag1').value.trim();
            const d2 = document.getElementById('finalDiag2').value.trim();
            const d3 = document.getElementById('finalDiag3').value.trim();
            const ab = document.querySelector('input[name="finalAntibiotic"]:checked');
            const cert = document.querySelector('input[name="certainty"]:checked');

            if (!d1 || !ab || !cert) {
                alert('è¯·å®Œæ•´å¡«å†™å¿…å¡«ä¿¡æ¯ï¼ˆç¬¬ä¸€è¯Šæ–­ã€æ˜¯å¦ä½¿ç”¨æŠ—ç”Ÿç´ ã€å†³ç­–ç¡®å®šæ€§ï¼‰');
                return;
            }

            const useAb = ab.value === 'yes';
            let abs = '';
            if (useAb) {
                abs = document.getElementById('finalAntibioticInput').value.trim();
                if (!abs) {
                    alert('è¯·å¡«å†™æŠ—ç”Ÿç´ ç§ç±»');
                    return;
                }
            }

            const c = allCases[curCase];
            const cd = expData.cases.find(x => x.caseId === c.id && x.systemIndex === c.systemIndex);
            cd.finalDecision = {
                diagnosis: [d1, d2, d3],
                useAntibiotic: useAb,
                antibiotics: abs,
                certainty: parseInt(cert.value)
            };
            cd.timestamps.finalSubmit = new Date().toISOString();

            saveProgress(); // è‡ªåŠ¨ä¿å­˜è¿›åº¦

            // ä¿å­˜ç¬¬äºŒé˜¶æ®µçš„è¿½è¸ªæ•°æ®
            if (MouseTracker.isTracking) {
                const metrics = MouseTracker.calculateMetrics();
                if (metrics) {
                    cd.mouseTracking_final = metrics;
                }
            }

            // æ˜¾ç¤ºæç¤ºæ¡†
            const tipDiv = document.createElement('div');
            tipDiv.className = 'submit-tip';
            tipDiv.textContent = 'âœ“ æœ€ç»ˆå†³ç­–å·²æˆåŠŸæäº¤ï¼';
            document.body.appendChild(tipDiv);

            // 20ç§’åè‡ªåŠ¨ç§»é™¤æç¤ºæ¡†
            setTimeout(() => {
                if (tipDiv.parentNode) {
                    tipDiv.parentNode.removeChild(tipDiv);
                }
            }, 3000);

            // æ·»åŠ é«˜äº®æ•ˆæœåˆ°æœ€ç»ˆå†³ç­–åŒºåŸŸ
            const finalSection = document.getElementById('finalDecisionSection');
            if (finalSection) {
                finalSection.classList.add('highlight-effect');

                // 20ç§’åè‡ªåŠ¨ç§»é™¤é«˜äº®æ•ˆæœ
                setTimeout(() => {
                    finalSection.classList.remove('highlight-effect');
                }, 300000);
            }

            completedCases++;
            // æ›´æ–°curCaseæŒ‡å‘ä¸‹ä¸€ä¸ªæ¡ˆä¾‹ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
            if (curCase < 8) {
                curCase = curCase + 1;
            }
            saveProgress(); // è‡ªåŠ¨ä¿å­˜è¿›åº¦
            updateProgress();

            document.getElementById('aiSidebar').classList.remove('active');
            document.getElementById('aiModalOverlay').classList.remove('active');

            // ã€ä¿®å¤2ã€‘æ£€æŸ¥æ˜¯å¦å®Œæˆäº†ä¸€ä¸ªç³»ç»Ÿçš„æ‰€æœ‰ç—…å† (æ¯3ä¸ªæ¡ˆä¾‹) - ä¼˜åŒ–å¯è¯»æ€§
            const shouldShowSurvey = (completedCases === 3 || completedCases === 6 || completedCases === 9);

            if (shouldShowSurvey) {
                // è®¡ç®—åº”è¯¥æ˜¾ç¤ºå“ªä¸ªç³»ç»Ÿçš„é‡è¡¨ (ç³»ç»Ÿ0, 1, 2)
                const systemIndex = Math.floor((completedCases - 1) / 3);
                console.log(`[é‡è¡¨è§¦å‘] å·²å®Œæˆ${completedCases}ä¸ªæ¡ˆä¾‹ï¼Œæ˜¾ç¤ºç³»ç»Ÿ${systemIndex}çš„é‡è¡¨`);
                showSystemSurvey(systemIndex);
            } else {
                // ç»§ç»­ä¸‹ä¸€ä¸ªç—…å†
                alert(`æ¡ˆä¾‹å·²å®Œæˆ!è¯·ç»§ç»­ä¸‹ä¸€æ¡ˆä¾‹ã€‚`);
                switchCase(curCase);
            }
        }

        // ========================================
        // ç³»ç»Ÿè¯„ä»·é‡è¡¨
        // ========================================
        function showSystemSurvey(systemIdx) {
            currentSystemIndex = systemIdx;
            const systemName = experimentConfig.systems[systemIdx].systemName;
            document.getElementById('surveySystemName').textContent = systemName;

            // æ˜¾ç¤ºé‡è¡¨
            document.getElementById('systemSurveyOverlay').style.display = 'flex';

            // é‡ç½®æ‰€æœ‰é‡è¡¨é€‰é¡¹ä¸ºé»˜è®¤çŠ¶æ€
            resetSystemSurvey();
        }


        function resetSystemSurvey() {
            // é‡ç½®æ‰€æœ‰radioæŒ‰é’®
            const radios = document.querySelectorAll('#systemSurveyOverlay input[type="radio"]');
            radios.forEach(radio => {
                radio.checked = false;
            });

            console.log('é‡è¡¨å·²é‡ç½®ä¸ºé»˜è®¤çŠ¶æ€');
        }

        function submitSystemSurvey() {
            // éªŒè¯æ‰€æœ‰é‡è¡¨é¡¹éƒ½å·²å¡«å†™
            const requiredIntention = ['intention1', 'intention2', 'intention3'];
            const requiredSliders = [
                'usefulness1', 'usefulness2', 'usefulness3', 'usefulness4', 'usefulness5', 'usefulness6',
                'easeOfUse1', 'easeOfUse2', 'easeOfUse3', 'easeOfUse4', 'easeOfUse5', 'easeOfUse6'
            ];

            // éªŒè¯é‡‡çº³æ„æ„¿ï¼ˆå•é€‰æŒ‰é’®ï¼‰
            for (const field of requiredIntention) {
                const radioChecked = document.querySelector(`input[name="${field}"]:checked`);
                if (!radioChecked) {
                    alert(`è¯·å®Œæ•´å¡«å†™ã€é‡‡çº³æ„æ„¿ã€‘éƒ¨åˆ†çš„æ‰€æœ‰é¢˜ç›®\n\næœªå®Œæˆé¡¹ï¼š${field}\n\næç¤ºï¼šè¯·ç¡®ä¿é€‰æ‹©äº†"é‡‡çº³æ„æ„¿"éƒ¨åˆ†çš„æ‰€æœ‰3ä¸ªå•é€‰é¢˜`);
                    // æ‰¾åˆ°æœªå¡«å†™çš„å•é€‰æŒ‰é’®ç»„å¹¶æ»šåŠ¨åˆ°é‚£é‡Œ
                    const radioGroup = document.querySelector(`input[name="${field}"]`);
                    if (radioGroup) {
                        radioGroup.parentElement.parentElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        // é«˜äº®æ˜¾ç¤ºæœªå¡«å†™çš„é¢˜ç›®
                        radioGroup.parentElement.parentElement.style.background = '#ffe6e6';
                        setTimeout(() => {
                            radioGroup.parentElement.parentElement.style.background = '';
                        }, 3000);
                    }
                    return;
                }
            }

            // éªŒè¯é€‰æ‹©é¢˜ï¼ˆæ„ŸçŸ¥æœ‰ç”¨æ€§å’Œæ„ŸçŸ¥æ˜“ç”¨æ€§ï¼‰
            for (const field of requiredSliders) {
                const radioChecked = document.querySelector(`input[name="${field}"]:checked`);
                if (!radioChecked) {
                    const sectionName = field.startsWith('usefulness') ? 'æ„ŸçŸ¥æœ‰ç”¨æ€§' : 'æ„ŸçŸ¥æ˜“ç”¨æ€§';
                    alert(`è¯·å®Œæ•´å¡«å†™ã€${sectionName}ã€‘éƒ¨åˆ†çš„æ‰€æœ‰é¢˜ç›®\n\næœªå®Œæˆé¡¹ï¼š${field}\n\næç¤ºï¼šè¯·é€‰æ‹©æ‰€æœ‰é¢˜ç›®çš„é€‰é¡¹`);
                    // æ‰¾åˆ°æœªå¡«å†™çš„å•é€‰æŒ‰é’®ç»„å¹¶æ»šåŠ¨åˆ°é‚£é‡Œ
                    const radioGroup = document.querySelector(`input[name="${field}"]`);
                    if (radioGroup) {
                        radioGroup.parentElement.parentElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        // é«˜äº®æ˜¾ç¤ºæœªå¡«å†™çš„é¢˜ç›®
                        radioGroup.parentElement.parentElement.style.background = '#ffe6e6';
                        setTimeout(() => {
                            radioGroup.parentElement.parentElement.style.background = '';
                        }, 3000);
                    }
                    return;
                }
            }

            // æ‰€æœ‰éªŒè¯é€šè¿‡åï¼Œå¼¹å‡ºç¡®è®¤æç¤º
            const confirmSubmit = confirm('ğŸ“‹ æäº¤ç¡®è®¤\n\nè¯·ç¡®è®¤æ‚¨çš„è¯„ä»·æ˜¯å¦å‡†ç¡®åæ˜ äº†å¯¹è¯¥AIç³»ç»Ÿçš„çœŸå®æ„Ÿå—ï¼Ÿ\n\nç‚¹å‡»"ç¡®å®š"æäº¤è¯„ä»·ï¼Œç‚¹å‡»"å–æ¶ˆ"è¿”å›æ£€æŸ¥ã€‚');
            if (!confirmSubmit) {
                return; // ç”¨æˆ·é€‰æ‹©è¿”å›æ£€æŸ¥
            }

            // æ”¶é›†é‡è¡¨æ•°æ®
            const surveyData = {
                intention: {
                    q1: parseInt(document.querySelector('input[name="intention1"]:checked').value),
                    q2: parseInt(document.querySelector('input[name="intention2"]:checked').value),
                    q3: parseInt(document.querySelector('input[name="intention3"]:checked').value)
                },
                usefulness: {
                    q1: parseInt(document.querySelector('input[name="usefulness1"]:checked').value),
                    q2: parseInt(document.querySelector('input[name="usefulness2"]:checked').value),
                    q3: parseInt(document.querySelector('input[name="usefulness3"]:checked').value),
                    q4: parseInt(document.querySelector('input[name="usefulness4"]:checked').value),
                    q5: parseInt(document.querySelector('input[name="usefulness5"]:checked').value),
                    q6: parseInt(document.querySelector('input[name="usefulness6"]:checked').value)
                },
                easeOfUse: {
                    q1: parseInt(document.querySelector('input[name="easeOfUse1"]:checked').value),
                    q2: parseInt(document.querySelector('input[name="easeOfUse2"]:checked').value),
                    q3: parseInt(document.querySelector('input[name="easeOfUse3"]:checked').value),
                    q4: parseInt(document.querySelector('input[name="easeOfUse4"]:checked').value),
                    q5: parseInt(document.querySelector('input[name="easeOfUse5"]:checked').value),
                    q6: parseInt(document.querySelector('input[name="easeOfUse6"]:checked').value)
                },
                timestamp: new Date().toISOString()
            };

            // ä¿å­˜åˆ°å¯¹åº”ç³»ç»Ÿçš„æ•°æ®ä¸­
            expData.systems[currentSystemIndex].survey = surveyData;
            saveProgress(); // ç«‹å³ä¿å­˜é‡è¡¨æ•°æ®

            // å…³é—­é‡è¡¨
            document.getElementById('systemSurveyOverlay').style.display = 'none';

            if (completedCases >= 9) {
                // æ‰€æœ‰å®éªŒå®Œæˆï¼Œæ˜¾ç¤ºåŠ³åŠ¡è´¹ä¿¡æ¯æ”¶é›†ç•Œé¢
                expData.endTime = new Date().toISOString();
                saveProgress(); // æœ€ç»ˆä¿å­˜

                const allResults = JSON.parse(localStorage.getItem('experimentResults') || '[]');
                allResults.push(expData);
                localStorage.setItem('experimentResults', JSON.stringify(allResults));

                // æ˜¾ç¤ºåŠ³åŠ¡è´¹ä¿¡æ¯æ”¶é›†ç•Œé¢
                document.getElementById('paymentInfoOverlay').style.display = 'flex';
            } else {
                // ç»§ç»­ä¸‹ä¸€ä¸ªç³»ç»Ÿçš„ç—…å†
                saveProgress(); // è‡ªåŠ¨ä¿å­˜è¿›åº¦
                alert(`æ„Ÿè°¢æ‚¨çš„è¯„ä»·!è¯·ç»§ç»­ä¸‹ä¸€ç³»ç»Ÿçš„ç—…å†ã€‚`);
                // ä½¿ç”¨completedCasesä½œä¸ºä¸‹ä¸€ä¸ªæ¡ˆä¾‹ç´¢å¼•ï¼Œè€Œä¸æ˜¯curCase+1
                // å› ä¸ºåœ¨æ¢å¤è¿›åº¦æ—¶curCaseå¯èƒ½ä¸å‡†ç¡®
                const nextIdx = completedCases;
                if (nextIdx < 9) {
                    switchCase(nextIdx);
                }
            }
        }

        // ========================================
        // æäº¤åŠ³åŠ¡è´¹ä¿¡æ¯
        // ========================================
        function submitPaymentInfo() {
            // è·å–åŠ³åŠ¡è´¹ä¿¡æ¯
            const idCard = document.getElementById('idCard').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const workplace = document.getElementById('workplace').value.trim();
            const bankCard = document.getElementById('bankCard').value.trim();
            const bankRegion = document.getElementById('bankRegion').value.trim();
            const bankName = document.getElementById('bankName').value.trim();

            // éªŒè¯å¿…å¡«é¡¹
            if (!idCard || !phone || !workplace || !bankCard || !bankRegion || !bankName) {
                alert('è¯·å®Œæ•´å¡«å†™æ‰€æœ‰åŠ³åŠ¡è´¹ä¿¡æ¯');
                return;
            }

            // éªŒè¯èº«ä»½è¯å·æ ¼å¼ï¼ˆ18ä½ï¼‰å¹¶æ ¡éªŒæ ¡éªŒä½
            if (!/^\d{17}[\dXx]$/.test(idCard)) {
                alert('èº«ä»½è¯å·æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·è¾“å…¥18ä½èº«ä»½è¯å·');
                document.getElementById('idCard').focus();
                return;
            }

            // éªŒè¯èº«ä»½è¯æ ¡éªŒä½
            function validateIDCard(id) {
                const weights = [7, 9, 10, 5, 8, 4, 2, 1, 6, 3, 7, 9, 10, 5, 8, 4, 2];
                const checkCodes = ['1', '0', 'X', '9', '8', '7', '6', '5', '4', '3', '2'];
                let sum = 0;
                for (let i = 0; i < 17; i++) {
                    sum += parseInt(id[i]) * weights[i];
                }
                const checkCode = checkCodes[sum % 11];
                return id[17].toUpperCase() === checkCode;
            }

            if (!validateIDCard(idCard)) {
                alert('èº«ä»½è¯å·æ ¡éªŒä½ä¸æ­£ç¡®ï¼Œè¯·æ£€æŸ¥è¾“å…¥');
                document.getElementById('idCard').focus();
                return;
            }

            // éªŒè¯æ‰‹æœºå·æ ¼å¼ï¼ˆ11ä½ï¼‰
            if (!/^1[3-9]\d{9}$/.test(phone)) {
                alert('æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·è¾“å…¥11ä½æœ‰æ•ˆæ‰‹æœºå·');
                document.getElementById('phone').focus();
                return;
            }

            // éªŒè¯é“¶è¡Œå¡å·ï¼ˆ16-19ä½æ•°å­—ï¼‰
            if (!/^\d{16,19}$/.test(bankCard)) {
                alert('é“¶è¡Œå¡å·æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·è¾“å…¥16-19ä½é“¶è¡Œå¡å·');
                document.getElementById('bankCard').focus();
                return;
            }

            // éªŒè¯å·¥ä½œå•ä½è‡³å°‘5ä¸ªå­—ç¬¦
            if (workplace.length < 5) {
                alert('è¯·è¾“å…¥å®Œæ•´çš„å·¥ä½œå•ä½åç§°ï¼ˆè‡³å°‘5ä¸ªå­—ç¬¦ï¼‰');
                document.getElementById('workplace').focus();
                return;
            }

            // ä¿å­˜åŠ³åŠ¡è´¹ä¿¡æ¯åˆ°demographics
            const demographics = JSON.parse(localStorage.getItem('demographics') || '{}');
            demographics.reimbursement = {
                idCard: idCard,
                phone: phone,
                workplace: workplace,
                bankCard: bankCard,
                bankRegion: bankRegion,
                bankName: bankName
            };
            localStorage.setItem('demographics', JSON.stringify(demographics));

            // åŒæ—¶ä¿å­˜åˆ°expData
            expData.reimbursement = demographics.reimbursement;
            saveProgress();

            // å…³é—­åŠ³åŠ¡è´¹ä¿¡æ¯ç•Œé¢
            document.getElementById('paymentInfoOverlay').style.display = 'none';

            // æ˜¾ç¤ºå®Œæˆç•Œé¢
            document.getElementById('completedParticipantId').textContent = expData.participantId;
            document.getElementById('caseContentArea').classList.add('hidden');
            document.getElementById('completionArea').classList.remove('hidden');

            // å‡†å¤‡å‘é€æ•°æ®ï¼ˆç§»é™¤rawTrajectoryä»¥å‡å°æ•°æ®é‡ï¼‰
            const dataToSend = JSON.parse(JSON.stringify(expData));
            dataToSend.cases.forEach(caseData => {
                // ä¿ç•™ç»Ÿè®¡æŒ‡æ ‡ï¼Œä½†ç§»é™¤å®Œæ•´è½¨è¿¹
                if (caseData.mouseTracking_initial && caseData.mouseTracking_initial.rawTrajectory) {
                    const trajectoryLength = caseData.mouseTracking_initial.rawTrajectory.length;
                    delete caseData.mouseTracking_initial.rawTrajectory;
                    caseData.mouseTracking_initial.trajectoryPoints = trajectoryLength;
                }
                if (caseData.mouseTracking_final && caseData.mouseTracking_final.rawTrajectory) {
                    const trajectoryLength = caseData.mouseTracking_final.rawTrajectory.length;
                    delete caseData.mouseTracking_final.rawTrajectory;
                    caseData.mouseTracking_final.trajectoryPoints = trajectoryLength;
                }
            });

            const dataSize = JSON.stringify(dataToSend).length;
            console.log(`ğŸ“§ å‡†å¤‡å‘é€æ•°æ®ï¼Œå¤§å°: ${(dataSize/1024).toFixed(2)} KB`);

            // å‘é€æ•°æ®åˆ°é‚®ç®±ï¼ˆå¦‚æœEmailJSå¯ç”¨ï¼‰
            // å¦‚æœCDNå·²åŠ è½½ä½†initè¿˜æ²¡å®Œæˆï¼Œå°è¯•å³æ—¶åˆå§‹åŒ–
            if (!emailjsReady && typeof emailjs !== 'undefined' && emailjs.init) {
                try {
                    emailjs.init(EMAILJS_CONFIG.publicKey);
                    emailjsReady = true;
                    console.log('[EmailJS] å‘é€å‰å³æ—¶åˆå§‹åŒ–æˆåŠŸ');
                } catch(e) {
                    console.error('[EmailJS] å³æ—¶åˆå§‹åŒ–å¤±è´¥:', e);
                }
            }

            if (emailjsReady && typeof emailjs !== 'undefined') {
                emailjs.send(EMAILJS_CONFIG.serviceId, EMAILJS_CONFIG.templateId, {
                    participant_id: expData.participantId,
                    participant_name: expData.participantName,
                    systems: expData.systems.map(s => `é…ç½®#${s.systemIndex}`).join('; '),
                    design_info: JSON.stringify(expData.experimentDesign),
                    completed_cases: expData.cases.length,
                    data_size_kb: (dataSize/1024).toFixed(2),
                    full_data: JSON.stringify(dataToSend, null, 2)
                }).then(
                    () => {
                        console.log('âœ… å®éªŒæ•°æ®å‘é€æˆåŠŸ');
                        clearProgress(); // å®éªŒå®Œæˆï¼Œæ¸…é™¤ä¿å­˜çš„è¿›åº¦
                        alert('å®éªŒæ•°æ®å·²æˆåŠŸå‘é€ï¼');
                    },
                    (error) => {
                        console.error('âŒ æ•°æ®å‘é€å¤±è´¥:', error);
                        // é‚®ä»¶å¤±è´¥æ—¶æä¾›ä¸‹è½½å¤‡ä»½
                        offerDataDownload(dataToSend);
                        alert('æ•°æ®å‘é€å¤±è´¥ï¼Œä½†æ•°æ®å·²ä¿å­˜åœ¨æœ¬åœ°ã€‚\n\nå·²è‡ªåŠ¨ç”Ÿæˆæ•°æ®å¤‡ä»½æ–‡ä»¶ä¾›æ‚¨ä¸‹è½½ã€‚\nè¯·å°†ä¸‹è½½çš„æ–‡ä»¶å‘é€ç»™å®éªŒç®¡ç†å‘˜ã€‚\n\nè”ç³»äººï¼šæŸ³ç¾½å§\nç”µè¯ï¼š18772101551\nå¾®ä¿¡å·ï¼šlys-414321');
                    }
                );
            } else {
                console.warn('[EmailJS] åº“æœªåŠ è½½ï¼Œæ— æ³•è‡ªåŠ¨å‘é€æ•°æ®');
                // EmailJSä¸å¯ç”¨æ—¶æä¾›ä¸‹è½½å¤‡ä»½
                offerDataDownload(dataToSend);
                alert('âš ï¸ ç”±äºç½‘ç»œåŸå› ï¼Œæ•°æ®æ— æ³•è‡ªåŠ¨å‘é€ã€‚\n\nå·²è‡ªåŠ¨ç”Ÿæˆæ•°æ®å¤‡ä»½æ–‡ä»¶ä¾›æ‚¨ä¸‹è½½ã€‚\nè¯·å°†ä¸‹è½½çš„æ–‡ä»¶å‘é€ç»™å®éªŒç®¡ç†å‘˜ã€‚\n\nè”ç³»äººï¼šæŸ³ç¾½å§\nç”µè¯ï¼š18772101551\nå¾®ä¿¡å·ï¼šlys-414321');
            }

            setTimeout(() => {
                alert(`ğŸ‰ å®éªŒå®Œæˆï¼\n\næ„Ÿè°¢æ‚¨çš„å‚ä¸å’Œä»˜å‡ºï¼\næ‚¨çš„æ•°æ®å·²æˆåŠŸæäº¤ã€‚\nåŠ³åŠ¡æŠ¥é…¬å°†åœ¨å®¡æ ¸åå‘æ”¾è‡³æ‚¨çš„é“¶è¡Œè´¦æˆ·ã€‚\n\nç¥æ‚¨ç”Ÿæ´»æ„‰å¿«ï¼`);
            }, 1000);
        }

        // ========================================
        // æ•°æ®å¤‡ä»½ä¸‹è½½ï¼ˆCDNä¸å¯ç”¨æ—¶çš„é™çº§æ–¹æ¡ˆï¼‰
        // ========================================
        function offerDataDownload(data) {
            try {
                const jsonStr = JSON.stringify(data, null, 2);
                const blob = new Blob([jsonStr], { type: 'application/json;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `å®éªŒæ•°æ®_${data.participantId || 'unknown'}_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 100);
                console.log('[æ•°æ®å¤‡ä»½] å·²è§¦å‘ä¸‹è½½');
            } catch(e) {
                console.error('[æ•°æ®å¤‡ä»½] ä¸‹è½½å¤±è´¥:', e);
                // æœ€åçš„é™çº§ï¼šå¤åˆ¶åˆ°å‰ªè´´æ¿
                try {
                    const jsonStr = JSON.stringify(data);
                    navigator.clipboard.writeText(jsonStr).then(() => {
                        alert('æ•°æ®å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼Œè¯·ç²˜è´´åˆ°æ–‡ä»¶ä¸­å¹¶å‘é€ç»™å®éªŒç®¡ç†å‘˜ã€‚');
                    });
                } catch(e2) {
                    console.error('[æ•°æ®å¤‡ä»½] å‰ªè´´æ¿ä¹Ÿå¤±è´¥:', e2);
                }
            }
        }

        function closeAIModal() {
            const overlay = document.getElementById('aiModalOverlay');
            const modal = document.getElementById('aiModal');
            overlay.classList.remove('active', 'minimized');
            modal.classList.remove('minimized');
        }

        function toggleMinimizeModal() {
            const overlay = document.getElementById('aiModalOverlay');
            const modal = document.getElementById('aiModal');
            const icon = document.getElementById('minimizeIcon');

            if (modal.classList.contains('minimized')) {
                modal.classList.remove('minimized');
                overlay.classList.remove('minimized');
                icon.textContent = 'âˆ’';
            } else {
                modal.classList.add('minimized');
                overlay.classList.add('minimized');
                icon.textContent = 'â–¡';
            }
        }

        async function submitPastedContentSidebar() {
            const pastedText = document.getElementById('pasteTextareaSidebar').value.trim();

            if (pastedText.length < 50) {
                alert('è¯·ç²˜è´´å®Œæ•´çš„ç—…å†å†…å®¹(è‡³å°‘50ä¸ªå­—ç¬¦)');
                return;
            }

            const c = allCases[curCase];
            const cd = expData.cases.find(x => x.caseId === c.id && x.systemIndex === c.systemIndex);
            cd.timestamps.pastedContent = new Date().toISOString();
            cd.pastedContentLength = pastedText.length;
            saveProgress(); // ä¿å­˜ç²˜è´´çŠ¶æ€

            document.getElementById('pasteSectionSidebar').classList.add('hidden');
            await getAISuggestion();
        }

        async function submitPastedContentModal() {
            const pastedText = document.getElementById('pasteTextareaModal').value.trim();

            if (pastedText.length < 50) {
                alert('è¯·ç²˜è´´å®Œæ•´çš„ç—…å†å†…å®¹(è‡³å°‘50ä¸ªå­—ç¬¦)');
                return;
            }

            const c = allCases[curCase];
            const cd = expData.cases.find(x => x.caseId === c.id && x.systemIndex === c.systemIndex);
            cd.timestamps.pastedContent = new Date().toISOString();
            cd.pastedContentLength = pastedText.length;
            saveProgress(); // ä¿å­˜ç²˜è´´çŠ¶æ€

            await getAISuggestion();
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }


        function updateSliderValue(slider) {
            const labels = ['éå¸¸ä¸åŒæ„', 'ä¸å¯èƒ½', 'ç¨å¾®ä¸å¯èƒ½', 'ä¸­ç«‹', 'ç¨å¾®å¯èƒ½', 'å¯èƒ½', 'éå¸¸åŒæ„'];
            const value = parseInt(slider.value);
            const valueDisplay = document.getElementById(slider.name + '-value');
            if (valueDisplay) {
                valueDisplay.textContent = `å½“å‰å€¼: ${value} - ${labels[value - 1]}`;
            }
        }

        function updateIntentionSliderValue(slider) {
            const labels = ['éå¸¸ä¸åŒæ„', 'ä¸åŒæ„', 'ä¸­ç«‹', 'åŒæ„', 'éå¸¸åŒæ„'];
            const value = parseInt(slider.value);
            const valueDisplay = document.getElementById(slider.name + '-value');
            if (valueDisplay) {
                valueDisplay.textContent = `å½“å‰å€¼: ${value} - ${labels[value - 1]}`;
            }
        }

        // ã€ä¿®å¤6ã€‘ä½¿ç”¨ç°ä»£Clipboard APIå¤åˆ¶ç—…å†
        async function copyMedicalRecord() {
            const textarea = document.getElementById('medicalRecordDisplay');
            const copyBtn = document.getElementById('copyBtn');
            const text = textarea.value;

            try {
                // ä¼˜å…ˆä½¿ç”¨ç°ä»£Clipboard API
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    await navigator.clipboard.writeText(text);
                } else {
                    // é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨ä¼ ç»Ÿæ–¹æ³•
                    textarea.select();
                    textarea.setSelectionRange(0, 99999);
                    document.execCommand('copy');
                    window.getSelection().removeAllRanges();
                }

                // æ˜¾ç¤ºæˆåŠŸåé¦ˆ
                copyBtn.textContent = 'âœ“ å·²å¤åˆ¶!';
                copyBtn.classList.add('copy-success');

                // 2ç§’åæ¢å¤æŒ‰é’®çŠ¶æ€
                setTimeout(() => {
                    copyBtn.textContent = 'ğŸ“‹ ä¸€é”®å¤åˆ¶ç—…å†';
                    copyBtn.classList.remove('copy-success');
                }, 2000);
            } catch (err) {
                console.error('å¤åˆ¶å¤±è´¥:', err);
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶æ–‡æœ¬');
            }
        }

        function autoResizeTextarea(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        }

        // é¡µé¢å…³é—­/åˆ·æ–°å‰è‡ªåŠ¨ä¿å­˜
        window.addEventListener('beforeunload', function(e) {
            if (expData && expData.cases && expData.cases.length > 0) {
                saveProgress();
                console.log('é¡µé¢å…³é—­å‰å·²ä¿å­˜è¿›åº¦');
            }
        });

        // ã€ä¿®å¤8ã€‘å®šæ—¶è‡ªåŠ¨ä¿å­˜ï¼ˆæ¯15ç§’ï¼‰- å‡å°‘æ•°æ®ä¸¢å¤±é£é™©
        setInterval(function() {
            if (expData && expData.cases && expData.cases.length > 0) {
                saveProgress();
            }
        }, 15000); // ä»30ç§’æ”¹ä¸º15ç§’

        window.onload = function() {
            // è®¾å¤‡æ£€æµ‹
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            const isTablet = /(tablet|ipad|playbook|silk)|(android(?!.*mobi))/i.test(navigator.userAgent);

            if (isMobile || isTablet) {
                alert('âš ï¸ é‡è¦æç¤º\n\næœ¬å®éªŒå¿…é¡»åœ¨ç”µè„‘ï¼ˆPCæˆ–Macï¼‰ä¸Šå®Œæˆï¼Œä¸æ”¯æŒæ‰‹æœºæˆ–å¹³æ¿è®¾å¤‡ã€‚\n\nè¯·ä½¿ç”¨ç”µè„‘æµè§ˆå™¨è®¿é—®æœ¬é¡µé¢ã€‚');
                // å¯é€‰ï¼šç¦ç”¨ç•Œé¢æˆ–éšè—å†…å®¹
                document.body.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100vh;background:#f5f7fa;"><div style="max-width:600px;padding:40px;background:white;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.1);text-align:center;"><h2 style="color:#e74c3c;margin-bottom:20px;">âš ï¸ è®¾å¤‡ä¸æ”¯æŒ</h2><p style="font-size:18px;line-height:1.6;color:#2c3e50;">æœ¬å®éªŒå¿…é¡»åœ¨<strong>ç”µè„‘ï¼ˆPCæˆ–Macï¼‰</strong>ä¸Šå®Œæˆã€‚</p><p style="font-size:16px;color:#718096;margin-top:16px;">è¯·ä½¿ç”¨ç”µè„‘æµè§ˆå™¨è®¿é—®æœ¬é¡µé¢ã€‚</p></div></div>';
                return;
            }

            // æ£€æŸ¥æ˜¯å¦æœ‰æœªå®Œæˆçš„å®éªŒè¿›åº¦
            const savedProgress = localStorage.getItem('experimentProgress');
            const savedName = localStorage.getItem('participantName');
            const demographics = localStorage.getItem('demographics');

            if (savedProgress && savedName && demographics) {
                // æœ‰æœªå®Œæˆçš„å®éªŒï¼Œç›´æ¥æ˜¾ç¤ºæ¢å¤æç¤º
                document.getElementById('participantInput').value = savedName;
                document.getElementById('participantInput').disabled = true; // ç¦ç”¨è¾“å…¥ï¼Œé˜²æ­¢ä¿®æ”¹

                // åœ¨æ¬¢è¿ç•Œé¢æ˜¾ç¤ºæç¤º
                const welcomeBox = document.querySelector('.welcome-box');
                const restoreHint = document.createElement('div');
                restoreHint.style.cssText = 'background:#e8f5e9;padding:12px;border-radius:6px;margin-top:12px;font-size:14px;color:#2e7d32;line-height:1.6;';
                restoreHint.innerHTML = '<strong>âœ“ æ£€æµ‹åˆ°æœªå®Œæˆçš„å®éªŒ</strong><br>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å°†è‡ªåŠ¨æ¢å¤æ‚¨çš„è¿›åº¦';
                welcomeBox.appendChild(restoreHint);

                // ä¿®æ”¹æŒ‰é’®æ–‡å­—å’Œè¡Œä¸º
                const startBtn = document.getElementById('startBtn');
                startBtn.textContent = 'æ¢å¤å®éªŒè¿›åº¦';
                startBtn.disabled = false;
                startBtn.onclick = function() {
                    startExperiment(); // ç›´æ¥æ¢å¤å®éªŒï¼Œè·³è¿‡ä¸ªäººä¿¡æ¯å¡«å†™
                };

                // æ·»åŠ "é‡æ–°å¼€å§‹"æŒ‰é’®
                const resetBtn = document.createElement('button');
                resetBtn.className = 'welcome-btn';
                resetBtn.style.cssText = 'background:#e74c3c;margin-top:10px;';
                resetBtn.textContent = 'æ”¾å¼ƒè¿›åº¦ï¼Œé‡æ–°å¼€å§‹';
                resetBtn.onclick = function() {
                    if (confirm('âš ï¸ è­¦å‘Š\n\nç¡®å®šè¦æ”¾å¼ƒå½“å‰è¿›åº¦å—ï¼Ÿ\n\næ­¤æ“ä½œå°†æ¸…é™¤æ‰€æœ‰å·²ä¿å­˜çš„æ•°æ®ï¼Œæ‚¨éœ€è¦é‡æ–°å¡«å†™ä¿¡æ¯å¹¶å¼€å§‹å®éªŒã€‚\n\nç‚¹å‡»"ç¡®å®š"æ¸…é™¤è¿›åº¦ï¼Œç‚¹å‡»"å–æ¶ˆ"è¿”å›ã€‚')) {
                        clearProgress();
                        localStorage.removeItem('participantId');
                        localStorage.removeItem('participantName');
                        localStorage.removeItem('demographics');
                        localStorage.removeItem('screeningData');
                        location.reload(); // åˆ·æ–°é¡µé¢
                    }
                };
                welcomeBox.appendChild(resetBtn);

                return;
            }

            // åŸæœ‰çš„é€»è¾‘
            const savedId = localStorage.getItem('participantId');
            if (savedId && savedName) {
                document.getElementById('participantInput').value = savedName;

                if (confirm(`æ£€æµ‹åˆ°æ‚¨ä¹‹å‰ä½¿ç”¨çš„IDæ˜¯ã€Œ${savedName}ã€\n\næ˜¯å¦ç»§ç»­ä½¿ç”¨?\n\nç‚¹å‡»"ç¡®å®š"ç»§ç»­,ç‚¹å‡»"å–æ¶ˆ"é‡æ–°è¾“å…¥ã€‚`)) {
                    // æ£€æŸ¥æ˜¯å¦å·²æœ‰ä¸ªäººä¿¡æ¯
                    if (demographics) {
                        startExperiment();
                    } else {
                        goToScreening();
                    }
                } else {
                    localStorage.removeItem('participantId');
                    localStorage.removeItem('participantName');
                    localStorage.removeItem('demographics');
                    localStorage.removeItem('screeningData');
                    clearProgress(); // åŒæ—¶æ¸…é™¤è¿›åº¦
                }
            }
        };
    </script>
</body>
</html>
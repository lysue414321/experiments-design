<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIä¸´åºŠå†³ç­–æ”¯æŒç³»ç»Ÿ - åˆ†è¾¨ç‡VIå®éªŒè®¾è®¡</title>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Microsoft YaHei', sans-serif; background: #f5f7fa; padding: 20px; }

        .welcome-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000; }
        .welcome-box { background: white; border-radius: 16px; padding: 40px; max-width: 500px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); }
        .welcome-box h2 { color: #1976d2; font-size: 24px; margin-bottom: 16px; text-align: center; }
        .welcome-box p { color: #616161; line-height: 1.6; margin-bottom: 24px; font-size: 14px; }
        .welcome-input { width: 100%; padding: 12px 16px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; margin-bottom: 24px; font-weight: 600; }
        .welcome-input:focus { outline: none; border-color: #1976d2; }
        .welcome-btn { width: 100%; padding: 14px; background: #1976d2; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .welcome-btn:hover { background: #1565c0; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(25,118,210,0.3); }
        .welcome-btn:disabled { background: #e0e0e0; cursor: not-allowed; transform: none; }
        .welcome-info { background: #e3f2fd; padding: 12px; border-radius: 8px; margin-top: 16px; font-size: 12px; color: #1565c0; line-height: 1.6; }
        .error-text { color: #d32f2f; font-size: 12px; margin-top: 8px; display: none; }

        .survey-item { margin-bottom: 20px; }
        .survey-question { font-size: 14px; color: #2c3e50; margin-bottom: 10px; font-weight: 500; line-height: 1.5; }
        .likert-scale, .likert-scale-7 { display: flex; flex-wrap: wrap; gap: 8px; }
        .likert-scale label, .likert-scale-7 label { padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 4px; cursor: pointer; font-size: 13px; transition: all 0.2s; background: white; }
        .likert-scale label:hover, .likert-scale-7 label:hover { background: #f0f9ff; border-color: #3498db; }
        .likert-scale label input, .likert-scale-7 label input { margin-right: 6px; }
        .likert-scale input:checked + label, .likert-scale-7 input:checked + label,
        .likert-scale label:has(input:checked), .likert-scale-7 label:has(input:checked) { background: #3498db; color: white; border-color: #3498db; }

        .main-wrapper { max-width: 1400px; margin: 0 auto; }
        .header { background: white; padding: 20px 30px; border-radius: 6px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); border-left: 4px solid #3498db; }
        .header h1 { color: #2c3e50; font-size: 20px; margin-bottom: 8px; font-weight: 600; }
        .experiment-tag { display: inline-block; background: #ecf0f1; color: #34495e; padding: 5px 12px; border-radius: 3px; font-size: 12px; font-weight: 500; }
        .feature-indicator { display: inline-block; margin-left: 10px; padding: 4px 8px; background: #e8f5e9; color: #2e7d32; border-radius: 3px; font-size: 11px; }
        .feature-indicator.basic { background: #e3f2fd; color: #1565c0; }
        .save-status { float: right; font-size: 12px; color: #27ae60; padding: 5px 12px; background: #d4edda; border-radius: 3px; }

        .case-navigation { background: white; padding: 15px 30px; border-radius: 6px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
        .progress-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 12px; border-bottom: 2px solid #e0e6ed; }
        .progress-title { font-size: 15px; font-weight: 600; color: #2c3e50; }
        .progress-stats { display: flex; gap: 20px; font-size: 13px; }
        .progress-stat-item { display: flex; align-items: center; gap: 6px; }
        .progress-stat-label { color: #718096; }
        .progress-stat-value { font-weight: 600; color: #3498db; }
        .progress-bar-wrapper { margin-bottom: 20px; }
        .progress-bar-bg { width: 100%; height: 20px; background: #e0e6ed; border-radius: 10px; overflow: hidden; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1); }
        .progress-bar-fill { height: 100%; background: linear-gradient(90deg, #3498db 0%, #2ecc71 100%); border-radius: 10px; transition: width 0.4s ease; display: flex; align-items: center; justify-content: flex-end; padding-right: 8px; }
        .progress-bar-text { color: white; font-size: 11px; font-weight: 600; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        .system-group { margin-bottom: 15px; }
        .system-group-title { font-size: 14px; font-weight: 600; color: #2c3e50; margin-bottom: 8px; padding: 8px 12px; background: #f8f9fa; border-radius: 4px; }
        .case-nav-btns { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        .case-nav-btn { padding: 10px 20px; border: 2px solid #d1d5db; background: white; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: 600; color: #4a5568; transition: all 0.2s; }
        .case-nav-btn.current { background: #3498db; border-color: #3498db; color: white; }
        .case-nav-btn.completed { background: #27ae60; border-color: #27ae60; color: white; }

        .content-layout { display: flex; gap: 20px; align-items: flex-start; }
        .main-content { flex: 1; min-width: 0; }

        .ai-sidebar { width: 420px; background: white; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); position: sticky; top: 20px; max-height: calc(100vh - 40px); overflow-y: auto; display: none; }
        .ai-sidebar.active { display: block; }
        .ai-sidebar-header { padding: 18px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 6px 6px 0 0; }
        .ai-sidebar-content { padding: 20px; }

        .ai-modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 9999; }
        .ai-modal-overlay.active { display: flex; }
        .ai-modal-overlay.minimized {
            align-items: flex-end;
            justify-content: flex-end;
            padding: 20px;
            pointer-events: none;
            background: transparent;
        }
        .ai-modal { background: white; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); max-width: 600px; width: 90%; max-height: 85vh; overflow-y: auto; position: relative; transition: all 0.3s ease; }
        .ai-modal.minimized {
            max-width: 300px;
            max-height: 60px;
            overflow: hidden;
            pointer-events: auto;
        }
        .ai-modal-header { padding: 18px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 8px 8px 0 0; display: flex; justify-content: space-between; align-items: center; }
        .ai-modal-controls { display: flex; gap: 8px; }
        .ai-modal-btn { background: rgba(255,255,255,0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; transition: background 0.2s; }
        .ai-modal-btn:hover { background: rgba(255,255,255,0.3); }
        .ai-modal-content { padding: 20px; }
        .ai-modal.minimized .ai-modal-content { display: none; }

        .ai-section { margin-bottom: 25px; padding: 16px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #3498db; }
        .ai-section.hidden { display: none; }
        .ai-section-title { font-size: 14px; font-weight: 600; color: #2c3e50; margin-bottom: 12px; }

        .thinking-process { background: #fff9e6; border-left: 3px solid #f39c12; padding: 12px; border-radius: 4px; margin-bottom: 12px; }
        .thinking-step { padding: 8px 0; color: #856404; font-size: 13px; line-height: 1.6; opacity: 0; animation: fadeIn 0.3s forwards; }
        @keyframes fadeIn { to { opacity: 1; } }
        .thinking-label { font-weight: 600; color: #e67e22; }

        .ai-conclusion { background: #e8f5e9; border: 2px solid #27ae60; padding: 14px; border-radius: 6px; margin-top: 12px; }
        .conclusion-label { font-weight: 600; color: #2e7d32; margin-bottom: 8px; font-size: 14px; }

        .diagnosis-item-with-confidence { padding: 10px; background: white; border-radius: 4px; margin-bottom: 8px; border: 1px solid #e0e6ed; }
        .diagnosis-name { font-weight: 600; color: #2c3e50; margin-bottom: 6px; }
        .confidence-bar-container { display: flex; align-items: center; gap: 10px; margin-top: 6px; }
        .confidence-bar { flex: 1; height: 8px; background: #e0e6ed; border-radius: 4px; overflow: hidden; }
        .confidence-fill { height: 100%; border-radius: 4px; transition: width 0.3s; }
        .confidence-fill.high { background: #27ae60; }
        .confidence-fill.medium { background: #f39c12; }
        .confidence-fill.low { background: #e74c3c; }
        .confidence-text { font-size: 13px; font-weight: 600; color: #4a5568; min-width: 45px; text-align: right; }
        .confidence-explain { font-size: 11px; color: #718096; margin-top: 4px; }

        .ig-visualization { background: white; border: 1px solid #e0e6ed; border-radius: 6px; padding: 16px; margin-top: 12px; }
        .ig-title { font-size: 13px; font-weight: 600; color: #2c3e50; margin-bottom: 8px; }
        .ig-explain { font-size: 11px; color: #718096; margin-bottom: 12px; line-height: 1.5; }
        .ig-chart-container { position: relative; height: 280px; }

        .antibiotic-recommendation { margin-top: 12px; }
        .antibiotic-standard { background: #fff3e0; border-left: 3px solid #ff9800; padding: 12px; border-radius: 4px; margin-bottom: 8px; }
        .antibiotic-primary { background: #f0fdf4; border: 2px solid #27ae60; padding: 12px; border-radius: 4px; }
        .searching-indicator { color: #1976d2; font-style: italic; animation: pulse 1.5s ease-in-out infinite; margin: 10px 0; font-size: 13px; }
        @keyframes pulse { 0%, 100% { opacity: 0.6; } 50% { opacity: 1; } }

        .panel { background: white; border-radius: 6px; padding: 25px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); margin-bottom: 20px; }
        .panel-title { font-size: 16px; font-weight: 600; color: #2c3e50; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #e0e6ed; }

        .medical-record-textarea { width: 100%; min-height: 400px; padding: 12px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 14px; font-family: 'Microsoft YaHei', monospace; line-height: 1.8; background: #f8f9fa; resize: none; overflow: hidden; }

        .input-group { margin-bottom: 18px; }
        .input-group label { display: block; font-weight: 600; color: #4a5568; margin-bottom: 8px; font-size: 13px; }
        .input-group input[type="text"], .input-group input[type="number"] { width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 14px; }

        .diagnosis-list { margin-top: 10px; }
        .diagnosis-item { display: grid; grid-template-columns: 90px 1fr; gap: 10px; margin-bottom: 10px; align-items: center; }

        .radio-group { margin-top: 8px; }
        .radio-group label { display: block; font-weight: normal; margin-bottom: 6px; cursor: pointer; padding: 9px 12px; border-radius: 4px; transition: background 0.2s; }
        .radio-group label:hover { background: #f7fafc; }
        .radio-group input { margin-right: 8px; }

        .btn { padding: 11px 24px; border: none; border-radius: 4px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .btn-primary { background: #3498db; color: white; }
        .btn-primary:hover { background: #2980b9; }
        .btn-success { background: #27ae60; color: white; }
        .btn-success:hover { background: #229954; }
        .btn-ai-suggest { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-ai-suggest:hover { opacity: 0.9; transform: translateY(-1px); }

        .action-buttons { margin-top: 25px; text-align: right; }
        .action-buttons .btn { margin-left: 10px; }

        .hidden { display: none; }
        .required-mark { color: #e53e3e; }
        .help-text { font-size: 12px; color: #718096; margin-top: 4px; }

        @media (max-width: 1200px) {
            .content-layout { flex-direction: column; }
            .ai-sidebar { width: 100%; position: relative; top: 0; max-height: none; }
        }
    </style>
</head>
<body>
    <!-- ç¬¬ä¸€æ­¥ï¼šå§“åè¾“å…¥ -->
    <div id="welcomeOverlay" class="welcome-overlay">
        <div class="welcome-box">
            <h2>ğŸ“ æ¬¢è¿å‚ä¸ä¸´åºŠAIå®éªŒ</h2>
            <p>æ„Ÿè°¢æ‚¨å‚ä¸æœ¬æ¬¡ç ”ç©¶!è¯·è¾“å…¥æ‚¨çš„å§“åæˆ–å·¥å·,ç³»ç»Ÿå°†è‡ªåŠ¨ä¸ºæ‚¨åˆ†é…å®éªŒæ–¹æ¡ˆã€‚</p>
            <input type="text" id="participantInput" class="welcome-input" placeholder="è¯·è¾“å…¥æ‚¨çš„å§“åæˆ–å·¥å·">
            <div id="errorText" class="error-text">è¯·è¾“å…¥è‡³å°‘2ä¸ªå­—ç¬¦</div>
            <button class="welcome-btn" id="startBtn" onclick="goToDemographics()">ä¸‹ä¸€æ­¥</button>
            <div class="welcome-info">
                ğŸ’¡ <strong>æç¤º:</strong>
                <br>â€¢ æœ¬å®éªŒé‡‡ç”¨åˆ†è¾¨ç‡VIçš„2^(6-1)éƒ¨åˆ†æå› è®¾è®¡
                <br>â€¢ å…±32ç§AIç³»ç»Ÿé…ç½®,æ‚¨å°†ä½“éªŒå…¶ä¸­3ç§
                <br>â€¢ æ¯ç§é…ç½®éœ€å®Œæˆ3ä¸ªç—…å†(å…±9ä¸ªç—…å†)
                <br>â€¢ æ‰€æœ‰ç³»ç»Ÿéƒ½æä¾›AIè¾…åŠ©è¯Šæ–­å»ºè®®
                <br>â€¢ æ•´ä¸ªå®éªŒçº¦éœ€45-60åˆ†é’Ÿ
            </div>
        </div>
    </div>

    <!-- ç¬¬äºŒæ­¥ï¼šä¸ªäººä¿¡æ¯è¡¨å• -->
    <div id="demographicsOverlay" class="welcome-overlay" style="display: none;">
        <div class="welcome-box" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
            <h2>ğŸ“‹ ä¸ªäººä¿¡æ¯è°ƒæŸ¥</h2>
            <p style="font-size: 13px; margin-bottom: 20px;">è¯·å¦‚å®å¡«å†™ä»¥ä¸‹ä¿¡æ¯ï¼Œæ‰€æœ‰æ•°æ®ä»…ç”¨äºç ”ç©¶åˆ†æ</p>

            <div style="text-align: left;">
                <div class="input-group" style="margin-bottom: 15px;">
                    <label style="font-weight: 600; margin-bottom: 8px; display: block;">1. æ€§åˆ« <span class="required-mark">*</span></label>
                    <div class="radio-group">
                        <label><input type="radio" name="gender" value="ç”·">ç”·</label>
                        <label><input type="radio" name="gender" value="å¥³">å¥³</label>
                    </div>
                </div>

                <div class="input-group" style="margin-bottom: 15px;">
                    <label style="font-weight: 600; margin-bottom: 8px; display: block;">2. å¹´é¾„ <span class="required-mark">*</span></label>
                    <input type="number" id="age" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;" placeholder="è¯·è¾“å…¥å¹´é¾„">
                </div>

                <div class="input-group" style="margin-bottom: 15px;">
                    <label style="font-weight: 600; margin-bottom: 8px; display: block;">3. æ–‡åŒ–ç¨‹åº¦ <span class="required-mark">*</span></label>
                    <div class="radio-group">
                        <label><input type="radio" name="education" value="å°å­¦åŠä»¥ä¸‹">å°å­¦åŠä»¥ä¸‹</label>
                        <label><input type="radio" name="education" value="åˆä¸­">åˆä¸­</label>
                        <label><input type="radio" name="education" value="é«˜ä¸­æˆ–ä¸­ä¸“">é«˜ä¸­æˆ–ä¸­ä¸“</label>
                        <label><input type="radio" name="education" value="å¤§ä¸“æˆ–æœ¬ç§‘">å¤§ä¸“æˆ–æœ¬ç§‘</label>
                        <label><input type="radio" name="education" value="ç¡•å£«ç ”ç©¶ç”Ÿ">ç¡•å£«ç ”ç©¶ç”Ÿ</label>
                        <label><input type="radio" name="education" value="åšå£«ç ”ç©¶ç”Ÿ">åšå£«ç ”ç©¶ç”Ÿ</label>
                    </div>
                </div>

                <div class="input-group" style="margin-bottom: 15px;">
                    <label style="font-weight: 600; margin-bottom: 8px; display: block;">4. æ‚¨æ‰€åœ¨çš„çœä»½ <span class="required-mark">*</span></label>
                    <input type="text" id="province" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;" placeholder="è¯·è¾“å…¥çœä»½">
                </div>

                <div class="input-group" style="margin-bottom: 15px;">
                    <label style="font-weight: 600; margin-bottom: 8px; display: block;">5. åŸºå±‚å·¥ä½œå¹´é™ï¼ˆå¹´ï¼‰<span class="required-mark">*</span></label>
                    <input type="number" id="workYears" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;" placeholder="è¯·è¾“å…¥å·¥ä½œå¹´é™">
                </div>

                <div class="input-group" style="margin-bottom: 15px;">
                    <label style="font-weight: 600; margin-bottom: 8px; display: block;">6. èŒç§° <span class="required-mark">*</span></label>
                    <div class="radio-group">
                        <label><input type="radio" name="title" value="é«˜çº§">é«˜çº§</label>
                        <label><input type="radio" name="title" value="ä¸­çº§">ä¸­çº§</label>
                        <label><input type="radio" name="title" value="åˆçº§">åˆçº§</label>
                        <label><input type="radio" name="title" value="æœªå®šçº§">æœªå®šçº§</label>
                    </div>
                </div>

                <div class="input-group" style="margin-bottom: 15px;">
                    <label style="font-weight: 600; margin-bottom: 8px; display: block;">7. åŸºå±‚åŒ»ç–—æœºæ„ç±»å‹ <span class="required-mark">*</span></label>
                    <div class="radio-group">
                        <label><input type="radio" name="facility" value="ç¤¾åŒºå«ç”ŸæœåŠ¡ä¸­å¿ƒ">ç¤¾åŒºå«ç”ŸæœåŠ¡ä¸­å¿ƒ</label>
                        <label><input type="radio" name="facility" value="ç¤¾åŒºå«ç”ŸæœåŠ¡ç«™">ç¤¾åŒºå«ç”ŸæœåŠ¡ç«™</label>
                        <label><input type="radio" name="facility" value="ä¹¡é•‡å«ç”Ÿé™¢">ä¹¡é•‡å«ç”Ÿé™¢</label>
                        <label><input type="radio" name="facility" value="æ‘å«ç”Ÿå®¤">æ‘å«ç”Ÿå®¤</label>
                    </div>
                </div>

                <div class="input-group" style="margin-bottom: 15px;">
                    <label style="font-weight: 600; margin-bottom: 8px; display: block;">8. æ—¥å‡è¯Šç–—äººæ¬¡ï¼ˆä¸ªäººï¼‰<span class="required-mark">*</span></label>
                    <input type="number" id="dailyPatients" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;" placeholder="è¯·è¾“å…¥æ—¥å‡è¯Šç–—äººæ¬¡">
                </div>

                <div class="input-group" style="margin-bottom: 15px;">
                    <label style="font-weight: 600; margin-bottom: 8px; display: block;">9. æ‚¨å¯¹äººå·¥æ™ºèƒ½çš„äº†è§£ç¨‹åº¦ <span class="required-mark">*</span></label>
                    <div class="radio-group">
                        <label><input type="radio" name="aiKnowledge" value="éå¸¸äº†è§£">éå¸¸äº†è§£</label>
                        <label><input type="radio" name="aiKnowledge" value="æ¯”è¾ƒäº†è§£">æ¯”è¾ƒäº†è§£</label>
                        <label><input type="radio" name="aiKnowledge" value="ä¸€èˆ¬">ä¸€èˆ¬</label>
                        <label><input type="radio" name="aiKnowledge" value="æ¯”è¾ƒä¸äº†è§£">æ¯”è¾ƒä¸äº†è§£</label>
                        <label><input type="radio" name="aiKnowledge" value="éå¸¸ä¸äº†è§£">éå¸¸ä¸äº†è§£</label>
                    </div>
                </div>

                <div class="input-group" style="margin-bottom: 20px;">
                    <label style="font-weight: 600; margin-bottom: 8px; display: block;">10. æ˜¯å¦åœ¨è¯Šç–—å†³ç­–ä¸­ä½¿ç”¨è¿‡äººå·¥æ™ºèƒ½è¿›è¡Œè¾…åŠ© <span class="required-mark">*</span></label>
                    <div class="radio-group">
                        <label><input type="radio" name="aiExperience" value="æ˜¯">æ˜¯</label>
                        <label><input type="radio" name="aiExperience" value="å¦">å¦</label>
                    </div>
                </div>
            </div>

            <button class="welcome-btn" onclick="submitDemographics()">æäº¤å¹¶å¼€å§‹å®éªŒ</button>
        </div>
    </div>

    <!-- ç³»ç»Ÿå®Œæˆåçš„é‡è¡¨ -->
    <div id="systemSurveyOverlay" class="welcome-overlay" style="display: none;">
        <div class="welcome-box" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
            <h2>ğŸ“Š ç³»ç»Ÿè¯„ä»·é‡è¡¨</h2>
            <p style="font-size: 13px; margin-bottom: 20px; color: #718096;">
                æ‚¨å·²å®Œæˆ<strong id="surveySystemName" style="color: #3498db;"></strong>çš„æ‰€æœ‰ç—…å†ï¼<br>
                è¯·æ ¹æ®æ‚¨åˆšæ‰çš„ä½¿ç”¨ä½“éªŒï¼Œå¯¹è¯¥AIç³»ç»Ÿè¿›è¡Œè¯„ä»·
            </p>

            <div style="text-align: left;">
                <!-- é‡‡çº³æ„æ„¿ -->
                <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                    <h3 style="font-size: 15px; color: #2c3e50; margin-bottom: 15px;">B. é‡‡çº³æ„æ„¿</h3>

                    <div class="survey-item">
                        <p class="survey-question">1. å½“æˆ‘æ‰€åœ¨çš„æœºæ„å¼•å…¥è¯¥AI-CDSSåï¼Œæˆ‘æ„¿æ„å°†å…¶åº”ç”¨äºæ—¥å¸¸è¯Šç–—</p>
                        <div class="likert-scale">
                            <label><input type="radio" name="intention1" value="1">1 éå¸¸ä¸åŒæ„</label>
                            <label><input type="radio" name="intention1" value="2">2 ä¸åŒæ„</label>
                            <label><input type="radio" name="intention1" value="3">3 ä¸å¤ªç¡®å®š</label>
                            <label><input type="radio" name="intention1" value="4">4 åŒæ„</label>
                            <label><input type="radio" name="intention1" value="5">5 éå¸¸åŒæ„</label>
                        </div>
                    </div>

                    <div class="survey-item">
                        <p class="survey-question">2. æˆ‘æ‰“ç®—æ ¹æ®å®é™…éœ€æ±‚ï¼Œä½¿ç”¨AI-CDSSä¸ºæ‚£è€…æä¾›åŒ»ç–—æœåŠ¡</p>
                        <div class="likert-scale">
                            <label><input type="radio" name="intention2" value="1">1 éå¸¸ä¸åŒæ„</label>
                            <label><input type="radio" name="intention2" value="2">2 ä¸åŒæ„</label>
                            <label><input type="radio" name="intention2" value="3">3 ä¸å¤ªç¡®å®š</label>
                            <label><input type="radio" name="intention2" value="4">4 åŒæ„</label>
                            <label><input type="radio" name="intention2" value="5">5 éå¸¸åŒæ„</label>
                        </div>
                    </div>

                    <div class="survey-item">
                        <p class="survey-question">3. åœ¨æ¡ä»¶å…è®¸çš„æƒ…å†µä¸‹ï¼Œæˆ‘æ„¿æ„é¢‘ç¹ä½¿ç”¨AI-CDSSå¼€å±•æ—¥å¸¸è¯Šç–—</p>
                        <div class="likert-scale">
                            <label><input type="radio" name="intention3" value="1">1 éå¸¸ä¸åŒæ„</label>
                            <label><input type="radio" name="intention3" value="2">2 ä¸åŒæ„</label>
                            <label><input type="radio" name="intention3" value="3">3 ä¸å¤ªç¡®å®š</label>
                            <label><input type="radio" name="intention3" value="4">4 åŒæ„</label>
                            <label><input type="radio" name="intention3" value="5">5 éå¸¸åŒæ„</label>
                        </div>
                    </div>
                </div>

                <!-- æ„ŸçŸ¥æœ‰ç”¨æ€§ -->
                <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                    <h3 style="font-size: 15px; color: #2c3e50; margin-bottom: 15px;">C. æ„ŸçŸ¥æœ‰ç”¨æ€§</h3>

                    <div class="survey-item">
                        <p class="survey-question">1. åœ¨å·¥ä½œä¸­ä½¿ç”¨AI-CDSSèƒ½è®©æˆ‘æ›´å¿«åœ°å®Œæˆä»»åŠ¡</p>
                        <div class="likert-scale-7">
                            <label><input type="radio" name="usefulness1" value="1">1</label>
                            <label><input type="radio" name="usefulness1" value="2">2</label>
                            <label><input type="radio" name="usefulness1" value="3">3</label>
                            <label><input type="radio" name="usefulness1" value="4">4</label>
                            <label><input type="radio" name="usefulness1" value="5">5</label>
                            <label><input type="radio" name="usefulness1" value="6">6</label>
                            <label><input type="radio" name="usefulness1" value="7">7</label>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 11px; color: #718096; margin-top: 4px;">
                            <span>éå¸¸ä¸åŒæ„</span>
                            <span>éå¸¸åŒæ„</span>
                        </div>
                    </div>

                    <div class="survey-item">
                        <p class="survey-question">2. ä½¿ç”¨AI-CDSSä¼šæé«˜æˆ‘çš„å·¥ä½œè¡¨ç°</p>
                        <div class="likert-scale-7">
                            <label><input type="radio" name="usefulness2" value="1">1</label>
                            <label><input type="radio" name="usefulness2" value="2">2</label>
                            <label><input type="radio" name="usefulness2" value="3">3</label>
                            <label><input type="radio" name="usefulness2" value="4">4</label>
                            <label><input type="radio" name="usefulness2" value="5">5</label>
                            <label><input type="radio" name="usefulness2" value="6">6</label>
                            <label><input type="radio" name="usefulness2" value="7">7</label>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 11px; color: #718096; margin-top: 4px;">
                            <span>éå¸¸ä¸åŒæ„</span>
                            <span>éå¸¸åŒæ„</span>
                        </div>
                    </div>

                    <div class="survey-item">
                        <p class="survey-question">3. åœ¨å·¥ä½œä¸­ä½¿ç”¨AI-CDSSä¼šæé«˜æˆ‘çš„å·¥ä½œæ•ˆç‡</p>
                        <div class="likert-scale-7">
                            <label><input type="radio" name="usefulness3" value="1">1</label>
                            <label><input type="radio" name="usefulness3" value="2">2</label>
                            <label><input type="radio" name="usefulness3" value="3">3</label>
                            <label><input type="radio" name="usefulness3" value="4">4</label>
                            <label><input type="radio" name="usefulness3" value="5">5</label>
                            <label><input type="radio" name="usefulness3" value="6">6</label>
                            <label><input type="radio" name="usefulness3" value="7">7</label>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 11px; color: #718096; margin-top: 4px;">
                            <span>éå¸¸ä¸åŒæ„</span>
                            <span>éå¸¸åŒæ„</span>
                        </div>
                    </div>

                    <div class="survey-item">
                        <p class="survey-question">4. ä½¿ç”¨AI-CDSSä¼šå¢å¼ºæˆ‘çš„å·¥ä½œæœ‰æ•ˆæ€§</p>
                        <div class="likert-scale-7">
                            <label><input type="radio" name="usefulness4" value="1">1</label>
                            <label><input type="radio" name="usefulness4" value="2">2</label>
                            <label><input type="radio" name="usefulness4" value="3">3</label>
                            <label><input type="radio" name="usefulness4" value="4">4</label>
                            <label><input type="radio" name="usefulness4" value="5">5</label>
                            <label><input type="radio" name="usefulness4" value="6">6</label>
                            <label><input type="radio" name="usefulness4" value="7">7</label>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 11px; color: #718096; margin-top: 4px;">
                            <span>éå¸¸ä¸åŒæ„</span>
                            <span>éå¸¸åŒæ„</span>
                        </div>
                    </div>

                    <div class="survey-item">
                        <p class="survey-question">5. ä½¿ç”¨AI-CDSSä¼šè®©æˆ‘çš„å·¥ä½œæ›´è½»æ¾</p>
                        <div class="likert-scale-7">
                            <label><input type="radio" name="usefulness5" value="1">1</label>
                            <label><input type="radio" name="usefulness5" value="2">2</label>
                            <label><input type="radio" name="usefulness5" value="3">3</label>
                            <label><input type="radio" name="usefulness5" value="4">4</label>
                            <label><input type="radio" name="usefulness5" value="5">5</label>
                            <label><input type="radio" name="usefulness5" value="6">6</label>
                            <label><input type="radio" name="usefulness5" value="7">7</label>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 11px; color: #718096; margin-top: 4px;">
                            <span>éå¸¸ä¸åŒæ„</span>
                            <span>éå¸¸åŒæ„</span>
                        </div>
                    </div>

                    <div class="survey-item">
                        <p class="survey-question">6. æˆ‘è®¤ä¸ºAI-CDSSåœ¨å·¥ä½œä¸­æ˜¯æœ‰ç”¨çš„</p>
                        <div class="likert-scale-7">
                            <label><input type="radio" name="usefulness6" value="1">1</label>
                            <label><input type="radio" name="usefulness6" value="2">2</label>
                            <label><input type="radio" name="usefulness6" value="3">3</label>
                            <label><input type="radio" name="usefulness6" value="4">4</label>
                            <label><input type="radio" name="usefulness6" value="5">5</label>
                            <label><input type="radio" name="usefulness6" value="6">6</label>
                            <label><input type="radio" name="usefulness6" value="7">7</label>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 11px; color: #718096; margin-top: 4px;">
                            <span>éå¸¸ä¸åŒæ„</span>
                            <span>éå¸¸åŒæ„</span>
                        </div>
                    </div>
                </div>

                <!-- æ„ŸçŸ¥æ˜“ç”¨æ€§ -->
                <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                    <h3 style="font-size: 15px; color: #2c3e50; margin-bottom: 15px;">D. æ„ŸçŸ¥æ˜“ç”¨æ€§</h3>

                    <div class="survey-item">
                        <p class="survey-question">1. å­¦ä¹ æ“ä½œAI-CDSSå¯¹æˆ‘æ¥è¯´ä¼šå¾ˆå®¹æ˜“</p>
                        <div class="likert-scale-7">
                            <label><input type="radio" name="easeOfUse1" value="1">1</label>
                            <label><input type="radio" name="easeOfUse1" value="2">2</label>
                            <label><input type="radio" name="easeOfUse1" value="3">3</label>
                            <label><input type="radio" name="easeOfUse1" value="4">4</label>
                            <label><input type="radio" name="easeOfUse1" value="5">5</label>
                            <label><input type="radio" name="easeOfUse1" value="6">6</label>
                            <label><input type="radio" name="easeOfUse1" value="7">7</label>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 11px; color: #718096; margin-top: 4px;">
                            <span>éå¸¸ä¸åŒæ„</span>
                            <span>éå¸¸åŒæ„</span>
                        </div>
                    </div>

                    <div class="survey-item">
                        <p class="survey-question">2. æˆ‘å‘ç°è®©AI-CDSSå®Œæˆæˆ‘æƒ³è¦çš„æ“ä½œå¾ˆå®¹æ˜“</p>
                        <div class="likert-scale-7">
                            <label><input type="radio" name="easeOfUse2" value="1">1</label>
                            <label><input type="radio" name="easeOfUse2" value="2">2</label>
                            <label><input type="radio" name="easeOfUse2" value="3">3</label>
                            <label><input type="radio" name="easeOfUse2" value="4">4</label>
                            <label><input type="radio" name="easeOfUse2" value="5">5</label>
                            <label><input type="radio" name="easeOfUse2" value="6">6</label>
                            <label><input type="radio" name="easeOfUse2" value="7">7</label>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 11px; color: #718096; margin-top: 4px;">
                            <span>éå¸¸ä¸åŒæ„</span>
                            <span>éå¸¸åŒæ„</span>
                        </div>
                    </div>

                    <div class="survey-item">
                        <p class="survey-question">3. æˆ‘ä¸AI-CDSSçš„äº¤äº’æ˜¯æ¸…æ™°æ˜“æ‡‚çš„</p>
                        <div class="likert-scale-7">
                            <label><input type="radio" name="easeOfUse3" value="1">1</label>
                            <label><input type="radio" name="easeOfUse3" value="2">2</label>
                            <label><input type="radio" name="easeOfUse3" value="3">3</label>
                            <label><input type="radio" name="easeOfUse3" value="4">4</label>
                            <label><input type="radio" name="easeOfUse3" value="5">5</label>
                            <label><input type="radio" name="easeOfUse3" value="6">6</label>
                            <label><input type="radio" name="easeOfUse3" value="7">7</label>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 11px; color: #718096; margin-top: 4px;">
                            <span>éå¸¸ä¸åŒæ„</span>
                            <span>éå¸¸åŒæ„</span>
                        </div>
                    </div>

                    <div class="survey-item">
                        <p class="survey-question">4. æˆ‘å‘ç°AI-CDSSçš„äº¤äº’æ–¹å¼æ˜¯çµæ´»çš„</p>
                        <div class="likert-scale-7">
                            <label><input type="radio" name="easeOfUse4" value="1">1</label>
                            <label><input type="radio" name="easeOfUse4" value="2">2</label>
                            <label><input type="radio" name="easeOfUse4" value="3">3</label>
                            <label><input type="radio" name="easeOfUse4" value="4">4</label>
                            <label><input type="radio" name="easeOfUse4" value="5">5</label>
                            <label><input type="radio" name="easeOfUse4" value="6">6</label>
                            <label><input type="radio" name="easeOfUse4" value="7">7</label>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 11px; color: #718096; margin-top: 4px;">
                            <span>éå¸¸ä¸åŒæ„</span>
                            <span>éå¸¸åŒæ„</span>
                        </div>
                    </div>

                    <div class="survey-item">
                        <p class="survey-question">5. æˆ‘èƒ½å¤Ÿå¾ˆå®¹æ˜“åœ°ç†Ÿç»ƒä½¿ç”¨AI-CDSS</p>
                        <div class="likert-scale-7">
                            <label><input type="radio" name="easeOfUse5" value="1">1</label>
                            <label><input type="radio" name="easeOfUse5" value="2">2</label>
                            <label><input type="radio" name="easeOfUse5" value="3">3</label>
                            <label><input type="radio" name="easeOfUse5" value="4">4</label>
                            <label><input type="radio" name="easeOfUse5" value="5">5</label>
                            <label><input type="radio" name="easeOfUse5" value="6">6</label>
                            <label><input type="radio" name="easeOfUse5" value="7">7</label>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 11px; color: #718096; margin-top: 4px;">
                            <span>éå¸¸ä¸åŒæ„</span>
                            <span>éå¸¸åŒæ„</span>
                        </div>
                    </div>

                    <div class="survey-item">
                        <p class="survey-question">6. æˆ‘è®¤ä¸ºAI-CDSSæ˜“äºä½¿ç”¨</p>
                        <div class="likert-scale-7">
                            <label><input type="radio" name="easeOfUse6" value="1">1</label>
                            <label><input type="radio" name="easeOfUse6" value="2">2</label>
                            <label><input type="radio" name="easeOfUse6" value="3">3</label>
                            <label><input type="radio" name="easeOfUse6" value="4">4</label>
                            <label><input type="radio" name="easeOfUse6" value="5">5</label>
                            <label><input type="radio" name="easeOfUse6" value="6">6</label>
                            <label><input type="radio" name="easeOfUse6" value="7">7</label>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 11px; color: #718096; margin-top: 4px;">
                            <span>éå¸¸ä¸åŒæ„</span>
                            <span>éå¸¸åŒæ„</span>
                        </div>
                    </div>
                </div>
            </div>

            <button class="welcome-btn" onclick="submitSystemSurvey()">æäº¤è¯„ä»·</button>
        </div>
    </div>

    <div class="main-wrapper" id="mainContent" style="display: none;">
        <div class="header">
            <span class="save-status" id="saveStatus">å·²ä¿å­˜</span>
            <h1>AIä¸´åºŠå†³ç­–æ”¯æŒç³»ç»Ÿ - å‘¼å¸é“æ„ŸæŸ“è¯Šç–—</h1>
            <div class="experiment-tag" id="experimentTag">åŠ è½½ä¸­...</div>
            <span class="feature-indicator" id="featureIndicator" style="display: none;"></span>
        </div>

        <div class="case-navigation" id="caseNavigation">
            <div class="progress-header">
                <div class="progress-title">å®éªŒè¿›åº¦</div>
                <div class="progress-stats">
                    <div class="progress-stat-item">
                        <span class="progress-stat-label">å·²å®Œæˆ:</span>
                        <span class="progress-stat-value" id="completedCount">0/9</span>
                    </div>
                    <div class="progress-stat-item">
                        <span class="progress-stat-label">å½“å‰:</span>
                        <span class="progress-stat-value" id="currentCase">æ¡ˆä¾‹1</span>
                    </div>
                </div>
            </div>
            <div class="progress-bar-wrapper">
                <div class="progress-bar-bg">
                    <div class="progress-bar-fill" id="progressBarFill" style="width: 0%">
                        <span class="progress-bar-text" id="progressBarText">0%</span>
                    </div>
                </div>
            </div>
            <div id="caseNavigationContent"></div>
        </div>

        <div class="content-layout">
            <div class="main-content">
                <div id="caseContentArea">
                    <div class="panel">
                        <div class="panel-title">æ‚£è€…ç—…å†ä¿¡æ¯</div>
                        <div class="input-group">
                            <label>å®Œæ•´ç—…å†</label>
                            <textarea id="medicalRecordDisplay" class="medical-record-textarea" readonly></textarea>
                        </div>
                    </div>

                    <div class="panel">
                        <div class="panel-title">è¯Šç–—å†³ç­–</div>
                        <div id="initialDecisionSection">
                            <div style="background: #d4edda; color: #155724; padding: 8px 12px; border-radius: 4px; margin-bottom: 15px; font-size: 12px; font-weight: 600;">
                                é˜¶æ®µ1:åˆæ­¥è¯Šæ–­(æœªçœ‹AIå»ºè®®)
                            </div>
                            <div class="input-group">
                                <label>è¯Šæ–­(æŒ‰å¯èƒ½æ€§ä»å¤§åˆ°å°æ’åˆ—)<span class="required-mark">*</span></label>
                                <div class="help-text">è¯·åˆ—å‡ºæœ€å¯èƒ½çš„ä¸‰ä¸ªè¯Šæ–­</div>
                                <div class="diagnosis-list">
                                    <div class="diagnosis-item"><span style="font-size: 13px; color: #718096;">æœ€å¯èƒ½:</span><input type="text" id="initialDiag1" placeholder="ç¬¬ä¸€è¯Šæ–­"></div>
                                    <div class="diagnosis-item"><span style="font-size: 13px; color: #718096;">æ¬¡å¯èƒ½:</span><input type="text" id="initialDiag2" placeholder="ç¬¬äºŒè¯Šæ–­"></div>
                                    <div class="diagnosis-item"><span style="font-size: 13px; color: #718096;">ç¬¬ä¸‰å¯èƒ½:</span><input type="text" id="initialDiag3" placeholder="ç¬¬ä¸‰è¯Šæ–­"></div>
                                </div>
                            </div>
                            <div class="input-group">
                                <label>æ˜¯å¦ä½¿ç”¨æŠ—ç”Ÿç´  <span class="required-mark">*</span></label>
                                <div class="radio-group">
                                    <label><input type="radio" name="initialAntibiotic" value="no">å¦,ä¸ä½¿ç”¨æŠ—ç”Ÿç´ </label>
                                    <label><input type="radio" name="initialAntibiotic" value="yes">æ˜¯,éœ€è¦ä½¿ç”¨æŠ—ç”Ÿç´ </label>
                                </div>
                            </div>
                            <div class="input-group hidden" id="initialAntibioticTypes">
                                <label>è¯·å¡«å†™æŠ—ç”Ÿç´ ç§ç±»<span class="required-mark">*</span></label>
                                <input type="text" id="initialAntibioticInput" placeholder="ä¾‹å¦‚:é˜¿è«è¥¿æ—ã€å¤´å­¢æ°¨è‹„">
                            </div>
                            <div class="action-buttons">
                                <button class="btn btn-ai-suggest" onclick="submitInitialDecision()">ğŸ“Š æäº¤å¹¶è·å–AIå»ºè®®</button>
                            </div>
                        </div>

                        <div id="finalDecisionSection" class="hidden">
                            <div style="background: #cfe2ff; color: #084298; padding: 8px 12px; border-radius: 4px; margin-bottom: 15px; font-size: 12px; font-weight: 600;">
                                é˜¶æ®µ2:æœ€ç»ˆå†³ç­–(å·²æŸ¥çœ‹AIå»ºè®®)
                            </div>
                            <div class="input-group">
                                <label>è¯Šæ–­(æŒ‰å¯èƒ½æ€§ä»å¤§åˆ°å°æ’åˆ—)<span class="required-mark">*</span></label>
                                <div class="diagnosis-list">
                                    <div class="diagnosis-item"><span style="font-size: 13px; color: #718096;">æœ€å¯èƒ½:</span><input type="text" id="finalDiag1"></div>
                                    <div class="diagnosis-item"><span style="font-size: 13px; color: #718096;">æ¬¡å¯èƒ½:</span><input type="text" id="finalDiag2"></div>
                                    <div class="diagnosis-item"><span style="font-size: 13px; color: #718096;">ç¬¬ä¸‰å¯èƒ½:</span><input type="text" id="finalDiag3"></div>
                                </div>
                            </div>
                            <div class="input-group">
                                <label>æ˜¯å¦ä½¿ç”¨æŠ—ç”Ÿç´  <span class="required-mark">*</span></label>
                                <div class="radio-group">
                                    <label><input type="radio" name="finalAntibiotic" value="no">å¦,ä¸ä½¿ç”¨æŠ—ç”Ÿç´ </label>
                                    <label><input type="radio" name="finalAntibiotic" value="yes">æ˜¯,éœ€è¦ä½¿ç”¨æŠ—ç”Ÿç´ </label>
                                </div>
                            </div>
                            <div class="input-group hidden" id="finalAntibioticTypes">
                                <label>è¯·å¡«å†™æŠ—ç”Ÿç´ ç§ç±»<span class="required-mark">*</span></label>
                                <input type="text" id="finalAntibioticInput">
                            </div>
                            <div class="input-group">
                                <label>å†³ç­–ç¡®å®šæ€§ <span class="required-mark">*</span></label>
                                <div class="radio-group">
                                    <label><input type="radio" name="certainty" value="1">1 - éå¸¸ä¸ç¡®å®š</label>
                                    <label><input type="radio" name="certainty" value="2">2 - ä¸ç¡®å®š</label>
                                    <label><input type="radio" name="certainty" value="3">3 - ä¸€èˆ¬</label>
                                    <label><input type="radio" name="certainty" value="4">4 - ç¡®å®š</label>
                                    <label><input type="radio" name="certainty" value="5">5 - éå¸¸ç¡®å®š</label>
                                </div>
                            </div>
                            <div class="action-buttons">
                                <button class="btn btn-success" onclick="submitFinalDecision()">æäº¤æœ€ç»ˆå†³ç­–</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="completionArea" class="hidden">
                    <div style="background: #d4edda; border: 2px solid #27ae60; border-radius: 6px; padding: 30px; text-align: center;">
                        <h2 style="color: #155724;">âœ“ å®éªŒå·²å®Œæˆ</h2>
                        <p style="margin-top: 15px;">æ„Ÿè°¢æ‚¨çš„å‚ä¸!æ‰€æœ‰9ä¸ªæ¡ˆä¾‹å·²å®Œæˆã€‚</p>
                        <p style="font-size: 13px; color: #718096; margin-top: 15px;">å‚ä¸è€…:<span id="completedParticipantId" style="font-weight: 600;"></span></p>
                    </div>
                </div>
            </div>

            <div class="ai-sidebar" id="aiSidebar">
                <div class="ai-sidebar-header">
                    <h3>ğŸ¤– AIè¾…åŠ©è¯Šç–—ç³»ç»Ÿ</h3>
                    <div style="font-size: 11px; opacity: 0.9; margin-top: 4px;">æ™ºèƒ½åˆ†æ Â· è¾…åŠ©å†³ç­–</div>
                </div>
                <div class="ai-sidebar-content">
                    <div class="ai-section hidden" id="pasteSectionSidebar">
                        <div class="ai-section-title">ğŸ“‹ è¯·å¤åˆ¶ç²˜è´´ç—…å†å†…å®¹</div>
                        <div style="color: #718096; font-size: 13px; line-height: 1.6; margin-bottom: 16px;">
                            ä¸ºäº†è®©AIç³»ç»Ÿåˆ†æç—…å†,è¯·å°†å·¦ä¾§çš„å®Œæ•´ç—…å†å†…å®¹å¤åˆ¶ç²˜è´´åˆ°ä¸‹æ–¹æ–‡æœ¬æ¡†ä¸­:
                        </div>
                        <textarea id="pasteTextareaSidebar" class="medical-record-textarea" placeholder="è¯·åœ¨æ­¤å¤„ç²˜è´´å®Œæ•´ç—…å†å†…å®¹..." style="margin-bottom: 16px;"></textarea>
                        <div style="text-align: right;">
                            <button class="btn btn-primary" onclick="submitPastedContentSidebar()">âœ“ æäº¤å¹¶è·å–AIå»ºè®®</button>
                        </div>
                    </div>

                    <div class="ai-section hidden" id="thinkingSection">
                        <div class="ai-section-title">ğŸ’­ AIæ¨ç†è¿‡ç¨‹</div>
                        <div class="thinking-process" id="thinkingProcess"></div>
                    </div>

                    <div class="ai-section hidden" id="diagnosisSection">
                        <div class="ai-section-title">ğŸ¯ è¯Šæ–­å»ºè®®</div>
                        <div id="diagnosisContent"></div>
                    </div>

                    <div class="ai-section hidden" id="featureSection">
                        <div class="ai-section-title">ğŸ“Š å…³é”®ç‰¹å¾åˆ†æ</div>
                        <div class="ig-visualization">
                            <div class="ig-title">ç—…å†ç‰¹å¾å¯¹è¯Šæ–­çš„å½±å“ç¨‹åº¦</div>
                            <div class="ig-explain">
                                æ­¤å›¾æ˜¾ç¤ºå„é¡¹ç—…å†ä¿¡æ¯å¯¹AIè¯Šæ–­å†³ç­–çš„è´¡çŒ®åº¦ã€‚<strong style="color: #27ae60;">ç»¿è‰²</strong>è¡¨ç¤ºè¯¥ç‰¹å¾æ”¯æŒå½“å‰è¯Šæ–­,<strong style="color: #e74c3c;">çº¢è‰²</strong>è¡¨ç¤ºè¯¥ç‰¹å¾ä¸æ”¯æŒå½“å‰è¯Šæ–­ã€‚æ•°å€¼è¶Šå¤§,å½±å“è¶Šæ˜¾è‘—ã€‚
                            </div>
                            <div class="ig-chart-container">
                                <canvas id="igChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="ai-section hidden" id="treatmentSection">
                        <div class="ai-section-title">ğŸ’Š ç”¨è¯å»ºè®®</div>
                        <div id="treatmentContent"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="ai-modal-overlay" id="aiModalOverlay">
            <div class="ai-modal" id="aiModal">
                <div class="ai-modal-header">
                    <div>
                        <h3>ğŸ¤– AIè¾…åŠ©è¯Šç–—ç³»ç»Ÿ</h3>
                        <div style="font-size: 11px; opacity: 0.9; margin-top: 4px;">æ™ºèƒ½åˆ†æ Â· è¾…åŠ©å†³ç­–</div>
                    </div>
                    <div class="ai-modal-controls">
                        <button class="ai-modal-btn" onclick="toggleMinimizeModal()" title="æœ€å°åŒ–">
                            <span id="minimizeIcon">âˆ’</span>
                        </button>
                        <button class="ai-modal-btn" onclick="closeAIModal()" title="å…³é—­">Ã—</button>
                    </div>
                </div>
                <div class="ai-modal-content">
                    <div class="ai-section hidden" id="pasteSectionModal">
                        <div class="ai-section-title">ğŸ“‹ è¯·å¤åˆ¶ç²˜è´´ç—…å†å†…å®¹</div>
                        <div style="color: #718096; font-size: 13px; line-height: 1.6; margin-bottom: 16px;">
                            ä¸ºäº†è®©AIç³»ç»Ÿåˆ†æç—…å†,è¯·å°†å·¦ä¾§çš„å®Œæ•´ç—…å†å†…å®¹å¤åˆ¶ç²˜è´´åˆ°ä¸‹æ–¹æ–‡æœ¬æ¡†ä¸­:
                        </div>
                        <textarea id="pasteTextareaModal" class="medical-record-textarea" placeholder="è¯·åœ¨æ­¤å¤„ç²˜è´´å®Œæ•´ç—…å†å†…å®¹..." style="margin-bottom: 16px;"></textarea>
                        <div style="text-align: right;">
                            <button class="btn btn-primary" onclick="submitPastedContentModal()">âœ“ æäº¤å¹¶è·å–AIå»ºè®®</button>
                        </div>
                    </div>

                    <div class="ai-section hidden" id="thinkingSectionModal">
                        <div class="ai-section-title">ğŸ’­ AIæ¨ç†è¿‡ç¨‹</div>
                        <div class="thinking-process" id="thinkingProcessModal"></div>
                    </div>

                    <div class="ai-section hidden" id="diagnosisSectionModal">
                        <div class="ai-section-title">ğŸ¯ è¯Šæ–­å»ºè®®</div>
                        <div id="diagnosisContentModal"></div>
                    </div>

                    <div class="ai-section hidden" id="featureSectionModal">
                        <div class="ai-section-title">ğŸ“Š å…³é”®ç‰¹å¾åˆ†æ</div>
                        <div class="ig-visualization">
                            <div class="ig-title">ç—…å†ç‰¹å¾å¯¹è¯Šæ–­çš„å½±å“ç¨‹åº¦</div>
                            <div class="ig-explain">
                                æ­¤å›¾æ˜¾ç¤ºå„é¡¹ç—…å†ä¿¡æ¯å¯¹AIè¯Šæ–­å†³ç­–çš„è´¡çŒ®åº¦ã€‚<strong style="color: #27ae60;">ç»¿è‰²</strong>è¡¨ç¤ºè¯¥ç‰¹å¾æ”¯æŒå½“å‰è¯Šæ–­,<strong style="color: #e74c3c;">çº¢è‰²</strong>è¡¨ç¤ºè¯¥ç‰¹å¾ä¸æ”¯æŒå½“å‰è¯Šæ–­ã€‚æ•°å€¼è¶Šå¤§,å½±å“è¶Šæ˜¾è‘—ã€‚
                            </div>
                            <div class="ig-chart-container">
                                <canvas id="igChartModal"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="ai-section hidden" id="treatmentSectionModal">
                        <div class="ai-section-title">ğŸ’Š ç”¨è¯å»ºè®®</div>
                        <div id="treatmentContentModal"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // ç—…å†æ•°æ®åº“ (ä¿æŒä¸å˜)
        // ========================================
        const CASE_DATABASE = {
            case001: {
                id: "case001",
                patientId: "PT2023001",
                gender: "ç”·",
                age: "45å²",
                visitDate: "2023-10-15",
                chiefComplaint: "å‘çƒ­ã€å’³å—½ã€å’³ç—°3å¤©",
                presentIllness: "æ‚£è€…3å¤©å‰å—å‡‰åå‡ºç°å‘çƒ­,ä½“æ¸©æœ€é«˜38.5â„ƒ,ä¼´æœ‰å’³å—½ã€å’³é»„è‰²ç²˜ç—°,é‡ä¸å¤š,æ— èƒ¸ç—›ã€å’¯è¡€ã€‚è‡ªè¡Œæœç”¨é€€çƒ­è¯åä½“æ¸©å¯æš‚æ—¶ä¸‹é™,ä½†åå¤å‘çƒ­ã€‚",
                personalHistory: "å¸çƒŸ20å¹´,æ¯å¤©10æ”¯;å¶é¥®é…’ã€‚",
                allergyHistory: "æ— è¯ç‰©è¿‡æ•å²",
                physicalExam: "T 38.2â„ƒ,P 92æ¬¡/åˆ†,R 20æ¬¡/åˆ†,BP 125/80mmHgã€‚å’½éƒ¨å……è¡€,æ‰æ¡ƒä½“æ— è‚¿å¤§ã€‚åŒè‚ºå‘¼å¸éŸ³ç²—,å¯é—»åŠå°‘é‡æ¹¿æ€§å•°éŸ³ã€‚",
                labTests: "è¡€å¸¸è§„:WBC 12.5Ã—10^9/L,N 85%ã€‚èƒ¸éƒ¨Xçº¿:åŒè‚ºçº¹ç†å¢ç²—ã€‚",
                aiRecommendation: {
                    thinking: [
                        "æ‚£è€…è¡¨ç°ä¸ºæ€¥æ€§å‘çƒ­ã€å’³å—½ã€å’³é»„ç—°,æç¤ºæ€¥æ€§å‘¼å¸é“æ„ŸæŸ“",
                        "è¡€å¸¸è§„æ˜¾ç¤ºç™½ç»†èƒå’Œä¸­æ€§ç²’ç»†èƒå‡å‡é«˜,æ”¯æŒç»†èŒæ„ŸæŸ“å¯èƒ½",
                        "èƒ¸éƒ¨Xçº¿æœªè§æ˜æ˜¾è‚ºç‚è¡¨ç°,è€ƒè™‘æ€¥æ€§æ”¯æ°”ç®¡ç‚å¯èƒ½æ€§å¤§",
                        "æ‚£è€…æœ‰å¸çƒŸå²,æ˜¯å‘¼å¸é“æ„ŸæŸ“çš„æ˜“æ„Ÿå› ç´ "
                    ],
                    diagnosis: [
                        { name: "æ€¥æ€§æ”¯æ°”ç®¡ç‚", confidence: 85 },
                        { name: "ç¤¾åŒºè·å¾—æ€§è‚ºç‚", confidence: 40 },
                        { name: "ä¸Šå‘¼å¸é“æ„ŸæŸ“", confidence: 30 }
                    ],
                    featureImportance: {
                        features: ["å‘çƒ­", "å’³å—½", "å’³é»„ç—°", "ç™½ç»†èƒå‡é«˜", "å¸çƒŸå²", "è‚ºéƒ¨æ¹¿å•°éŸ³"],
                        gradients: [0.8, 0.6, 0.7, 0.9, 0.4, 0.5]
                    },
                    useAntibiotic: true,
                    antibioticStandard: "æ ¹æ®æŒ‡å—,æ€¥æ€§æ”¯æ°”ç®¡ç‚ä¼´æœ‰è„“ç—°å’Œç™½ç»†èƒå‡é«˜,å»ºè®®ä½¿ç”¨æŠ—ç”Ÿç´ æ²»ç–—ã€‚é¦–é€‰é˜¿è«è¥¿æ—å…‹æ‹‰ç»´é…¸é’¾æˆ–ç¬¬äºŒä»£å¤´å­¢èŒç´ ã€‚",
                    antibioticPrimary: "é˜¿è«è¥¿æ—å…‹æ‹‰ç»´é…¸é’¾ 625mg å£æœ,æ¯8å°æ—¶ä¸€æ¬¡,ç–—ç¨‹5-7å¤©",
                    antibioticReasoning: "æ‚£è€…æœ‰æ˜ç¡®çš„ç»†èŒæ„ŸæŸ“è¯æ®(å‘çƒ­ã€é»„ç—°ã€ç™½ç»†èƒå‡é«˜),ä¸”ä¸ºå¸çƒŸè€…,æ„ŸæŸ“é£é™©è¾ƒé«˜,å› æ­¤å»ºè®®ä½¿ç”¨æŠ—ç”Ÿç´ æ²»ç–—ã€‚"
                }
            },
            case002: {
                id: "case002",
                patientId: "PT2023002",
                gender: "å¥³",
                age: "32å²",
                visitDate: "2023-10-18",
                chiefComplaint: "å’½ç—›ã€æµæ¶•2å¤©",
                presentIllness: "æ‚£è€…2å¤©å‰å‡ºç°å’½ç—›ã€æµæ¸…æ¶•,ä¼´æœ‰è½»å¾®å¤´ç—›,æ— å‘çƒ­,æ— å’³å—½å’³ç—°ã€‚è‡ªè¡Œæœç”¨æ„Ÿå†’è¯åç—‡çŠ¶ç•¥æœ‰ç¼“è§£ã€‚",
                personalHistory: "æ— å¸çƒŸé¥®é…’å²ã€‚åŠå…¬å®¤æ–‡èŒäººå‘˜ã€‚",
                allergyHistory: "é’éœ‰ç´ è¿‡æ•",
                physicalExam: "T 36.8â„ƒ,P 78æ¬¡/åˆ†,R 18æ¬¡/åˆ†,BP 110/70mmHgã€‚å’½éƒ¨å……è¡€æ˜æ˜¾,æ‰æ¡ƒä½“Iåº¦è‚¿å¤§,æ— è„“ç‚¹ã€‚åŒè‚ºå‘¼å¸éŸ³æ¸…,æœªé—»åŠå¹²æ¹¿å•°éŸ³ã€‚",
                labTests: "è¡€å¸¸è§„:WBC 7.2Ã—10^9/L,N 65%ã€‚",
                aiRecommendation: {
                    thinking: [
                        "æ‚£è€…è¡¨ç°ä¸ºå’½ç—›ã€æµæ¶•ç­‰ä¸Šå‘¼å¸é“ç—‡çŠ¶,æ— å‘çƒ­",
                        "è¡€å¸¸è§„æ­£å¸¸,ä¸æ”¯æŒç»†èŒæ„ŸæŸ“",
                        "ä½“æ ¼æ£€æŸ¥ä»…è§å’½éƒ¨å……è¡€,æ— æ‰æ¡ƒä½“åŒ–è„“è¡¨ç°",
                        "ç»¼åˆè€ƒè™‘ä¸ºç—…æ¯’æ€§ä¸Šå‘¼å¸é“æ„ŸæŸ“"
                    ],
                    diagnosis: [
                        { name: "æ€¥æ€§ä¸Šå‘¼å¸é“æ„ŸæŸ“(ç—…æ¯’æ€§)", confidence: 90 },
                        { name: "æ€¥æ€§å’½ç‚", confidence: 70 },
                        { name: "æ€¥æ€§æ‰æ¡ƒä½“ç‚", confidence: 20 }
                    ],
                    featureImportance: {
                        features: ["å’½ç—›", "æµæ¶•", "æ— å‘çƒ­", "è¡€å¸¸è§„æ­£å¸¸", "å’½éƒ¨å……è¡€", "æ‰æ¡ƒä½“æ— è„“ç‚¹"],
                        gradients: [0.7, 0.5, 0.8, 0.9, 0.6, 0.7]
                    },
                    useAntibiotic: false,
                    antibioticStandard: "æ ¹æ®æŒ‡å—,å•çº¯ç—…æ¯’æ€§ä¸Šå‘¼å¸é“æ„ŸæŸ“ä¸å»ºè®®ä½¿ç”¨æŠ—ç”Ÿç´ ã€‚",
                    antibioticPrimary: "",
                    antibioticReasoning: "æ‚£è€…ä¸´åºŠè¡¨ç°å’Œå®éªŒå®¤æ£€æŸ¥å‡ä¸æ”¯æŒç»†èŒæ„ŸæŸ“,ä¸ºå…¸å‹çš„ç—…æ¯’æ€§ä¸Šå‘¼å¸é“æ„ŸæŸ“,å› æ­¤ä¸å»ºè®®ä½¿ç”¨æŠ—ç”Ÿç´ ã€‚å»ºè®®å¯¹ç—‡æ²»ç–—,å¤šä¼‘æ¯,å¤šé¥®æ°´ã€‚"
                }
            },
            case003: {
                id: "case003",
                patientId: "PT2023003",
                gender: "ç”·",
                age: "68å²",
                visitDate: "2023-10-20",
                chiefComplaint: "å‘çƒ­ã€å’³å—½ã€èƒ¸ç—›5å¤©",
                presentIllness: "æ‚£è€…5å¤©å‰å¼€å§‹å‘çƒ­,ä½“æ¸©æœ€é«˜39.2â„ƒ,ä¼´æœ‰å’³å—½ã€å’³é“é”ˆè‰²ç—°,å³ä¾§èƒ¸ç—›,æ·±å‘¼å¸æ—¶åŠ é‡ã€‚è‡ªè¡Œæœç”¨é€€çƒ­è¯æ•ˆæœä¸ä½³ã€‚",
                personalHistory: "æœ‰é«˜è¡€å‹ç—…å²10å¹´,è§„å¾‹æœè¯;å¸çƒŸ30å¹´,å·²æˆ’çƒŸ5å¹´ã€‚",
                allergyHistory: "æ— è¯ç‰©è¿‡æ•å²",
                physicalExam: "T 39.0â„ƒ,P 105æ¬¡/åˆ†,R 24æ¬¡/åˆ†,BP 140/85mmHgã€‚å³ä¸‹è‚ºå©è¯ŠæµŠéŸ³,è¯­é¢¤å¢å¼º,å¯é—»åŠæ”¯æ°”ç®¡å‘¼å¸éŸ³å’Œæ¹¿æ€§å•°éŸ³ã€‚",
                labTests: "è¡€å¸¸è§„:WBC 15.8Ã—10^9/L,N 90%ã€‚èƒ¸éƒ¨CT:å³ä¸‹è‚ºå¤§ç‰‡å®å˜å½±,æç¤ºå¤§å¶æ€§è‚ºç‚ã€‚",
                aiRecommendation: {
                    thinking: [
                        "æ‚£è€…è¡¨ç°ä¸ºé«˜çƒ­ã€å’³å—½ã€é“é”ˆè‰²ç—°å’Œèƒ¸ç—›,å…¸å‹è‚ºç‚ç—‡çŠ¶",
                        "è¡€å¸¸è§„æ˜¾ç¤ºæ˜æ˜¾ç™½ç»†èƒå’Œä¸­æ€§ç²’ç»†èƒå‡é«˜,å¼ºçƒˆæ”¯æŒç»†èŒæ„ŸæŸ“",
                        "èƒ¸éƒ¨CTæ˜¾ç¤ºå¤§å¶æ€§è‚ºç‚è¡¨ç°,ç¬¦åˆè‚ºç‚é“¾çƒèŒæ„ŸæŸ“ç‰¹å¾",
                        "æ‚£è€…ä¸ºè€å¹´äºº,æœ‰é«˜è¡€å‹åŸºç¡€ç—…,æ„ŸæŸ“é£é™©è¾ƒé«˜"
                    ],
                    diagnosis: [
                        { name: "ç¤¾åŒºè·å¾—æ€§è‚ºç‚(å¤§å¶æ€§è‚ºç‚)", confidence: 95 },
                        { name: "æ€¥æ€§æ”¯æ°”ç®¡ç‚", confidence: 20 },
                        { name: "è‚ºç»“æ ¸", confidence: 10 }
                    ],
                    featureImportance: {
                        features: ["é«˜çƒ­", "é“é”ˆè‰²ç—°", "èƒ¸ç—›", "ç™½ç»†èƒæ˜¾è‘—å‡é«˜", "è‚ºéƒ¨å®å˜", "è€å¹´æ‚£è€…"],
                        gradients: [0.9, 0.8, 0.7, 0.95, 0.85, 0.6]
                    },
                    useAntibiotic: true,
                    antibioticStandard: "æ ¹æ®æŒ‡å—,ç¤¾åŒºè·å¾—æ€§è‚ºç‚éœ€ç«‹å³ä½¿ç”¨æŠ—ç”Ÿç´ æ²»ç–—ã€‚é¦–é€‰Î²-å†…é…°èƒºç±»è”åˆå¤§ç¯å†…é…¯ç±»,æˆ–å‘¼å¸å–¹è¯ºé…®ç±»ã€‚",
                    antibioticPrimary: "å¤´å­¢æ›²æ¾ 2g é™è„‰æ»´æ³¨,æ¯æ—¥ä¸€æ¬¡ + é˜¿å¥‡éœ‰ç´  500mg å£æœ,æ¯æ—¥ä¸€æ¬¡",
                    antibioticReasoning: "æ‚£è€…ä¸´åºŠè¡¨ç°å’Œå½±åƒå­¦æ£€æŸ¥å‡æ”¯æŒé‡ç—‡ç¤¾åŒºè·å¾—æ€§è‚ºç‚è¯Šæ–­,éœ€è¦ç«‹å³ä½¿ç”¨å¼ºæ•ˆæŠ—ç”Ÿç´ æ²»ç–—,å¹¶è€ƒè™‘ä½é™¢æ²»ç–—ã€‚"
                }
            },
            case004: {
                id: "case004",
                patientId: "PT2023004",
                gender: "å¥³",
                age: "25å²",
                visitDate: "2023-10-22",
                chiefComplaint: "å’½ç—›ã€å‘çƒ­1å¤©",
                presentIllness: "æ‚£è€…1å¤©å‰å¼€å§‹å’½ç—›,åå’½æ—¶åŠ é‡,ä¼´æœ‰å‘çƒ­,ä½“æ¸©æœ€é«˜38.8â„ƒ,æ— å’³å—½ã€å’³ç—°ã€‚è‡ªè¡Œæœç”¨é€€çƒ­è¯åä½“æ¸©å¯æš‚æ—¶ä¸‹é™ã€‚",
                personalHistory: "æ— ç‰¹æ®Šç—…å²ã€‚æ•™å¸ˆèŒä¸š,è¿‘æœŸæ¥è§¦è¿‡æ„Ÿå†’å­¦ç”Ÿã€‚",
                allergyHistory: "æ— è¯ç‰©è¿‡æ•å²",
                physicalExam: "T 38.5â„ƒ,P 92æ¬¡/åˆ†,R 18æ¬¡/åˆ†,BP 115/75mmHgã€‚å’½éƒ¨æ˜æ˜¾å……è¡€,æ‰æ¡ƒä½“IIåº¦è‚¿å¤§,è¡¨é¢æœ‰ç™½è‰²è„“ç‚¹ã€‚åŒä¾§é¢Œä¸‹æ·‹å·´ç»“è‚¿å¤§ã€å‹ç—›ã€‚",
                labTests: "è¡€å¸¸è§„:WBC 13.2Ã—10^9/L,N 82%ã€‚å¿«é€Ÿé“¾çƒèŒæ£€æµ‹:é˜³æ€§ã€‚",
                aiRecommendation: {
                    thinking: [
                        "æ‚£è€…è¡¨ç°ä¸ºå’½ç—›ã€å‘çƒ­,æ‰æ¡ƒä½“æœ‰è„“ç‚¹,æç¤ºç»†èŒæ€§æ‰æ¡ƒä½“ç‚",
                        "è¡€å¸¸è§„æ˜¾ç¤ºç™½ç»†èƒå’Œä¸­æ€§ç²’ç»†èƒå‡é«˜,æ”¯æŒç»†èŒæ„ŸæŸ“",
                        "å¿«é€Ÿé“¾çƒèŒæ£€æµ‹é˜³æ€§,ç¡®è¯ŠAç»„é“¾çƒèŒæ„ŸæŸ“",
                        "æ‚£è€…ä¸ºæ•™å¸ˆ,æ¥è§¦æ„Ÿå†’å­¦ç”Ÿ,æ„ŸæŸ“é£é™©è¾ƒé«˜"
                    ],
                    diagnosis: [
                        { name: "æ€¥æ€§åŒ–è„“æ€§æ‰æ¡ƒä½“ç‚", confidence: 90 },
                        { name: "ä¼ æŸ“æ€§å•æ ¸ç»†èƒå¢å¤šç—‡", confidence: 30 },
                        { name: "ç—…æ¯’æ€§å’½ç‚", confidence: 15 }
                    ],
                    featureImportance: {
                        features: ["å’½ç—›", "å‘çƒ­", "æ‰æ¡ƒä½“è„“ç‚¹", "ç™½ç»†èƒå‡é«˜", "é“¾çƒèŒé˜³æ€§", "é¢Œä¸‹æ·‹å·´ç»“è‚¿å¤§"],
                        gradients: [0.8, 0.7, 0.9, 0.8, 0.95, 0.6]
                    },
                    useAntibiotic: true,
                    antibioticStandard: "æ ¹æ®æŒ‡å—,Aç»„é“¾çƒèŒæ€§æ‰æ¡ƒä½“ç‚éœ€ä½¿ç”¨æŠ—ç”Ÿç´ æ²»ç–—,é¦–é€‰é’éœ‰ç´ ç±»ã€‚",
                    antibioticPrimary: "é’éœ‰ç´ Vé’¾ 500mg å£æœ,æ¯æ—¥3æ¬¡,ç–—ç¨‹10å¤©",
                    antibioticReasoning: "æ‚£è€…æœ‰æ˜ç¡®çš„Aç»„é“¾çƒèŒæ„ŸæŸ“è¯æ®,éœ€è¦ä½¿ç”¨æŠ—ç”Ÿç´ æ²»ç–—ä»¥é¢„é˜²å¹¶å‘ç—‡(å¦‚é£æ¹¿çƒ­ã€è‚¾å°çƒè‚¾ç‚)ã€‚"
                }
            },
            case005: {
                id: "case005",
                patientId: "PT2023005",
                gender: "ç”·",
                age: "55å²",
                visitDate: "2023-10-25",
                chiefComplaint: "å’³å—½ã€æ°”ä¿ƒ1å‘¨",
                presentIllness: "æ‚£è€…1å‘¨å‰å¼€å§‹å’³å—½,å¹²å’³ä¸ºä¸»,ä¼´æœ‰æ´»åŠ¨åæ°”ä¿ƒ,æ— å‘çƒ­ã€èƒ¸ç—›ã€‚ç—‡çŠ¶é€æ¸åŠ é‡,è½»å¾®æ´»åŠ¨å³æ„Ÿæ°”ä¿ƒã€‚",
                personalHistory: "æœ‰COPDç—…å²8å¹´,é•¿æœŸå¸çƒŸ,æ¯å¤©20æ”¯ã€‚",
                allergyHistory: "æ— è¯ç‰©è¿‡æ•å²",
                physicalExam: "T 36.9â„ƒ,P 88æ¬¡/åˆ†,R 22æ¬¡/åˆ†,BP 130/80mmHgã€‚åŒè‚ºå‘¼å¸éŸ³ä½,å¯é—»åŠæ•£åœ¨å“®é¸£éŸ³ã€‚æ¡¶çŠ¶èƒ¸ã€‚",
                labTests: "è¡€å¸¸è§„:WBC 8.5Ã—10^9/L,N 70%ã€‚èƒ¸éƒ¨Xçº¿:è‚ºæ°”è‚¿è¡¨ç°,æ— æµ¸æ¶¦å½±ã€‚è‚ºåŠŸèƒ½:FEV1/FVC 55%ã€‚",
                aiRecommendation: {
                    thinking: [
                        "æ‚£è€…è¡¨ç°ä¸ºå’³å—½ã€æ°”ä¿ƒ,æ— å‘çƒ­,æç¤ºéæ„ŸæŸ“æ€§å‘¼å¸é“ç–¾ç—…",
                        "æœ‰COPDç—…å²å’Œé•¿æœŸå¸çƒŸå²,è‚ºåŠŸèƒ½æ£€æŸ¥è¯å®æ°”æµå—é™",
                        "è¡€å¸¸è§„æ­£å¸¸,æ— æ„ŸæŸ“è¯æ®",
                        "è€ƒè™‘ä¸ºCOPDæ€¥æ€§åŠ é‡"
                    ],
                    diagnosis: [
                        { name: "COPDæ€¥æ€§åŠ é‡", confidence: 85 },
                        { name: "æ”¯æ°”ç®¡å“®å–˜æ€¥æ€§å‘ä½œ", confidence: 40 },
                        { name: "ç¤¾åŒºè·å¾—æ€§è‚ºç‚", confidence: 20 }
                    ],
                    featureImportance: {
                        features: ["æ°”ä¿ƒ", "å¹²å’³", "æ— å‘çƒ­", "COPDç—…å²", "è‚ºåŠŸèƒ½å¼‚å¸¸", "å“®é¸£éŸ³"],
                        gradients: [0.8, 0.6, 0.7, 0.9, 0.85, 0.7]
                    },
                    useAntibiotic: false,
                    antibioticStandard: "æ ¹æ®æŒ‡å—,COPDæ€¥æ€§åŠ é‡æ— è„“ç—°å’Œæ„ŸæŸ“è¯æ®æ—¶,ä¸å»ºè®®å¸¸è§„ä½¿ç”¨æŠ—ç”Ÿç´ ã€‚",
                    antibioticPrimary: "",
                    antibioticReasoning: "æ‚£è€…æ— å‘çƒ­,è¡€å¸¸è§„æ­£å¸¸,æ— è„“ç—°,ä¸ç¬¦åˆæŠ—ç”Ÿç´ ä½¿ç”¨æŒ‡å¾ã€‚æ²»ç–—é‡ç‚¹åº”ä¸ºæ”¯æ°”ç®¡æ‰©å¼ å‰‚å’Œç³–çš®è´¨æ¿€ç´ ã€‚"
                }
            }
        };

        // ========================================
        // EmailJSé…ç½®
        // ========================================
        const EMAILJS_CONFIG = {
            serviceId: 'service_sjev6dm',
            templateId: 'template_ldiu064',
            publicKey: 'GbpZKeaCKEnzJeoAo'
        };
        (function() { emailjs.init(EMAILJS_CONFIG.publicKey); })();

        // ========================================
        // å…¨å±€å˜é‡
        // ========================================
        let igChartInstance = null;
        let igChartInstanceModal = null;
        let experimentConfig = null;
        let expData = null;
        let curCase = 0, completedCases = 0;
        let allCases = [];
        let currentDisplayMode = 'sidebar';
        let currentSystemIndex = -1; // è·Ÿè¸ªå½“å‰ç³»ç»Ÿ

        // ========================================
        // ç¬¬ä¸€æ­¥ï¼šå§“åè¾“å…¥
        // ========================================
        document.getElementById('participantInput').addEventListener('input', function() {
            const value = this.value.trim();
            const errorText = document.getElementById('errorText');
            const startBtn = document.getElementById('startBtn');

            if (value.length < 2) {
                errorText.style.display = 'block';
                startBtn.disabled = true;
            } else {
                errorText.style.display = 'none';
                startBtn.disabled = false;
            }
        });

        function goToDemographics() {
            const input = document.getElementById('participantInput');
            const participantName = input.value.trim();

            if (!participantName || participantName.length < 2) {
                document.getElementById('errorText').style.display = 'block';
                return;
            }

            // ä¿å­˜å§“åå¹¶æ˜¾ç¤ºä¸ªäººä¿¡æ¯è¡¨å•
            localStorage.setItem('participantName', participantName);
            document.getElementById('welcomeOverlay').style.display = 'none';
            document.getElementById('demographicsOverlay').style.display = 'flex';
        }

        // ========================================
        // ç¬¬äºŒæ­¥ï¼šæäº¤ä¸ªäººä¿¡æ¯
        // ========================================
        function submitDemographics() {
            // éªŒè¯æ‰€æœ‰å¿…å¡«é¡¹
            const gender = document.querySelector('input[name="gender"]:checked');
            const age = document.getElementById('age').value.trim();
            const education = document.querySelector('input[name="education"]:checked');
            const province = document.getElementById('province').value.trim();
            const workYears = document.getElementById('workYears').value.trim();
            const title = document.querySelector('input[name="title"]:checked');
            const facility = document.querySelector('input[name="facility"]:checked');
            const dailyPatients = document.getElementById('dailyPatients').value.trim();
            const aiKnowledge = document.querySelector('input[name="aiKnowledge"]:checked');
            const aiExperience = document.querySelector('input[name="aiExperience"]:checked');

            if (!gender || !age || !education || !province || !workYears || !title ||
                !facility || !dailyPatients || !aiKnowledge || !aiExperience) {
                alert('è¯·å®Œæ•´å¡«å†™æ‰€æœ‰å¿…å¡«é¡¹');
                return;
            }

            // ä¿å­˜ä¸ªäººä¿¡æ¯
            const demographics = {
                gender: gender.value,
                age: parseInt(age),
                education: education.value,
                province: province,
                workYears: parseInt(workYears),
                title: title.value,
                facility: facility.value,
                dailyPatients: parseInt(dailyPatients),
                aiKnowledge: aiKnowledge.value,
                aiExperience: aiExperience.value
            };

            localStorage.setItem('demographics', JSON.stringify(demographics));

            // å…³é—­ä¸ªäººä¿¡æ¯è¡¨å•,å¼€å§‹å®éªŒ
            document.getElementById('demographicsOverlay').style.display = 'none';
            startExperiment();
        }

        // ========================================
        // ç¬¬ä¸‰æ­¥ï¼šå¼€å§‹å®éªŒ
        // ========================================
        function startExperiment() {
            const participantName = localStorage.getItem('participantName');
            const timestamp = new Date().toISOString();

            experimentConfig = generateExperimentConfig(participantName, timestamp);
            localStorage.setItem('participantId', experimentConfig.participantId);

            // æ§åˆ¶å°è¾“å‡ºå®éªŒé…ç½®ä¿¡æ¯
            console.log('='.repeat(60));
            console.log('å®éªŒé…ç½®ä¿¡æ¯ - åˆ†è¾¨ç‡VIéƒ¨åˆ†æå› è®¾è®¡');
            console.log('='.repeat(60));
            console.log('å‚ä¸è€…å§“å:', participantName);
            console.log('å‚ä¸è€…ID:', experimentConfig.participantId);
            console.log('æ—¶é—´æˆ³:', timestamp);
            console.log('-'.repeat(60));
            console.log('å®éªŒè®¾è®¡:', experimentConfig.experimentDesign);
            console.log('-'.repeat(60));
            console.log('ç³»ç»Ÿé…ç½®è¯¦æƒ…:');
            experimentConfig.systems.forEach((s, idx) => {
                console.log(`\nç³»ç»Ÿ${idx + 1}:`);
                console.log('  - è®¾è®¡çŸ©é˜µç¼–å·:', s.systemIndex);
                console.log('  - æ¿€æ´»ç‰¹å¾:', s.activeFeatures.join(', ') || 'åŸºç¡€AI');
                console.log('  - ç‰¹å¾é…ç½®:', s.features);
                console.log('  - åˆ†é…ç—…å†:', s.assignedCases);
                console.log('  - è®¾è®¡ä¿¡æ¯:', s.designInfo);
            });
            console.log('='.repeat(60));

            document.getElementById('mainContent').style.display = 'block';
            initializeExperiment();
        }

        function generateRandomSystems() {
            const all = Array.from({length: 32}, (_, i) => i);
            for (let i = all.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [all[i], all[j]] = [all[j], all[i]];
            }
            return all.slice(0, 3);
        }

        function generateExperimentConfig(participantName, timestamp) {
            const designMatrix = [];

            for (let i = 0; i < 32; i++) {
                const row = {
                    A: (i >> 4) & 1,
                    B: (i >> 3) & 1,
                    C: (i >> 2) & 1,
                    D: (i >> 1) & 1,
                    E: i & 1,
                };
                row.F = row.A ^ row.B ^ row.C ^ row.D ^ row.E;
                designMatrix.push(row);
            }

            const systemIndices = generateRandomSystems();
            const allCaseIds = Object.keys(CASE_DATABASE);

            const systems = systemIndices.map((sysIdx, systemNum) => {
                const shuffled = [...allCaseIds].sort(() => Math.random() - 0.5).slice(0, 3);

                const featureNames = {
                    A: 'ä¾§è¾¹æ ',
                    B: 'æ€ç»´é“¾',
                    C: 'ç½®ä¿¡åº¦',
                    D: 'ç‰¹å¾é‡è¦æ€§',
                    E: 'åˆ†æ­¥è¯ç‰©',
                    F: 'è‡ªåŠ¨æå–'
                };

                const features = designMatrix[sysIdx];
                const activeFeatures = Object.entries(features)
                    .filter(([key, val]) => val === 1)
                    .map(([key]) => featureNames[key]);

                return {
                    systemIndex: sysIdx + 1,
                    systemName: `ç³»ç»Ÿ${systemNum + 1}`,
                    features: features,
                    activeFeatures: activeFeatures,
                    assignedCases: shuffled,
                    designInfo: {
                        resolution: 'VI',
                        generator: 'F=ABCDE',
                        totalRuns: 32,
                        selectedRun: sysIdx + 1
                    }
                };
            });

            return {
                participantId: participantName + '_' + Date.now(),
                participantName: participantName,
                timestamp: timestamp,
                experimentDesign: {
                    type: '2^(6-1)éƒ¨åˆ†æå› è®¾è®¡',
                    resolution: 'VI',
                    factors: 6,
                    runs: 32,
                    generator: 'F=ABCDE',
                    description: 'åˆ†è¾¨ç‡VIç¡®ä¿ä¸»æ•ˆåº”å’ŒäºŒå› å­äº¤äº’å¯æ¸…æ™°ä¼°è®¡'
                },
                systems: systems
            };
        }

        function initializeExperiment() {
            allCases = [];

            experimentConfig.systems.forEach((system, sysIdx) => {
                system.assignedCases.forEach((caseId, caseIdx) => {
                    const caseData = CASE_DATABASE[caseId];
                    if (!caseData) {
                        console.error(`ç—…å† ${caseId} åœ¨æ•°æ®åº“ä¸­æœªæ‰¾åˆ°`);
                        return;
                    }

                    allCases.push({
                        ...caseData,
                        systemIndex: sysIdx,
                        systemOrder: sysIdx,
                        systemName: system.systemName,
                        caseName: `${system.systemName}-æ¡ˆä¾‹${caseIdx + 1}`,
                        features: system.features,
                        activeFeatures: system.activeFeatures
                    });
                });
            });

            document.getElementById('experimentTag').textContent =
                `å‚ä¸è€…:${experimentConfig.participantId}`;

            // åˆå§‹åŒ–å®éªŒæ•°æ®
            const demographics = JSON.parse(localStorage.getItem('demographics') || '{}');
            expData = {
                participantId: experimentConfig.participantId,
                participantName: experimentConfig.participantName,
                timestamp: experimentConfig.timestamp,
                demographics: demographics,
                experimentDesign: experimentConfig.experimentDesign,
                systems: experimentConfig.systems.map(s => ({
                    systemIndex: s.systemIndex,
                    systemName: s.systemName,
                    features: s.features,
                    activeFeatures: s.activeFeatures,
                    designInfo: s.designInfo,
                    survey: null  // å°†åœ¨ç³»ç»Ÿå®Œæˆåå¡«å……
                })),
                startTime: new Date().toISOString(),
                cases: [],
                endTime: null
            };

            // åˆ›å»ºæ¡ˆä¾‹å¯¼èˆª
            const nav = document.getElementById('caseNavigationContent');
            nav.innerHTML = '';

            experimentConfig.systems.forEach((system, sysIdx) => {
                const group = document.createElement('div');
                group.className = 'system-group';

                const groupTitle = document.createElement('div');
                groupTitle.className = 'system-group-title';
                const featureText = system.activeFeatures.length > 0
                    ? system.activeFeatures.join(', ')
                    : 'åŸºç¡€AI';
                groupTitle.textContent = `${system.systemName} [é…ç½®#${system.systemIndex}] - ${featureText}`;
                group.appendChild(groupTitle);

                const btns = document.createElement('div');
                btns.className = 'case-nav-btns';

                system.assignedCases.forEach((caseId, caseIdx) => {
                    const globalIdx = sysIdx * 3 + caseIdx;
                    const btn = document.createElement('button');
                    btn.className = 'case-nav-btn';
                    btn.id = `nav-btn-${globalIdx}`;
                    btn.textContent = `æ¡ˆä¾‹${caseIdx + 1}`;
                    btn.onclick = () => switchCase(globalIdx);
                    if (globalIdx !== 0) btn.disabled = true;
                    btns.appendChild(btn);
                });

                group.appendChild(btns);
                nav.appendChild(group);
            });

            loadCase(0);
            updateProgress();
        }

        function updateProgress() {
            const totalCases = 9;
            const percentage = Math.round((completedCases / totalCases) * 100);

            const progressBarFill = document.getElementById('progressBarFill');
            const progressBarText = document.getElementById('progressBarText');
            if (progressBarFill) {
                progressBarFill.style.width = `${percentage}%`;
            }
            if (progressBarText) {
                progressBarText.textContent = `${percentage}%`;
            }

            const completedCount = document.getElementById('completedCount');
            if (completedCount) {
                completedCount.textContent = `${completedCases}/9`;
            }

            const currentCaseElement = document.getElementById('currentCase');
            if (currentCaseElement) {
                const systemNum = Math.floor(curCase / 3) + 1;
                const caseNum = (curCase % 3) + 1;
                currentCaseElement.textContent = `ç³»ç»Ÿ${systemNum}-æ¡ˆä¾‹${caseNum}`;
            }

            for (let i = 0; i < 9; i++) {
                const btn = document.getElementById(`nav-btn-${i}`);
                if (btn) {
                    btn.classList.remove('completed', 'current');
                    if (i < completedCases) {
                        btn.classList.add('completed');
                    } else if (i === curCase) {
                        btn.classList.add('current');
                    }
                }
            }
        }

        function switchCase(i) {
            curCase = i;

            document.getElementById('aiSidebar').classList.remove('active');
            document.getElementById('aiModalOverlay').classList.remove('active');

            document.getElementById('aiModalOverlay').classList.remove('minimized');
            document.getElementById('aiModal').classList.remove('minimized');
            document.getElementById('minimizeIcon').textContent = 'âˆ’';

            loadCase(i);
            updateProgress();
        }

        function formatMedicalRecord(c) {
            return `æ‚£è€…ID: ${c.patientId}
æ€§åˆ«: ${c.gender}
å¹´é¾„: ${c.age}
å°±è¯Šæ—¥æœŸ: ${c.visitDate}

ã€ä¸»è¯‰ã€‘
${c.chiefComplaint}

ã€ç°ç—…å²ã€‘
${c.presentIllness}

ã€ä¸ªäººå²ã€‘
${c.personalHistory}

ã€è¯ç‰©è¿‡æ•å²ã€‘
${c.allergyHistory}

ã€ä½“æ ¼æ£€æŸ¥ã€‘
${c.physicalExam}

ã€è¾…åŠ©æ£€æŸ¥ã€‘
${c.labTests}`;
        }

        function loadCase(i) {
            const c = allCases[i];

            const featureIndicator = document.getElementById('featureIndicator');
            featureIndicator.style.display = 'inline-block';

            if (c.activeFeatures.length > 0) {
                featureIndicator.textContent = `AIå¢å¼ºç‰¹å¾: ${c.activeFeatures.join(', ')}`;
                featureIndicator.className = 'feature-indicator';
            } else {
                featureIndicator.textContent = 'åŸºç¡€AI(è¯Šæ–­+ç”¨è¯å»ºè®®)';
                featureIndicator.className = 'feature-indicator basic';
            }

            const textarea = document.getElementById('medicalRecordDisplay');
            textarea.value = formatMedicalRecord(c);
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';

            let cd = expData.cases.find(x => x.caseId === c.id && x.systemIndex === c.systemIndex);
            if (!cd) {
                cd = {
                    caseId: c.id,
                    caseName: c.caseName,
                    systemIndex: c.systemIndex,
                    systemName: c.systemName,
                    timestamps: {}
                };
                expData.cases.push(cd);
                cd.timestamps.caseStart = new Date().toISOString();
            }

            document.getElementById('initialDiag1').value = '';
            document.getElementById('initialDiag2').value = '';
            document.getElementById('initialDiag3').value = '';
            document.querySelectorAll('input[name="initialAntibiotic"]').forEach(r => r.checked = false);
            document.getElementById('initialAntibioticTypes').classList.add('hidden');

            document.getElementById('finalDiag1').value = '';
            document.getElementById('finalDiag2').value = '';
            document.getElementById('finalDiag3').value = '';
            document.querySelectorAll('input[name="finalAntibiotic"]').forEach(r => r.checked = false);
            document.getElementById('finalAntibioticTypes').classList.add('hidden');
            document.getElementById('finalAntibioticInput').value = '';
            document.querySelectorAll('input[name="certainty"]').forEach(r => r.checked = false);

            document.getElementById('initialDecisionSection').classList.remove('hidden');
            document.getElementById('finalDecisionSection').classList.add('hidden');
        }

        document.querySelectorAll('input[name="initialAntibiotic"]').forEach(r => {
            r.addEventListener('change', function() {
                document.getElementById('initialAntibioticTypes').classList.toggle('hidden', this.value !== 'yes');
            });
        });

        document.querySelectorAll('input[name="finalAntibiotic"]').forEach(r => {
            r.addEventListener('change', function() {
                document.getElementById('finalAntibioticTypes').classList.toggle('hidden', this.value !== 'yes');
            });
        });

        async function submitInitialDecision() {
            const d1 = document.getElementById('initialDiag1').value.trim();
            const d2 = document.getElementById('initialDiag2').value.trim();
            const d3 = document.getElementById('initialDiag3').value.trim();
            const ab = document.querySelector('input[name="initialAntibiotic"]:checked');

            if (!d1 || !d2 || !d3) {
                alert('è¯·å¡«å†™æ‰€æœ‰è¯Šæ–­');
                return;
            }
            if (!ab) {
                alert('è¯·é€‰æ‹©æ˜¯å¦ä½¿ç”¨æŠ—ç”Ÿç´ ');
                return;
            }

            const useAb = ab.value === 'yes';
            let abs = '';
            if (useAb) {
                abs = document.getElementById('initialAntibioticInput').value.trim();
                if (!abs) {
                    alert('è¯·å¡«å†™æŠ—ç”Ÿç´ ç§ç±»');
                    return;
                }
            }

            const c = allCases[curCase];
            const cd = expData.cases.find(x => x.caseId === c.id && x.systemIndex === c.systemIndex);
            cd.initialDecision = {
                diagnosis: [d1, d2, d3],
                useAntibiotic: useAb,
                antibiotics: abs
            };
            cd.timestamps.initialSubmit = new Date().toISOString();

            const useModal = (c.features.A === 0);

            if (c.features.F === 0) {
                if (useModal) {
                    document.getElementById('aiModalOverlay').classList.add('active');
                    document.getElementById('pasteSectionModal').classList.remove('hidden');
                    document.getElementById('pasteTextareaModal').value = '';

                    document.getElementById('thinkingSectionModal').classList.add('hidden');
                    document.getElementById('diagnosisSectionModal').classList.add('hidden');
                    document.getElementById('featureSectionModal').classList.add('hidden');
                    document.getElementById('treatmentSectionModal').classList.add('hidden');
                } else {
                    document.getElementById('aiSidebar').classList.add('active');
                    document.getElementById('pasteSectionSidebar').classList.remove('hidden');
                    document.getElementById('pasteTextareaSidebar').value = '';

                    document.getElementById('thinkingSection').classList.add('hidden');
                    document.getElementById('diagnosisSection').classList.add('hidden');
                    document.getElementById('featureSection').classList.add('hidden');
                    document.getElementById('treatmentSection').classList.add('hidden');
                }
            } else {
                await getAISuggestion();
            }
        }

        async function getAISuggestion() {
            const c = allCases[curCase];
            const useModal = (c.features.A === 0);

            if (useModal) {
                document.getElementById('aiModalOverlay').classList.add('active');
                document.getElementById('aiModalOverlay').classList.remove('minimized');
                document.getElementById('aiModal').classList.remove('minimized');
                document.getElementById('minimizeIcon').textContent = 'âˆ’';

                document.getElementById('pasteSectionModal').classList.add('hidden');
                document.getElementById('thinkingSectionModal').classList.remove('hidden');
                currentDisplayMode = 'modal';
            } else {
                document.getElementById('aiSidebar').classList.add('active');
                document.getElementById('pasteSectionSidebar').classList.add('hidden');
                document.getElementById('thinkingSection').classList.remove('hidden');
                currentDisplayMode = 'sidebar';
            }

            const getElement = (baseName) => {
                return document.getElementById(baseName + (useModal ? 'Modal' : ''));
            };

            if (c.features.B === 1) {
                getElement('thinkingSection').classList.remove('hidden');
                const thinkingProcess = getElement('thinkingProcess');
                thinkingProcess.innerHTML = '';

                for (let i = 0; i < c.aiRecommendation.thinking.length; i++) {
                    await sleep(300);
                    const step = document.createElement('div');
                    step.className = 'thinking-step';
                    step.innerHTML = `<span class="thinking-label">æ­¥éª¤ ${i+1}:</span> ${c.aiRecommendation.thinking[i]}`;
                    thinkingProcess.appendChild(step);
                }
                await sleep(500);
            } else {
                getElement('thinkingSection').classList.add('hidden');
            }

            getElement('diagnosisSection').classList.remove('hidden');
            let diagnosisHTML = '<div class="ai-conclusion"><div class="conclusion-label">ğŸ¯ AIè¯Šæ–­ç»“è®º</div>';

            c.aiRecommendation.diagnosis.forEach((d, i) => {
                diagnosisHTML += `<div class="diagnosis-item-with-confidence">
                    <div class="diagnosis-name">${i+1}. ${d.name}</div>`;

                if (c.features.C === 1) {
                    const confClass = d.confidence >= 80 ? 'high' : d.confidence >= 60 ? 'medium' : 'low';
                    const confExplain = d.confidence >= 80 ? 'é«˜ç½®ä¿¡åº¦:AIå¯¹æ­¤è¯Šæ–­éå¸¸ç¡®å®š' :
                                       d.confidence >= 60 ? 'ä¸­ç­‰ç½®ä¿¡åº¦:AIè®¤ä¸ºæ­¤è¯Šæ–­è¾ƒä¸ºå¯èƒ½' :
                                       'ä½ç½®ä¿¡åº¦:AIè®¤ä¸ºæ­¤è¯Šæ–­å¯èƒ½æ€§è¾ƒä½';
                    diagnosisHTML += `
                        <div class="confidence-bar-container">
                            <div class="confidence-bar">
                                <div class="confidence-fill ${confClass}" style="width: ${d.confidence}%"></div>
                            </div>
                            <span class="confidence-text">${d.confidence}%</span>
                        </div>
                        <div class="confidence-explain">${confExplain}</div>`;
                }

                diagnosisHTML += `</div>`;
            });
            diagnosisHTML += '</div>';

            getElement('diagnosisContent').innerHTML = diagnosisHTML;

            if (c.features.D === 1) {
                await sleep(500);
                renderFeatureImportance(c.aiRecommendation.featureImportance, useModal);
                getElement('featureSection').classList.remove('hidden');
            } else {
                getElement('featureSection').classList.add('hidden');
            }

            await sleep(500);
            await showTreatmentRecommendation(c, useModal);

            document.getElementById('initialDecisionSection').classList.add('hidden');
            document.getElementById('finalDecisionSection').classList.remove('hidden');

            const cd = expData.cases.find(x => x.caseId === c.id && x.systemIndex === c.systemIndex);
            document.getElementById('finalDiag1').value = cd.initialDecision.diagnosis[0];
            document.getElementById('finalDiag2').value = cd.initialDecision.diagnosis[1];
            document.getElementById('finalDiag3').value = cd.initialDecision.diagnosis[2];

            const antibioticValue = cd.initialDecision.useAntibiotic ? 'yes' : 'no';
            document.querySelector(`input[name="finalAntibiotic"][value="${antibioticValue}"]`).checked = true;

            if (cd.initialDecision.useAntibiotic) {
                document.getElementById('finalAntibioticTypes').classList.remove('hidden');
                document.getElementById('finalAntibioticInput').value = cd.initialDecision.antibiotics;
            }
        }

        function renderFeatureImportance(data, useModal = false) {
            const chartId = useModal ? 'igChartModal' : 'igChart';
            const ctx = document.getElementById(chartId);

            if (useModal && igChartInstanceModal) {
                igChartInstanceModal.destroy();
            } else if (!useModal && igChartInstance) {
                igChartInstance.destroy();
            }

            const colors = data.gradients.map(val => val >= 0 ? '#27ae60' : '#e74c3c');

            const chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.features,
                    datasets: [{
                        data: data.gradients,
                        backgroundColor: colors,
                        borderColor: colors,
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.x;
                                    const direction = value >= 0 ? 'æ”¯æŒ' : 'ä¸æ”¯æŒ';
                                    return `${direction}å½“å‰è¯Šæ–­: ${Math.abs(value * 100).toFixed(1)}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return (value * 100).toFixed(0) + '%';
                                }
                            }
                        }
                    }
                }
            });

            if (useModal) {
                igChartInstanceModal = chartInstance;
            } else {
                igChartInstance = chartInstance;
            }
        }

        async function showTreatmentRecommendation(c, useModal = false) {
            const rec = c.aiRecommendation;
            const getElement = (baseName) => {
                return document.getElementById(baseName + (useModal ? 'Modal' : ''));
            };

            let html = `
                <div style="margin-bottom: 12px; padding: 12px; background: white; border-radius: 4px; border: 2px solid ${rec.useAntibiotic ? '#27ae60' : '#e74c3c'};">
                    <strong>æ˜¯å¦éœ€è¦æŠ—ç”Ÿç´ :</strong>
                    <span style="color: ${rec.useAntibiotic ? '#27ae60' : '#e74c3c'}; font-weight: 600; font-size: 15px;">
                        ${rec.useAntibiotic ? 'âœ“ å»ºè®®ä½¿ç”¨' : 'âœ— ä¸å»ºè®®ä½¿ç”¨'}
                    </span>
                </div>
            `;

            if (rec.useAntibiotic && rec.antibioticStandard) {
                if (c.features.E === 1) {
                    html += `
                        <div class="antibiotic-standard">
                            <strong>ğŸ¥ æ ‡å‡†æ²»ç–—æ–¹æ¡ˆ:</strong>
                            <div style="margin-top: 6px; color: #e65100;">${rec.antibioticStandard}</div>
                        </div>
                    `;

                    getElement('treatmentContent').innerHTML = html;
                    getElement('treatmentSection').classList.remove('hidden');

                    await sleep(1500);
                    html += '<div class="searching-indicator">ğŸ” æ­£åœ¨æ£€ç´¢åŸºå±‚åŒ»ç–—æœºæ„è¯å“åº“å­˜...</div>';
                    getElement('treatmentContent').innerHTML = html;

                    await sleep(1500);
                    html = html.replace('<div class="searching-indicator">ğŸ” æ­£åœ¨æ£€ç´¢åŸºå±‚åŒ»ç–—æœºæ„è¯å“åº“å­˜...</div>', '');
                    html += `
                        <div class="antibiotic-primary">
                            <strong>âœ“ åŸºå±‚åŒ»ç–—æœºæ„å¯åŠæ–¹æ¡ˆ:</strong>
                            <div style="margin-top: 6px; color: #2e7d32; font-weight: 600;">${rec.antibioticPrimary}</div>
                            <div style="margin-top: 8px; font-size: 12px; color: #059669;">è¯¥æ–¹æ¡ˆè¯ç‰©åœ¨åŸºå±‚åŒ»ç–—æœºæ„å¸¸å¤‡,å¯ç«‹å³è·å–</div>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="antibiotic-standard">
                            <strong>ğŸ¥ æ ‡å‡†æ²»ç–—æ–¹æ¡ˆ:</strong>
                            <div style="margin-top: 6px; color: #e65100;">${rec.antibioticStandard}</div>
                        </div>
                    `;
                }
            }

            html += `
                <div style="margin-top: 16px; padding: 12px; background: #fffbea; border-radius: 4px; font-size: 13px; color: #856404; line-height: 1.6;">
                    <strong>ğŸ’¡ AIæ¨ç†è¯´æ˜:</strong><br>
                    ${rec.antibioticReasoning}
                </div>
            `;

            getElement('treatmentContent').innerHTML = html;
            getElement('treatmentSection').classList.remove('hidden');
        }

        function submitFinalDecision() {
            const d1 = document.getElementById('finalDiag1').value.trim();
            const d2 = document.getElementById('finalDiag2').value.trim();
            const d3 = document.getElementById('finalDiag3').value.trim();
            const ab = document.querySelector('input[name="finalAntibiotic"]:checked');
            const cert = document.querySelector('input[name="certainty"]:checked');

            if (!d1 || !d2 || !d3 || !ab || !cert) {
                alert('è¯·å®Œæ•´å¡«å†™æ‰€æœ‰ä¿¡æ¯');
                return;
            }

            const useAb = ab.value === 'yes';
            let abs = '';
            if (useAb) {
                abs = document.getElementById('finalAntibioticInput').value.trim();
                if (!abs) {
                    alert('è¯·å¡«å†™æŠ—ç”Ÿç´ ç§ç±»');
                    return;
                }
            }

            const c = allCases[curCase];
            const cd = expData.cases.find(x => x.caseId === c.id && x.systemIndex === c.systemIndex);
            cd.finalDecision = {
                diagnosis: [d1, d2, d3],
                useAntibiotic: useAb,
                antibiotics: abs,
                certainty: parseInt(cert.value)
            };
            cd.timestamps.finalSubmit = new Date().toISOString();

            completedCases++;
            updateProgress();

            document.getElementById('aiSidebar').classList.remove('active');
            document.getElementById('aiModalOverlay').classList.remove('active');

            // æ£€æŸ¥æ˜¯å¦å®Œæˆäº†ä¸€ä¸ªç³»ç»Ÿçš„æ‰€æœ‰ç—…å† (æ¯3ä¸ªæ¡ˆä¾‹)
            if ((completedCases % 3 === 0) && completedCases < 9) {
                // æ˜¾ç¤ºç³»ç»Ÿè¯„ä»·é‡è¡¨
                showSystemSurvey(Math.floor((completedCases - 1) / 3));
            } else if (completedCases >= 9) {
                // å®Œæˆæœ€åä¸€ä¸ªç³»ç»Ÿ,æ˜¾ç¤ºé‡è¡¨
                showSystemSurvey(2);
            } else {
                // ç»§ç»­ä¸‹ä¸€ä¸ªç—…å†
                alert(`æ¡ˆä¾‹å·²å®Œæˆ!è¯·ç»§ç»­ä¸‹ä¸€æ¡ˆä¾‹ã€‚`);
                const nextIdx = curCase + 1;
                document.getElementById(`nav-btn-${nextIdx}`).disabled = false;
                switchCase(nextIdx);
            }
        }

        // ========================================
        // ç³»ç»Ÿè¯„ä»·é‡è¡¨
        // ========================================
        function showSystemSurvey(systemIdx) {
            currentSystemIndex = systemIdx;
            const systemName = experimentConfig.systems[systemIdx].systemName;
            document.getElementById('surveySystemName').textContent = systemName;

            // é‡ç½®æ‰€æœ‰é‡è¡¨é€‰é¡¹
            document.querySelectorAll('#systemSurveyOverlay input[type="radio"]').forEach(r => r.checked = false);

            document.getElementById('systemSurveyOverlay').style.display = 'flex';
        }

        function submitSystemSurvey() {
            // éªŒè¯æ‰€æœ‰é‡è¡¨é¡¹éƒ½å·²å¡«å†™
            const requiredFields = [
                'intention1', 'intention2', 'intention3',
                'usefulness1', 'usefulness2', 'usefulness3', 'usefulness4', 'usefulness5', 'usefulness6',
                'easeOfUse1', 'easeOfUse2', 'easeOfUse3', 'easeOfUse4', 'easeOfUse5', 'easeOfUse6'
            ];

            for (const field of requiredFields) {
                if (!document.querySelector(`input[name="${field}"]:checked`)) {
                    alert('è¯·å®Œæ•´å¡«å†™æ‰€æœ‰è¯„ä»·é¡¹');
                    return;
                }
            }

            // æ”¶é›†é‡è¡¨æ•°æ®
            const surveyData = {
                intention: {
                    q1: parseInt(document.querySelector('input[name="intention1"]:checked').value),
                    q2: parseInt(document.querySelector('input[name="intention2"]:checked').value),
                    q3: parseInt(document.querySelector('input[name="intention3"]:checked').value)
                },
                usefulness: {
                    q1: parseInt(document.querySelector('input[name="usefulness1"]:checked').value),
                    q2: parseInt(document.querySelector('input[name="usefulness2"]:checked').value),
                    q3: parseInt(document.querySelector('input[name="usefulness3"]:checked').value),
                    q4: parseInt(document.querySelector('input[name="usefulness4"]:checked').value),
                    q5: parseInt(document.querySelector('input[name="usefulness5"]:checked').value),
                    q6: parseInt(document.querySelector('input[name="usefulness6"]:checked').value)
                },
                easeOfUse: {
                    q1: parseInt(document.querySelector('input[name="easeOfUse1"]:checked').value),
                    q2: parseInt(document.querySelector('input[name="easeOfUse2"]:checked').value),
                    q3: parseInt(document.querySelector('input[name="easeOfUse3"]:checked').value),
                    q4: parseInt(document.querySelector('input[name="easeOfUse4"]:checked').value),
                    q5: parseInt(document.querySelector('input[name="easeOfUse5"]:checked').value),
                    q6: parseInt(document.querySelector('input[name="easeOfUse6"]:checked').value)
                },
                timestamp: new Date().toISOString()
            };

            // ä¿å­˜åˆ°å¯¹åº”ç³»ç»Ÿçš„æ•°æ®ä¸­
            expData.systems[currentSystemIndex].survey = surveyData;

            // å…³é—­é‡è¡¨
            document.getElementById('systemSurveyOverlay').style.display = 'none';

            if (completedCases >= 9) {
                // æ‰€æœ‰å®éªŒå®Œæˆ
                expData.endTime = new Date().toISOString();

                const allResults = JSON.parse(localStorage.getItem('experimentResults') || '[]');
                allResults.push(expData);
                localStorage.setItem('experimentResults', JSON.stringify(allResults));

                document.getElementById('completedParticipantId').textContent = expData.participantId;
                document.getElementById('caseContentArea').classList.add('hidden');
                document.getElementById('completionArea').classList.remove('hidden');

                // å‘é€æ•°æ®åˆ°é‚®ç®±
                emailjs.send(EMAILJS_CONFIG.serviceId, EMAILJS_CONFIG.templateId, {
                    participant_id: expData.participantId,
                    participant_name: expData.participantName,
                    systems: expData.systems.map(s => `é…ç½®#${s.systemIndex}`).join(', '),
                    design_info: JSON.stringify(expData.experimentDesign),
                    full_data: JSON.stringify(expData, null, 2)
                }).then(
                    () => console.log('å®éªŒæ•°æ®å‘é€æˆåŠŸ'),
                    (error) => console.error('æ•°æ®å‘é€å¤±è´¥:', error)
                );

                setTimeout(() => {
                    alert(`å®éªŒå®Œæˆ!æ„Ÿè°¢æ‚¨çš„å‚ä¸ã€‚\n\næ‚¨ä½¿ç”¨çš„ç³»ç»Ÿé…ç½®:\n${expData.systems.map((s,i) => `ç³»ç»Ÿ${i+1}: é…ç½®#${s.systemIndex}`).join('\n')}`);
                }, 1000);
            } else {
                // ç»§ç»­ä¸‹ä¸€ä¸ªç³»ç»Ÿçš„ç—…å†
                alert(`æ„Ÿè°¢æ‚¨çš„è¯„ä»·!è¯·ç»§ç»­ä¸‹ä¸€ç³»ç»Ÿçš„ç—…å†ã€‚`);
                const nextIdx = curCase + 1;
                document.getElementById(`nav-btn-${nextIdx}`).disabled = false;
                switchCase(nextIdx);
            }
        }

        function closeAIModal() {
            const overlay = document.getElementById('aiModalOverlay');
            const modal = document.getElementById('aiModal');
            overlay.classList.remove('active', 'minimized');
            modal.classList.remove('minimized');
        }

        function toggleMinimizeModal() {
            const overlay = document.getElementById('aiModalOverlay');
            const modal = document.getElementById('aiModal');
            const icon = document.getElementById('minimizeIcon');

            if (modal.classList.contains('minimized')) {
                modal.classList.remove('minimized');
                overlay.classList.remove('minimized');
                icon.textContent = 'âˆ’';
            } else {
                modal.classList.add('minimized');
                overlay.classList.add('minimized');
                icon.textContent = 'â–¡';
            }
        }

        async function submitPastedContentSidebar() {
            const pastedText = document.getElementById('pasteTextareaSidebar').value.trim();

            if (pastedText.length < 50) {
                alert('è¯·ç²˜è´´å®Œæ•´çš„ç—…å†å†…å®¹(è‡³å°‘50ä¸ªå­—ç¬¦)');
                return;
            }

            const c = allCases[curCase];
            const cd = expData.cases.find(x => x.caseId === c.id && x.systemIndex === c.systemIndex);
            cd.timestamps.pastedContent = new Date().toISOString();
            cd.pastedContentLength = pastedText.length;

            document.getElementById('pasteSectionSidebar').classList.add('hidden');
            await getAISuggestion();
        }

        async function submitPastedContentModal() {
            const pastedText = document.getElementById('pasteTextareaModal').value.trim();

            if (pastedText.length < 50) {
                alert('è¯·ç²˜è´´å®Œæ•´çš„ç—…å†å†…å®¹(è‡³å°‘50ä¸ªå­—ç¬¦)');
                return;
            }

            const c = allCases[curCase];
            const cd = expData.cases.find(x => x.caseId === c.id && x.systemIndex === c.systemIndex);
            cd.timestamps.pastedContent = new Date().toISOString();
            cd.pastedContentLength = pastedText.length;

            await getAISuggestion();
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        window.onload = function() {
            const savedId = localStorage.getItem('participantId');
            const savedName = localStorage.getItem('participantName');

            if (savedId && savedName) {
                document.getElementById('participantInput').value = savedName;

                if (confirm(`æ£€æµ‹åˆ°æ‚¨ä¹‹å‰ä½¿ç”¨çš„IDæ˜¯ã€Œ${savedName}ã€\n\næ˜¯å¦ç»§ç»­ä½¿ç”¨?\n\nç‚¹å‡»"ç¡®å®š"ç»§ç»­,ç‚¹å‡»"å–æ¶ˆ"é‡æ–°è¾“å…¥ã€‚`)) {
                    // æ£€æŸ¥æ˜¯å¦å·²æœ‰ä¸ªäººä¿¡æ¯
                    const demographics = localStorage.getItem('demographics');
                    if (demographics) {
                        startExperiment();
                    } else {
                        goToDemographics();
                    }
                } else {
                    localStorage.removeItem('participantId');
                    localStorage.removeItem('participantName');
                    localStorage.removeItem('demographics');
                }
            }
        };
    </script>
</body>
</html>